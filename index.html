<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <link rel="icon" type="image/png" href="logo-dark.png">
  
  <title>Hells Angels - Calculadora e Login</title>
  
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  
  <style>
    /* ---------------------- VARI√ÅVEIS DE COR (MANTIDAS DO index_new.html) ---------------------- */
    :root {
      --cor-fundo: #fff0f6;
      --cor-texto: #4a0033;
      --cor-principal: #e60073;
      --cor-card: #ffffff;
      --cor-borda: #ffb3d9;
      --cor-btn-primario: #e60073;
      --cor-btn-texto: #fff;
      --cor-btn-secundario: #ffd6eb;
      --cor-btn-secundario-texto: #4a0033;
      --cor-erro: #cc0000;
      /* NOVO: Cor para o brilho pulsante */
      --cor-glow-pulsante: rgba(230, 0, 115, 0.8); /* Cor Principal com opacidade */
    }

    body.dark {
      --cor-fundo: #1a000d; 
      --cor-texto: #ffccf0; 
      --cor-principal: #ff0080; 
      --cor-card: #2c001a; 
      --cor-borda: #e60073; 
      --cor-btn-primario: #ff0080; 
      --cor-btn-texto: #fff;
      --cor-btn-secundario: #4d002a; 
      --cor-btn-secundario-texto: #ffccf0; 
      /* NOVO: Cor para o brilho pulsante no modo escuro */
      --cor-glow-pulsante: rgba(255, 0, 128, 0.6); /* Cor Principal Escura com opacidade */
    }
    
    body.dark input[type=number], body.dark input[type=text], body.dark select {
      background: #33001f;
      color: var(--cor-texto);
      border: 1px solid var(--cor-borda);
    }
    
    /* ---------------------- ESTILOS LOGIN (ADICIONADOS DO ARQUIVO DE LOGIN) ---------------------- */
    .login-container {
      width: 100%;
      max-width: 400px;
      background: var(--cor-card);
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      border: 1px solid var(--cor-borda);
      text-align: center;
    }

    /* A logo no login tem um tamanho maior */
    .login-container .app-logo {
      max-height: 100px; 
      margin-bottom: 25px;
    }

    .login-container h1 {
      margin: 0 0 25px;
      font-size: 28px;
      font-weight: 700;
      color: var(--cor-principal);
    }
    
    .login-container label {
      margin: 15px 0 6px;
      font-weight: 600;
      color: var(--cor-principal);
      text-align: left;
    }

    .login-container input[type=text], .login-container input[type=password] {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid var(--cor-borda);
      background: #fff;
      color: var(--cor-texto);
      font-size: 16px;
      box-sizing: border-box;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    
    body.dark .login-container input[type=text], body.dark .login-container input[type=password] {
      background: #33001f;
      color: var(--cor-texto);
      border: 1px solid var(--cor-borda);
    }
    
    .login-container input:focus {
        border-color: var(--cor-principal) !important; 
        box-shadow: 0 0 5px rgba(230, 0, 115, 0.4); 
        outline: none;
    }

    .login-container button {
      width: 100%;
      padding: 12px 20px;
      margin-top: 25px;
      border-radius: 8px;
      font-size: 16px;
    }
    
    /* Ajustado para ser reutilizado como errorMessage e regErrorMessage */
    #errorMessage, #regErrorMessage {
      color: var(--cor-erro);
      margin-top: 15px;
      font-weight: 600;
      min-height: 18px;
    }
    /* ---------------------- FIM ESTILOS LOGIN ---------------------- */

    
    /* --- ESTILO PARA INPUT DATALIST (Foco Rosa/Roxo) --- (MANTIDO DO index_new.html) */
    input[list]:focus, input[list]:hover {
        border-color: var(--cor-principal) !important; 
        box-shadow: 0 0 5px rgba(230, 0, 115, 0.4); 
    }
    
    /* --- NOVO ESTILO PARA DATALIST (Sugest√µes de Organiza√ß√£o) --- */
    input[list] {
        position: relative;
        z-index: 1; 
    }
    
    input[list]::-webkit-calendar-picker-indicator {
        display: none;
    }
    /* --- FIM NOVO ESTILO PARA DATALIST --- */
    
    /* --- NOVO: Estilo para a dica de sugest√£o da Organiza√ß√£o --- */
    .suggestion-tip {
        font-size: 11px;
        color: var(--cor-principal); /* Usa a cor principal para destaque */
        margin-top: 4px;
        margin-bottom: 0;
        font-weight: 500;
        opacity: 0.8;
    }
    /* --- FIM NOVO: Estilo para a dica de sugest√£o da Organiza√ß√£o --- */
    
    /* --- ESTILOS TOUR --- */
    .tour-tooltip {
      position: absolute;
      background: var(--cor-principal);
      color: var(--cor-btn-texto);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      max-width: 300px;
      text-align: left;
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 10002;
    }

    .tour-tooltip.active {
      opacity: 1;
      transform: translateY(0);
    }

    .tour-tooltip h4 {
        margin: 0 0 5px;
        font-size: 16px;
        color: var(--cor-btn-texto);
    }
    .tour-tooltip p {
        margin: 0;
        font-size: 14px;
        margin-bottom: 10px;
    }
    
    .tour-tooltip button {
        background: var(--cor-btn-secundario);
        color: var(--cor-btn-secundario-texto);
        padding: 6px 10px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        margin-right: 8px;
    }
    
    .tour-highlight {
      box-shadow: 0 0 0 3px rgba(230,0,115,0.6), 0 0 10px rgba(230,0,115,0.5);
      position: relative;
      z-index: 10001;
    }
    /* --- FIM ESTILOS TOUR --- */
    
    /* --- ESTILO PARA CAMPO INV√ÅLIDO --- */
    input.input-invalido, select.input-invalido {
        border: 2px solid var(--cor-erro) !important;
        box-shadow: 0 0 4px var(--cor-erro);
    }
    /* --- FIM ESTILO PARA CAMPO INV√ÅLIDO --- */

    
    /* Container para a logo (do index_new.html) */
    #logoLink {
        position: fixed;
        top: 16px; 
        left: 16px; 
        width: auto; 
        max-height: 80px; 
        cursor: pointer;
        z-index: 9998; 
    }
    
    /* Ajuste na logo superior */
    .app-logo {
      max-height: 80px; 
      width: auto;
      transition: opacity 0.3s ease, filter 0.3s ease;
      display: block; 
    }
    
    /* NOVO: Efeito de ilumina√ß√£o ao passar o mouse na Logo (na calculadora) */
    #appLogo:hover {
        /* Brilho da logo ao passar o mouse */
        filter: drop-shadow(0 0 8px var(--cor-principal)) drop-shadow(0 0 15px var(--cor-glow-pulsante));
        opacity: 0.9;
    }

    
    /* Estilos Gerais do Corpo do index_new.html (aplicados somente ap√≥s o login) */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 960px;
      margin: 24px auto;
      padding: 20px;
      background: var(--cor-fundo);
      color: var(--cor-texto);
      transition: background 0.25s ease, color 0.25s ease;
    }
    
    /* Garante que o conte√∫do principal comece escondido e s√≥ apare√ßa se JS/Welcome Screen n√£o funcionar */
    #mainCard {
        display: none; /* Alterado para come√ßar escondido */
    }

    h1 {
      margin: 0 0 12px;
      font-size: 24px;
      font-weight: 700;
      color: var(--cor-principal);
      text-align: center;
    }

    h2 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--cor-principal);
    }
    
    h3 {
        color: var(--cor-principal); 
        font-weight:600; 
        margin-top: 16px;
    }

    .card {
      background: var(--cor-card);
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border: 1px solid var(--cor-borda);
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin: 10px 0 6px;
      font-weight: 600;
      color: var(--cor-principal);
    }

    input[type=number], input[type=text], select {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid var(--cor-borda);
      background: #fff;
      color: var(--cor-texto);
      font-size: 14px;
      box-sizing: border-box;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    
    input[type=number] {
        width: 140px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
      margin-top: 12px;
    }
    
    .grid-venda {
        grid-template-columns: 1fr 1fr;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 14px;
    }

    th, td {
      padding: 6px; 
      border-bottom: 1px solid var(--cor-borda);
      text-align: left;
    }

    th {
      background: var(--cor-btn-secundario);
      color: var(--cor-btn-secundario-texto);
      font-weight: 600;
    }
    
    
/* --- NOVO ESTILO PARA RESPONSIVIDADE DA TABELA --- */
.history-table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    width: 100%;
    margin-top: 8px;
}

/* Garante que o container interno n√£o atrapalhe a rolagem */
#historyBackground {
    overflow: hidden;
}

/* Mant√©m a tabela com comportamento de tabela e largura controlada */
#historyCard table {
    width: 100%;
    display: table;
    border-collapse: collapse;
    table-layout: fixed; /* ajuda a manter colunas alinhadas */
    min-width: 900px; /* for√ßa scroll em telas pequenas mantendo alinhamento */
}

/* Estilo base para c√©lulas */
#historyCard th, #historyCard td {
    padding: 8px 10px;
    vertical-align: middle;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 13px;
}

/* Defini√ß√£o de larguras e alinhamentos por coluna - ajust√°veis conforme necessidade */
#historyCard th:nth-child(1), #historyCard td:nth-child(1) { width: 90px; text-align: center; } /* Data/Hora */
#historyCard th:nth-child(2), #historyCard td:nth-child(2) { width: 160px; text-align: left; }   /* Cliente */
#historyCard th:nth-child(3), #historyCard td:nth-child(3) { width: 160px; text-align: center; } /* Organiza√ß√£o/Tipo */
#historyCard th:nth-child(4), #historyCard td:nth-child(4) { width: 110px; text-align: center; } /* Telefone */
#historyCard th:nth-child(5), #historyCard td:nth-child(5) { width: 280px; text-align: left; }   /* Produtos */
#historyCard th:nth-child(6), #historyCard td:nth-child(6) { width: 140px; text-align: center; } /* Valor */
#historyCard th:nth-child(7), #historyCard td:nth-child(7) { width: 140px; text-align: center; } /* Negociadoras */
#historyCard th:nth-child(8), #historyCard td:nth-child(8) { width: 150px; text-align: center; } /* A√ß√µes */

/* Ajuste para a linha de data/hora (duas linhas dentro da mesma c√©lula) */
.history-datetime-line {
    display: block;
    line-height: 1.1;
    font-size: 12px;
}

/* Faz com que valores longos quebrem visualmente melhor em c√©lulas menores quando necess√°rio */
@media (max-width: 700px) {
    #historyCard th, #historyCard td {
        font-size: 12px;
    }
    #historyCard th:nth-child(5), #historyCard td:nth-child(5) { width: 320px; }
}
/* --- FIM NOVO ESTILO PARA RESPONSIVIDADE DA TABELA --- */



    .actions {
      margin-top: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    button {
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: opacity 0.2s ease, box-shadow 0.3s ease; /* Adicionado box-shadow para transi√ß√£o do glow */
    }

    button:hover { opacity: 0.85; }
    
    /* NOVO: Efeito de brilho pulsante para o bot√£o principal (Calcular/Registrar) */
    .primary, .success {
        animation: pulse-glow 2s infinite ease-in-out;
    }
    
    /* NOVO: Keyframes para o brilho pulsante */
    @keyframes pulse-glow {
        0% {
            box-shadow: 0 0 0 rgba(0, 0, 0, 0); 
        }
        50% {
            box-shadow: 0 0 10px var(--cor-glow-pulsante), 0 0 20px var(--cor-glow-pulsante); 
        }
        100% {
            box-shadow: 0 0 0 rgba(0, 0, 0, 0); 
        }
    }

    .primary { background: var(--cor-btn-primario); color: var(--cor-btn-texto); }
    .muted { background: var(--cor-btn-secundario); color: var(--cor-btn-secundario-texto); }
    .success { background: #00b33c; color: #fff; }

    /* Container para agrupar e posicionar bot√µes (Modo Noturno e Tutorial) */
    .top-right-controls {
        position: fixed;
        top: 16px;
        right: 16px;
        display: flex;
        gap: 10px;
        z-index: 9999;
    }

    /* Estilo base para bot√µes de controle fixos */
    .control-btn {
        padding: 10px 14px;
        border-radius: 10px;
        background: var(--cor-btn-primario);
        color: var(--cor-btn-texto);
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        border: none;
        transition: opacity 0.2s ease;
    }
    .control-btn:hover {
        opacity: 0.85;
    }
    
    /* --- Estilo para o Fundo do Hist√≥rico --- */
    #historyBackground {
      /* ALTERA√á√ÉO: Fundo semi-transparente (70%) */
      background: rgba(255, 255, 255, 0.7); 
      position: relative; 
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border: 1px solid var(--cor-borda);
      margin-bottom: 20px;
      min-height: 400px; 
      overflow: hidden;
    }
    
    #historyBackground img {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      height: auto;
      opacity: 0.3; /* ALTERA√á√ÉO: Aumentado para maior visibilidade */ 
      z-index: 1; 
      object-fit: contain; 
    }
    
    #historyBackground > * {
      position: relative; 
      z-index: 2;
    }
    
    #historyCard table {
        font-size: 12px;
    }
    
    /* --- CORRE√á√ÉO DE ALINHAMENTO DAS C√âLULAS (Principal Altera√ß√£o) --- */
    
#historyCard th, #historyCard td {
    padding: 8px 6px;
    text-align: center;
    vertical-align: middle; /* Centraliza verticalmente */
    white-space: nowrap;    /* Evita quebras desnecess√°rias */
}

/* Corrige o bloco de data/hora */
#historyCard tr td:first-child {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    line-height: 1.2;
    padding: 4px 0;
}

.history-datetime-line {
    display: block;
    font-size: 12px;
}

    
    /* Estilo para cada linha do texto dentro da c√©lula de Data/Hora */
    .history-datetime-line {
        display: block;
        line-height: 1.2; 
        padding: 6px 0 0 6px; /* Adiciona o padding de volta (topo e esquerda) */
    }
    
    /* Reduz o espa√ßamento vertical para compactar o texto na c√©lula de Valor Total (que tem quebra de linha) */
    
.valor-total-cell {
    display: flex;
    flex-direction: column;
    align-items: center;      /* Centraliza horizontalmente */
    justify-content: center;  /* Centraliza verticalmente */
    padding: 4px 0;
    line-height: 1.3;
    text-align: center;
}

.valor-total-cell span {
    display: block;
}

.valor-obs-text {
    font-size: 11px;
    color: var(--cor-principal);
    margin-top: 2px; /* Pequeno espa√ßamento entre o valor e a observa√ß√£o */
}

    
    /* --- FIM CORRE√á√ÉO DE ALINHAMENTO --- */
    
    
    /* Estilo para colocar os bot√µes do hist√≥rico na mesma linha (Responsivo) */
    .history-actions-cell {
        display: flex;
        gap: 5px; /* Espa√ßamento entre os bot√µes */
        flex-wrap: nowrap; /* Garante que fiquem na mesma linha */
        padding-top: 4px; /* Ajuste para o padding das outras c√©lulas */
    }
    
    .history-actions-cell button {
        padding: 4px 8px;
        font-size: 11px;
        margin-top: 2px; /* Pequeno ajuste de margem */
        border-radius: 4px;
        white-space: nowrap; /* Impede a quebra de linha dos bot√µes */
    }

    /* --- Estilos para Notifica√ß√£o Toast --- */
    #toast-container {
        position: fixed;
        bottom: 20px; 
        right: 20px; 
        z-index: 10005; 
        display: flex;
        flex-direction: column-reverse; 
        gap: 10px; 
        align-items: flex-end; 
    }

    .toast {
        background-color: var(--cor-principal); 
        color: var(--cor-btn-texto);
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        opacity: 0;
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        transform: translateY(20px); 
        max-width: 300px;
        min-width: 150px;
        text-align: center;
    }

    .toast.show {
        opacity: 1;
        transform: translateY(0);
    }
    
    .toast.success {
        background-color: #00b33c; 
    }

    .toast.error {
        background-color: var(--cor-erro); 
    }
    
    .action-btn {
        padding: 4px 8px;
        font-size: 12px;
        margin-right: 0px; 
        border-radius: 4px;
    }
    
    /* Otimiza√ß√£o para telas muito pequenas */
    @media (max-width: 500px) {
        body {
            padding: 10px;
            margin: 10px auto;
        }
        .top-right-controls {
            top: 10px;
            right: 10px;
        }
        .control-btn {
            padding: 8px 10px;
            font-size: 12px;
        }
        .grid {
            grid-template-columns: 1fr;
        }
        .grid-venda {
            grid-template-columns: 1fr;
        }
    }
    /* --- FIM Estilos para Notifica√ß√£o Toast --- */
  
/* --- ESTILO FINAL DA TABELA DE HIST√ìRICO --- */
.history-table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    width: 100%;
    margin-top: 8px;
}

#historyCard table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    min-width: 900px;
    background: transparent; 
}

#historyCard th, #historyCard td {
    padding: 6px 8px;
    text-align: center;
    vertical-align: middle;
    white-space: nowrap;
    font-size: 14px; 
    border-bottom: 1px solid var(--cor-borda);
}

/* NOVO: Fundo para as c√©lulas de dados para garantir a legibilidade */
#historyCard td {
    background: var(--cor-card); 
    opacity: 0.95; /* Leve transpar√™ncia para manter o efeito do fundo */
}

body.dark #historyCard td {
    background: var(--cor-card); /* Cor do card escuro */
    opacity: 0.95;
}


/* Alinhamento individual por coluna - larguras ajustadas */
#historyCard th:nth-child(1), #historyCard td:nth-child(1) { width: 100px; }   /* Data/Hora - Aumentado */
#historyCard th:nth-child(2), #historyCard td:nth-child(2) { width: 140px; }  /* Cliente - Aumentado */
#historyCard th:nth-child(3), #historyCard td:nth-child(3) { width: 160px; }  /* Organiza√ß√£o */
#historyCard th:nth-child(4), #historyCard td:nth-child(4) { width: 110px; }  /* Telefone */
#historyCard th:nth-child(5), #historyCard td:nth-child(5) { width: 280px; }  /* Produtos - Aumentado */
#historyCard th:nth-child(6), #historyCard td:nth-child(6) { width: 150px; }  /* Valor - Aumentado */
#historyCard th:nth-child(7), #historyCard td:nth-child(7) { width: 130px; }  /* Negociadoras */
#historyCard th:nth-child(8), #historyCard td:nth-child(8) { width: 150px; }  /* A√ß√µes */

/* Data e hora */
.history-datetime-line {
    display: block;
    line-height: 1.2; 
    font-size: 13px; 
}

/* Valor Total - tornando o valor em negrito */
.valor-total-cell span:first-child {
    font-weight: 700; /* Negrito */
}

.valor-obs-text {
    font-size: 12px; /* Aumentado */
    color: var(--cor-principal);
}

/* Bot√µes de a√ß√µes */
.history-actions-cell {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
}

.history-actions-cell button {
    padding: 3px 6px;
    font-size: 11px;
    border-radius: 4px;
    white-space: nowrap;
}

/* Aumenta altura total da linha */
#historyCard tr {
    height: 40px;
}

/* NOVO: Estilo para o cabe√ßalho TH */
#historyCard th {
    background: var(--cor-principal); /* Usa a cor principal para o cabe√ßalho */
    color: var(--cor-btn-texto);     /* Texto branco */
}

/* NOVO: Fundo semi-transparente para modo escuro */
body.dark #historyBackground {
  /* Cor escura do card #2c001a (que √© 44, 0, 26 em RGB) com 70% de opacidade */
  background: rgba(44, 0, 26, 0.7); 
}
/* --- FIM DO ESTILO FINAL DA TABELA DE HIST√ìRICO --- */
</style>
</head>
<body class="light">
  
  <a href="#" id="logoLink" style="display: none;"> <img id="appLogo" src="logo-dark.png" alt="Hells Angels Logo" class="app-logo">
  </a>

  <div id="loginScreen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--cor-fundo); z-index: 10000; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; box-sizing: border-box;"> 
      <div class="login-container">
          <img src="logo-dark.png" alt="Hells Angels Logo" class="app-logo">
          <h1 id="authTitle">Acesso Restrito</h1>
          
          <form id="loginForm">
              <div>
                  <label for="loginUsername">Usu√°rio:</label>
                  <input id="loginUsername" type="text" placeholder="Digite seu nome de usu√°rio" required>
              </div>
              <div>
                  <label for="loginPassword">Senha:</label>
                  <input id="loginPassword" type="password" placeholder="Digite sua senha" required>
              </div>
              <div id="errorMessage"></div>
              <button type="submit" id="loginBtn" class="primary">Entrar</button>
              
              <p style="margin-top: 15px; font-size: 14px;">N√£o tem uma conta? <a href="#" id="toggleToReg" style="color: var(--cor-principal); font-weight: 600;">Crie uma agora</a></p>
          </form>
          
          <form id="registrationForm" style="display: none;">
              <div>
                  <label for="regUsername">Usu√°rio para Registro:</label>
                  <input id="regUsername" type="text" placeholder="Crie seu nome de usu√°rio" required>
              </div>
              <div>
                  <label for="regPassword">Senha (m√≠nimo 6 caracteres):</label>
                  <input id="regPassword" type="password" placeholder="Crie sua senha" required>
              </div>
              <div>
                  <label for="regConfirmPassword">Confirme a Senha:</label>
                  <input id="regConfirmPassword" type="password" placeholder="Repita a senha" required>
              </div>
              <div id="regErrorMessage"></div>
              <button type="submit" id="regBtn" class="success">Criar Conta</button>
              
              <p style="margin-top: 15px; font-size: 14px;">J√° tem uma conta? <a href="#" id="toggleToLogin" style="color: var(--cor-principal); font-weight: 600;">Fa√ßa Login</a></p>
          </form>
      </div>
  </div>
  <div class="top-right-controls">
      <button class="control-btn" id="logoutBtn" style="display:none;">üîí Sair</button>
      
      <button class="control-btn" id="tutorialBtn" style="display: none;">üí° Tutorial</button> 
      <button class="control-btn" id="themeBtn">üåô Modo Noturno</button>
  </div>
  
  <div class="card" id="mainCard" style="display:none">
    <h1>Calculadora e Registro de Vendas Hells Angels</h1>
    
    <div class="card-venda">
        <h2>Dados da Venda</h2>
        <div class="grid grid-venda">
            <div>
                <label for="nomeCliente">Nome:</label>
                <input id="nomeCliente" type="text" value="">
            </div>
            <div>
                <label for="dataVenda">Data:</label>
                <input id="dataVenda" type="text" readonly> 
            </div>
            
            <div>
                <label for="organizacao">Organiza√ß√£o:</label>
                <input id="organizacao" type="text" value="" list="sugestoesOrganizacao">
                
                <p class="suggestion-tip">Digite para ver sugest√µes de organiza√ß√µes.</p>
                
                <datalist id="sugestoesOrganizacao">
                    <option value="Serpents"></option>
                    <option value="Nox"></option>
                    <option value="NKT"></option>
                    <option value="Ruptura"></option>
                    <option value="Midnight"></option>
                    <option value="Meraki"></option>
                    <option value="Lotus"></option>
                    <option value="Hydra"></option>
                    <option value="Hooligans"></option>
                    <option value="Families"></option>
                    <option value="Cartel"></option>
                    <option value="Blood Street"></option>
                    <option value="Blood Reapers"></option>
                    <option value="Blue Diamond"></option>
                    <option value="Black Heart"></option>
                    <option value="Ballas"></option>
                    <option value="Aura"></option>
                    <option value="Anarquia"></option>
                    <option value="8 Anjo"></option>
                    <option value="Vagos"></option>
                    <option value="Vertice"></option>
                    <option value="Void"></option>
                    <option value="Solo"></option>
                </datalist>
            </div>
            <div>
                <label for="organizacaoTipo">Op√ß√£o (CNPJ/CPF):</label>
                <select id="organizacaoTipo">
                    <option value="CNPJ">CNPJ</option>
                    <option value="CPF">CPF</option>
                    <option value="OUTROS">Outros</option>
                </select>
            </div>
            
            <div>
                <label for="telefone">Telefone:</label>
                <input id="telefone" type="text" value="" maxlength="13"> 
            </div>
            
            <div>
                <label for="negociadoras">Negociadoras:</label>
                <input id="negociadoras" type="text" value="">
            </div>
            <div style="grid-column: 1 / -1;">
                <label for="vendaValorObs">Valor - Observa√ß√£o (Como foi o pagamento):</label>
                <input id="vendaValorObs" type="text" value="">
            </div>
        </div>
    </div>
    
    <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--cor-borda);">

    <h2>C√°lculo de Produtos</h2>
    <p class="small">Informe quantos produtos deseja fabricar/vender e escolha o tipo de valor.</p>

    <div class="grid">
      <div>
        <label for="qtyTickets">Quantidade de Tickets</label>
        <input id="qtyTickets" type="number" min="0" value="">
      </div>
      <div>
        <label for="qtyTablets">Quantidade de Tablets</label>
        <input id="qtyTablets" type="number" min="0" value="">
      </div>
      <div>
        <label for="qtyNitro">Quantidade de Nitro</label>
        <input id="qtyNitro" type="number" min="0" value="">
      </div>
      <div>
        <label for="tipoValor">Tipo de Valor</label>
        <select id="tipoValor">
          <option value="limpo">Dinheiro Limpo</option>
          <option value="sujo">Dinheiro Sujo</option>
          <option value="limpo_alianca">Limpo (Alian√ßa)</option>
          <option value="sujo_alianca">Sujo (Alian√ßa)</option>
        </select>
      </div>
    </div>

    <div class="actions">
      <button id="calcBtn" class="primary">Calcular</button>
      <button id="resetBtn" class="muted">Limpar Campos</button>
      <button id="registerBtn" class="success">Registrar Venda</button>
      <button id="toggleHistoryBtn" class="muted">Ver Hist√≥rico</button>
      <button id="csvBtn" class="muted">Exportar CSV</button>
      <button id="discordBtnCalc" class="muted">Discord</button> 
    </div>

    <div id="resultsContainer">
      <div id="results" style="margin-top:16px;display:none">
        <h3>Totais necess√°rios</h3>
        <table>
          <thead><tr><th>Material</th><th>Quantidade total</th></tr></thead>
          <tbody id="resultsBody"></tbody>
        </table>

        <h3>Valores Estimados</h3>
        <table>
          <thead><tr><th>Produto</th><th>Valor Total</th></tr></thead>
          <tbody id="valuesBody"></tbody>
          <tfoot>
            <tr><th>Total Geral</th><th id="valorTotalGeral">R$ 0</th></tr>
          </tfoot>
        </table>
        <p class="result-note" style="font-size: 12px; margin-top: 8px;">Os valores variam conforme o tipo selecionado (limpo, sujo, alian√ßa).</p>
      </div>
    </div>
  </div>

  <div class="card" id="historyCard" style="display:none">
      <div id="historyBackground" class="card">
        <h2>Hist√≥rico de Vendas Registradas</h2>
        <img id="historyImg" src="logo-dark.png" alt="Fundo Hist√≥rico"> 
        
        <input type="text" id="filtroHistorico" placeholder="üîç Pesquisar no hist√≥rico (Nome, Data, Item, etc.)" style="margin-bottom: 10px; width: 100%;">
        
        <div class="actions">
          <button id="clearHistoryBtn" class="muted">Limpar Hist√≥rico</button>
          <button id="toggleCalcBtn" class="muted">Voltar √† Calculadora</button>
        </div>
        <div class="history-table-wrapper"><table id="historicoVendas"> 
            <thead> 
                <tr> 
                    <th>Data/Hora</th> 
                    <th>Cliente</th> 
                    <th>Organiza√ß√£o/Tipo</th> 
                    <th>Telefone</th> 
                    <th>Produtos (Unidade)</th> 
                    <th>Valor Total</th> 
                    <th>Negociadoras</th> 
                    <th>A√ß√µes</th> 
                </tr> 
            </thead> 
            <tbody id="salesHistory"></tbody> 
        </table></div> 
      </div> 
  </div> 
  <div id="toast-container"></div> 
  <script> 
// --- FIREBASE CONFIGURA√á√ÉO (ADICIONADO E REQUER ATUALIZA√á√ÉO) --- 
const firebaseConfig = { 
    apiKey: "AIzaSyAhDVBfXoO_Rdi3e-trdbaaPppwDkTDgVc", 
    authDomain: "hells-angels-438c2.firebaseapp.com", 
    databaseURL: "https://hells-angels-438c2-default-rtdb.firebaseio.com", 
    projectId: "hells-angels-438c2", 
    storageBucket: "hells-angels-438c2.firebasestorage.app", 
    messagingSenderId: "429406215315", 
    appId: "1:429406215315:web:96b68b172247824b308166", 
    measurementId: "G-CR415MEY32" 
}; 
// Inicializar o Firebase 
firebase.initializeApp(firebaseConfig); 
const auth = firebase.auth(); 
// --- FIM FIREBASE CONFIGURA√á√ÉO --- 

// DOM√çNIO FICT√çCIO PARA MAPEAMENTO DE USU√ÅRIO 
const VIRTUAL_DOMAIN = '@ha-auth.local'; 

const perUnit = { 
    tickets: { moneyBruto: 525 }, 
    tablets: { cobre: 20, plastico: 40, fita_adesiva: 2, lixo_eletronico: 2 }, 
    nitro: { aluminio: 20, cobre: 20, vidro: 45, fita_adesiva: 1, porca: 1, parafuso: 1 } 
}; 

const valores = { 
    tablets: { limpo: 17000, sujo: 20000, limpo_alianca: 15000, sujo_alianca: 18000 }, 
    tickets: { limpo: 9800, sujo: 11700, limpo_alianca: 8000, sujo: 10000 }, 
    nitro: { limpo: 42500, sujo: 50000, limpo_alianca: 38000, sujo_alianca: 45000 } 
}; 

const valorDescricao = { 
    'limpo': 'Dinheiro Limpo', 
    'sujo': 'Dinheiro Sujo', 
    'limpo_alianca': 'Limpo (Alian√ßa)', 
    'sujo_alianca': 'Sujo (Alian√ßa)' 
}; 

// Usando 'logo-dark.png' como placeholder para todas as imagens 
const logoLightModeSrc = "logo-dark.png"; 
const logoDarkModeSrc = "logo-dark.png"; 
const historyBackgroundSrc = "logo-dark.png"; 

function showToast(message, type = 'default', duration = 3000) { 
    const container = document.getElementById('toast-container'); 
    if (!container) return; 
    const toast = document.createElement('div'); 
    toast.classList.add('toast'); 
    if (type) { 
        toast.classList.add(type); 
    } 
    toast.textContent = message; 
    container.appendChild(toast); 
    void toast.offsetWidth; 
    toast.classList.add('show'); 
    setTimeout(() => { 
        toast.classList.remove('show'); 
        setTimeout(() => { 
            toast.remove(); 
        }, 300); 
    }, duration); 
} 

let vendas = []; 
let vendaEmEdicaoId = null; 

function loadVendas() { 
    const json = localStorage.getItem('ha_vendas'); 
    if (json) { 
        vendas = JSON.parse(json); 
    } 
} 

function saveVendas() { 
    localStorage.setItem('ha_vendas', JSON.stringify(vendas)); 
} 

const els = { 
    // Campos do Login (ATUALIZADOS) 
    loginScreen: document.getElementById('loginScreen'), 
    loginForm: document.getElementById('loginForm'), 
    loginUsername: document.getElementById('loginUsername'), // ATUALIZADO 
    loginPassword: document.getElementById('loginPassword'), 
    loginBtn: document.getElementById('loginBtn'), 
    errorMessage: document.getElementById('errorMessage'), 
    logoutBtn: document.getElementById('logoutBtn'), 

    // NOVOS CAMPOS DE REGISTRO (ATUALIZADOS) 
    registrationForm: document.getElementById('registrationForm'), 
    regUsername: document.getElementById('regUsername'), // ATUALIZADO 
    regPassword: document.getElementById('regPassword'), 
    regConfirmPassword: document.getElementById('regConfirmPassword'), 
    regBtn: document.getElementById('regBtn'), 
    regErrorMessage: document.getElementById('regErrorMessage'), 
    toggleToReg: document.getElementById('toggleToReg'), 
    toggleToLogin: document.getElementById('toggleToLogin'), 
    authTitle: document.getElementById('authTitle'), 

    // Campos do C√°lculo 
    qtyTickets: document.getElementById('qtyTickets'), 
    qtyTablets: document.getElementById('qtyTablets'), 
    qtyNitro: document.getElementById('qtyNitro'), 
    tipoValor: document.getElementById('tipoValor'), 

    // Campos do Cliente/Venda 
    nomeCliente: document.getElementById('nomeCliente'), 
    dataVenda: document.getElementById('dataVenda'), 
    organizacaoTipo: document.getElementById('organizacaoTipo'), 
    organizacao: document.getElementById('organizacao'), 
    telefone: document.getElementById('telefone'), 
    negociadoras: document.getElementById('negociadoras'), 
    vendaValorObs: document.getElementById('vendaValorObs'), 

    // Bot√µes 
    calcBtn: document.getElementById('calcBtn'), 
    resetBtn: document.getElementById('resetBtn'), 
    csvBtn: document.getElementById('csvBtn'), 
    registerBtn: document.getElementById('registerBtn'), 
    discordBtnCalc: document.getElementById('discordBtnCalc'), 

    // Resultados e Hist√≥rico 
    results: document.getElementById('results'), 
    resultsBody: document.getElementById('resultsBody'), 
    valuesBody: document.getElementById('valuesBody'), 
    valorTotalGeral: document.getElementById('valorTotalGeral'), 
    salesHistory: document.getElementById('salesHistory'), 
    clearHistoryBtn: document.getElementById('clearHistoryBtn'), 
    filtroHistorico: document.getElementById('filtroHistorico'), 

    // Bot√µes de controle fixos 
    themeBtn: document.getElementById('themeBtn'), 
    tutorialBtn: document.getElementById('tutorialBtn'), 
    mainCard: document.getElementById('mainCard'), 
    historyCard: document.getElementById('historyCard'), 
    toggleHistoryBtn: document.getElementById('toggleHistoryBtn'), 
    toggleCalcBtn: document.getElementById('toggleCalcBtn'), 

    // Elemento da Logo 
    appLogo: document.getElementById('appLogo'), 
    logoLink: document.getElementById('logoLink'), 
}; 

// --- FUN√á√ïES DE VISUALIZA√á√ÉO E AUTHENTICA√á√ÉO (NOVAS/ADAPTADAS) --- 
function showLoginScreen() { 
    // Altera o estilo do body para centralizar o login 
    document.body.style.maxWidth = 'none'; 
    document.body.style.margin = '0'; 
    document.body.style.height = '100vh'; 
    document.body.style.display = 'flex'; 
    document.body.style.justifyContent = 'center'; 
    document.body.style.alignItems = 'center'; 
    els.loginScreen.style.display = 'flex'; 
    els.mainCard.style.display = 'none'; 
    els.historyCard.style.display = 'none'; 
    els.logoLink.style.display = 'none'; // Esconde a logo do app 
    els.tutorialBtn.style.display = 'none'; // Esconde o tutorial 
    els.logoutBtn.style.display = 'none'; // Esconde o bot√£o de sair 
    clearTour(); // Para o tour caso esteja ativo 
    toggleAuthView(false); // Garante que a tela de Login √© a primeira a aparecer 
} 

function showMainApp() { 
    // Restaura o estilo do body para o layout do app 
    document.body.style.maxWidth = '960px'; 
    document.body.style.margin = '24px auto'; 
    document.body.style.height = 'auto'; 
    document.body.style.display = 'block'; 
    document.body.style.justifyContent = 'initial'; 
    document.body.style.alignItems = 'initial'; 
    els.loginScreen.style.display = 'none'; 
    els.mainCard.style.display = 'block'; 
    els.historyCard.style.display = 'none'; 
    els.logoLink.style.display = 'block'; // Mostra a logo 
    els.tutorialBtn.style.display = 'block'; // Mostra o tutorial 
    els.logoutBtn.style.display = 'block'; // Mostra o bot√£o de sair 
    renderHistorico(); // Garante que o hist√≥rico est√° carregado 
} 

// Fun√ß√£o para alternar entre Login e Registro 
function toggleAuthView(showRegistration) { 
    if (showRegistration) { 
        els.loginForm.style.display = 'none'; 
        els.registrationForm.style.display = 'block'; 
        els.authTitle.textContent = 'Cria√ß√£o de Conta'; 
        els.errorMessage.textContent = ''; // Limpa erros de login 
    } else { 
        els.loginForm.style.display = 'block'; 
        els.registrationForm.style.display = 'none'; 
        els.authTitle.textContent = 'Acesso Restrito'; 
        els.regErrorMessage.textContent = ''; // Limpa erros de registro 
    } 
} 

// Fun√ß√£o de Login (ADAPTADA PARA USU√ÅRIO) 
function handleLogin(e) { 
    e.preventDefault(); 
    const username = els.loginUsername.value.trim(); 
    const password = els.loginPassword.value; 
    const virtualEmail = username + VIRTUAL_DOMAIN; // Mapeia para e-mail virtual 
    els.errorMessage.textContent = ''; 
    els.loginBtn.disabled = true; 
    auth.signInWithEmailAndPassword(virtualEmail, password) 
        .then((userCredential) => { 
            showToast(`Bem-vindo(a) ${username}!`, "success"); 
        }) 
        .catch((error) => { 
            els.loginBtn.disabled = false; // Reativa o bot√£o 
            let message = "Ocorreu um erro no login."; 
            switch (error.code) { 
                case 'auth/user-not-found': 
                case 'auth/wrong-password': 
                    message = "Usu√°rio ou senha incorretos."; // Mensagem gen√©rica para seguran√ßa 
                    break; 
                case 'auth/invalid-email': 
                    message = "Formato de usu√°rio inv√°lido."; 
                    break; 
                default: 
                    message = "Erro: " + error.message; 
                    break; 
            } 
            els.errorMessage.textContent = message; 
        }); 
} 

// Fun√ß√£o de Registro (ADAPTADA PARA USU√ÅRIO) 
function handleRegistration(e) { 
    e.preventDefault(); 
    const username = els.regUsername.value.trim(); 
    const password = els.regPassword.value; 
    const confirmPassword = els.regConfirmPassword.value; 
    const virtualEmail = username + VIRTUAL_DOMAIN; // Mapeia para e-mail virtual 
    els.regErrorMessage.textContent = ''; 
    els.regPassword.classList.remove('input-invalido'); 
    els.regConfirmPassword.classList.remove('input-invalido'); 

    if (username.length < 3) { 
        els.regErrorMessage.textContent = "O nome de usu√°rio deve ter no m√≠nimo 3 caracteres."; 
        els.regUsername.classList.add('input-invalido'); 
        return; 
    } 
    if (password !== confirmPassword) { 
        els.regErrorMessage.textContent = "As senhas n√£o coincidem."; 
        els.regPassword.classList.add('input-invalido'); 
        els.regConfirmPassword.classList.add('input-invalido'); 
        return; 
    } 
    if (password.length < 6) { 
        els.regErrorMessage.textContent = "A senha deve ter no m√≠nimo 6 caracteres."; 
        els.regPassword.classList.add('input-invalido'); 
        els.regConfirmPassword.classList.add('input-invalido'); 
        return; 
    } 

    els.regBtn.disabled = true; 
    auth.createUserWithEmailAndPassword(virtualEmail, password) 
        .then((userCredential) => { 
            showToast(`Conta do usu√°rio ${username} criada com sucesso! Voc√™ foi logado.`, "success", 5000); 
        }) 
        .catch((error) => { 
            els.regBtn.disabled = false; // Reativa o bot√£o 
            let message = "Ocorreu um erro no registro."; 
            switch (error.code) { 
                case 'auth/email-already-in-use': 
                    message = `O usu√°rio "${username}" j√° est√° em uso.`; 
                    break; 
                case 'auth/weak-password': 
                    message = "A senha √© muito fraca."; 
                    break; 
                default: 
                    message = "Erro: " + error.message; 
                    break; 
            } 
            els.regErrorMessage.textContent = message; 
        }); 
} 

// Observador de Estado de Autentica√ß√£o 
auth.onAuthStateChanged((user) => { 
    if (user) { 
        // Usu√°rio logado 
        showMainApp(); 
    } else { 
        // Usu√°rio deslogado 
        showLoginScreen(); 
    } 
}); 

// --- FIM FUN√á√ïES DE VISUALIZA√á√ÉO E AUTHENTICA√á√ÉO --- 

// --- L√ìGICA DO TEMA ESCURO (MANTIDA) --- 
function toggleTheme() { 
    const isDark = document.body.classList.contains('dark'); 
    if (isDark) { 
        document.body.classList.remove('dark'); 
        document.body.classList.add('light'); 
        els.themeBtn.textContent = 'üåô Modo Noturno'; 
        els.appLogo.src = logoLightModeSrc; 
        document.getElementById('historyImg').src = historyBackgroundSrc; 
        localStorage.setItem('ha_theme', 'light'); 
    } else { 
        document.body.classList.remove('light'); 
        document.body.classList.add('dark'); 
        els.themeBtn.textContent = '‚òÄÔ∏è Modo Diurno'; 
        els.appLogo.src = logoDarkModeSrc; 
        document.getElementById('historyImg').src = historyBackgroundSrc; 
        localStorage.setItem('ha_theme', 'dark'); 
    } 
} 

// --- L√ìGICA DO C√ÅLCULO (MANTIDA) --- 
function calcular() { 
    const qtyTickets = parseInt(els.qtyTickets.value) || 0; 
    const qtyTablets = parseInt(els.qtyTablets.value) || 0; 
    const qtyNitro = parseInt(els.qtyNitro.value) || 0; 
    const tipoValor = els.tipoValor.value; 

    // Resetar totais 
    let totals = {}; 
    let valorTotalGeral = 0; 
    let valuesHtml = ''; 
    let totalsHtml = ''; 

    // Calcular materiais 
    if (qtyTickets > 0) { 
        const material = perUnit.tickets; 
        for (const [key, value] of Object.entries(material)) { 
            totals[key] = (totals[key] || 0) + qtyTickets * value; 
        } 
    } 

    if (qtyTablets > 0) { 
        const material = perUnit.tablets; 
        for (const [key, value] of Object.entries(material)) { 
            totals[key] = (totals[key] || 0) + qtyTablets * value; 
        } 
    } 

    if (qtyNitro > 0) { 
        const material = perUnit.nitro; 
        for (const [key, value] of Object.entries(material)) { 
            totals[key] = (totals[key] || 0) + qtyNitro * value; 
        } 
    } 

    // Calcular valores e adicionar ao HTML 
    if (qtyTickets > 0) { 
        const valorUnitario = valores.tickets[tipoValor]; 
        const valorTotal = qtyTickets * valorUnitario; 
        valorTotalGeral += valorTotal; 
        valuesHtml += `<tr><td>Tickets (${qtyTickets} un)</td><td>R$ ${valorTotal.toLocaleString('pt-BR')}</td></tr>`; 
    } 
    if (qtyTablets > 0) { 
        const valorUnitario = valores.tablets[tipoValor]; 
        const valorTotal = qtyTablets * valorUnitario; 
        valorTotalGeral += valorTotal; 
        valuesHtml += `<tr><td>Tablets (${qtyTablets} un)</td><td>R$ ${valorTotal.toLocaleString('pt-BR')}</td></tr>`; 
    } 
    if (qtyNitro > 0) { 
        const valorUnitario = valores.nitro[tipoValor]; 
        const valorTotal = qtyNitro * valorUnitario; 
        valorTotalGeral += valorTotal; 
        valuesHtml += `<tr><td>Nitro (${qtyNitro} un)</td><td>R$ ${valorTotal.toLocaleString('pt-BR')}</td></tr>`; 
    } 

    // Adicionar materiais ao HTML 
    for (const [key, value] of Object.entries(totals)) { 
        totalsHtml += `<tr><td>${key.replace('_', ' ').toUpperCase()}</td><td>${value.toLocaleString('pt-BR')}</td></tr>`; 
    } 

    // Mostrar resultados se houver algo 
    if (totalsHtml || valuesHtml) { 
        els.results.style.display = 'block'; 
        els.resultsBody.innerHTML = totalsHtml; 
        els.valuesBody.innerHTML = valuesHtml; 
        els.valorTotalGeral.textContent = `R$ ${valorTotalGeral.toLocaleString('pt-BR')}`; 
    } else { 
        els.results.style.display = 'none'; 
        els.resultsBody.innerHTML = ''; 
        els.valuesBody.innerHTML = ''; 
        els.valorTotalGeral.textContent = 'R$ 0'; 
    } 
} 

function clearAllFields() { 
    els.qtyTickets.value = ''; 
    els.qtyTablets.value = ''; 
    els.qtyNitro.value = ''; 
    els.nomeCliente.value = ''; 
    els.organizacao.value = ''; 
    els.telefone.value = ''; 
    els.negociadoras.value = ''; 
    els.vendaValorObs.value = ''; 
    els.dataVenda.value = new Date().toLocaleDateString('pt-BR'); 
    els.results.style.display = 'none'; 

    // Remover classes de invalidez 
    document.querySelectorAll('.input-invalido').forEach(el => el.classList.remove('input-invalido')); 

    // Resetar edi√ß√£o 
    vendaEmEdicaoId = null; 
    els.registerBtn.textContent = 'Registrar Venda'; 
    els.registerBtn.classList.remove('muted'); 
    els.registerBtn.classList.add('success'); 

    // Recalcular para limpar resultados vis√≠veis 
    calcular(); 
} 

// --- L√ìGICA DO REGISTRO (MANTIDA) --- 

function validateFields() { 
    let isValid = true; 
    const requiredFields = [ 
        els.nomeCliente, els.organizacao, els.telefone, els.negociadoras 
    ]; 
    const hasProducts = parseInt(els.qtyTickets.value) > 0 || 
                        parseInt(els.qtyTablets.value) > 0 || 
                        parseInt(els.qtyNitro.value) > 0; 

    // Valida√ß√£o de produtos 
    if (!hasProducts) { 
        showToast("√â necess√°rio informar a quantidade de pelo menos um produto.", "error"); 
        // Adicionar uma indica√ß√£o visual nos campos de quantidade, se desejar 
        els.qtyTickets.classList.add('input-invalido'); 
        els.qtyTablets.classList.add('input-invalido'); 
        els.qtyNitro.classList.add('input-invalido'); 
        isValid = false; 
    } else { 
        els.qtyTickets.classList.remove('input-invalido'); 
        els.qtyTablets.classList.remove('input-invalido'); 
        els.qtyNitro.classList.remove('input-invalido'); 
    } 

    // Valida√ß√£o de campos de texto 
    requiredFields.forEach(field => { 
        if (!field.value.trim()) { 
            field.classList.add('input-invalido'); 
            isValid = false; 
        } else { 
            field.classList.remove('input-invalido'); 
        } 
    }); 

    if (!isValid) { 
        showToast("Preencha todos os campos obrigat√≥rios (marcados em vermelho) e adicione produtos.", "error", 4000); 
    } 

    return isValid; 
} 


function registerVenda() { 
    if (!validateFields()) { 
        return; 
    } 

    const qtyTickets = parseInt(els.qtyTickets.value) || 0; 
    const qtyTablets = parseInt(els.qtyTablets.value) || 0; 
    const qtyNitro = parseInt(els.qtyNitro.value) || 0; 
    const tipoValor = els.tipoValor.value; 

    // Calcular Valor Total (repetido de calcular, para garantir consist√™ncia) 
    let valorTotalGeral = 0; 
    let produtosVendidos = []; 

    if (qtyTickets > 0) { 
        const valorUnitario = valores.tickets[tipoValor]; 
        const valorTotal = qtyTickets * valorUnitario; 
        valorTotalGeral += valorTotal; 
        produtosVendidos.push(`${qtyTickets} Tickets`); 
    } 
    if (qtyTablets > 0) { 
        const valorUnitario = valores.tablets[tipoValor]; 
        const valorTotal = qtyTablets * valorUnitario; 
        valorTotalGeral += valorTotal; 
        produtosVendidos.push(`${qtyTablets} Tablets`); 
    } 
    if (qtyNitro > 0) { 
        const valorUnitario = valores.nitro[tipoValor]; 
        const valorTotal = qtyNitro * valorUnitario; 
        valorTotalGeral += valorTotal; 
        produtosVendidos.push(`${qtyNitro} Nitro`); 
    } 

    // Dados da venda 
    const venda = { 
        id: vendaEmEdicaoId || Date.now().toString(), 
        data: els.dataVenda.value, 
        hora: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }), 
        cliente: els.nomeCliente.value.trim(), 
        organizacao: els.organizacao.value.trim(), 
        organizacaoTipo: els.organizacaoTipo.value, 
        telefone: els.telefone.value, 
        negociadoras: els.negociadoras.value.trim(), 
        produtos: produtosVendidos.join(', '), 
        valorTotal: valorTotalGeral, 
        tipoValor: valorDescricao[tipoValor], 
        obsValor: els.vendaValorObs.value.trim() 
    }; 

    if (vendaEmEdicaoId) { 
        // Edi√ß√£o 
        const index = vendas.findIndex(v => v.id === vendaEmEdicaoId); 
        if (index > -1) { 
            vendas[index] = venda; 
            showToast("Venda editada com sucesso!", "success"); 
        } 
    } else { 
        // Novo registro 
        vendas.push(venda); 
        showToast("Venda registrada com sucesso!", "success"); 
    } 

    saveVendas(); 
    clearAllFields(); 
    renderHistorico(); 
} 

function deleteVenda(id) { 
    if (confirm("Tem certeza que deseja deletar este registro de venda?")) { 
        vendas = vendas.filter(v => v.id !== id); 
        saveVendas(); 
        renderHistorico(); 
        showToast("Venda deletada.", "error"); 
    } 
} 

function editVenda(id) { 
    const venda = vendas.find(v => v.id === id); 
    if (!venda) return; 

    // Alternar para a tela de c√°lculo/registro 
    toggleView(false); 

    // Preencher campos 
    vendaEmEdicaoId = id; 
    els.registerBtn.textContent = 'Salvar Edi√ß√£o'; 
    els.registerBtn.classList.remove('success'); 
    els.registerBtn.classList.add('muted'); 

    els.nomeCliente.value = venda.cliente; 
    els.dataVenda.value = venda.data; 
    els.organizacao.value = venda.organizacao; 
    els.organizacaoTipo.value = venda.organizacaoTipo; 
    els.telefone.value = venda.telefone; 
    els.negociadoras.value = venda.negociadoras; 
    els.vendaValorObs.value = venda.obsValor; 

    // Preencher produtos 
    // Isso √© complexo, pois precisamos reverter de 'X Produtos' para QTYs 
    // Aqui, vamos apenas zerar os QTYs e assumir que o usu√°rio ajustar√° manualmente, 
    // ou desenvolver uma l√≥gica mais robusta que o escopo atual n√£o cobre. 
    els.qtyTickets.value = ''; 
    els.qtyTablets.value = ''; 
    els.qtyNitro.value = ''; 

    // Limpar resultados antigos 
    els.results.style.display = 'none'; 
    showToast(`Carregando venda de ${venda.cliente} para edi√ß√£o. Ajuste os produtos se necess√°rio.`, "default", 3500); 
} 


function renderHistorico(filtro = '') { 
    els.salesHistory.innerHTML = ''; 
    const vendasFiltradas = vendas.filter(venda => { 
        if (!filtro) return true; 
        const search = filtro.toLowerCase(); 
        return Object.values(venda).some(value => 
            String(value).toLowerCase().includes(search) 
        ); 
    }).sort((a, b) => b.id - a.id); // Ordena da mais recente para a mais antiga (assumindo ID = timestamp) 

    if (vendasFiltradas.length === 0) { 
        els.salesHistory.innerHTML = '<tr><td colspan="8" style="text-align: center;">Nenhuma venda encontrada.</td></tr>'; 
        return; 
    } 

    vendasFiltradas.forEach(venda => { 
        const row = els.salesHistory.insertRow(); 

        row.insertCell().innerHTML = `<span class="history-datetime-line">${venda.data}</span><span class="history-datetime-line">${venda.hora}</span>`; 
        row.insertCell().textContent = venda.cliente; 
        row.insertCell().innerHTML = `${venda.organizacao}<br><span class="valor-obs-text">(${venda.organizacaoTipo})</span>`; 
        row.insertCell().textContent = venda.telefone; 
        row.insertCell().textContent = venda.produtos; 
        
        // Coluna Valor Total com Observa√ß√£o 
        const valorCell = row.insertCell(); 
        valorCell.classList.add('valor-total-cell'); 
        valorCell.innerHTML = `<span>R$ ${venda.valorTotal.toLocaleString('pt-BR')}</span>`; 
        if (venda.obsValor) { 
            valorCell.innerHTML += `<span class="valor-obs-text" title="${venda.obsValor}">${venda.obsValor}</span>`; 
        } 

        row.insertCell().textContent = venda.negociadoras; 

        // Coluna A√ß√µes 
        const actionsCell = row.insertCell(); 
        actionsCell.classList.add('history-actions-cell'); 
        
        const editBtn = document.createElement('button'); 
        editBtn.textContent = 'Editar'; 
        editBtn.className = 'muted action-btn'; 
        editBtn.onclick = () => editVenda(venda.id); 
        
        const deleteBtn = document.createElement('button'); 
        deleteBtn.textContent = 'Excluir'; 
        deleteBtn.className = 'primary action-btn'; 
        deleteBtn.style.background = '#cc0000'; // Vermelho para exclus√£o 
        deleteBtn.onclick = () => deleteVenda(venda.id); 

        actionsCell.appendChild(editBtn); 
        actionsCell.appendChild(deleteBtn); 
    }); 
} 

function exportToCSV() { 
    if (vendas.length === 0) { 
        showToast("N√£o h√° dados de vendas para exportar.", "error"); 
        return; 
    } 

    const headers = [ 
        "ID", "Data", "Hora", "Cliente", "Organiza√ß√£o", "Tipo Org.", "Telefone", 
        "Negociadoras", "Produtos", "Valor Total", "Tipo Valor", "Observa√ß√£o Valor" 
    ]; 

    const csvRows = []; 
    csvRows.push(headers.join(';')); 

    for (const venda of vendas) { 
        const values = [ 
            venda.id, 
            venda.data, 
            venda.hora, 
            venda.cliente.replace(/"/g, '""'), 
            venda.organizacao.replace(/"/g, '""'), 
            venda.organizacaoTipo, 
            venda.telefone, 
            venda.negociadoras.replace(/"/g, '""'), 
            venda.produtos.replace(/"/g, '""'), 
            venda.valorTotal, 
            venda.tipoValor, 
            venda.obsValor.replace(/"/g, '""') 
        ].map(String); 
        
        // Remove quebras de linha e substitui por espa√ßo no CSV para evitar quebras de linha no registro.
        const sanitizedValues = values.map(val => val.replace(/(\r\n|\n|\r)/gm, " "));

        csvRows.push(sanitizedValues.join(';')); 
    } 

    const csvString = csvRows.join('\n'); 
    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' }); 
    const link = document.createElement("a"); 
    link.href = URL.createObjectURL(blob); 
    link.download = `HellsAngels_Vendas_${new Date().toISOString().slice(0, 10)}.csv`; 
    link.click(); 

    showToast("Dados exportados para CSV!", "success"); 
} 

function toggleView(showHistory) { 
    if (showHistory) { 
        els.mainCard.style.display = 'none'; 
        els.historyCard.style.display = 'block'; 
        renderHistorico(els.filtroHistorico.value); 
    } else { 
        els.mainCard.style.display = 'block'; 
        els.historyCard.style.display = 'none'; 
    } 
} 

function copyToDiscordFormat() { 
    // Valida√ß√£o b√°sica 
    if (!els.nomeCliente.value.trim() || !els.organizacao.value.trim()) { 
        showToast("Preencha Nome e Organiza√ß√£o antes de copiar para o Discord.", "error"); 
        return; 
    } 

    const qtyTickets = parseInt(els.qtyTickets.value) || 0; 
    const qtyTablets = parseInt(els.qtyTablets.value) || 0; 
    const qtyNitro = parseInt(els.qtyNitro.value) || 0; 
    const tipoValor = els.tipoValor.value; 

    if (qtyTickets === 0 && qtyTablets === 0 && qtyNitro === 0) { 
        showToast("Selecione pelo menos um produto para copiar.", "error"); 
        return; 
    } 

    let valorTotalGeral = 0; 
    let produtosVendidos = []; 

    if (qtyTickets > 0) { 
        const valorUnitario = valores.tickets[tipoValor]; 
        const valorTotal = qtyTickets * valorUnitario; 
        valorTotalGeral += valorTotal; 
        produtosVendidos.push(`${qtyTickets} Tickets (R$ ${valorTotal.toLocaleString('pt-BR')})`); 
    } 
    if (qtyTablets > 0) { 
        const valorUnitario = valores.tablets[tipoValor]; 
        const valorTotal = qtyTablets * valorUnitario; 
        valorTotalGeral += valorTotal; 
        produtosVendidos.push(`${qtyTablets} Tablets (R$ ${valorTotal.toLocaleString('pt-BR')})`); 
    } 
    if (qtyNitro > 0) { 
        const valorUnitario = valores.nitro[tipoValor]; 
        const valorTotal = qtyNitro * valorUnitario; 
        valorTotalGeral += valorTotal; 
        produtosVendidos.push(`${qtyNitro} Nitro (R$ ${valorTotal.toLocaleString('pt-BR')})`); 
    } 

    const discordMessage = `**REGISTRO DE VENDA**\n` + 
                           `**Cliente:** ${els.nomeCliente.value.trim()}\n` + 
                           `**Organiza√ß√£o:** ${els.organizacao.value.trim()} (${els.organizacaoTipo.value})\n` + 
                           `**Telefone:** ${els.telefone.value}\n` + 
                           `**Negociadoras:** ${els.negociadoras.value.trim()}\n` + 
                           `**Produtos:**\n- ${produtosVendidos.join('\n- ')}\n` + 
                           `**TOTAL GERAL:** R$ ${valorTotalGeral.toLocaleString('pt-BR')}\n` + 
                           `**Tipo de Valor:** ${valorDescricao[tipoValor]}\n` + 
                           `**Obs. Pagamento:** ${els.vendaValorObs.value.trim() || 'N/A'}`; 
                           
    navigator.clipboard.writeText(discordMessage).then(() => { 
        showToast("Dados copiados para a √°rea de transfer√™ncia no formato Discord!", "success", 3500); 
    }).catch(err => { 
        showToast("Falha ao copiar: " + err, "error"); 
    }); 
} 

// --- L√ìGICA DO TUTORIAL (MANTIDA) --- 
let tourSteps = []; 
let currentStep = 0; 
let tooltipElement = null; 

function createTourSteps() { 
    tourSteps = [ 
        { 
            element: els.nomeCliente.parentElement, 
            title: "1/6 - Dados do Cliente", 
            text: "Comece preenchendo as informa√ß√µes b√°sicas da venda, como o nome do cliente, a organiza√ß√£o a que pertence, telefone e as negociadoras envolvidas." 
        }, 
        { 
            element: els.qtyTickets.parentElement, 
            title: "2/6 - Produtos e Quantidade", 
            text: "Insira as quantidades dos produtos que ser√£o fabricados/vendidos (Tickets, Tablets, Nitro)." 
        }, 
        { 
            element: els.tipoValor.parentElement, 
            title: "3/6 - Tipo de Valor", 
            text: "Selecione o tipo de valor a ser utilizado no c√°lculo (Limpo, Sujo, Alian√ßa). Isso afeta o c√°lculo final." 
        }, 
        { 
            element: els.calcBtn, 
            title: "4/6 - Calcular Totais", 
            text: "Clique em 'Calcular' para ver a lista de materiais necess√°rios para a fabrica√ß√£o e o valor total estimado da venda." 
        }, 
        { 
            element: els.registerBtn, 
            title: "5/6 - Registrar a Venda", 
            text: "Ap√≥s o c√°lculo e preenchimento dos dados do cliente, clique em 'Registrar Venda' para salvar o hist√≥rico no seu navegador." 
        }, 
        { 
            element: els.toggleHistoryBtn, 
            title: "6/6 - Hist√≥rico", 
            text: "Use este bot√£o para visualizar todas as vendas registradas e edit√°-las ou exclu√≠-las." 
        } 
    ]; 
} 

function startTour() { 
    createTourSteps(); 
    currentStep = 0; 
    showStep(currentStep); 
} 

function nextStep() { 
    if (currentStep < tourSteps.length - 1) { 
        currentStep++; 
        showStep(currentStep); 
    } else { 
        clearTour(); 
        showToast("Tutorial conclu√≠do! Voc√™ est√° pronto para come√ßar.", "success", 3000); 
    } 
} 

function prevStep() { 
    if (currentStep > 0) { 
        currentStep--; 
        showStep(currentStep); 
    } 
} 

function clearTour() { 
    if (tooltipElement) { 
        tooltipElement.classList.remove('active'); 
        setTimeout(() => tooltipElement.remove(), 300); 
        tooltipElement = null; 
    } 
    document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight')); 
} 

function showStep(index) { 
    clearTour(); 
    const step = tourSteps[index]; 
    if (!step || !step.element) return; 

    // 1. Destaque 
    step.element.classList.add('tour-highlight'); 

    // 2. Criar Tooltip 
    tooltipElement = document.createElement('div'); 
    tooltipElement.className = 'tour-tooltip'; 
    tooltipElement.innerHTML = `
        <h4>${step.title}</h4>
        <p>${step.text}</p>
        <div style="display:flex; justify-content: space-between;">
            <div>
                ${index > 0 ? `<button onclick="prevStep()">Voltar</button>` : ''}
                ${index < tourSteps.length - 1 ? `<button onclick="nextStep()">Avan√ßar</button>` : `<button onclick="clearTour()">Fechar</button>`}
            </div>
            <button onclick="clearTour()" style="background: none; color: white;">Pular Tutorial</button>
        </div>
    `; 

    document.body.appendChild(tooltipElement); 

    // 3. Posicionar Tooltip 
    const rect = step.element.getBoundingClientRect(); 
    const tooltipRect = tooltipElement.getBoundingClientRect(); 

    // Tenta posicionar abaixo e centralizado horizontalmente 
    let top = rect.bottom + 10 + window.scrollY; 
    let left = rect.left + (rect.width / 2) - (200); // 200 √© aprox metade do max-width 
    
    // Ajuste para n√£o sair da tela √† esquerda 
    if (left < 10) { 
        left = 10; 
    } 
    // Ajuste para n√£o sair da tela √† direita 
    if (left + 300 > window.innerWidth - 10) { 
        left = window.innerWidth - 310; 
    } 

    // Se n√£o houver espa√ßo suficiente abaixo, posiciona acima 
    if (top + tooltipRect.height > window.innerHeight + window.scrollY) { 
        top = rect.top - tooltipRect.height - 10 + window.scrollY; 
    } 

    tooltipElement.style.top = `${top}px`; 
    tooltipElement.style.left = `${left}px`; 

    // 4. Mostrar 
    void tooltipElement.offsetWidth; // For√ßa reflow 
    tooltipElement.classList.add('active'); 

    // Rola para o elemento, se necess√°rio 
    step.element.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
} 

// --- FUN√á√ïES DE DATA E FORMATA√á√ÉO (MANTIDA) --- 
function updateDate() { 
    els.dataVenda.value = new Date().toLocaleDateString('pt-BR'); 
} 

// --- FUN√á√ÉO DE FORMATA√á√ÉO DE TELEFONE (ATUALIZADA) ---
function formatPhone(value) {
    // 1. Remove todos os caracteres n√£o-d√≠gitos
    let digits = value.replace(/\D/g, '');
    
    // 2. Limita a 6 d√≠gitos (para o formato XXX-XXX ap√≥s (055))
    digits = digits.substring(0, 6); 
    
    // 3. Aplica a m√°scara: (055) XXX-XXX (13 caracteres)
    let formatted = '(055)';
    
    // Adiciona o primeiro grupo de 3 d√≠gitos
    if (digits.length > 0) {
        formatted += ' ' + digits.substring(0, 3);
    }
    
    // Adiciona o tra√ßo e o segundo grupo de 3 d√≠gitos
    if (digits.length > 3) {
        formatted += '-' + digits.substring(3, 6);
    }

    return formatted;
}


// --- LISTENERS DE EVENTOS (MANTIDOS E ADAPTADOS) --- 

// Listener de Login e Registro 
els.loginForm.addEventListener('submit', handleLogin); 
els.registrationForm.addEventListener('submit', handleRegistration); 
els.toggleToReg.addEventListener('click', (e) => { e.preventDefault(); toggleAuthView(true); }); 
els.toggleToLogin.addEventListener('click', (e) => { e.preventDefault(); toggleAuthView(false); }); 

// Listener de Logout 
els.logoutBtn.addEventListener('click', () => { 
    auth.signOut().then(() => { 
        showToast("Deslogado com sucesso.", "default"); 
    }).catch((error) => { 
        showToast("Erro ao deslogar: " + error.message, "error"); 
    }); 
}); 

// Listener do Bot√£o de Tema 
els.themeBtn.addEventListener('click', toggleTheme); 

// Listener do Filtro de Hist√≥rico 
els.filtroHistorico.addEventListener('input', (e) => { 
    renderHistorico(e.target.value); 
}); 

// Listener do Bot√£o de C√°lculo/Registro 
els.calcBtn.addEventListener('click', calcular); 
els.resetBtn.addEventListener('click', clearAllFields); 
els.registerBtn.addEventListener('click', registerVenda); 
els.csvBtn.addEventListener('click', exportToCSV); 
els.discordBtnCalc.addEventListener('click', copyToDiscordFormat); 

// Listener do Bot√£o de Hist√≥rico/Calculadora 
els.toggleHistoryBtn.addEventListener('click', () => toggleView(true)); 
els.toggleCalcBtn.addEventListener('click', () => { 
    toggleView(false); 
    els.filtroHistorico.value = ''; // Limpa filtro ao voltar 
}); 

// Listener do Bot√£o de Limpar Hist√≥rico 
els.clearHistoryBtn.addEventListener('click', () => { 
    if (confirm("ATEN√á√ÉO: Isso ir√° deletar permanentemente TODO o hist√≥rico de vendas. Tem certeza?")) { 
        vendas = []; 
        saveVendas(); 
        renderHistorico(); 
        showToast("Hist√≥rico de vendas completamente limpo.", "error", 4000); 
    } 
}); 

// Listener de atualiza√ß√£o de c√°lculo em tempo real 
document.querySelectorAll('#qtyTickets, #qtyTablets, #qtyNitro, #tipoValor').forEach(input => { 
    input.addEventListener('input', calcular); 
}); 

// Listener de tutorial 
els.tutorialBtn.addEventListener('click', startTour); 

// Listener da Logo Superior (Voltar para calculadora e cancelar edi√ß√£o) 
els.logoLink.addEventListener('click', (e) => { 
    e.preventDefault(); 

    if (vendaEmEdicaoId) { 
        vendaEmEdicaoId = null; 
        els.registerBtn.textContent = 'Registrar Venda'; 
        clearAllFields(); 
        showToast("Edi√ß√£o pendente cancelada.", "error", 2000); 
    } 
    
    toggleView(false); 
    clearTour(); 
}); 

// Listener para formata√ß√£o de telefone
els.telefone.addEventListener('input', (e) => {
    e.target.value = formatPhone(e.target.value);
});

// --- Chamadas Iniciais --- 
loadVendas(); 

// Aplica o tema salvo (mantido) 
const savedTheme = localStorage.getItem('ha_theme'); 
if (savedTheme) { 
    document.body.classList.remove('light', 'dark'); 
    document.body.classList.add(savedTheme); 
    if (savedTheme === 'dark') { 
        els.themeBtn.textContent = '‚òÄÔ∏è Modo Diurno'; 
        els.appLogo.src = logoDarkModeSrc; 
        document.getElementById('historyImg').src = historyBackgroundSrc; 
    } else { 
        els.themeBtn.textContent = 'üåô Modo Noturno'; 
        els.appLogo.src = logoLightModeSrc; 
        document.getElementById('historyImg').src = historyBackgroundSrc; 
    } 
} else { 
    document.body.classList.add('light'); 
    els.appLogo.src = logoLightModeSrc; 
    document.getElementById('historyImg').src = historyBackgroundSrc; 
} 

updateDate(); 
</script>
</body>
</html>
