<script type="module">
    // ------------------------------------
    // 1. IMPORTA√á√ïES E CONFIGURA√á√ÉO FIREBASE
    // ------------------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, set, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAhDVBfXoO_Rdi3e-trdbaaPppwDkTDgVc",
        authDomain: "hells-angels-438c2.firebaseapp.com",
        databaseURL: "https://hells-angels-438c2-default-rtdb.firebaseio.com/",
        projectId: "hells-angels-438c2",
        storageBucket: "hells-angels-438c2.firebasestorage.app",
        messagingSenderId: "429406215315",
        appId: "1:429406215315:web:96b68b172247824b308166",
        measurementId: "G-CR415MEY32"
    };

    // --- [CRITICAL SECURITY NOTE] ---
    // Your Firebase configuration is visible on the client-side. This is normal,
    // but it means you MUST secure your Realtime Database. Without security rules,
    // anyone can read, write, or delete your entire database.
    //
    // Go to your Firebase Console -> Realtime Database -> Rules and paste the
    // following rules to ensure only logged-in users can access the data:
    //
    // {
    //   "rules": {
    //     "vendas": {
    //       ".read": "auth != null",
    //       ".write": "auth != null",
    //       "$vendaId": {
    //         ".validate": "newData.hasChildren(['nomeCliente', 'dataVenda', 'produtos', 'valorTotal', 'registradoPor'])"
    //       }
    //     }
    //   }
    // }
    //
    // This is a basic rule set. You can make it more complex if needed.
    // DO NOT SKIP THIS STEP!
    // ---------------------------------

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // ------------------------------------
    // 2. CONSTANTES E ESTADO GLOBAL
    // ------------------------------------
    let vendas = [];
    let vendaEmEdicaoId = null;
    let currentUser = null;

    const PER_UNIT = {
        tickets: { moneyBruto: 525 },
        tablets: { cobre: 20, plastico: 40, fita_adesiva: 2, lixo_eletronico: 2 },
        nitro: { aluminio: 20, cobre: 20, vidro: 45, fita_adesiva: 1, porca: 1, parafuso: 1 }
    };

    const VALORES = {
        tablets: { limpo: 17000, sujo: 20000, limpo_alianca: 15000, sujo_alianca: 18000 },
        tickets: { limpo: 9800, sujo: 11700, limpo_alianca: 8000, sujo_alianca: 10000 },
        nitro: { limpo: 42500, sujo: 50000, limpo_alianca: 38000, sujo_alianca: 45000 }
    };

    const VALOR_DESCRICAO = {
        'limpo': 'Dinheiro Limpo',
        'sujo': 'Dinheiro Sujo',
        'limpo_alianca': 'Limpo (Alian√ßa)',
        'sujo_alianca': 'Sujo (Alian√ßa)'
    };
    
    // Usando 'logo-dark.png' como placeholder
    const LOGO_SRC = "logo-dark.png";

    // Mapeamento de elementos DOM
    const els = {
        body: document.body,
        qtyTickets: document.getElementById('qtyTickets'),
        qtyTablets: document.getElementById('qtyTablets'),
        qtyNitro: document.getElementById('qtyNitro'),
        tipoValor: document.getElementById('tipoValor'),
        nomeCliente: document.getElementById('nomeCliente'),
        organizacao: document.getElementById('organizacao'),
        organizacaoTipo: document.getElementById('organizacaoTipo'),
        telefone: document.getElementById('telefone'),
        negociadoras: document.getElementById('negociadoras'),
        vendaValorObs: document.getElementById('vendaValorObs'),
        dataVenda: document.getElementById('dataVenda'),
        filtroHistorico: document.getElementById('filtroHistorico'),
        resultsBody: document.getElementById('resultsBody'),
        valuesBody: document.getElementById('valuesBody'),
        valorTotalGeral: document.getElementById('valorTotalGeral'),
        results: document.getElementById('results'),
        mainCard: document.getElementById('mainCard'),
        historyCard: document.getElementById('historyCard'),
        salesHistory: document.getElementById('salesHistory'),
        calcBtn: document.getElementById('calcBtn'),
        resetBtn: document.getElementById('resetBtn'),
        registerBtn: document.getElementById('registerBtn'),
        cancelEditBtn: document.getElementById('cancelEditBtn'),
        toggleHistoryBtn: document.getElementById('toggleHistoryBtn'),
        toggleCalcBtn: document.getElementById('toggleCalcBtn'),
        clearHistoryBtn: document.getElementById('clearHistoryBtn'),
        csvBtn: document.getElementById('csvBtn'),
        discordBtnCalc: document.getElementById('discordBtnCalc'),
        themeBtn: document.getElementById('themeBtn'),
        tutorialBtn: document.getElementById('tutorialBtn'),
        logoLink: document.getElementById('logoLink'),
        appLogo: document.getElementById('appLogo'),
        historyImg: document.getElementById('historyImg'),
        welcomeScreen: document.getElementById('welcomeScreen'),
        enterBtn: document.getElementById('enterBtn'),
        welcomeLogo: document.getElementById('welcomeLogo'),
        authScreen: document.getElementById('authScreen'),
        authTitle: document.getElementById('authTitle'),
        username: document.getElementById('username'),
        password: document.getElementById('password'),
        authActionBtn: document.getElementById('authActionBtn'),
        authToggleBtn: document.getElementById('authToggleBtn'),
        authMessage: document.getElementById('authMessage'),
        logoutBtn: document.getElementById('logoutBtn')
    };

    // ------------------------------------
    // 3. FUN√á√ïES DE UTILIDADE E FORMATO
    // ------------------------------------

    const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 0, maximumFractionDigits: 0 });
    const capitalizeText = (text) => text ? text.trim().toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ') : '';
    const getQty = (element) => Math.max(0, parseInt(element.value, 10) || 0);

    const showToast = (message, type = 'default', duration = 3000) => {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => toast.remove());
        }, duration);
    };

    const phoneMask = (value) => {
        const PREFIX = "(055) ";
        let digits = value.replace(/\D/g, "");
        if (digits.startsWith("055")) digits = digits.substring(3);
        digits = digits.substring(0, 6);
        let formatted = digits.length > 3 ? `${digits.substring(0, 3)}-${digits.substring(3)}` : digits;
        return PREFIX + formatted;
    };

    const updateDataVenda = () => {
        els.dataVenda.value = new Date().toLocaleDateString('pt-BR');
    };

    // ------------------------------------
    // 4. L√ìGICA DE C√ÅLCULO
    // ------------------------------------
    const calculate = () => {
        const qtyTickets = getQty(els.qtyTickets);
        const qtyTablets = getQty(els.qtyTablets);
        const qtyNitro = getQty(els.qtyNitro);
        const tipoValor = els.tipoValor.value;
        
        if (qtyTickets === 0 && qtyTablets === 0 && qtyNitro === 0) {
            els.results.style.display = 'none';
            return;
        }

        const totals = {
            cobre: qtyTablets * PER_UNIT.tablets.cobre + qtyNitro * PER_UNIT.nitro.cobre,
            plastico: qtyTablets * PER_UNIT.tablets.plastico,
            fita_adesiva: qtyTablets * PER_UNIT.tablets.fita_adesiva + qtyNitro * PER_UNIT.nitro.fita_adesiva,
            lixo_eletronico: qtyTablets * PER_UNIT.tablets.lixo_eletronico,
            aluminio: qtyNitro * PER_UNIT.nitro.aluminio,
            vidro: qtyNitro * PER_UNIT.nitro.vidro,
            porca: qtyNitro * PER_UNIT.nitro.porca,
            parafuso: qtyNitro * PER_UNIT.nitro.parafuso,
            moneyBruto: qtyTickets * PER_UNIT.tickets.moneyBruto
        };

        const values = {
            tickets: qtyTickets * VALORES.tickets[tipoValor],
            tablets: qtyTablets * VALORES.tablets[tipoValor],
            nitro: qtyNitro * VALORES.nitro[tipoValor]
        };
        const totalGeral = values.tickets + values.tablets + values.nitro;

        els.resultsBody.innerHTML = Object.entries(totals)
            .filter(([, amount]) => amount > 0)
            .map(([material, amount]) => `<tr><td>${capitalizeText(material.replace('_', ' '))}</td><td>${amount.toLocaleString('pt-BR')}</td></tr>`)
            .join('');
        
        els.valuesBody.innerHTML = Object.entries(values)
            .filter(([, value]) => value > 0)
            .map(([product, value]) => `<tr><td>${capitalizeText(product)} (${VALOR_DESCRICAO[tipoValor]})</td><td>${formatCurrency(value)}</td></tr>`)
            .join('');
        
        els.valorTotalGeral.textContent = formatCurrency(totalGeral);
        els.results.style.display = 'block';
    };

    // ------------------------------------
    // 5. FUN√á√ïES DE PERSIST√äNCIA (FIREBASE)
    // ------------------------------------
    const getVendaData = () => {
        const qtyTickets = getQty(els.qtyTickets);
        const qtyTablets = getQty(els.qtyTablets);
        const qtyNitro = getQty(els.qtyNitro);

        if (qtyTickets + qtyTablets + qtyNitro === 0) {
            showToast("Nenhum produto selecionado para registro.", "error");
            return null;
        }

        const essentialFields = [els.nomeCliente, els.organizacao];
        let isValid = true;
        essentialFields.forEach(field => {
            field.classList.remove('input-invalido');
            if (!field.value.trim()) {
                field.classList.add('input-invalido');
                isValid = false;
            }
        });

        if (!isValid) {
            showToast("Preencha o Nome e a Organiza√ß√£o antes de registrar.", "error");
            return null;
        }

        calculate();
        const valorTotalNumeric = parseFloat(els.valorTotalGeral.textContent.replace(/[^0-9,-]+/g, "").replace(',', '.'));
        
        const produtos = [];
        if (qtyTickets > 0) produtos.push(`Tickets (${qtyTickets})`);
        if (qtyTablets > 0) produtos.push(`Tablets (${qtyTablets})`);
        if (qtyNitro > 0) produtos.push(`Nitro (${qtyNitro})`);
        
        return {
            nomeCliente: capitalizeText(els.nomeCliente.value) || "N√£o Informado",
            organizacao: capitalizeText(els.organizacao.value),
            organizacaoTipo: els.organizacaoTipo.value,
            telefone: els.telefone.value,
            negociadoras: capitalizeText(els.negociadoras.value) || (currentUser?.displayName || "N√£o Informado"),
            vendaValorObs: capitalizeText(els.vendaValorObs.value) || "S/ Obs",
            dataVenda: new Date().toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' }),
            produtos: produtos.join(', '),
            valorTotal: valorTotalNumeric,
            tipoValor: VALOR_DESCRICAO[els.tipoValor.value],
            registradoPor: currentUser?.displayName || "Desconhecido"
        };
    };

    const registerVenda = async () => {
        const data = getVendaData();
        if (!data) return;

        setLoading(true, els.registerBtn);
        try {
            if (vendaEmEdicaoId) {
                await set(ref(db, 'vendas/' + vendaEmEdicaoId), data);
                showToast("Venda atualizada com sucesso!", "success");
            } else {
                await push(ref(db, 'vendas'), data);
                showToast("Venda registrada com sucesso!", "success");
            }
            clearAllFields();
        } catch (error) {
            console.error("Erro ao registrar/atualizar venda:", error);
            showToast(`Erro ao salvar: ${error.message}`, "error");
        } finally {
            setLoading(false, els.registerBtn);
        }
    };

    const loadHistory = () => {
        onValue(ref(db, 'vendas'), (snapshot) => {
            vendas = [];
            if (snapshot.exists()) {
                snapshot.forEach((child) => vendas.push({ id: child.key, ...child.val() }));
            }
            vendas.reverse();
            filterHistory();
        }, (error) => {
            console.error("Erro ao carregar hist√≥rico:", error);
            showToast(`Erro ao carregar hist√≥rico: ${error.message}`, "error");
        });
    };
    
    const deleteVenda = async (id) => {
        if (!confirm('Tem certeza que deseja excluir esta venda?')) return;
        
        try {
            await remove(ref(db, 'vendas/' + id));
            showToast("Venda exclu√≠da com sucesso!", "default");
            if (vendaEmEdicaoId === id) clearAllFields();
        } catch (error) {
            console.error("Erro ao excluir venda:", error);
            showToast(`Erro ao excluir: ${error.message}`, "error");
        }
    };
    
    const clearHistory = async () => {
        if (!confirm('Tem certeza que deseja APAGAR TODO o hist√≥rico de vendas? Esta a√ß√£o √© irrevers√≠vel.')) return;

        try {
            await remove(ref(db, 'vendas'));
            showToast("Todo o hist√≥rico de vendas foi apagado.", "success");
        } catch (error) {
            console.error("Erro ao limpar hist√≥rico:", error);
            showToast(`Erro ao limpar hist√≥rico: ${error.message}`, "error");
        }
    };

    // ------------------------------------
    // 6. AUTENTICA√á√ÉO
    // ------------------------------------
    const handleAuthAction = async () => {
        const username = els.username.value.trim();
        const password = els.password.value.trim();
        const isRegisterMode = els.authActionBtn.textContent.includes('Cadastrar');

        if (!username || !password) {
            els.authMessage.textContent = 'Preencha o nome de usu√°rio e a senha.';
            return;
        }
        if (isRegisterMode && password.length < 6) {
            els.authMessage.textContent = 'A senha deve ter no m√≠nimo 6 caracteres.';
            return;
        }

        const email = `${username}@hells.com`;
        setLoading(true, els.authActionBtn, els.authToggleBtn);
        els.authMessage.textContent = '';

        try {
            if (isRegisterMode) {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: username });
                showToast(`Usu√°rio ${username} registrado! Fa√ßa o login.`, "success");
                toggleAuthMode(false); // Switch back to login mode
            } else {
                await signInWithEmailAndPassword(auth, email, password);
                // Success is handled by onAuthStateChanged
            }
        } catch (error) {
            const errorMessages = {
                'auth/invalid-credential': "Nome de usu√°rio ou senha incorretos.",
                'auth/user-not-found': "Usu√°rio n√£o encontrado.",
                'auth/wrong-password': "Senha incorreta.",
                'auth/email-already-in-use': "Este nome de usu√°rio j√° est√° em uso.",
                'auth/weak-password': "A senha deve ter pelo menos 6 caracteres."
            };
            els.authMessage.textContent = errorMessages[error.code] || "Ocorreu um erro. Tente novamente.";
            console.error("Auth Error:", error);
        } finally {
            setLoading(false, els.authActionBtn, els.authToggleBtn);
        }
    };

    const handleLogout = async () => {
        try {
            await signOut(auth);
            showToast("Voc√™ saiu com sucesso.", "default");
            vendas = []; // Clear local data on logout
            filterHistory();
        } catch (error) {
            console.error("Logout Error:", error);
            showToast(`Erro ao sair: ${error.message}`, "error");
        }
    };
    
    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        if (user) {
            if (!user.displayName) {
                const usernameFromEmail = user.email.split('@')[0];
                updateProfile(user, { displayName: usernameFromEmail });
                currentUser.displayName = usernameFromEmail;
            }
            loadHistory();
            els.authScreen.style.display = 'none';
            els.mainCard.style.display = 'block';
            els.historyCard.style.display = 'none';
        } else {
            els.authScreen.style.display = 'block';
            els.mainCard.style.display = 'none';
            els.historyCard.style.display = 'none';
        }
        clearTour();
    });

    const toggleAuthMode = (isRegister) => {
        if (isRegister) {
            els.authTitle.textContent = 'Cadastro de Usu√°rio';
            els.authActionBtn.textContent = 'Confirmar Cadastro';
            els.authToggleBtn.textContent = 'Voltar para Login';
            els.authMessage.textContent = 'Preencha os campos para se cadastrar.';
        } else {
            els.authTitle.textContent = 'Autentica√ß√£o de Usu√°rio';
            els.authActionBtn.textContent = 'Entrar';
            els.authToggleBtn.textContent = 'Cadastrar';
            els.authMessage.textContent = '';
        }
    };
    
    // ------------------------------------
    // 7. FUN√á√ïES DE UI E MANIPULA√á√ÉO DO DOM
    // ------------------------------------
    const setLoading = (isLoading, ...buttons) => {
        buttons.forEach(btn => {
            if (btn) btn.disabled = isLoading;
        });
    };

    const clearAllFields = () => {
        const fieldsToClear = [els.qtyTickets, els.qtyTablets, els.qtyNitro, els.nomeCliente, els.organizacao, els.telefone, els.negociadoras, els.vendaValorObs];
        fieldsToClear.forEach(field => field.value = '');
        
        const fieldsToRemoveError = [els.nomeCliente, els.organizacao];
        fieldsToRemoveError.forEach(field => field.classList.remove('input-invalido'));

        els.tipoValor.value = 'limpo';
        els.results.style.display = 'none';
        els.valorTotalGeral.textContent = 'R$ 0';
        
        // Reset edit mode
        vendaEmEdicaoId = null;
        els.registerBtn.textContent = 'Registrar Venda';
        els.cancelEditBtn.style.display = 'none';
        els.resetBtn.style.display = 'inline-flex';
        
        updateDataVenda();
    };
    
    const toggleView = (showHistory) => {
        els.mainCard.style.display = showHistory ? 'none' : 'block';
        els.historyCard.style.display = showHistory ? 'block' : 'none';
        els.appLogo.src = LOGO_SRC;
        if (showHistory) {
            els.filtroHistorico.value = '';
            filterHistory();
        }
    };

    const exportCSV = () => {
        if (vendas.length === 0) return showToast("N√£o h√° vendas para exportar.", "error");

        const headers = ["ID", "Data/Hora", "Registrado Por", "Cliente", "Organiza√ß√£o", "Tipo", "Telefone", "Negociadoras", "Produtos", "Valor Total (R$)", "Tipo Valor", "Observa√ß√£o"];
        const rows = vendas.map(v => [
            v.id, v.dataVenda, v.registradoPor, v.nomeCliente, v.organizacao, v.organizacaoTipo, v.telefone, v.negociadoras,
            `"${v.produtos.replace(/"/g, '""')}"`, v.valorTotal, v.tipoValor, `"${v.vendaValorObs.replace(/"/g, '""')}"`
        ].join(','));

        const csvContent = "data:text/csv;charset=utf-8," + [headers.join(','), ...rows].join('\n');
        const link = document.createElement("a");
        link.setAttribute("href", encodeURI(csvContent));
        link.setAttribute("download", `historico_hells_angels_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.csv`);
        link.click();
        link.remove();
        showToast("Hist√≥rico exportado para CSV!", "success");
    };
    
    const exportDiscord = () => {
        const data = getVendaData();
        if (!data) return;

        const produtosLista = data.produtos.split(', ').map(p => `‚Ä¢ ${p}`).join('\n');
        const discordMessage = `
**[ VENDA REGISTRADA ]**
**Registrado Por:** ${data.registradoPor}
**Data:** ${data.dataVenda}

**--- DADOS DO CLIENTE ---**
**Nome:** ${data.nomeCliente}
**Organiza√ß√£o/Op√ß√£o:** ${data.organizacao} (${data.organizacaoTipo})
**Telefone:** ${data.telefone}

**--- PRODUTOS & VALOR ---**
**Produtos:**
${produtosLista}
**Tipo de Valor:** ${data.tipoValor}
**Valor Total:** ${formatCurrency(data.valorTotal)}

**--- INFORMA√á√ïES ADICIONAIS ---**
**Negociadoras:** ${data.negociadoras}
**Pagamento/Observa√ß√£o:** ${data.vendaValorObs}
        `.trim();
        
        navigator.clipboard.writeText(discordMessage)
            .then(() => showToast("Mensagem Discord copiada!", "success"))
            .catch(err => {
                console.error('Erro ao copiar:', err);
                showToast("Erro ao copiar.", "error");
            });
    };
    
    const createHistoryRowHTML = (venda) => {
        const [data, hora = ''] = venda.dataVenda.split(', ');
        const valorObsText = venda.vendaValorObs.length > 15 ? venda.vendaValorObs.substring(0, 12) + '...' : venda.vendaValorObs;

        return `
            <tr id="venda-${venda.id}">
                <td><span class="history-datetime-line">${data}</span><span class="history-datetime-line">${hora}</span></td>
                <td>${venda.nomeCliente}</td>
                <td>${venda.organizacao} (${venda.organizacaoTipo})</td>
                <td>${venda.telefone}</td>
                <td title="${venda.produtos}">${venda.produtos}</td>
                <td class="valor-total-cell" title="${venda.vendaValorObs}">
                    <span>${formatCurrency(venda.valorTotal)}</span>
                    <span class="valor-obs-text">(${valorObsText})</span>
                </td>
                <td>${venda.negociadoras}</td>
                <td>${venda.registradoPor}</td>
                <td class="history-actions-cell">
                    <button data-action="edit" data-id="${venda.id}" class="muted action-btn">Editar</button>
                    <button data-action="delete" data-id="${venda.id}" class="danger action-btn">Excluir</button>
                </td>
            </tr>`;
    };
    
    const filterHistory = () => {
        const filterText = els.filtroHistorico.value.toLowerCase();
        const filteredVendas = vendas.filter(v => 
            `${v.nomeCliente} ${v.organizacao} ${v.produtos} ${v.dataVenda} ${v.negociadoras} ${v.vendaValorObs}`.toLowerCase().includes(filterText)
        );
        
        if (filteredVendas.length > 0) {
            els.salesHistory.innerHTML = filteredVendas.map(createHistoryRowHTML).join('');
        } else {
            const message = vendas.length === 0 
                ? "Nenhuma venda registrada ainda." 
                : `Nenhum resultado encontrado para "${els.filtroHistorico.value}".`;
            els.salesHistory.innerHTML = `<tr><td colspan="9" style="text-align:center; padding: 20px;">${message}</td></tr>`;
        }
    };
    
    const editVenda = (id) => {
        const venda = vendas.find(v => v.id === id);
        if (!venda) return;
        
        toggleView(false);
        
        els.nomeCliente.value = venda.nomeCliente;
        els.organizacao.value = venda.organizacao;
        els.organizacaoTipo.value = venda.organizacaoTipo;
        els.telefone.value = venda.telefone;
        els.negociadoras.value = venda.negociadoras;
        els.vendaValorObs.value = venda.vendaValorObs;

        const ticketsMatch = venda.produtos.match(/Tickets \((\d+)\)/);
        const tabletsMatch = venda.produtos.match(/Tablets \((\d+)\)/);
        const nitroMatch = venda.produtos.match(/Nitro \((\d+)\)/);
        
        els.qtyTickets.value = ticketsMatch ? ticketsMatch[1] : '';
        els.qtyTablets.value = tabletsMatch ? tabletsMatch[1] : '';
        els.qtyNitro.value = nitroMatch ? nitroMatch[1] : '';
        
        const tipoKey = Object.keys(VALOR_DESCRICAO).find(key => VALOR_DESCRICAO[key] === venda.tipoValor);
        els.tipoValor.value = tipoKey || 'limpo';
        
        vendaEmEdicaoId = id;
        els.registerBtn.textContent = 'Salvar Edi√ß√£o';
        els.cancelEditBtn.style.display = 'inline-flex';
        els.resetBtn.style.display = 'none';
        
        calculate();
        showToast(`Editando venda de ${venda.nomeCliente}.`, "default");
        window.scrollTo(0, 0);
    };

    // ------------------------------------
    // 8. L√ìGICA DO TUTORIAL
    // ------------------------------------
    let currentTourStep = 0;
    const tourSteps = [
        { element: els.nomeCliente, title: "1/7: Dados do Cliente", content: "Comece preenchendo o nome do cliente. Lembre-se, a capitaliza√ß√£o √© autom√°tica!" },
        { element: els.organizacao, title: "2/7: Organiza√ß√£o e Telefone", content: "Informe a organiza√ß√£o e o telefone. A m√°scara (055) XXX-XXX √© aplicada automaticamente." },
        { element: els.qtyTickets, title: "3/7: Quantidade de Produtos", content: "Preencha a quantidade de Tickets, Tablets ou Nitro." },
        { element: els.tipoValor, title: "4/7: Tipo de Valor", content: "Escolha o tipo de dinheiro e se a venda √© para uma Alian√ßa." },
        { element: els.calcBtn, title: "5/7: Calcular e Registrar", content: "Use 'Calcular' para ver os totais. Depois, use 'Registrar Venda' para salvar." },
        { element: els.toggleHistoryBtn, title: "6/7: Hist√≥rico de Vendas", content: "Acesse todas as vendas salvas. Voc√™ pode editar, excluir ou exportar." },
        { element: els.discordBtnCalc, title: "7/7: Exportar para o Discord", content: "Use este bot√£o para copiar os dados formatados para colar no Discord!" }
    ];

    const showTourStep = (step) => {
        clearTour();
        const { element, title, content } = tourSteps[step];
        element.classList.add('tour-highlight');

        const tooltip = document.createElement('div');
        tooltip.className = 'tour-tooltip';
        tooltip.id = 'tourTooltip';
        tooltip.innerHTML = `<h4>${title}</h4><p>${content}</p>
            <button id="tourNextBtn">${step < tourSteps.length - 1 ? 'Pr√≥ximo' : 'Finalizar'}</button>
            <button id="tourExitBtn" style="background:#555; color: white;">Sair</button>`;
        els.body.appendChild(tooltip);

        const rect = element.getBoundingClientRect();
        let top = rect.bottom + window.scrollY + 10;
        let left = rect.left + window.scrollX;
        if (left + 300 > window.innerWidth) left = window.innerWidth - 310;
        if (left < 10) left = 10;
        if (rect.bottom > window.innerHeight * 0.7) top = rect.top + window.scrollY - tooltip.offsetHeight - 10;
        
        tooltip.style.top = `${top}px`;
        tooltip.style.left = `${left}px`;
        setTimeout(() => tooltip.classList.add('active'), 10);

        document.getElementById('tourNextBtn').addEventListener('click', nextTourStep);
        document.getElementById('tourExitBtn').addEventListener('click', clearTour);
    };

    const startTour = () => {
        currentTourStep = 0;
        toggleView(false);
        showTourStep(currentTourStep);
    };

    const nextTourStep = () => {
        currentTourStep++;
        if (currentTourStep < tourSteps.length) {
            showTourStep(currentTourStep);
        } else {
            clearTour();
            showToast("Tutorial finalizado!", "success");
        }
    };
    
    const clearTour = () => {
        document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));
        const tooltip = document.getElementById('tourTooltip');
        if (tooltip) tooltip.remove();
    };

    // ------------------------------------
    // 9. EVENT LISTENERS E INICIALIZA√á√ÉO
    // ------------------------------------
    const bindEventListeners = () => {
        // A√ß√µes da Calculadora
        els.calcBtn.addEventListener('click', calculate);
        els.resetBtn.addEventListener('click', clearAllFields);
        els.registerBtn.addEventListener('click', registerVenda);
        els.cancelEditBtn.addEventListener('click', clearAllFields);
        els.toggleHistoryBtn.addEventListener('click', () => toggleView(true));
        els.discordBtnCalc.addEventListener('click', exportDiscord);
        els.csvBtn.addEventListener('click', exportCSV);

        // A√ß√µes do Hist√≥rico
        els.toggleCalcBtn.addEventListener('click', () => {
            if (vendaEmEdicaoId) {
                clearAllFields();
                showToast("Edi√ß√£o pendente cancelada.", "error");
            }
            toggleView(false);
        });
        els.clearHistoryBtn.addEventListener('click', clearHistory);
        els.filtroHistorico.addEventListener('input', filterHistory);
        els.salesHistory.addEventListener('click', (e) => {
            const button = e.target.closest('button[data-action]');
            if (!button) return;
            const { action, id } = button.dataset;
            if (action === 'edit') editVenda(id);
            if (action === 'delete') deleteVenda(id);
        });

        // Controles Globais
        els.themeBtn.addEventListener('click', toggleTheme);
        els.tutorialBtn.addEventListener('click', startTour);
        els.logoLink.addEventListener('click', (e) => { e.preventDefault(); toggleView(false); });
        els.logoutBtn.addEventListener('click', handleLogout);
        
        // Tela de Boas-Vindas
        els.enterBtn.addEventListener('click', () => {
            els.welcomeScreen.classList.add('hidden');
            localStorage.setItem('hasVisited', 'true');
            els.welcomeScreen.addEventListener('transitionend', () => els.welcomeScreen.style.display = 'none');
        });

        // Autentica√ß√£o
        els.authActionBtn.addEventListener('click', handleAuthAction);
        els.authToggleBtn.addEventListener('click', () => {
            const isCurrentlyRegisterMode = els.authTitle.textContent.includes('Cadastro');
            toggleAuthMode(!isCurrentlyRegisterMode);
        });
        els.password.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') handleAuthAction();
        });

        // Formata√ß√£o de Inputs
        const fieldsToCapitalize = [els.nomeCliente, els.organizacao, els.negociadoras, els.vendaValorObs];
        fieldsToCapitalize.forEach(field => {
            field.addEventListener('input', (e) => e.target.value = capitalizeText(e.target.value));
        });

        els.telefone.addEventListener('input', (e) => e.target.value = phoneMask(e.target.value));
        els.telefone.addEventListener('focus', (e) => {
            if (!e.target.value.trim() || e.target.value.length < 7) {
                e.target.value = "(055) ";
            }
        });
    };

    const toggleTheme = () => {
        const isDark = els.body.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        els.themeBtn.textContent = isDark ? '‚òÄÔ∏è Modo Claro' : 'üåô Modo Noturno';
        showToast(`Modo ${isDark ? 'Noturno' : 'Claro'} ativado.`, "default");
    };

    const iniciarAplicacao = () => { // <<< NOME DA FUN√á√ÉO CORRIGIDO
        bindEventListeners();
        updateDataVenda();

        // Carregar tema salvo
        const savedTheme = localStorage.getItem('theme') || 'light';
        els.body.className = savedTheme;
        if (savedTheme === 'dark') {
            els.themeBtn.textContent = '‚òÄÔ∏è Modo Claro';
        }
        
        // L√≥gica de primeira visita
        if (localStorage.getItem('hasVisited')) {
            els.welcomeScreen.style.display = 'none';
        } else {
            els.welcomeScreen.classList.add('show');
            els.authScreen.style.display = 'none';
            els.mainCard.style.display = 'none';
        }
        
        // Todas as logos s√£o as mesmas
        els.appLogo.src = LOGO_SRC;
        els.historyImg.src = LOGO_SRC;
        els.welcomeLogo.src = LOGO_SRC;
    };
    
    // Inicia a aplica√ß√£o
    iniciarAplicacao(); // <<< CHAMADA DA FUN√á√ÉO CORRIGIDA
</script>
