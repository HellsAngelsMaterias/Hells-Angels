<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <link rel="icon" type="image/png" href="logo-dark.png">
  
  <title>Hells Angels</title>
  
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <style>
    :root {
      --cor-fundo: #fff0f6;
      --cor-texto: #4a0033;
      --cor-principal: #e60073;
      --cor-card: #ffffff;
      --cor-borda: #ffb3d9;
      --cor-btn-primario: #e60073;
      --cor-btn-texto: #fff;
      --cor-btn-secundario: #ffd6eb;
      --cor-btn-secundario-texto: #4a0033;
      --cor-erro: #cc0000;
      /* NOVO: Cor para o brilho pulsante */
      --cor-glow-pulsante: rgba(230, 0, 115, 0.8); /* Cor Principal com opacidade */
    }

    body.dark {
      --cor-fundo: #1a000d; 
      --cor-texto: #ffccf0; 
      --cor-principal: #ff0080; 
      --cor-card: #2c001a; 
      --cor-borda: #e60073; 
      --cor-btn-primario: #ff0080;
      --cor-btn-texto: #fff;
      --cor-btn-secundario: #4d0026;
      --cor-btn-secundario-texto: #ffccf0;
      --cor-erro: #ff5555;
      --cor-glow-pulsante: rgba(255, 0, 128, 0.8);
    }
    
    * {
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background-color: var(--cor-fundo);
      color: var(--cor-texto);
      margin: 0;
      padding: 0;
      transition: background-color 0.3s, color 0.3s;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* NOVOS ESTILOS PARA TELA DE LOGIN */
    #authLogo {
      max-width: 80%;
      max-height: 120px; 
      margin-bottom: 25px;
      display: block;
    }
    
    #authScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--cor-card);
      z-index: 10000; 
      display: none; /* Controlado pelo JS */
      flex-direction: column;
      justify-content: center; 
      align-items: center;
      text-align: center;
      transition: opacity 0.5s ease;
      padding: 20px; 
      box-sizing: border-box; 
    }
    
    #authScreen.show {
        display: flex; 
    }
    
    #authScreen.hidden {
      opacity: 0;
      pointer-events: none; 
    }
    
    #authScreen h2 {
      font-size: 36px;
      margin-top: 10px; 
      margin-bottom: 20px;
      color: var(--cor-principal);
      font-weight: 900;
    }
    
    .auth-input {
        width: 80%;
        max-width: 300px;
        margin: 8px 0;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid var(--cor-borda);
        background-color: var(--cor-fundo);
        color: var(--cor-texto);
    }

    body.dark .auth-input {
        background: #33001f;
        color: var(--cor-texto);
        border: 1px solid var(--cor-borda);
    }
    
    #authError {
        color: var(--cor-erro);
        font-weight: 600;
        margin-top: 10px;
    }

    #logoutBtn {
        background: var(--cor-erro); 
        color: var(--cor-btn-texto);
        display: none; 
    }
    /* FIM NOVOS ESTILOS */

    /* Estilos Gerais */
    header {
      width: 100%;
      text-align: center;
      padding: 15px 0;
      border-bottom: 2px solid var(--cor-borda);
      background-color: var(--cor-card);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    #logo-link {
        display: block;
        text-decoration: none;
        color: var(--cor-principal);
        font-size: 30px;
        font-weight: 900;
        letter-spacing: 2px;
        text-transform: uppercase;
        cursor: pointer;
        transition: color 0.3s;
        /* NOVO: A logo só deve ser visível após o login */
        display: none; 
    }

    .top-right-controls {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 10px;
    }

    .control-btn {
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background-color: var(--cor-btn-secundario);
      color: var(--cor-btn-secundario-texto);
      font-weight: 600;
      transition: background-color 0.3s;
    }

    .control-btn:hover {
      opacity: 0.8;
    }
    
    main {
      padding: 20px;
      width: 100%;
      max-width: 1200px;
      flex-grow: 1;
    }
    
    .card {
      background-color: var(--cor-card);
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      transition: background-color 0.3s, box-shadow 0.3s;
    }

    .card h2 {
      color: var(--cor-principal);
      border-bottom: 2px solid var(--cor-borda);
      padding-bottom: 10px;
      margin-top: 0;
      margin-bottom: 20px;
    }

    /* Inputs e Selects */
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid var(--cor-borda);
      border-radius: 5px;
      background-color: var(--cor-fundo);
      color: var(--cor-texto);
      transition: border-color 0.3s;
    }

    input[type=number] {
      -moz-appearance: textfield;
    }
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    textarea {
        resize: vertical;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--cor-principal);
      outline: none;
    }

    /* Botões */
    button, .button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 700;
      transition: opacity 0.3s, background-color 0.3s, box-shadow 0.3s;
      display: inline-block;
      text-align: center;
      margin-right: 10px;
    }

    button.primary, .button.primary {
      background-color: var(--cor-btn-primario);
      color: var(--cor-btn-texto);
    }
    
    button.muted, .button.muted {
        background-color: var(--cor-btn-secundario);
        color: var(--cor-btn-secundario-texto);
    }

    button:hover:not(:disabled), .button:hover:not(:disabled) {
      opacity: 0.9;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Seções e Grid */
    .grid-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }

    .grid-item-full {
      grid-column: 1 / -1;
    }

    /* Resultados e Materiais */
    #resultadoCalc {
      margin-top: 20px;
      padding: 15px;
      border: 2px dashed var(--cor-principal);
      border-radius: 5px;
      background-color: var(--cor-fundo);
    }

    #resultadoCalc p {
      margin: 5px 0;
      font-size: 1.1em;
    }
    
    .valor-total {
        font-size: 1.5em;
        font-weight: 900;
        color: var(--cor-principal);
        /* NOVO: Efeito de brilho pulsante */
        animation: pulse-glow 2s infinite alternate;
    }
    
    @keyframes pulse-glow {
        from {
            text-shadow: 0 0 5px var(--cor-glow-pulsante), 0 0 10px var(--cor-glow-pulsante);
        }
        to {
            text-shadow: 0 0 10px var(--cor-glow-pulsante), 0 0 20px var(--cor-glow-pulsante);
        }
    }

    /* Histórico */
    #historyCard {
      display: none;
    }
    
    #historicoTabelaContainer {
        max-height: 500px;
        overflow-y: auto;
        margin-top: 20px;
        border: 1px solid var(--cor-borda);
        border-radius: 5px;
    }

    #historicoVendas {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9em;
    }

    #historicoVendas thead th {
        position: sticky;
        top: 0;
        background-color: var(--cor-principal);
        color: var(--cor-btn-texto);
        padding: 10px;
        text-align: left;
        z-index: 5;
    }
    
    #historicoVendas tbody tr {
      border-bottom: 1px solid var(--cor-borda);
    }

    #historicoVendas tbody tr:nth-child(even) {
      background-color: var(--cor-fundo);
    }

    #historicoVendas tbody td {
      padding: 10px;
      vertical-align: top;
    }

    .btn-action {
        margin-right: 5px;
        padding: 5px 8px;
        font-size: 0.8em;
    }

    .btn-edit { background-color: #007bff; color: #fff; }
    .btn-delete { background-color: var(--cor-erro); color: #fff; }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: white;
      padding: 12px 20px;
      border-radius: 5px;
      z-index: 10001;
      opacity: 0;
      transition: opacity 0.5s, transform 0.5s;
      pointer-events: none;
      font-weight: bold;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    
    .toast.success { background-color: #28a745; }
    .toast.error { background-color: var(--cor-erro); }
    .toast.info { background-color: #17a2b8; }
    
    /* Welcome Screen (Agora desnecessária com o login, mas mantida) */
    #welcomeScreen {
        display: none;
    }

    @media (max-width: 768px) {
      .grid-container {
        grid-template-columns: 1fr;
      }
      .top-right-controls {
          position: relative;
          top: unset;
          right: unset;
          justify-content: center;
          margin-top: 10px;
      }
      header {
          padding-bottom: 10px;
      }
      .control-btn {
          font-size: 0.9em;
      }
      #authScreen h2 {
          font-size: 28px;
      }
    }
  </style>
</head>
<body class="dark">

  <div id="authScreen" class="show"> 
      <img id="authLogo" src="logo-dark.png" alt="Auth Logo"> 
      <h2>Acesso Hells Angels</h2>
      
      <input type="text" id="usernameInput" class="auth-input" placeholder="Nome de Usuário">
      <input type="password" id="passwordInput" class="auth-input" placeholder="Senha">
      
      <button id="loginBtn" class="primary" style="margin-top: 10px; padding: 10px 30px;">Entrar</button>
      <button id="registerAuthBtn" class="muted" style="margin-top: 10px; padding: 10px 30px;">Criar Nova Conta</button>
      
      <p id="authError" style="display:none;"></p>
  </div>
  <header>
    <a href="#" id="logo-link">Hells Angels</a>
    <div class="top-right-controls">
      <button class="control-btn" id="logoutBtn" style="display:none;">🚪 Logout</button> 
      <button class="control-btn" id="tutorialBtn">💡 Tutorial</button>
      <button class="control-btn" id="themeBtn">☀️ Modo Claro</button>
    </div>
  </header>

  <main>
    <div id="mainCard" class="card">
        
      <div class="grid-item-full" style="text-align: center; margin-bottom: 20px;">
        <button id="toggleCalcBtn" class="primary">Calculadora</button>
        <button id="toggleHistoryBtn" class="muted">Ver Histórico de Vendas</button>
      </div>

      <section id="calcSection">
        <h2>Calculadora e Registro de Vendas</h2>
        <div class="grid-container">
          
          <div class="grid-item">
            <label for="nomeCliente">Nome do Cliente (Obrigatório):</label>
            <input type="text" id="nomeCliente" required>

            <label for="organizacao">Organização:</label>
            <input type="text" id="organizacao" list="organizacoesLista">
            <datalist id="organizacoesLista">
                <option value="Serpents">
                <option value="Nox">
                <option value="NKT">
                <option value="Ballers">
                <option value="Goon">
                <option value="Triads">
            </datalist>

            <label for="opcao">Opção (CNPJ/CPF/Outros):</label>
            <input type="text" id="opcao">

            <label for="telefone">Telefone (Obrigatório):</label>
            <input type="text" id="telefone" placeholder="(055) XXX-XXX" required>
            
          </div>

          <div class="grid-item">
            
            <label for="ticketsQtd">Tickets (Qtd):</label>
            <input type="number" id="ticketsQtd" min="0" value="0">

            <label for="tabletsQtd">Tablets (Qtd):</label>
            <input type="number" id="tabletsQtd" min="0" value="0">

            <label for="nitroQtd">Nitro (Qtd):</label>
            <input type="number" id="nitroQtd" min="0" value="0">
            
            <label for="tipoValor">Tipo de Valor (Obrigatório):</label>
            <select id="tipoValor" required>
              <option value="Limpo">Dinheiro Limpo</option>
              <option value="Sujo">Dinheiro Sujo</option>
              <option value="LimpoAlianca">Dinheiro Limpo (Aliança)</option>
              <option value="SujoAlianca">Dinheiro Sujo (Aliança)</option>
            </select>
          </div>
          
          <div class="grid-item-full">
            <label for="obsValor">Observação de Valor (Ex: Pix, Transferência):</label>
            <textarea id="obsValor"></textarea>

            <label for="observacao">Outras Observações:</label>
            <textarea id="observacao"></textarea>
          </div>

          <div class="grid-item-full">
            
            <button id="calculateBtn" class="primary">Calcular</button>
            <button id="registerBtn" class="primary">Registrar Venda</button>
            <button id="exportCsvBtn" class="muted">Exportar CSV</button>
            <button id="discordBtnCalc" class="muted">Copiar p/ Discord</button>
            
            <div id="resultadoCalc" style="display: none;">
              <h3>Materiais Necessários:</h3>
              <p id="materiaisResultado"></p>
              <h3>Valores Estimados:</h3>
              <p id="valorBrutoResultado"></p>
              <p id="valorTotalResultado" class="valor-total"></p>
            </div>
            
          </div>
        </div>
      </section>

      <section id="historyCard" style="display: none;">
        <h2>Histórico de Vendas Compartilhado</h2>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <input type="text" id="filtroHistorico" placeholder="Filtrar por nome, organização ou negociadora..." style="flex-grow: 1; margin-bottom: 0;">
            </div>
        
        <div id="historicoTabelaContainer">
            <table id="historicoVendas">
              <thead>
                <tr>
                  <th>Data/Hora</th>
                  <th>Cliente</th>
                  <th>Organização/Tipo</th>
                  <th>Telefone</th>
                  <th>Produtos</th>
                  <th>Valor Total</th>
                  <th>Negociadora</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody>
                </tbody>
            </table>
        </div>
      </section>

    </div></main>
  
  <div id="toast" class="toast"></div>

  <script>
    // Variáveis Globais (agora 'vendas' será atualizada pelo listener do Firebase)
    let vendas = []; 
    let vendaEmEdicaoId = null; 

    // Mapeamento dos elementos DOM
    const els = {
      // Elementos Principais
      mainCard: document.getElementById('mainCard'),
      logoLink: document.getElementById('logo-link'),
      toggleCalcBtn: document.getElementById('toggleCalcBtn'),
      toggleHistoryBtn: document.getElementById('toggleHistoryBtn'),
      calcSection: document.getElementById('calcSection'),
      historyCard: document.getElementById('historyCard'),
      themeBtn: document.getElementById('themeBtn'),
      tutorialBtn: document.getElementById('tutorialBtn'),

      // Elementos da Calculadora
      nomeCliente: document.getElementById('nomeCliente'),
      organizacao: document.getElementById('organizacao'),
      opcao: document.getElementById('opcao'),
      telefone: document.getElementById('telefone'),
      ticketsQtd: document.getElementById('ticketsQtd'),
      tabletsQtd: document.getElementById('tabletsQtd'),
      nitroQtd: document.getElementById('nitroQtd'),
      tipoValor: document.getElementById('tipoValor'),
      obsValor: document.getElementById('obsValor'),
      observacao: document.getElementById('observacao'),
      calculateBtn: document.getElementById('calculateBtn'),
      registerBtn: document.getElementById('registerBtn'),
      exportCsvBtn: document.getElementById('exportCsvBtn'),
      discordBtnCalc: document.getElementById('discordBtnCalc'),
      resultadoCalc: document.getElementById('resultadoCalc'),
      materiaisResultado: document.getElementById('materiaisResultado'),
      valorBrutoResultado: document.getElementById('valorBrutoResultado'),
      valorTotalResultado: document.getElementById('valorTotalResultado'),

      // Elementos do Histórico
      filtroHistorico: document.getElementById('filtroHistorico'),
      historicoVendas: document.getElementById('historicoVendas'),

      // NOVOS ELEMENTOS DE AUTENTICAÇÃO
      usernameInput: document.getElementById('usernameInput'),
      passwordInput: document.getElementById('passwordInput'),
      loginBtn: document.getElementById('loginBtn'),
      registerAuthBtn: document.getElementById('registerAuthBtn'),
      authScreen: document.getElementById('authScreen'),
      authError: document.getElementById('authError'),
      logoutBtn: document.getElementById('logoutBtn'),
      // FIM NOVOS ELEMENTOS DE AUTENTICAÇÃO
    };

    // Constantes de Valores
    const PRECOS_BASE = {
        Tickets: {
            material: 'R$ 525 (Dinheiro Sujo)',
            Limpo: 9800,
            Sujo: 11700,
            LimpoAlianca: 8000,
            SujoAlianca: 10000
        },
        Tablets: {
            material: '20 Cobre, 40 Plástico, 2 Fita Adesiva, 2 Lixo Eletrônico',
            Limpo: 17000,
            Sujo: 20000,
            LimpoAlianca: 15000,
            SujoAlianca: 18000
        },
        Nitro: {
            material: '20 Alumínio, 20 Cobre, 45 Vidro, 1 Fita Adesiva, 1 Porca, 1 Parafuso',
            Limpo: 42500,
            Sujo: 50000,
            LimpoAlianca: 38000,
            SujoAlianca: 45000
        }
    };
    
    // ========================================================================
    // === CONFIGURAÇÃO FIREBASE E AUTENTICAÇÃO ===
    // ========================================================================
    const firebaseConfig = {
        apiKey: "AIzaSyAhDVBfXoO_Rdi3e-trdbaaPppwDkTDgVc", // Sua Chave de API
        authDomain: "hells-angels-438c2.firebaseapp.com",
        projectId: "hells-angels-438c2",
        storageBucket: "hells-angels-438c2.firebasestorage.app",
        messagingSenderId: "429406215315",
        appId: "1:429406215315:web:b9a153138589ba52308166"
    };

    let firebaseApp;
    let auth;
    let db;
    let globalUser = null;
    const VENDAS_COLLECTION = 'hells_vendas_shared';
    const FAKE_EMAIL_DOMAIN = '@hells-angels.com';

    try {
        firebaseApp = firebase.initializeApp(firebaseConfig);
        auth = firebaseApp.auth();
        db = firebaseApp.firestore();
    } catch (e) {
        console.error("Erro ao inicializar Firebase. Verifique sua configuração.", e);
    }

    const showAuthError = (message) => {
        els.authError.textContent = message;
        els.authError.style.display = 'block';
        setTimeout(() => els.authError.style.display = 'none', 5000);
    };

    const handleLogin = async () => {
        const username = els.usernameInput.value.trim();
        const password = els.passwordInput.value.trim();
        if (!username || !password) {
            showAuthError("Preencha o nome de usuário e a senha.");
            return;
        }
        const email = `${username}${FAKE_EMAIL_DOMAIN}`;
        
        try {
            await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
            let errorMessage = "Erro ao fazer login. Verifique as credenciais.";
            if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                errorMessage = "Nome de usuário ou senha inválidos.";
            }
            showAuthError(errorMessage);
            console.error("Login Error:", error);
        }
    };

    const handleRegister = async () => {
        const username = els.usernameInput.value.trim();
        const password = els.passwordInput.value.trim();
        if (!username || !password || password.length < 6) {
            showAuthError("O nome de usuário e a senha são obrigatórios. A senha deve ter pelo menos 6 caracteres.");
            return;
        }
        const email = `${username}${FAKE_EMAIL_DOMAIN}`;
        
        try {
            await auth.createUserWithEmailAndPassword(email, password);
            await auth.currentUser.updateProfile({ displayName: username });
            showToast(`Conta criada com sucesso para ${username}!`, 'success', 3000);
        } catch (error) {
            let errorMessage = "Erro ao criar conta. Tente outro nome de usuário.";
            if (error.code === 'auth/email-already-in-use') {
                errorMessage = "Nome de usuário já está em uso.";
            }
            showAuthError(errorMessage);
            console.error("Registration Error:", error);
        }
    };

    const logout = async () => {
        try {
            await auth.signOut();
            showToast("Você foi desconectado.", 'success', 2000);
        } catch (error) {
            showToast("Erro ao fazer logout.", 'error');
            console.error("Logout Error:", error);
        }
    };

    // ========================================================================
    // === LÓGICA DE HISTÓRICO COMPARTILHADO (FIREBASE FIRESTORE) ===
    // ========================================================================

    // Função que substitui saveVendas()
    const saveVendaToFirestore = async (vendaData, vendaId = null) => {
        if (!db) return;
        try {
            const dataToSave = {
                ...vendaData,
                negociadora: globalUser ? globalUser.displayName : 'Desconhecido'
            };

            if (vendaId) {
                // Edição
                const vendaRef = db.collection(VENDAS_COLLECTION).doc(vendaId);
                await vendaRef.update({
                    ...dataToSave,
                    dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp(),
                });
                showToast("Venda editada e salva no servidor.", 'success');
            } else {
                // Nova Venda
                await db.collection(VENDAS_COLLECTION).add({
                    ...dataToSave,
                    dataRegistro: firebase.firestore.FieldValue.serverTimestamp(),
                });
                showToast("Venda registrada e salva no servidor.", 'success');
            }
        } catch (error) {
            showToast("Erro ao salvar venda no servidor.", 'error');
            console.error("Firestore Save Error:", error);
        }
    };
    
    // Função que substitui loadVendas()
    const loadVendasFromFirestore = (filtro = '') => {
        if (!db) return;

        db.collection(VENDAS_COLLECTION)
          .orderBy('dataRegistro', 'desc') 
          .onSnapshot((snapshot) => {
            let vendasCarregadas = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                // O Firebase salva o Timestamp, precisamos formatá-lo
                const timestamp = data.dataRegistro ? data.dataRegistro.toDate() : new Date();
                const dataFormatada = timestamp.toLocaleString('pt-BR');
                
                vendasCarregadas.push({ 
                    id: doc.id, 
                    dataFormatada: dataFormatada,
                    ...data 
                });
            });

            window.vendas = vendasCarregadas; // Sincroniza a lista global
            renderHistoricoComDados(vendasCarregadas, filtro); 
            
        }, (error) => {
            showToast("Erro ao carregar histórico do servidor.", 'error');
            console.error("Firestore Load Error:", error);
        });
    };

    const deleteVendaFromFirestore = async (vendaId) => {
        if (!db) return;
        try {
            await db.collection(VENDAS_COLLECTION).doc(vendaId).delete();
            showToast("Venda excluída do servidor.", 'success', 2000);
        } catch (error) {
            showToast("Erro ao excluir venda do servidor.", 'error');
            console.error("Firestore Delete Error:", error);
        }
    };
    
    // ========================================================================
    // === FUNÇÕES DE CÁLCULO E VALIDAÇÃO ===
    // ========================================================================
    
    function formatMoney(amount) {
      return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(amount);
    }

    function getVendaData() {
        const nomeCliente = els.nomeCliente.value.trim();
        const organizacao = els.organizacao.value.trim();
        const opcao = els.opcao.value.trim();
        const telefone = els.telefone.value.trim();
        const ticketsQtd = parseInt(els.ticketsQtd.value) || 0;
        const tabletsQtd = parseInt(els.tabletsQtd.value) || 0;
        const nitroQtd = parseInt(els.nitroQtd.value) || 0;
        const tipoValor = els.tipoValor.value;
        const obsValor = els.obsValor.value.trim();
        const observacao = els.observacao.value.trim();
        
        return { nomeCliente, organizacao, opcao, telefone, ticketsQtd, tabletsQtd, nitroQtd, tipoValor, obsValor, observacao };
    }

    function calculate(vendaData) {
        let total = 0;
        let materiais = [];
        let valoresBrutos = [];
        const { ticketsQtd, tabletsQtd, nitroQtd, tipoValor } = vendaData;

        // Tickets
        if (ticketsQtd > 0) {
            total += ticketsQtd * PRECOS_BASE.Tickets[tipoValor];
            materiais.push(`${ticketsQtd} Tickets: ${PRECOS_BASE.Tickets.material} cada.`);
            valoresBrutos.push(`${ticketsQtd} Tickets @ ${formatMoney(PRECOS_BASE.Tickets[tipoValor])} = ${formatMoney(ticketsQtd * PRECOS_BASE.Tickets[tipoValor])}`);
        }

        // Tablets
        if (tabletsQtd > 0) {
            total += tabletsQtd * PRECOS_BASE.Tablets[tipoValor];
            materiais.push(`${tabletsQtd} Tablets: ${PRECOS_BASE.Tablets.material} cada.`);
            valoresBrutos.push(`${tabletsQtd} Tablets @ ${formatMoney(PRECOS_BASE.Tablets[tipoValor])} = ${formatMoney(tabletsQtd * PRECOS_BASE.Tablets[tipoValor])}`);
        }

        // Nitro
        if (nitroQtd > 0) {
            total += nitroQtd * PRECOS_BASE.Nitro[tipoValor];
            materiais.push(`${nitroQtd} Nitro: ${PRECOS_BASE.Nitro.material} cada.`);
            valoresBrutos.push(`${nitroQtd} Nitro @ ${formatMoney(PRECOS_BASE.Nitro[tipoValor])} = ${formatMoney(nitroQtd * PRECOS_BASE.Nitro[tipoValor])}`);
        }
        
        return { total, materiais, valoresBrutos };
    }

    function updateCalculations() {
        const vendaData = getVendaData();
        const { total, materiais, valoresBrutos } = calculate(vendaData);
        
        if (total > 0) {
            els.resultadoCalc.style.display = 'block';
            els.materiaisResultado.innerHTML = materiais.length > 0 ? materiais.join('<br>') : 'Nenhum material necessário.';
            els.valorBrutoResultado.innerHTML = valoresBrutos.length > 0 ? valoresBrutos.join('<br>') : 'Nenhum valor individual.';
            els.valorTotalResultado.textContent = `TOTAL DA VENDA: ${formatMoney(total)} (${vendaData.obsValor || vendaData.tipoValor})`;
        } else {
            els.resultadoCalc.style.display = 'none';
        }
        
        return total;
    }

    function clearAllFields() {
        els.nomeCliente.value = '';
        els.organizacao.value = '';
        els.opcao.value = '';
        els.telefone.value = '';
        els.ticketsQtd.value = 0;
        els.tabletsQtd.value = 0;
        els.nitroQtd.value = 0;
        els.tipoValor.value = 'Limpo'; 
        els.obsValor.value = '';
        els.observacao.value = '';
        vendaEmEdicaoId = null;
        els.registerBtn.textContent = 'Registrar Venda';
        updateCalculations();
    }

    function validateFields(data) {
        if (!data.nomeCliente || !data.telefone) {
            showToast("O nome do cliente e o telefone são obrigatórios.", "error");
            return false;
        }
        if (data.ticketsQtd + data.tabletsQtd + data.nitroQtd === 0) {
            showToast("A quantidade de produtos não pode ser zero.", "error");
            return false;
        }
        return true;
    }

    // ========================================================================
    // === FUNÇÕES DE INTERFACE ===
    // ========================================================================

    function showToast(message, type = 'info', duration = 3000) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast show ${type}`;
      setTimeout(() => {
        toast.classList.remove('show');
      }, duration);
    }
    
    function toggleView(showHistory) {
        if (showHistory) {
            els.calcSection.style.display = 'none';
            els.historyCard.style.display = 'block';
            els.toggleHistoryBtn.classList.add('primary');
            els.toggleHistoryBtn.classList.remove('muted');
            els.toggleCalcBtn.classList.add('muted');
            els.toggleCalcBtn.classList.remove('primary');
            // Recarrega os dados do Firestore (Embora o listener faça isso)
            loadVendasFromFirestore(els.filtroHistorico.value || ''); 
        } else {
            els.calcSection.style.display = 'block';
            els.historyCard.style.display = 'none';
            els.toggleCalcBtn.classList.add('primary');
            els.toggleCalcBtn.classList.remove('muted');
            els.toggleHistoryBtn.classList.add('muted');
            els.toggleHistoryBtn.classList.remove('primary');
        }
    }
    
    function copyToClipboard(text, successMessage) {
        navigator.clipboard.writeText(text).then(() => {
            showToast(successMessage, 'success');
        }).catch(err => {
            console.error('Erro ao copiar: ', err);
            showToast('Erro ao copiar para a área de transferência.', 'error');
        });
    }

    // Função que renderiza a tabela com os dados do Firebase (substitui a original)
    function renderHistoricoComDados(vendasCarregadas, filtro = '') {
        const tbody = els.historicoVendas.querySelector('tbody');
        tbody.innerHTML = '';
        
        const filtroLower = filtro.toLowerCase();
        
        const vendasFiltradas = vendasCarregadas.filter(venda => {
            if (!filtroLower) return true;
            return (
                venda.nomeCliente.toLowerCase().includes(filtroLower) ||
                venda.organizacao.toLowerCase().includes(filtroLower) ||
                venda.negociadora.toLowerCase().includes(filtroLower) ||
                (venda.opcao && venda.opcao.toLowerCase().includes(filtroLower))
            );
        });

        if (vendasFiltradas.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Nenhuma venda encontrada.</td></tr>';
            return;
        }

        vendasFiltradas.forEach(venda => {
            const tr = document.createElement('tr');
            
            // Calcula o valor total para exibição
            const { total } = calculate(venda);
            
            // Constrói a lista de produtos
            let produtos = [];
            if (venda.ticketsQtd > 0) produtos.push(`${venda.ticketsQtd} Tickets`);
            if (venda.tabletsQtd > 0) produtos.push(`${venda.tabletsQtd} Tablets`);
            if (venda.nitroQtd > 0) produtos.push(`${venda.nitroQtd} Nitro`);

            // Dados da linha
            tr.innerHTML = `
                <td>${venda.dataFormatada || 'N/A'}</td>
                <td>${venda.nomeCliente}</td>
                <td>${venda.organizacao} (${venda.tipoValor})</td>
                <td>${venda.telefone}</td>
                <td>${produtos.join(', ')}</td>
                <td>${formatMoney(total)} (${venda.obsValor || 'Dinheiro'})</td>
                <td>${venda.negociadora || 'Desconhecido'}</td>
                <td>
                    <button class="btn-action btn-discord" data-id="${venda.id}">📋 Discord</button>
                    <button class="btn-action btn-edit" data-id="${venda.id}">✏️ Editar</button>
                    <button class="btn-action btn-delete" data-id="${venda.id}">🗑️ Excluir</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        // Adiciona event listeners para os botões do histórico
        tbody.querySelectorAll('.btn-edit').forEach(button => {
            button.addEventListener('click', (e) => editVenda(e.target.dataset.id));
        });
        tbody.querySelectorAll('.btn-delete').forEach(button => {
            button.addEventListener('click', (e) => {
                if(confirm('Tem certeza que deseja excluir esta venda do histórico compartilhado?')) {
                    deleteVendaFromFirestore(e.target.dataset.id);
                }
            });
        });
        tbody.querySelectorAll('.btn-discord').forEach(button => {
            button.addEventListener('click', (e) => copyDiscordFromHistory(e.target.dataset.id));
        });
    }

    function editVenda(vendaId) {
        const venda = vendas.find(v => v.id === vendaId);
        if (!venda) {
            showToast("Venda não encontrada.", "error");
            return;
        }

        // Preenche os campos da calculadora
        els.nomeCliente.value = venda.nomeCliente || '';
        els.organizacao.value = venda.organizacao || '';
        els.opcao.value = venda.opcao || '';
        els.telefone.value = venda.telefone || '';
        els.ticketsQtd.value = venda.ticketsQtd || 0;
        els.tabletsQtd.value = venda.tabletsQtd || 0;
        els.nitroQtd.value = venda.nitroQtd || 0;
        els.tipoValor.value = venda.tipoValor || 'Limpo';
        els.obsValor.value = venda.obsValor || '';
        els.observacao.value = venda.observacao || '';
        
        vendaEmEdicaoId = vendaId; 
        els.registerBtn.textContent = 'Salvar Edição';
        
        updateCalculations();
        toggleView(false); // Volta para a tela da calculadora
        showToast(`Editando venda de ${venda.nomeCliente}`, 'info', 2000);
    }
    
    // Funções de Cópia para Discord
    function getDiscordSummary(vendaData, total) {
        const produtos = [];
        if (vendaData.ticketsQtd > 0) produtos.push(`Tickets: ${vendaData.ticketsQtd}`);
        if (vendaData.tabletsQtd > 0) produtos.push(`Tablets: ${vendaData.tabletsQtd}`);
        if (vendaData.nitroQtd > 0) produtos.push(`Nitro: ${vendaData.nitroQtd}`);
        
        const negociadora = globalUser ? globalUser.displayName : 'Desconhecido';

        return `**[VENDA HA]**
Cliente: ${vendaData.nomeCliente}
Organização: ${vendaData.organizacao} (${vendaData.opcao || 'N/A'})
Telefone: ${vendaData.telefone}
Produtos: ${produtos.join(', ')}
Valor Total: ${formatMoney(total)} (${vendaData.obsValor || vendaData.tipoValor})
Negociadora: ${negociadora}
Observações: ${vendaData.observacao || 'N/A'}`;
    }

    function copyDiscordFromCalc() {
        const vendaData = getVendaData();
        const { total } = calculate(vendaData);
        if (total === 0) {
            showToast("Calcule uma venda antes de copiar.", "error");
            return;
        }
        const summary = getDiscordSummary(vendaData, total);
        copyToClipboard(summary, "Resumo da venda copiado para o Discord!");
    }

    function copyDiscordFromHistory(vendaId) {
        const venda = vendas.find(v => v.id === vendaId);
        if (!venda) return;
        
        const { total } = calculate(venda);
        const summary = getDiscordSummary(venda, total);
        
        copyToClipboard(summary, `Resumo da venda de ${venda.nomeCliente} copiado!`);
    }

    // ========================================================================
    // === LISTENERS E INICIALIZAÇÃO ===
    // ========================================================================

    // Função para tratar formatação do telefone
    function formatTelefone(input) {
        let value = input.value.replace(/\D/g, ''); // Remove tudo que não é dígito
        if (value.length > 0) {
            value = `(055) ${value}`;
        }
        if (value.length > 6) {
            value = value.substring(0, 6) + ' ' + value.substring(6);
        }
        if (value.length > 10) {
            value = value.substring(0, 10) + '-' + value.substring(10);
        }
        input.value = value.substring(0, 15);
    }
    
    // Tutorial (Mantido, mas a implementação do 'intro.js' deve ser adicionada se necessário)
    function startTour() {
        showToast("O tutorial precisa de uma biblioteca externa (como o Intro.js) para funcionar corretamente.", "info");
    }
    function clearTour() { /* Função dummy */ }
    
    function updateThemeLogo() {
        // Se a logo precisar mudar entre light e dark mode (ex: logo-light.png/logo-dark.png)
        const isDark = document.body.classList.contains('dark');
        const logo = document.getElementById('authLogo');
        if (logo) logo.src = isDark ? 'logo-dark.png' : 'logo-light.png';
    }


    // --- Listener de Status de Autenticação Principal (Controla a visão) ---
    const checkAuthStatus = () => {
        auth.onAuthStateChanged((user) => {
            if (user) {
                // Logado
                globalUser = user;
                els.authScreen.classList.remove('show');
                els.authScreen.classList.add('hidden');
                els.mainCard.style.display = 'block'; // Mostra o conteúdo
                els.logoutBtn.style.display = 'block';
                els.logoLink.style.display = 'block';
                
                loadVendasFromFirestore(els.filtroHistorico.value || ''); // Inicia o carregamento do histórico compartilhado
                showToast(`Bem-vindo, ${user.displayName || user.email.split('@')[0]}!`, 'success', 2000);
                
            } else {
                // Deslogado
                globalUser = null;
                els.authScreen.classList.add('show');
                els.authScreen.classList.remove('hidden');
                els.mainCard.style.display = 'none'; // Oculta o conteúdo
                els.logoutBtn.style.display = 'none';
                els.logoLink.style.display = 'none';
                clearAllFields(); // Limpa campos ao deslogar
            }
        });
    };

    // --- Configurações Iniciais e Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        // Simulação de carregamento do tema
        document.body.classList.add('dark');
        els.themeBtn.textContent = '☀️ Modo Claro';
        updateThemeLogo();
        
        // Listeners da Calculadora
        els.calculateBtn.addEventListener('click', updateCalculations);
        els.ticketsQtd.addEventListener('input', updateCalculations);
        els.tabletsQtd.addEventListener('input', updateCalculations);
        els.nitroQtd.addEventListener('input', updateCalculations);
        els.tipoValor.addEventListener('change', updateCalculations);
        els.obsValor.addEventListener('input', updateCalculations);
        
        els.telefone.addEventListener('input', (e) => formatTelefone(e.target));
        
        els.registerBtn.addEventListener('click', async () => {
            const vendaData = getVendaData();
            const total = updateCalculations();
            
            if (validateFields(vendaData)) {
                
                // Salva a venda no Firebase (seja nova ou edição)
                const finalData = { ...vendaData, total };
                await saveVendaToFirestore(finalData, vendaEmEdicaoId);
                
                clearAllFields();
            }
        });
        
        els.exportCsvBtn.addEventListener('click', () => {
             showToast("A funcionalidade de Exportar CSV precisa ser adaptada para o novo cálculo de materiais. Calcule a venda e copie o resultado manualmente.", "error", 4000);
             // Para uma implementação simples, use a lógica de calculate e gere o CSV a partir dela.
        });
        
        els.discordBtnCalc.addEventListener('click', copyDiscordFromCalc);
        
        // Listeners do Histórico e Navegação
        if (els.filtroHistorico) {
            els.filtroHistorico.addEventListener('input', () => {
                // Recarrega do Firebase com o filtro
                renderHistoricoComDados(window.vendas, els.filtroHistorico.value); 
            });
        }
        
        els.themeBtn.addEventListener('click',() => {
            document.body.classList.toggle('dark');
            document.body.classList.toggle('light');
            els.themeBtn.textContent = document.body.classList.contains('dark') ? '☀️ Modo Claro' : '🌙 Modo Noturno';
            updateThemeLogo(); 
        });
        
        els.tutorialBtn.addEventListener('click', startTour);
        els.toggleHistoryBtn.addEventListener('click', () => toggleView(true));
        
        // Se estiver editando, cancelar edição ao trocar para a calculadora
        els.toggleCalcBtn.addEventListener('click', () => {
            if (vendaEmEdicaoId) { 
                vendaEmEdicaoId = null;
                els.registerBtn.textContent = 'Registrar Venda';
                clearAllFields();
                showToast("Edição pendente cancelada.", "error", 2000);
            }
            toggleView(false);
        });
        
        els.logoLink.addEventListener('click', (e) => {
            e.preventDefault(); 
            if (vendaEmEdicaoId) {
                vendaEmEdicaoId = null;
                els.registerBtn.textContent = 'Registrar Venda';
                clearAllFields();
                showToast("Edição pendente cancelada.", "error", 2000);
            }
            toggleView(false); 
            clearTour(); 
        });
        
        // Listeners de Autenticação
        els.loginBtn.addEventListener('click', handleLogin);
        els.registerAuthBtn.addEventListener('click', handleRegister);
        els.logoutBtn.addEventListener('click', logout);
        
        // Inicia a verificação de status de autenticação (IMPORTANTE)
        checkAuthStatus();
    });
  </script>
</body>
</html>
