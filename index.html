<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/png" href="logo-dark.png">
  <title>Hells Angels</title>
  <style>
    :root {
      --cor-fundo: #fff0f6; --cor-texto: #4a0033; --cor-principal: #e60073;
      --cor-card: #ffffff; --cor-borda: #ffb3d9; --cor-btn-primario: #e60073;
      --cor-btn-texto: #fff; --cor-btn-secundario: #ffd6eb;
      --cor-btn-secundario-texto: #4a0033; --cor-erro: #cc0000;
      --cor-glow-pulsante: rgba(230, 0, 115, 0.8);
    }
    body.dark {
      --cor-fundo: #1a000d; --cor-texto: #ffccf0; --cor-principal: #ff0080; 
      --cor-card: #2c001a; --cor-borda: #e60073; --cor-btn-primario: #ff0080; 
      --cor-btn-texto: #fff; --cor-btn-secundario: #4d002a; 
      --cor-btn-secundario-texto: #ffccf0; --cor-glow-pulsante: rgba(255, 0, 128, 0.6);
    }
    body.dark input, body.dark select { background: #33001f; color: var(--cor-texto); border: 1px solid var(--cor-borda); }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 960px; margin: 24px auto; padding: 20px; background: var(--cor-fundo); color: var(--cor-texto); transition: background 0.25s ease, color 0.25s ease; }
    h1 { margin: 0; font-size: 24px; font-weight: 700; color: var(--cor-principal); text-align: center; flex-grow: 1; }
    .card { background: var(--cor-card); padding: 18px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid var(--cor-borda); margin-bottom: 20px; }
    .header-container { display:flex; justify-content: space-between; align-items: center; gap: 15px; margin-bottom: 12px; }
    .actions { margin-top: 14px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    button { padding: 8px 14px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 14px; transition: opacity 0.2s ease, box-shadow 0.3s ease; }
    button:hover { opacity: 0.85; }
    .primary { background: var(--cor-btn-primario); color: var(--cor-btn-texto); }
    .muted { background: var(--cor-btn-secundario); color: var(--cor-btn-secundario-texto); }
    .success { background: #00b33c; color: #fff; }
    .danger { background: var(--cor-erro); color: #fff; }
    .primary, .success { animation: pulse-glow 2s infinite ease-in-out; }
    @keyframes pulse-glow { 0% { box-shadow: 0 0 0 rgba(0,0,0,0); } 50% { box-shadow: 0 0 10px var(--cor-glow-pulsante); } 100% { box-shadow: 0 0 0 rgba(0,0,0,0); } }
    #adminPanel { display: none; }
    #authScreen .forgot-password { text-align: right; font-size: 13px; margin-top: -8px; margin-bottom: 10px; }
    #authScreen .forgot-password a { color: var(--cor-principal); text-decoration: none; }
    .history-table-wrapper { overflow-x: auto; width: 100%; margin-top: 8px; }
    #historyCard table { width: 100%; border-collapse: collapse; min-width: 1150px; }
    #historyCard th, #historyCard td { padding: 6px 8px; text-align: center; vertical-align: middle; white-space: nowrap; font-size: 14px; border-bottom: 1px solid var(--cor-borda); }
    #historyCard th { background: var(--cor-principal); color: var(--cor-btn-texto); }
    #historyCard td { background: var(--cor-card); opacity: 0.95; }
    /* Cole o resto do seu CSS aqui para manter o layout idêntico */
  </style>
</head>
<body>
  
  <div id="authScreen" class="card" style="max-width: 400px; margin: 100px auto 20px auto;">
      <h2>Autenticação</h2>
      <label for="username">Nome de Usuário:</label>
      <input id="username" type="text">
      <label for="password">Senha:</label>
      <input id="password" type="password">
      <div class="actions">
        <button id="loginBtn" class="primary">Entrar</button>
        <button id="registerUserBtn" class="muted">Cadastrar</button>
      </div>
  </div>

  <div class="card" id="mainCard" style="display:none">
    <div class="header-container">
        <h1>Calculadora e Registro de Vendas</h1>
        <div>
            <button id="adminPanelBtn" class="muted" style="display: none;">Painel Admin</button>
            <button id="toggleHistoryBtn" class="muted">Ver Histórico</button>
            <button id="logoutBtn" class="danger">Sair</button>
        </div>
    </div>
    </div>

  <div class="card" id="historyCard" style="display:none">
    <h2>Histórico de Vendas</h2>
    <div class="actions">
      <button id="clearHistoryBtn" class="danger">Limpar Histórico</button>
      <button id="toggleCalcBtn" class="muted">Voltar à Calculadora</button>
    </div>
    <div class="history-table-wrapper">
      <table id="historicoVendas">
        <thead>
          <tr>
              <th>Data/Hora</th><th>Cliente</th><th>Organização</th>
              <th>Registrado Por</th><th>Ações</th> 
          </tr>
        </thead>
        <tbody id="salesHistory"></tbody>
      </table>
    </div>
  </div>

  <div class="card" id="adminPanel" style="display:none">
    <h2>Painel de Administração</h2>
    <p>Aqui ficarão as ferramentas de gestão.</p>
    <button id="closeAdminPanelBtn" class="muted">Voltar à Calculadora</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, set, push, onValue, remove, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAhDVBfXoO_Rdi3e-trdbaaPppwDkTDgVc",
      authDomain: "hells-angels-438c2.firebaseapp.com",
      databaseURL: "https://hells-angels-438c2-default-rtdb.firebaseio.com/",
      projectId: "hells-angels-438c2"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    
    let vendas = [];
    let currentUser = null;
    let currentUserTag = 'Visitante'; // Padrão

    const els = {
      authScreen: document.getElementById('authScreen'),
      mainCard: document.getElementById('mainCard'),
      historyCard: document.getElementById('historyCard'),
      adminPanel: document.getElementById('adminPanel'),
      salesHistory: document.getElementById('salesHistory'),
      logoutBtn: document.getElementById('logoutBtn'),
      loginBtn: document.getElementById('loginBtn'),
      registerUserBtn: document.getElementById('registerUserBtn'),
      username: document.getElementById('username'),
      password: document.getElementById('password'),
      clearHistoryBtn: document.getElementById('clearHistoryBtn'),
      adminPanelBtn: document.getElementById('adminPanelBtn'),
      toggleHistoryBtn: document.getElementById('toggleHistoryBtn'),
      toggleCalcBtn: document.getElementById('toggleCalcBtn'),
      closeAdminPanelBtn: document.getElementById('closeAdminPanelBtn'),
      // Adicione aqui todos os outros `els` do seu ficheiro original
    };

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            const userRef = ref(db, `users/${user.uid}`);
            const snapshot = await get(userRef);
            currentUserTag = (snapshot.exists() && snapshot.val().tag) ? snapshot.val().tag : 'Visitante';
            
            if (!snapshot.exists()) {
                set(userRef, { username: user.displayName, tag: 'Visitante' });
            }

            els.authScreen.style.display = 'none';
            els.mainCard.style.display = 'block';
            els.adminPanelBtn.style.display = (currentUserTag === 'ADMIN') ? 'inline-block' : 'none';
            
            loadSales();
        } else {
            currentUser = null;
            currentUserTag = 'Visitante';
            els.authScreen.style.display = 'block';
            [els.mainCard, els.historyCard, els.adminPanel].forEach(el => el.style.display = 'none');
        }
    });
    
    function loadSales() {
        onValue(ref(db, 'vendas'), (snapshot) => {
            vendas = [];
            snapshot.forEach(child => vendas.push({ id: child.key, ...child.val() }));
            if (els.historyCard.style.display === 'block') displaySalesHistory();
        });
    }

    function displaySalesHistory() {
        const historyToDisplay = (currentUserTag === 'ADMIN' || currentUserTag === 'HELLS')
            ? vendas
            : vendas.filter(v => v.registradoPorUID === currentUser.uid);
        
        els.salesHistory.innerHTML = '';
        historyToDisplay.sort((a, b) => b.timestamp - a.timestamp).forEach(venda => {
            const row = els.salesHistory.insertRow();
            // Preencha as células com os dados da venda
            row.insertCell().textContent = venda.dataHora || 'N/A';
            row.insertCell().textContent = venda.cliente || 'N/A';
            row.insertCell().textContent = venda.organizacao || 'N/A';
            row.insertCell().textContent = venda.registradoPor || 'N/A';
            
            const actionsCell = row.insertCell();
            if ((currentUserTag === 'ADMIN') || (currentUser.uid === venda.registradoPorUID)) {
                actionsCell.innerHTML = `<button onclick="editVenda('${venda.id}')">Editar</button> <button onclick="removeVenda('${venda.id}')">Deletar</button>`;
            }
        });

        els.clearHistoryBtn.style.display = (currentUserTag === 'ADMIN') ? 'inline-block' : 'none';
    }

    // ADICIONE A SUA FUNÇÃO DE REGISTAR VENDA AQUI E LEMBRE-SE DE INCLUIR O UID
    // Exemplo:
    // function registerVenda() {
    //   ...
    //   const newVenda = {
    //     ...
    //     registradoPor: currentUser.displayName,
    //     registradoPorUID: currentUser.uid // **ESSENCIAL**
    //   };
    //   push(ref(db, 'vendas'), newVenda);
    // }

    window.editVenda = (id) => { console.log('Editar:', id); /* ... sua função de editar ... */ };
    window.removeVenda = (id) => { console.log('Remover:', id); /* ... sua função de remover ... */ };

    els.logoutBtn.onclick = () => auth.signOut();
    
    els.adminPanelBtn.onclick = () => {
        [els.mainCard, els.historyCard].forEach(el => el.style.display = 'none');
        els.adminPanel.style.display = 'block';
    };

    els.toggleHistoryBtn.onclick = () => {
        els.mainCard.style.display = 'none';
        els.historyCard.style.display = 'block';
        displaySalesHistory();
    };

    els.toggleCalcBtn.onclick = () => {
        els.mainCard.style.display = 'block';
        els.historyCard.style.display = 'none';
    };
    
    els.closeAdminPanelBtn.onclick = els.toggleCalcBtn.onclick;

    // Lógica de login/registo
    const handleAuth = (isRegistering) => {
        const email = els.username.value.trim() + "@ha.com";
        const password = els.password.value;
        const displayName = els.username.value.trim();

        if (isRegistering) {
            createUserWithEmailAndPassword(auth, email, password)
                .then(cred => updateProfile(cred.user, { displayName }))
                .catch(err => console.error("Erro no registo:", err));
        } else {
            signInWithEmailAndPassword(auth, email, password)
                .catch(err => console.error("Erro no login:", err));
        }
    };
    els.loginBtn.onclick = () => handleAuth(false);
    els.registerUserBtn.onclick = () => handleAuth(true);

  </script>
</body>
</html>
