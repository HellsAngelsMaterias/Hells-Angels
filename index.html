<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <link rel="icon" type="image/png" href="logo-dark.png">
  
  <title>Hells Angels</title>
  <style>
    :root {
      --cor-fundo: #fff0f6; --cor-texto: #4a0033; --cor-principal: #e60073;
      --cor-card: #ffffff; --cor-borda: #ffb3d9; --cor-btn-primario: #e60073;
      --cor-btn-texto: #fff; --cor-btn-secundario: #ffd6eb;
      --cor-btn-secundario-texto: #4a0033; --cor-erro: #cc0000;
      --cor-glow-pulsante: rgba(230, 0, 115, 0.8);\
      --cor-tag-admin: #0056b3; --cor-tag-hells: #e60073; --cor-tag-visitante: #008000;
    }
    body.dark {
      --cor-fundo: #1a000d; --cor-texto: #ffccf0; --cor-principal: #ff0080; 
      --cor-card: #2c001a; --cor-borda: #e60073; --cor-btn-primario: #ff0080; 
      --cor-btn-texto: #fff; --cor-btn-secundario: #4d002a; 
      --cor-btn-secundario-texto: #ffccf0; --cor-glow-pulsante: rgba(255, 0, 128, 0.6);
      --cor-tag-admin: #007bff; --cor-tag-hells: #ff0080; --cor-tag-visitante: #28a745;
    }
    body.dark input[type=number], body.dark input[type=text], body.dark select,
    body.dark .modal-content input[type=text], body.dark .modal-content textarea,
    body.dark #modalListaVeiculos {
      background: #33001f; color: var(--cor-texto); border: 1px solid var(--cor-borda);
    }
    .modal-content textarea {
        width: 100%; box-sizing: border-box; min-height: 80px;
        padding: 8px; border-radius: 6px; border: 1px solid var(--cor-borda);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    input[list]:focus, input[list]:hover { border-color: var(--cor-principal) !important; box-shadow: 0 0 5px rgba(230, 0, 115, 0.4); }
    input[list] { position: relative; z-index: 1; }
    input[list]::-webkit-calendar-picker-indicator { display: none; }
    .suggestion-tip { font-size: 11px; color: var(--cor-principal); margin-top: 4px; margin-bottom: 0; font-weight: 500; opacity: 0.8; }
    
    #tour-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.6); z-index: 10000; opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }
    #tour-overlay.active { opacity: 1; }
    .tour-tooltip {
      position: absolute; background: var(--cor-principal); color: var(--cor-btn-texto);
      padding: 15px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      max-width: 300px; text-align: left; opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease; z-index: 10002;
    }
    .tour-tooltip.active { opacity: 1; transform: translateY(0); }
    .tour-tooltip h4 { margin: 0 0 5px; font-size: 16px; color: var(--cor-btn-texto); }
    .tour-tooltip p { margin: 0; font-size: 14px; margin-bottom: 10px; }
    .tour-tooltip button {
        background: var(--cor-btn-secundario); color: var(--cor-btn-secundario-texto);
        padding: 6px 10px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; margin-right: 8px;
    }
    .tour-highlight {
      position: relative; z-index: 10001; 
      box-shadow: 0 0 0 3px var(--cor-principal), 0 0 15px var(--cor-principal);
      border-radius: 6px;
    }
    
    input.input-invalido, select.input-invalido, textarea.input-invalido { 
        border: 2px solid var(--cor-erro) !important; 
        box-shadow: 0 0 4px var(--cor-erro); 
    }
    #logoLink { position: fixed; top: 16px; left: 16px; width: auto; max-height: 80px; cursor: pointer; z-index: 9998; }
    .app-logo { max-height: 80px; width: auto; transition: opacity 0.3s ease, filter 0.3s ease; display: block; }
    #appLogo:hover { filter: drop-shadow(0 0 8px var(--cor-principal)) drop-shadow(0 0 15px var(--cor-glow-pulsante)); opacity: 0.9; }
    
    #welcomeLogo { max-width: 80%; max-height: 120px; margin-bottom: 25px; display: block; }
    #welcomeScreen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: var(--cor-card); z-index: 10000; display: none; 
      flex-direction: column; justify-content: center; align-items: center;
      text-align: center; transition: opacity 0.5s ease;
      padding: 20px; box-sizing: border-box; 
    }
    #welcomeScreen.show { display: flex; }
    #welcomeScreen.hidden { opacity: 0; pointer-events: none; }
    #welcomeScreen h2 { font-size: 36px; margin-top: 10px; margin-bottom: 20px; color: var(--cor-principal); }
    #welcomeScreen button { padding: 12px 24px; font-size: 18px; border-radius: 10px; margin-top: 10px; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 960px; margin: 24px auto; padding: 20px;
      background: var(--cor-fundo); color: var(--cor-texto);
      transition: background 0.25s ease, color 0.25s ease, max-width 0.4s ease-in-out;
    }
    body.history-view-active { max-width: 1200px; }
    body.dossier-view-active { max-width: 1200px; }

    #mainCard { display: block; }
    h1 { margin: 0; font-size: 24px; font-weight: 700; color: var(--cor-principal); text-align: center; flex-grow: 1; }
    h2 { font-size: 20px; font-weight: 600; margin-bottom: 10px; color: var(--cor-principal); }
    h3 { color: var(--cor-principal); font-weight:600; margin-top: 16px; }
    h4 { color: var(--cor-principal); font-weight:600; margin-top: 16px; }

    .card {
      background: var(--cor-card); padding: 18px; border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid var(--cor-borda);
      margin-bottom: 20px;
    }
    
    .header-container { display:flex; justify-content: space-between; align-items: center; gap: 15px; margin-bottom: 12px; }

    .user-status-display {
      font-size: 14px;
      font-weight: 700;
      padding: 6px 12px;
      border-radius: 8px;
      color: var(--cor-btn-texto);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-left: 10px;
    }
    .user-status-display.tag-admin { background-color: var(--cor-tag-admin); }
    .user-status-display.tag-hells { background-color: var(--cor-tag-hells); }
    .user-status-display.tag-visitante { background-color: var(--cor-tag-visitante); }
    
    label { display: block; margin: 10px 0 6px; font-weight: 600; color: var(--cor-principal); }
    input[type=number], input[type=text], select {
      width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--cor-borda);
      background: #fff; color: var(--cor-texto); font-size: 14px; box-sizing: border-box;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    input[type=number] { width: 140px; }
    
    input#placaVeiculo {
        text-transform: uppercase;
    }

    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 14px; margin-top: 12px; }
    
    /* --- MUDAN√áA DE LAYOUT (LINHAS 2-2-2-3) --- */
    .grid-venda { grid-template-columns: 1fr 1fr; }
    
    .grid-venda-3col { 
        display: grid; 
        grid-template-columns: 1fr 1fr 1fr; 
        gap: 14px; 
        grid-column: 1 / -1; /* Span full width */
    }
    /* --- FIM DA MUDAN√áA --- */

    table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 14px; }
    th, td { padding: 6px; border-bottom: 1px solid var(--cor-borda); text-align: left; }
    th { background: var(--cor-btn-secundario); color: var(--cor-btn-secundario-texto); font-weight: 600; }
    
    .actions { margin-top: 14px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    button {
      padding: 8px 14px; border-radius: 8px; border: none; cursor: pointer;
      font-weight: 600; font-size: 14px; transition: opacity 0.2s ease, box-shadow 0.3s ease;
    }
    button:hover { opacity: 0.85; }
    button:disabled { cursor: not-allowed; background-color: #ccc; }
    
    .primary, .success { animation: pulse-glow 2s infinite ease-in-out; }
    @keyframes pulse-glow {
        0% { box-shadow: 0 0 0 rgba(0, 0, 0, 0); }
        50% { box-shadow: 0 0 10px var(--cor-glow-pulsante), 0 0 20px var(--cor-glow-pulsante); }
        100% { box-shadow: 0 0 0 rgba(0, 0, 0, 0); }
    }

    .primary { background: var(--cor-btn-primario); color: var(--cor-btn-texto); }
    .muted { background: var(--cor-btn-secundario); color: var(--cor-btn-secundario-texto); }
    .success { background: #00b33c; color: #fff; }
    .danger { background: var(--cor-erro); color: #fff; }

    .top-right-controls { position: fixed; top: 16px; right: 16px; display: flex; flex-direction: column; gap: 10px; z-index: 9999; }
    .control-btn {
        padding: 10px 14px; border-radius: 10px; background: var(--cor-btn-primario);
        color: var(--cor-btn-texto); font-weight: 700; cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2); border: none;
        transition: opacity 0.2s ease;
    }
    .control-btn:hover { opacity: 0.85; }
    
    #historyBackground {
      background: rgba(255, 255, 255, 0.7); 
      position: relative; padding: 18px; border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid var(--cor-borda);
      margin-bottom: 20px; max-height: 75vh; overflow-y: auto;
    }
    body.dark #historyBackground { background: rgba(44, 0, 26, 0.7); }
    #historyBackground img {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%); width: 100%; height: auto;
      opacity: 0.3; z-index: 1; object-fit: contain; 
    }
    #historyBackground > * { position: relative; z-index: 2; }

    #toast-container {
        position: fixed; bottom: 20px; right: 20px; z-index: 10005; 
        display: flex; flex-direction: column-reverse; gap: 10px; align-items: flex-end; 
    }
    .toast {
        background-color: var(--cor-principal); color: var(--cor-btn-texto);
        padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        opacity: 0; transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        transform: translateY(20px); max-width: 300px; min-width: 150px; text-align: center;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { background-color: #00b33c; }
    .toast.error { background-color: var(--cor-erro); }
    
    .action-btn { padding: 4px 8px; font-size: 12px; margin-right: 0px; border-radius: 4px; }
    
    .history-table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; width: 100%; margin-top: 8px; }
    #historyCard table {
        width: 100%; border-collapse: collapse; table-layout: fixed;
        min-width: 1150px; background: transparent; 
    }
    #historyCard th, #historyCard td {
        padding: 6px 8px; text-align: center; vertical-align: middle;
        white-space: nowrap; font-size: 14px; border-bottom: 1px solid var(--cor-borda);
    }
    #historyCard td { background: var(--cor-card); opacity: 0.95; }
    body.dark #historyCard td { background: var(--cor-card); opacity: 0.95; }
    
    #historyCard th:nth-child(1), #historyCard td:nth-child(1) { width: 100px; }
    #historyCard th:nth-child(2), #historyCard td:nth-child(2) { width: 140px; }
    #historyCard th:nth-child(3), #historyCard td:nth-child(3) { width: 160px; }
    #historyCard th:nth-child(4), #historyCard td:nth-child(4) { width: 120px; }
    #historyCard th:nth-child(5), #historyCard td:nth-child(5) { width: 220px; }
    #historyCard th:nth-child(6), #historyCard td:nth-child(6) { width: 150px; }
    #historyCard th:nth-child(7), #historyCard td:nth-child(7) { width: 130px; }
    #historyCard th:nth-child(8), #historyCard td:nth-child(8) { width: 120px; }
    #historyCard th:nth-child(9), #historyCard td:nth-child(9) { width: 150px; }

    .history-datetime-line { display: block; line-height: 1.2; font-size: 13px; }
    .valor-total-cell span:first-child { font-weight: 700; }
    .valor-obs-text { font-size: 12px; color: var(--cor-principal); }

    .history-actions-cell { display: flex; align-items: center; justify-content: center; gap: 5px; }
    .history-actions-cell button { padding: 4px 8px; font-size: 11px; border-radius: 4px; white-space: nowrap; }

    #historyCard tr { height: 40px; }
    #historyCard th { background: var(--cor-principal); color: var(--cor-btn-texto); }

    #authScreen { padding: 25px; border-radius: 16px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); }
    #authScreen h2 {
        text-align: center; margin-bottom: 20px; padding-bottom: 10px;
        border-bottom: 2px solid var(--cor-borda); font-size: 26px;
    }
    #authScreen input[type=text], #authScreen input[type=password] {
        padding: 12px; font-size: 16px; border-radius: 8px;
        border: 1px solid var(--cor-borda); transition: all 0.3s ease;
    }
    #authScreen input[type=text]:focus, #authScreen input[type=password]:focus {
        border-color: var(--cor-principal) !important;
        box-shadow: 0 0 10px rgba(230, 0, 115, 0.5);
    }
    #authScreen .actions { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
    #authScreen .actions button { width: 100%; padding: 12px; font-size: 16px; }
    #authMessage { text-align: center; font-weight: 600; }
    
    #bottomPanel {
        position: fixed; bottom: 0; left: 0; width: 100%;
        background: var(--cor-card); border-top: 2px solid var(--cor-principal);
        box-shadow: 0 -4px 15px rgba(0,0,0,0.2);
        padding: 10px 20px; z-index: 9997;
        display: none;
        justify-content: center; align-items: center; gap: 20px;
    }
    
    /* --- IN√çCIO DOS NOVOS ESTILOS DO DOSSI√ä (v6) --- */
    .dossier-org-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
        gap: 20px;
        margin-top: 15px;
    }
    .dossier-org-card {
        background: var(--cor-card);
        border: 1px solid var(--cor-borda);
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        text-align: center;
        transition: box-shadow 0.2s ease, transform 0.2s ease;
        /* Habilita o drag-and-drop para bases */
        cursor: grab; 
        overflow: hidden; 
    }
    .dossier-org-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 15px rgba(0,0,0,0.12);
    }
    .dossier-org-card:active {
        cursor: grabbing;
    }
    .dossier-org-card h4 { /* Nome da Org */
        margin: 12px 10px 12px 10px;
        font-size: 20px;
        color: var(--cor-principal);
        font-weight: 700;
        word-wrap: break-word;
    }
    .dossier-org-card .dossier-org-foto {
        width: 100%;
        height: 160px; 
        object-fit: cover; 
        background-color: var(--cor-btn-secundario); 
        color: var(--cor-btn-secundario-texto);
        display: flex;
        align-items: center;
        justify-content: center;
        font-style: italic;
        font-size: 14px;
        overflow: hidden; 
        border-bottom: 1px solid var(--cor-borda);
    }
    .dossier-org-card .dossier-org-foto img {
         width: 100%;
         height: 100%;
         object-fit: cover; 
    }
    .dossier-org-card p { /* Info da Base */
        font-size: 13px;
        color: var(--cor-texto);
        padding: 0 12px 12px 12px;
        margin: 0;
        min-height: 30px;
        white-space: pre-wrap; /* Mant√©m quebras de linha */
    }
    .dossier-org-card .dossier-org-actions {
        border-top: 1px solid var(--cor-borda);
        padding: 8px;
        background: var(--cor-btn-secundario);
    }
    .dossier-org-card .dossier-org-actions button {
        font-size: 12px;
        padding: 5px 10px;
    }
    
    #dossierPeopleHeader {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    #dossierPeopleHeader h2 {
        margin: 0;
    }
    
    .dossier-people-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
        gap: 16px;
        margin-top: 15px;
    }
    /* --- FIM DOS NOVOS ESTILOS DO DOSSI√ä (v6) --- */
    
    .dossier-org-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--cor-principal);
        margin: 20px 0 5px 0;
        padding-bottom: 5px;
        border-bottom: 2px solid var(--cor-borda);
        /* --- MUDAN√áA: COMPACTAR T√çTULO DE BUSCA --- */
        font-size: 16px;
        margin-top: 5px; /* Reduz o espa√ßo superior */
        margin-bottom: 10px; /* Adiciona um pouco de espa√ßo para separar do grid */
        border-bottom: none; /* Remove a linha */
        padding-bottom: 0;
        /* --- FIM DA MUDAN√áA --- */
    }
    
    /* Grid de Pessoas (Estilo antigo, renomeado) */
    .dossier-entry-card {
        background: var(--cor-card);
        border: 1px solid var(--cor-borda);
        border-radius: 10px;
        padding: 12px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.07);
        text-align: center;
        font-size: 14px;
        display: flex;
        flex-direction: column;
        gap: 5px;
        transition: box-shadow 0.2s ease, transform 0.2s ease;
        /* --- MUDAN√áA: HIERARQUIA --- */
        cursor: grab;
    }
    .dossier-entry-card:active {
        cursor: grabbing;
    }
    /* --- FIM DA MUDAN√áA --- */
    
    .dossier-entry-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .dossier-entry-card h4 { /* Nome */
        margin: 5px 0 0 0;
        font-size: 17px;
        color: var(--cor-principal);
        font-weight: 700;
        word-wrap: break-word;
    }
    .dossier-entry-card p {
        margin: 0;
        line-height: 1.4;
        word-wrap: break-word;
    }
    .dossier-entry-card .dossier-foto {
        width: 100%;
        height: 180px; 
        object-fit: cover; 
        border-radius: 8px;
        background-color: var(--cor-btn-secundario); 
        color: var(--cor-btn-secundario-texto);
        display: flex;
        align-items: center;
        justify-content: center;
        font-style: italic;
        font-size: 13px;
        overflow: hidden; 
    }
    .dossier-entry-card .dossier-foto img {
         width: 100%;
         height: 100%;
         object-fit: cover; 
    }
    .dossier-entry-card .dossier-actions {
        margin-top: 10px;
        display: flex;
        justify-content: center;
        gap: 6px;
    }
    .dossier-entry-card .dossier-actions button {
        font-size: 12px;
        padding: 5px 10px;
    }

    .modal-overlay {
        display: none; position: fixed; top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.6);
        z-index: 10010;
    }
    .modal-content {
        display: none; position: fixed;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10011; width: 90%; max-width: 500px;
        max-height: 85vh; overflow-y: auto;
    }
    .modal-content input[type=text] {
        width: 100%; box-sizing: border-box; 
    }
    .modal-content label {
        margin-top: 10px;
    }
    
    /* --- MUDAN√áA: HIERARQUIA (Estilo "Fantasma") --- */
    .sortable-ghost {
        opacity: 0.4;
        background: var(--cor-btn-secundario);
    }
    /* --- FIM DA MUDAN√áA --- */
    
    /* --- NOVO GERENCIADOR DE VE√çCULOS (MODAL) --- */
    #modalListaVeiculos, #addModalListaVeiculos, #editModalListaVeiculos {
        margin-top: 10px; max-height: 120px; overflow-y: auto; 
        background: var(--cor-fundo); border-radius: 6px; 
        padding: 8px; border: 1px solid var(--cor-borda);
        min-height: 40px;
    }
    .veiculo-item-modal {
        display: flex; justify-content: space-between; align-items: center;
        padding: 4px; border-bottom: 1px solid var(--cor-borda);
        font-size: 14px;
    }
    .veiculo-item-modal:last-child { border-bottom: none; }
    .veiculo-item-modal span { word-break: break-all; }
    .veiculo-item-modal button { 
        font-size: 11px; padding: 3px 6px; 
        flex-shrink: 0; margin-left: 5px; /* Reduzido o margin-left */
    }
    /* --- FIM --- */
    
    /* --- IN√çCIO: NOVOS ESTILOS (Lightbox e Edi√ß√£o de Ve√≠culo) --- */
    #imageLightboxModal {
        display: none; /* Escondido por padr√£o */
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10012; /* Acima dos outros modais */
        max-width: 90vw;
        max-height: 90vh;
        background: #fff;
        padding: 10px;
        border-radius: 12px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.4);
    }
    #lightboxImg {
        max-width: 100%;
        max-height: 85vh; /* Um pouco menor que o modal para caber */
        display: block;
        border-radius: 8px;
    }
    body.dark #imageLightboxModal {
        background: var(--cor-card);
        border: 1px solid var(--cor-borda);
    }
    .btn-cancel-veiculo {
        display: none; /* Escondido por padr√£o */
        background-color: #888;
        color: #fff;
    }
    /* --- FIM: NOVOS ESTILOS --- */

    @media (max-width: 500px) {
        body { padding: 10px; margin: 10px auto; }
        .top-right-controls { top: 10px; right: 10px; }
        .control-btn { padding: 8px 10px; font-size: 12px; }
        .grid, .grid-venda { grid-template-columns: 1fr; }
        .user-status-display { display: none; }
        
        .dossier-org-grid, .dossier-people-grid {
             grid-template-columns: 1fr; 
        }
    }
  </style>
</head>
<body class="light">
  
  <a href="#" id="logoLink">
    <img id="appLogo" src="logo-dark.png" alt="Hells Angels Logo" class="app-logo">
  </a>

  <div id="welcomeScreen"> 
      <img id="welcomeLogo" src="logo-dark.png" alt="Welcome Logo"> 
      <h2 style="font-weight: 900;">Bem-vindo(a)</h2>
      <p style="margin-bottom: 20px; font-size: 16px;">Calculadora e Registro de Vendas Hells Angels</p>
      <button id="enterBtn" class="primary">Entrar no Site</button>
  </div>
  
  <div class="top-right-controls">
      <button class="control-btn" id="tutorialBtn">üí° Tutorial</button> 
      <button class="control-btn" id="themeBtn">üåô Modo Noturno</button>
      <button class="control-btn" id="investigacaoBtn" style="display:none; background-color: #0056b3;">üîé Investiga√ß√£o</button> 
  </div>

  <div id="authScreen" class="card" style="max-width: 400px; margin: 100px auto 20px auto; display: none;">
      <img src="logo-dark.png" alt="Hells Angels Logo" style="display: block; max-height: 100px; margin: 0 auto 20px auto;">
      <h2>Autentica√ß√£o de Usu√°rio</h2>
      <label for="username">Nome de Usu√°rio:</label>
      <input id="username" type="text" placeholder="Seu nome de usu√°rio">
      <label for="password">Senha:</label>
      <input id="password" type="password" placeholder="Sua senha">
      <div class="actions">
          <button id="loginBtn" class="primary">Entrar</button>
          <button id="registerUserBtn" class="muted">Cadastrar</button>
      </div>
      <a href="#" id="forgotPasswordLink" style="text-align: center; display: block; margin-top: 15px;">Esqueci a Senha</a>
      <p id="authMessage" style="color: var(--cor-erro); margin-top: 10px;"></p>
  </div>

  <div class="card" id="mainCard" style="display:none">
    <div class="header-container">
        <h1 id="mainTitle">Calculadora e Registro de Vendas</h1>
        <span id="userStatus" class="user-status-display" style="display:none;"></span>
        <button id="logoutBtn" class="danger" style="animation: none;">Sair</button>
    </div>
    
    <div class="card-venda">
        <h2>Dados da Venda</h2>
        <div class="grid grid-venda">
            <div>
                <label for="nomeCliente">Nome:</label>
                <input id="nomeCliente" type="text" value="">
            </div>
            <div>
                <label for="dataVenda">Data e Hor√°rio:</label>
                <input id="dataVenda" type="text" readonly> 
            </div>
            <div>
                <label for="organizacao">Organiza√ß√£o:</label>
                <input id="organizacao" type="text" value="" list="sugestoesOrganizacao">
                <p class="suggestion-tip">Digite para ver sugest√µes de organiza√ß√µes.</p>
                <datalist id="sugestoesOrganizacao">
                    <option value="Hells Angels"></option>
                    <option value="Serpents"></option> <option value="Nox"></option> <option value="NKT"></option> <option value="Ruptura"></option> <option value="Midnight"></option> <option value="Meraki"></option> <option value="Lotus"></option> <option value="Hydra"></option> <option value="Hooligans"></option> <option value="Families"></option> <option value="Cartel"></option> <option value="Blood Street"></option> <option value="Blood Reapers"></option> <option value="Blue Diamond"></option> <option value="Black Heart"></option> <option value="Ballas"></option> <option value="Aura"></option> <option value="Anarquia"></option> <option value="8 Anjo"></option> <option value="Vagos"></option> <option value="Vertice"></option> <option value="Void"></option> <option value="Solo"></option>
                </datalist>
            </div>
            <div>
                <label for="organizacaoTipo">Op√ß√£o (CNPJ/CPF):</label>
                <select id="organizacaoTipo">
                    <option value="CNPJ">CNPJ (Obrigat√≥rio)</option>
                    <option value="CPF">CPF (Opcional)</option>
                    <option value="OUTROS">Outros (Opcional)</option>
                </select>
            </div>
            <div>
                <label for="telefone">Telefone:</label>
                <input id="telefone" type="text" value="" maxlength="13"> 
            </div>
            
            <div>
                <label for="negociadoras">Negociadoras:</label>
                <input id="negociadoras" type="text" value="">
            </div>
            
            <div class="grid-venda-3col">
                <div>
                    <label for="carroVeiculo">Carro(s) (Opcional):</label>
                    <input id="carroVeiculo" type="text" value="">
                    <p class="suggestion-tip">Separe m√∫ltiplos com v√≠rgula.</p>
                </div>
                <div>
                    <label for="placaVeiculo">Placa(s) (Opcional):</label>
                    <input id="placaVeiculo" type="text" value="">
                    <p class="suggestion-tip">Separe m√∫ltiplos com v√≠rgula.</p>
                </div>
                <div>
                    <label for="vendaValorObs">Cargo:</label>
                    <input id="vendaValorObs" type="text" value="">
                </div>
            </div>
        </div>
    </div>
    
    <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--cor-borda);">

    <h2>C√°lculo de Produtos</h2>
    <p class="small">Informe quantos produtos deseja fabricar/vender e escolha o tipo de valor.</p>

    <div class="grid">
      <div>
        <label for="qtyTickets">Quantidade de Tickets</label>
        <input id="qtyTickets" type="number" min="0" value="">
      </div>
      <div>
        <label for="qtyTablets">Quantidade de Tablets</label>
        <input id="qtyTablets" type="number" min="0" value="">
      </div>
      <div>
        <label for="qtyNitro">Quantidade de Nitro</label>
        <input id="qtyNitro" type="number" min="0" value="">
      </div>
      <div>
        <label for="tipoValor">Tipo de Valor</label>
        <select id="tipoValor">
          <option value="limpo">Dinheiro Limpo</option>
          <option value="sujo">Dinheiro Sujo</option>
          <option value="limpo_alianca">Limpo (Alian√ßa)</option>
          <option value="sujo_alianca">Sujo (Alian√ßa)</option>
        </select>
      </div>
    </div>

    <div class="actions">
      <button id="calcBtn" class="primary">Calcular</button>
      <button id="resetBtn" class="muted">Limpar Campos</button>
      <button id="registerBtn" class="success">Registrar Venda</button>
      <button id="toggleHistoryBtn" class="muted">Ver Hist√≥rico</button>
      <button id="csvBtn" class="muted">Exportar CSV</button>
      <button id="discordBtnCalc" class="muted">Discord</button>
      <button id="adminPanelBtn" class="muted" style="display:none; background-color: #ffb3d9;">Painel Admin</button>
    </div>

    <div id="resultsContainer">
      <div id="results" style="margin-top:16px;display:none">
        <h3>Totais necess√°rios</h3>
        <table>
          <thead><tr><th>Material</th><th>Quantidade total</th></tr></thead>
          <tbody id="resultsBody"></tbody>
        </table>

        <h3>Valores Estimados</h3>
        <table>
          <thead><tr><th>Produto</th><th>Valor Total</th></tr></thead>
          <tbody id="valuesBody"></tbody>
          <tfoot>
            <tr><th>Total Geral</th><th id="valorTotalGeral">R$ 0</th></tr>
          </tfoot>
        </table>
        <p class="result-note" style="font-size: 12px; margin-top: 8px;">Os valores variam conforme o tipo selecionado (limpo, sujo, alian√ßa).</p>
      </div>
    </div>
  </div>
  
  <div class="card" id="adminPanel" style="display:none;">
      <h2>Painel do Administrador (Hierarquia)</h2>
      
      <div class="actions" style="margin-top: 0; margin-bottom: 15px; justify-content: flex-end;">
          <button id="toggleCalcBtnAdmin" class="muted">Voltar √† Calculadora</button>
      </div>
      
      <h3>Gerenciamento de Usu√°rios</h3>
      <p style="font-size: 13px;">Altere a permiss√£o de usu√°rios. Voc√™ n√£o pode alterar sua pr√≥pria tag.</p>
      <div class="history-table-wrapper">
          
          <table id="adminUserTable">
              <thead>
                  <tr>
                      <th style="width: 45%;">Usu√°rio (Nome)</th>
                      <th style="width: 40%;">Permiss√£o (Tag)</th>
                      <th style="width: 15%;">A√ß√µes</th>
                  </tr>
              </thead>
              <tbody id="adminUserListBody">
                  <tr><td colspan="3" style="text-align: center;">Carregando usu√°rios...</td></tr>
              </tbody>
          </table>

      </div>

      <h3 style="margin-top: 20px;">Controles de Layout Global</h3>
      <p style="font-size: 13px;">Habilite ou desabilite recursos para todos os usu√°rios do site em tempo real.</p>
      <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
          <label style="display: flex; align-items: center; gap: 8px; margin: 0;">
              <input type="checkbox" id="layoutToggleNightMode" style="width: auto;">
              Habilitar o bot√£o "Modo Noturno" para todos
          </label>
          <label style="display: flex; align-items: center; gap: 8px; margin: 0;">
              <input type="checkbox" id="layoutToggleBottomPanel" style="width: auto;">
              Ligar "Painel Inferior" para todos
          </label>
      </div>
      
      <h3 style="margin-top: 20px;">A√ß√µes de Dossi√™</h3>
      <p style="font-size: 13px;">Se voc√™ tem vendas antigas, clique no bot√£o abaixo UMA VEZ para copi√°-las para o novo sistema de Dossi√™.</p>
      <button id="migrateDossierBtn" class="danger" style="animation: none;">Migrar Vendas Antigas para Dossi√™</button>
      
      <p style="font-size: 13px; margin-top: 15px;">Se voc√™ usava o sistema antigo de Carros/Placas (com v√≠rgulas), clique abaixo UMA VEZ para migrar para o novo gerenciador.</p>
      <button id="migrateVeiculosBtn" class="danger" style="animation: none; background-color: #cc0000;">Migrar Ve√≠culos Antigos (Dossi√™)</button>
      
  </div>


  <div class="card" id="historyCard" style="display:none">
      <div id="historyBackground" class="card">
        <h2>Hist√≥rico de Vendas Registradas</h2>
        <img id="historyImg" src="logo-dark.png" alt="Fundo Hist√≥rico"> 
        <input type="text" id="filtroHistorico" placeholder="üîç Pesquisar no hist√≥rico (Nome, Data, Item, etc.)" style="margin-bottom: 10px; width: 100%;">
        <div class="actions">
          <button id="clearHistoryBtn" class="muted">Limpar Hist√≥rico</button>
          <button id="toggleCalcBtn" class="muted">Voltar √† Calculadora</button>
        </div>
        <div class="history-table-wrapper"><table id="historicoVendas">
          <thead>
              <tr>
                  <th>Data/Hora</th>
                  <th>Cliente</th>
                  <th>Organiza√ß√£o/Tipo</th>
                  <th>Telefone</th>
                  <th>Produtos (Unidade)</th>
                  <th>Valor Total</th>
                  <th>Negociadoras</th>
                  <th>Registrado Por</th> 
                  <th>A√ß√µes</th> 
              </tr>
          </thead>
          <tbody id="salesHistory"></tbody>
        </table></div>
      </div>
  </div>
  
  <div class="card" id="dossierCard" style="display:none">
      
      <div id="dossierOrgContainer">
          <h2>Sistema de Investiga√ß√£o (Bases)</h2>
          <div class="actions" style="margin-top: 0; margin-bottom: 10px;">
              <input type="text" id="filtroDossierOrgs" placeholder="üîç Buscar por Base ou Nome de Pessoa..." style="margin: 0; flex-grow: 1;">
              <button id="addOrgBtn" class="success" style="animation: none; margin-left: 10px;">+ Adicionar Base</button>
              <button id="toggleCalcBtnDossier" class="muted">Voltar √† Calculadora</button>
          </div>
          <div id="dossierOrgGrid" class="dossier-org-grid" style="margin-top: 15px;">
              <p>Carregando bases...</p>
          </div>
      </div>
      
      <div id="dossierPeopleContainer" style="display:none;">
          <div id="dossierPeopleHeader">
              <h2 id="dossierPeopleTitle">Membros</h2>
              <button id="dossierVoltarBtn" class="muted">‚Üê Voltar para Bases</button>
          </div>
           <div class="actions" style="margin-top: 0; margin-bottom: 10px;">
              <input type="text" id="filtroDossierPeople" placeholder="üîç Buscar por Nome, Carro ou Placa(s)..." style="margin: 0; flex-grow: 1;">
              <button id="addPessoaBtn" class="success" style="animation: none; margin-left: 10px;">+ Adicionar Pessoa</button>
          </div>
          <div id="dossierPeopleGrid" class="dossier-people-grid" style="margin-top: 15px;">
              <p>Carregando membros...</p>
          </div>
      </div>
  </div>
  
  
  <div id="toast-container"></div>
  
  <div id="bottomPanel">
      <span>Este √© o painel inferior. O conte√∫do pode ser personalizado.</span>
  </div>
  
  <div id="editDossierOverlay" class="modal-overlay"></div>
  <div id="editDossierModal" class="card modal-content">
      <h2>Editar Entrada do Dossi√™</h2>
      <input type="hidden" id="editDossierOrg">
      <input type="hidden" id="editDossierId">
      
      <label for="editDossierNome">Nome:</label>
      <input type="text" id="editDossierNome">
      
      <label for="editDossierNumero">N√∫mero:</label>
      <input type="text" id="editDossierNumero" maxlength="13">
      
      <label for="editDossierCargo">Cargo:</label>
      <input type="text" id="editDossierCargo">
      
      <label for="editDossierFotoUrl">Foto URL:</label>
      <input type="text" id="editDossierFotoUrl" placeholder="Cole o link da imagem aqui (ex: https://i.imgur.com/...)">
      
      <label for="editDossierInstagram">Instagram:</label>
      <input type="text" id="editDossierInstagram" placeholder="@usuario (opcional)">
      <h4 style="margin-top:15px; margin-bottom: 5px; color: var(--cor-principal);">Gerenciador de Ve√≠culos</h4>
      <div class="grid grid-venda" style="gap: 10px;">
          <input type="text" id="editModalCarroNome" placeholder="Nome do Carro">
          <input type="text" id="editModalCarroPlaca" placeholder="Placa" style="text-transform: uppercase;">
          
          <input type="text" id="editModalCarroFoto" placeholder="Foto URL (Opcional)" style="grid-column: 1 / -1;"> 
          
          <button id="editModalAddVeiculoBtn" class="muted" style="grid-column: 1 / -1; padding: 6px; height: 100%;">+ Adicionar Ve√≠culo</button>
          
          <button id="editModalCancelVeiculoBtn" class="muted btn-cancel-veiculo" style="grid-column: 1 / -1; padding: 6px;">Cancelar Edi√ß√£o</button>
      </div>
      <div id="editModalListaVeiculos">
          </div>
      
      <div class="actions" style="margin-top: 20px;">
          <button id="saveDossierBtn" class="success">Salvar</button>
          <button id="cancelDossierBtn" class="muted">Cancelar</button>
      </div>
  </div>
  
  <div id="addDossierOverlay" class="modal-overlay"></div>
  <div id="addDossierModal" class="card modal-content">
      <h2>Adicionar Pessoa ao Dossi√™</h2>
      
      <label for="addDossierOrganizacao">Organiza√ß√£o: (Autom√°tico)</label>
      <input type="text" id="addDossierOrganizacao" readonly disabled>
      
      <label for="addDossierNome">Nome:</label>
      <input type="text" id="addDossierNome">
      
      <label for="addDossierNumero">N√∫mero:</label>
      <input type="text" id="addDossierNumero" maxlength="13">
      
      <label for="addDossierCargo">Cargo:</label>
      <input type="text" id="addDossierCargo">
      
      <label for="addDossierFotoUrl">Foto URL:</label>
      <input type="text" id="addDossierFotoUrl" placeholder="Cole o link da imagem aqui (ex: https://i.imgur.com/...)">
      
      <h4 style="margin-top:15px; margin-bottom: 5px; color: var(--cor-principal);">Gerenciador de Ve√≠culos</h4>
      <div class="grid grid-venda" style="gap: 10px;">
          <input type="text" id="addModalCarroNome" placeholder="Nome do Carro">
          <input type="text" id="addModalCarroPlaca" placeholder="Placa" style="text-transform: uppercase;">
          
          <input type="text" id="addModalCarroFoto" placeholder="Foto URL (Opcional)" style="grid-column: 1 / -1;"> 
          
          <button id="addModalAddVeiculoBtn" class="muted" style="grid-column: 1 / -1; padding: 6px; height: 100%;">+ Adicionar Ve√≠culo</button>
          
          <button id="addModalCancelVeiculoBtn" class="muted btn-cancel-veiculo" style="grid-column: 1 / -1; padding: 6px;">Cancelar Edi√ß√£o</button>
      </div>
      <div id="addModalListaVeiculos">
          </div>
      
      <div class="actions" style="margin-top: 20px;">
          <button id="saveNewDossierBtn" class="success">Salvar Nova Pessoa</button>
          <button id="cancelNewDossierBtn" class="muted">Cancelar</button>
      </div>
  </div>
  
  <div id="orgModalOverlay" class="modal-overlay"></div>
  <div id="orgModal" class="card modal-content">
      <h2 id="orgModalTitle">Adicionar Nova Base</h2>
      <input type="hidden" id="editOrgId">
      
      <label for="orgNome">Nome da Organiza√ß√£o:</label>
      <input type="text" id="orgNome">
      
      <label for="orgFotoUrl">Foto URL (Link da imagem da base):</label>
      <input type="text" id="orgFotoUrl" placeholder="Cole o link da imagem aqui (ex: https://i.imgur.com/...)">
      
      <label for="orgInfo">Informa√ß√µes da Base (Opcional):</label>
      <textarea id="orgInfo" placeholder="Qualquer informa√ß√£o relevante sobre a base..."></textarea>
      
      <div class="actions" style="margin-top: 20px;">
          <button id="saveOrgBtn" class="success">Salvar</button>
          <button id="cancelOrgBtn" class="muted">Cancelar</button>
          <button id="deleteOrgBtn" class="danger" style="display: none; margin-left: auto; animation: none;">Apagar Base</button>
      </div>
  </div>
  
  <div id="imageLightboxOverlay" class="modal-overlay"></div>
  <div id="imageLightboxModal">
      <img id="lightboxImg" src="" alt="Visualiza√ß√£o da Imagem">
  </div>
  
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, sendPasswordResetEmail, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    // IMPORTADO 'update'
    import { getDatabase, ref, set, push, onValue, remove, get, query, orderByChild, equalTo, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    
    const firebaseConfig = {
      // ########## ATEN√á√ÉO!! ##########
      // COLE SUA NOVA CHAVE DE API AQUI
      apiKey: "AIzaSyCPNd9INqIfqG1-rjaYAlz988RLDZvL528", 
      // ########## ATEN√á√ÉO!! ##########
      authDomain: "hells-angels-438c2.firebaseapp.com",
      databaseURL: "https.://hells-angels-438c2-default-rtdb.firebaseio.com/",
      projectId: "hells-angels-438c2",
      storageBucket: "hells-angels-438c2.firebasestorage.app",
      messagingSenderId: "429406215315",
      appId: "1:429406215315:web:96b68b172247824b308166",
      measurementId: "G-CR415MEY32"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    
    let vendas = [];
    let vendaEmEdicaoId = null;
    let vendaOriginalRegistradoPor = null;
    let vendaOriginalRegistradoPorId = null;
    let vendaOriginalTimestamp = null;
    let vendaOriginalDataHora = null;
    let vendaOriginalDossierOrg = null; 
    
    // NOVAS VARI√ÅVEIS GLOBAIS PARA SINCRONIZA√á√ÉO
    let vendaOriginalCliente = null;
    let vendaOriginalOrganizacao = null;
    
    let currentUser = null;
    let currentUserData = null; 
    
    let globalAllOrgs = []; 
    let globalCurrentPeople = [];
    let sortableInstance = null; 
    let orgSortableInstance = null; 
    
    // --- NOVO (Gerenciador de Ve√≠culos) ---
    // Armazena temporariamente os ve√≠culos ao editar/adicionar um modal
    let tempVeiculos = {};
    // Armazena a chave do ve√≠culo sendo editado no modal
    let veiculoEmEdicaoKey = null; 
    // --- FIM ---
    
    const perUnit = {
      tickets: { dinheiro_sujo: 525 },
      tablets: { cobre: 20, plastico: 40, fita_adesiva: 2, lixo_eletronico: 2 },
      nitro: { aluminio: 20, cobre: 20, vidro: 45, fita_adesiva: 1, porca: 1, parafuso: 1 }
    };
    
    const valores = {
      tablets: { limpo: 17000, sujo: 20000, limpo_alianca: 15000, sujo_alianca: 18000 },
      tickets: { limpo: 9800, sujo: 11700, limpo_alianca: 8000, sujo_alianca: 10000 },
      nitro: { limpo: 42500, sujo: 50000, limpo_alianca: 38000, sujo_alianca: 45000 }
    };
    
    const valorDescricao = {
        'limpo': 'Dinheiro Limpo',
        'sujo': 'Dinheiro Sujo',
        'limpo_alianca': 'Limpo (Alian√ßa)',
        'sujo_alianca': 'Sujo (Alian√ßa)'
    };

    const logoLightModeSrc = "logo-dark.png";
    const logoDarkModeSrc = "logo-dark.png";
    const historyBackgroundSrc = "logo-dark.png";
    const welcomeLogoSrc = "logo-dark.png";
    
    const els = {
      qtyTickets: document.getElementById('qtyTickets'),
      qtyTablets: document.getElementById('qtyTablets'),
      qtyNitro: document.getElementById('qtyNitro'),
      tipoValor: document.getElementById('tipoValor'),
      nomeCliente: document.getElementById('nomeCliente'),
      organizacao: document.getElementById('organizacao'),
      organizacaoTipo: document.getElementById('organizacaoTipo'),
      telefone: document.getElementById('telefone'),
      carroVeiculo: document.getElementById('carroVeiculo'), 
      placaVeiculo: document.getElementById('placaVeiculo'),
      negociadoras: document.getElementById('negociadoras'),
      vendaValorObs: document.getElementById('vendaValorObs'),
      dataVenda: document.getElementById('dataVenda'),
      filtroHistorico: document.getElementById('filtroHistorico'),
      resultsBody: document.getElementById('resultsBody'),
      valuesBody: document.getElementById('valuesBody'),
      valorTotalGeral: document.getElementById('valorTotalGeral'),
      results: document.getElementById('results'),
      mainCard: document.getElementById('mainCard'),
      historyCard: document.getElementById('historyCard'),
      salesHistory: document.getElementById('salesHistory'),
      calcBtn: document.getElementById('calcBtn'),
      resetBtn: document.getElementById('resetBtn'),
      registerBtn: document.getElementById('registerBtn'),
      toggleHistoryBtn: document.getElementById('toggleHistoryBtn'),
      toggleCalcBtn: document.getElementById('toggleCalcBtn'),
      clearHistoryBtn: document.getElementById('clearHistoryBtn'),
      csvBtn: document.getElementById('csvBtn'),
      discordBtnCalc: document.getElementById('discordBtnCalc'),
      themeBtn: document.getElementById('themeBtn'),
      tutorialBtn: document.getElementById('tutorialBtn'),
      logoLink: document.getElementById('logoLink'),
      appLogo: document.getElementById('appLogo'),
      historyImg: document.getElementById('historyImg'),
      welcomeScreen: document.getElementById('welcomeScreen'),
      enterBtn: document.getElementById('enterBtn'),
      welcomeLogo: document.getElementById('welcomeLogo'),
      authScreen: document.getElementById('authScreen'),
      username: document.getElementById('username'),
      password: document.getElementById('password'),
      loginBtn: document.getElementById('loginBtn'),
      registerUserBtn: document.getElementById('registerUserBtn'),
      authMessage: document.getElementById('authMessage'),
      logoutBtn: document.getElementById('logoutBtn'),
      mainTitle: document.getElementById('mainTitle'),
      forgotPasswordLink: document.getElementById('forgotPasswordLink'),
      
      adminPanelBtn: document.getElementById('adminPanelBtn'),
      adminPanel: document.getElementById('adminPanel'),
      adminUserListBody: document.getElementById('adminUserListBody'),
      toggleCalcBtnAdmin: document.getElementById('toggleCalcBtnAdmin'), 
      layoutToggleNightMode: document.getElementById('layoutToggleNightMode'),
      layoutToggleBottomPanel: document.getElementById('layoutToggleBottomPanel'),
      bottomPanel: document.getElementById('bottomPanel'),
      userStatus: document.getElementById('userStatus'),
      
      investigacaoBtn: document.getElementById('investigacaoBtn'),
      dossierCard: document.getElementById('dossierCard'),
      toggleCalcBtnDossier: document.getElementById('toggleCalcBtnDossier'),
      
      dossierOrgContainer: document.getElementById('dossierOrgContainer'),
      filtroDossierOrgs: document.getElementById('filtroDossierOrgs'),
      addOrgBtn: document.getElementById('addOrgBtn'),
      dossierOrgGrid: document.getElementById('dossierOrgGrid'),
      
      dossierPeopleContainer: document.getElementById('dossierPeopleContainer'),
      dossierPeopleTitle: document.getElementById('dossierPeopleTitle'),
      dossierVoltarBtn: document.getElementById('dossierVoltarBtn'),
      filtroDossierPeople: document.getElementById('filtroDossierPeople'),
      addPessoaBtn: document.getElementById('addPessoaBtn'),
      dossierPeopleGrid: document.getElementById('dossierPeopleGrid'),
      
      migrateDossierBtn: document.getElementById('migrateDossierBtn'),
      migrateVeiculosBtn: document.getElementById('migrateVeiculosBtn'), // Novo bot√£o
      
      editDossierOverlay: document.getElementById('editDossierOverlay'),
      editDossierModal: document.getElementById('editDossierModal'),
      editDossierOrg: document.getElementById('editDossierOrg'),
      editDossierId: document.getElementById('editDossierId'),
      editDossierNome: document.getElementById('editDossierNome'),
      editDossierNumero: document.getElementById('editDossierNumero'),
      editDossierCargo: document.getElementById('editDossierCargo'),
      editDossierFotoUrl: document.getElementById('editDossierFotoUrl'),
      editDossierInstagram: document.getElementById('editDossierInstagram'), // <-- MUDAN√áA: INSTAGRAM
      saveDossierBtn: document.getElementById('saveDossierBtn'),
      cancelDossierBtn: document.getElementById('cancelDossierBtn'),
      
      // -- Novos elementos (Modal Editar)
      editModalCarroNome: document.getElementById('editModalCarroNome'),
      editModalCarroPlaca: document.getElementById('editModalCarroPlaca'),
      editModalCarroFoto: document.getElementById('editModalCarroFoto'), // NOVO
      editModalAddVeiculoBtn: document.getElementById('editModalAddVeiculoBtn'),
      editModalCancelVeiculoBtn: document.getElementById('editModalCancelVeiculoBtn'), // NOVO
      editModalListaVeiculos: document.getElementById('editModalListaVeiculos'),
      
      addDossierOverlay: document.getElementById('addDossierOverlay'),
      addDossierModal: document.getElementById('addDossierModal'),
      addDossierOrganizacao: document.getElementById('addDossierOrganizacao'),
      addDossierNome: document.getElementById('addDossierNome'),
      addDossierNumero: document.getElementById('addDossierNumero'),
      addDossierCargo: document.getElementById('addDossierCargo'),
      addDossierFotoUrl: document.getElementById('addDossierFotoUrl'),
      saveNewDossierBtn: document.getElementById('saveNewDossierBtn'),
      cancelNewDossierBtn: document.getElementById('cancelNewDossierBtn'),

      // -- Novos elementos (Modal Adicionar)
      addModalCarroNome: document.getElementById('addModalCarroNome'),
      addModalCarroPlaca: document.getElementById('addModalCarroPlaca'),
      addModalCarroFoto: document.getElementById('addModalCarroFoto'), // NOVO
      addModalAddVeiculoBtn: document.getElementById('addModalAddVeiculoBtn'),
      addModalCancelVeiculoBtn: document.getElementById('addModalCancelVeiculoBtn'), // NOVO
      addModalListaVeiculos: document.getElementById('addModalListaVeiculos'),
      
      orgModalOverlay: document.getElementById('orgModalOverlay'),
      orgModal: document.getElementById('orgModal'),
      orgModalTitle: document.getElementById('orgModalTitle'),
      editOrgId: document.getElementById('editOrgId'),
      orgNome: document.getElementById('orgNome'),
      orgFotoUrl: document.getElementById('orgFotoUrl'),
      orgInfo: document.getElementById('orgInfo'),
      saveOrgBtn: document.getElementById('saveOrgBtn'),
      cancelOrgBtn: document.getElementById('cancelOrgBtn'),
      deleteOrgBtn: document.getElementById('deleteOrgBtn'),
      
      // --- NOVOS ELEMENTOS DO LIGHTBOX ---
      imageLightboxOverlay: document.getElementById('imageLightboxOverlay'),
      imageLightboxModal: document.getElementById('imageLightboxModal'),
      lightboxImg: document.getElementById('lightboxImg')
    };
    
    const globalLayoutRef = ref(db, 'configuracoesGlobais/layout');
    onValue(globalLayoutRef, (snapshot) => {
        if (!snapshot.exists()) {
            console.warn("N√≥ /configuracoesGlobais/layout n√£o encontrado. Criando...");
            if(currentUserData && currentUserData.tag.toUpperCase() === 'ADMIN') {
                 set(globalLayoutRef, { enableNightMode: true, enableBottomPanel: false });
            }
            return;
        }
        const settings = snapshot.val();
        
        if (els.themeBtn) {
            els.themeBtn.style.display = settings.enableNightMode ? 'block' : 'none';
            if (!settings.enableNightMode) {
                document.body.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            }
        }
        
        if (els.bottomPanel) {
            els.bottomPanel.style.display = settings.enableBottomPanel ? 'flex' : 'none';
        }
    }, (error) => {
        if(error.code !== "PERMISSION_DENIED") {
            showToast(`Erro ao carregar configura√ß√µes de layout: ${error.message}`, 'error');
        }
    });
    
    
    const formatCurrency = (value) => {
      if (typeof value !== 'number' || isNaN(value)) { return 'R$ 0'; }
      return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 0, maximumFractionDigits: 0 });
    };

    // =================================================================
    // IN√çCIO: ALTERA√á√ÉO (Corre√ß√£o do CPF)
    // =================================================================
    const capitalizeText = (text) => {
        if (!text) return '';
        
        const upperText = text.toUpperCase();
        
        // Exce√ß√µes para Acr√¥nimos e Casos Espec√≠ficos
        if (upperText === 'CPF' || upperText === 'OUTROS' || upperText === 'CNPJ' || upperText === 'NKT') {
            return upperText;
        }
        if (text === 'dinheiro sujo') return 'Dinheiro Sujo';
        
        // L√≥gica original
        return text.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
    };
    // =================================================================
    // FIM: ALTERA√á√ÉO
    // =================================================================
    
    const showToast = (message, type = 'default', duration = 3000) => {
      const toastContainer = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      toastContainer.appendChild(toast);
      setTimeout(() => { toast.classList.add('show'); }, 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 300);
      }, duration);
    };
    
    const getQty = (element) => Math.max(0, parseInt(element.value) || 0);

    const PREFIX = "(055) ";
    const phoneMask = (value) => {
        let digits = value.replace(/\D/g, ""); 
        if (digits.startsWith("055")) { digits = digits.substring(3); }
        digits = digits.substring(0, 6); 
        let formattedNumber = digits.length > 3 ? `${digits.substring(0, 3)}-${digits.substring(3)}` : digits;
        return PREFIX + formattedNumber;
    }

    const camposTelefone = [els.telefone, els.editDossierNumero, els.addDossierNumero];
    
    camposTelefone.forEach(campo => {
        if (campo) {
            campo.addEventListener('input', (e) => {
                e.target.value = e.target.value.length < PREFIX.length ? PREFIX : phoneMask(e.target.value);
            });
            campo.addEventListener('focus', (e) => {
                if (!e.target.value || e.target.value.length < PREFIX.length) { e.target.value = PREFIX; }
            });
        }
    });

    const atualizarRelogio = () => {
        const agora = new Date();
        const dia = String(agora.getDate()).padStart(2, '0');
        const mes = String(agora.getMonth() + 1).padStart(2, '0');
        const ano = agora.getFullYear();
        const horas = String(agora.getHours()).padStart(2, '0');
        const minutos = String(agora.getMinutes()).padStart(2, '0');
        els.dataVenda.value = `${dia}/${mes}/${ano} ${horas}:${minutos}`;
    };
    atualizarRelogio();
    setInterval(atualizarRelogio, 30000);
    
    const camposParaCapitalizar = [ 
        els.nomeCliente, els.organizacao, els.negociadoras, els.vendaValorObs, 
        els.carroVeiculo, 
        els.addDossierNome, els.addDossierOrganizacao, els.addDossierCargo, 
        els.editDossierNome, els.editDossierCargo, 
        els.orgNome,
        els.addModalCarroNome, els.editModalCarroNome // Adiciona os novos campos de carro
    ];
    camposParaCapitalizar.forEach(campo => {
      if (campo) {
        campo.addEventListener('input', (e) => {
          const { selectionStart, selectionEnd } = e.target;
          e.target.value = capitalizeText(e.target.value);
          e.target.setSelectionRange(selectionStart, selectionEnd);
        });
      }
    });
    
    // N√ÉO CAPITALIZAR INSTAGRAM
    if (els.editDossierInstagram) {
        els.editDossierInstagram.addEventListener('input', (e) => {
          // Deixa o usu√°rio digitar livremente
        });
    }
    
    const calculate = () => {
      const { qtyTickets, qtyTablets, qtyNitro, tipoValor } = {
        qtyTickets: getQty(els.qtyTickets),
        qtyTablets: getQty(els.qtyTablets),
        qtyNitro: getQty(els.qtyNitro),
        tipoValor: els.tipoValor.value
      };
      const totalQuantities = { cobre: 0, plastico: 0, fita_adesiva: 0, lixo_eletronico: 0, aluminio: 0, vidro: 0, porca: 0, parafuso: 0, dinheiro_sujo: 0 };
      let totalValue = 0;
      const productValues = [];
      
      if (qtyTablets > 0) {
        totalQuantities.cobre += qtyTablets * perUnit.tablets.cobre;
        totalQuantities.plastico += qtyTablets * perUnit.tablets.plastico;
        totalQuantities.fita_adesiva += qtyTablets * perUnit.tablets.fita_adesiva;
        totalQuantities.lixo_eletronico += qtyTablets * perUnit.tablets.lixo_eletronico;
        const value = qtyTablets * valores.tablets[tipoValor];
        totalValue += value;
        productValues.push({ product: `Tablets (${qtyTablets} und.)`, value });
      }
      if (qtyTickets > 0) {
        totalQuantities.dinheiro_sujo += qtyTickets * perUnit.tickets.dinheiro_sujo;
        const value = qtyTickets * valores.tickets[tipoValor];
        totalValue += value;
        productValues.push({ product: `Tickets (${qtyTickets} und.)`, value });
      }
      if (qtyNitro > 0) {
        totalQuantities.aluminio += qtyNitro * perUnit.nitro.aluminio;
        totalQuantities.cobre += qtyNitro * perUnit.nitro.cobre;
        totalQuantities.vidro += qtyNitro * perUnit.nitro.vidro;
        totalQuantities.fita_adesiva += qtyNitro * perUnit.nitro.fita_adesiva;
        totalQuantities.porca += qtyNitro * perUnit.nitro.porca;
        totalQuantities.parafuso += qtyNitro * perUnit.nitro.parafuso;
        const value = qtyNitro * valores.nitro[tipoValor];
        totalValue += value;
        productValues.push({ product: `Nitro (${qtyNitro} und.)`, value });
      }
      
      const hasQuantities = qtyTickets > 0 || qtyTablets > 0 || qtyNitro > 0;
      if (hasQuantities) {
        updateResults(totalQuantities, productValues, totalValue);
      } else {
        els.results.style.display = 'none';
      }
      return { qtyTickets, qtyTablets, qtyNitro, totalValue, tipoValor, hasQuantities };
    };
    
    const updateResults = (totals, productValues, totalValue) => {
      els.results.style.display = 'block';
      els.resultsBody.innerHTML = Object.entries(totals)
        .filter(([, value]) => value > 0)
        .map(([material, value]) => `<tr><td>${capitalizeText(material.replace(/_/g, ' '))}</td><td>${value.toLocaleString('pt-BR')}</td></tr>`)
        .join('');
      els.valuesBody.innerHTML = productValues.map(item => `<tr><td>${item.product}</td><td>${formatCurrency(item.value)}</td></tr>`).join('');
      els.valorTotalGeral.textContent = formatCurrency(totalValue);
    };
    
    const clearAllFields = () => {
      ['qtyTickets', 'qtyTablets', 'qtyNitro', 'nomeCliente', 'organizacao', 'negociadoras', 'vendaValorObs', 'carroVeiculo', 'placaVeiculo'].forEach(id => els[id].value = '');
      els.tipoValor.value = 'limpo';
      els.organizacaoTipo.value = 'CNPJ';
      els.telefone.value = '';
      els.results.style.display = 'none';
      document.querySelectorAll('.input-invalido').forEach(input => input.classList.remove('input-invalido'));
      
      if (vendaEmEdicaoId) {
        vendaEmEdicaoId = null;
        vendaOriginalRegistradoPor = null;
        vendaOriginalRegistradoPorId = null;
        vendaOriginalTimestamp = null;
        vendaOriginalDataHora = null;
        vendaOriginalCliente = null; // LIMPA
        vendaOriginalOrganizacao = null; // LIMPA
        vendaOriginalDossierOrg = null; // <-- ALTERA√á√ÉO 2: Limpa a vari√°vel
        els.registerBtn.textContent = 'Registrar Venda';
      }
    };
    
    const validateFields = () => {
        let isValid = true;
        const camposObrigatorios = [ els.nomeCliente, els.telefone, els.negociadoras ];
        
        camposObrigatorios.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('input-invalido');
                isValid = false;
            } else {
                field.classList.remove('input-invalido');
            }
        });
        
        const tipoOrg = els.organizacaoTipo.value;
        if (tipoOrg === 'CNPJ') {
            if (!els.organizacao.value.trim()) {
                els.organizacao.classList.add('input-invalido');
                isValid = false;
            } else {
                els.organizacao.classList.remove('input-invalido');
            }
        } else {
            els.organizacao.classList.remove('input-invalido');
        }
        
        return isValid;
    };
    
    // =================================================================
    // IN√çCIO: L√ìGICA DE SINCRONIZA√á√ÉO DO DOSSI√ä (v12)
    // =================================================================
    
    // **** IN√çCIO: FUN√á√ÉO GLOBAL DE BUSCA (v12) ****
    /**
     * Procura por um nome de pessoa em TODAS as organiza√ß√µes do dossi√™.
     * Retorna os dados, a org e o ID se encontrar.
     */
    const findDossierEntryGlobal = async (nome) => {
        if (!nome) return null;
        
        try {
            // Esta permiss√£o (ler 'dossies/') √© necess√°ria para a fun√ß√£o de "mover"
            const dossiesRef = ref(db, 'dossies');
            const snapshot = await get(dossiesRef);
            
            if (!snapshot.exists()) return null;
            
            const dossies = snapshot.val();
            
            for (const orgKey in dossies) {
                const orgData = dossies[orgKey];
                // Itera sobre as chaves de pessoa (personId) dentro de cada org
                for (const personId in orgData) {
                    if (orgData[personId].nome && orgData[personId].nome.toLowerCase() === nome.toLowerCase()) {
                        // Encontrado!
                        return {
                            personData: orgData[personId],
                            oldOrg: orgKey,
                            personId: personId
                        };
                    }
                }
            }
        } catch (error) {
            // N√£o mostra erro de permiss√£o para visitantes
            if(error.code !== "PERMISSION_DENIED") {
                console.error("Erro na busca global:", error);
            }
            return null;
        }
        return null; // N√£o encontrado
    };
    // **** FIM: FUN√á√ÉO GLOBAL DE BUSCA ****
    
    // =================================================================
    // IN√çCIO: ADI√á√ÉO (Busca Global de Pessoas)
    // =================================================================
    // **** IN√çCIO: NOVA FUN√á√ÉO DE BUSCA GLOBAL (Request 1) ****
    /**
     * Procura por um NOME PARCIAL de pessoa em TODAS as organiza√ß√µes do dossi√™.
     * Retorna um array de resultados.
     */
    const searchAllPeopleGlobal = async (query) => {
        if (!query) return [];
        
        const results = [];
        const queryLower = query.toLowerCase();
        
        try {
            const dossiesRef = ref(db, 'dossies');
            const snapshot = await get(dossiesRef);
            
            if (!snapshot.exists()) return [];
            
            const dossies = snapshot.val();
            
            for (const orgKey in dossies) {
                const orgData = dossies[orgKey];
                for (const personId in orgData) {
                    const person = orgData[personId];
                    const nome = person.nome ? person.nome.toLowerCase() : '';
                    
                    // Verifica se o nome da pessoa inclui o texto da busca
                    if (nome.includes(queryLower)) {
                        results.push({
                            ...person,
                            id: personId,
                            org: orgKey // Adiciona a org/base ao resultado
                        });
                    }
                }
            }
        } catch (error) {
            if(error.code !== "PERMISSION_DENIED") {
                console.error("Erro na busca global de pessoas:", error);
            }
        }
        return results;
    };
    // **** FIM: NOVA FUN√á√ÉO DE BUSCA GLOBAL ****
    // =================================================================
    // FIM: ADI√á√ÉO
    // =================================================================
    
    /**
     * Mescla ve√≠culos de uma venda (formato string) com um objeto de ve√≠culos existente.
     * Usa a PLACA como chave √∫nica para evitar duplicatas.
     */
    const parseAndMergeVeiculos = (vendaData, existingVeiculos = {}) => {
        const carros = (vendaData.carro || '').split(',').map(c => c.trim());
        const placas = (vendaData.placas || '').split(',').map(p => p.trim());
        const maxLen = Math.max(carros.length, placas.length);
        
        const merged = { ...existingVeiculos }; // Come√ßa com os ve√≠culos existentes

        for (let i = 0; i < maxLen; i++) {
            const carro = carros[i] || 'N/A';
            const placa = placas[i] || '';
            
            if (placa) {
                // Se tem placa, usa como chave.
                if (!merged[placa]) { // S√≥ adiciona se a placa N√ÉO existir
                    merged[placa] = { carro: carro, placa: placa, fotoUrl: '' };
                } else if (carro !== 'N/A' && merged[placa].carro === 'N/A') {
                    // Se j√° existe mas o carro era N/A, atualiza o nome do carro
                    merged[placa].carro = carro;
                }
            } else if (carro !== 'N/A') {
                // Se n√£o tem placa, √© dif√≠cil... vamos adicionar com uma chave tempor√°ria.
                // O usu√°rio ter√° que limpar duplicatas manualmente no dossi√™.
                const tempKey = `venda_${Date.now()}_${i}`;
                merged[tempKey] = { carro: carro, placa: '', fotoUrl: '' };
            }
        }
        return merged;
    };
    
    
    // Adiciona ou ATUALIZA entrada de pessoa no dossi√™
    // **** MODIFICADO (v12): Aceita 'dadosAntigos' para mesclar ao criar/atualizar ****
    const addDossierEntry = async (vendaData, dadosAntigos = null) => {
        const org = vendaData.organizacao.trim();
        const nome = vendaData.cliente.trim();
        
        if (!org || !nome) {
            console.warn("addDossierEntry: Org ou Nome faltando. Saindo.");
            return; // N√£o pode salvar sem org ou nome
        }

        // Garante que a Organiza√ß√£o exista em /organizacoes
        const orgRef = ref(db, `organizacoes/${org}`);
        get(orgRef).then(snapshot => {
            if (!snapshot.exists()) {
                // Adiciona o novo campo ordemIndex para bases
                set(orgRef, {
                    nome: org,
                    fotoUrl: '',
                    info: 'Base registrada automaticamente via Venda.',
                    ordemIndex: 9999 // Adiciona o √≠ndice de ordena√ß√£o
                });
            }
        });

        // Procura por uma pessoa com o mesmo nome NESSA organiza√ß√£o
        const dossierQuery = query(ref(db, `dossies/${org}`), orderByChild('nome'), equalTo(nome));
        
        try {
            const snapshot = await get(dossierQuery);
            
            if (snapshot.exists()) {
                // J√Å EXISTE: Atualiza a entrada existente
                let existingEntryId;
                let existingEntryData;
                snapshot.forEach(child => { 
                    existingEntryId = child.key; 
                    existingEntryData = child.val(); 
                });

                const updates = {};
                
                // **** IN√çCIO DA MODIFICA√á√ÉO (v12) ****
                // Mescla dados antigos (se movidos) com dados existentes
                
                // Atualiza telefone, cargo e data (para ter o mais recente da venda)
                updates.numero = vendaData.telefone || existingEntryData.numero;
                updates.cargo = vendaData.vendaValorObs || existingEntryData.cargo;
                updates.data = vendaData.dataHora; 
                
                // Base para ve√≠culos: usa dados antigos (se movidos) ou dados j√° existentes
                const baseVeiculos = (dadosAntigos ? dadosAntigos.veiculos : existingEntryData.veiculos) || {};
                updates.veiculos = parseAndMergeVeiculos(vendaData, baseVeiculos);

                // Preserva dados do registro antigo (se movido)
                if (dadosAntigos) {
                    updates.fotoUrl = dadosAntigos.fotoUrl || existingEntryData.fotoUrl || '';
                    updates.instagram = dadosAntigos.instagram || existingEntryData.instagram || '';
                    // Preserva a hierarquia, se n√£o houver, usa a existente, sen√£o 9999
                    updates.hierarquiaIndex = dadosAntigos.hierarquiaIndex !== undefined ? dadosAntigos.hierarquiaIndex : (existingEntryData.hierarquiaIndex !== undefined ? existingEntryData.hierarquiaIndex : 9999);
                }
                // **** FIM DA MODIFICA√á√ÉO (v12) ****

                const updateRef = ref(db, `dossies/${org}/${existingEntryId}`);
                await update(updateRef, updates);

            } else {
                // N√ÉO EXISTE: Cria uma nova entrada
                
                // **** IN√çCIO DA MODIFICA√á√ÉO (v12) ****
                // Come√ßa com os dados antigos (se movidos)
                const dossierEntry = { ...dadosAntigos };
                
                // Sobrescreve/Adiciona dados da venda atual
                dossierEntry.nome = vendaData.cliente;
                dossierEntry.numero = vendaData.telefone;
                dossierEntry.organizacao = org;
                dossierEntry.cargo = vendaData.vendaValorObs || 'N/A';
                dossierEntry.data = vendaData.dataHora; // Data da venda
                
                // Mescla ve√≠culos da venda com ve√≠culos antigos (se movidos)
                dossierEntry.veiculos = parseAndMergeVeiculos(vendaData, (dadosAntigos ? dadosAntigos.veiculos : {}));

                // Garante que campos opcionais existam (caso 'dadosAntigos' seja null)
                dossierEntry.fotoUrl = dossierEntry.fotoUrl || '';
                dossierEntry.instagram = dossierEntry.instagram || '';
                dossierEntry.hierarquiaIndex = dossierEntry.hierarquiaIndex !== undefined ? dossierEntry.hierarquiaIndex : 9999;
                // **** FIM DA MODIFICA√á√ÉO (v12) ****
                
                await push(ref(db, `dossies/${org}`), dossierEntry);
            }
        } catch (err) {
            console.error("Erro ao adicionar/atualizar dossi√™:", err);
            // N√ÉO MOSTRAR ERRO DE PERMISS√ÉO PARA VISITANTES
            if(err.code !== "PERMISSION_DENIED") {
                showToast(`Erro ao sincronizar dossi√™: ${err.message}`, "error");
            }
        }
    };
    
    // Atualiza o dossi√™ quando uma VENDA √© editada
    const updateDossierEntryOnEdit = async (oldNome, oldOrg, newVendaData) => {
        const newOrg = newVendaData.organizacao.trim();
        const newNome = newVendaData.cliente.trim();
        
        if (!oldOrg || !oldNome || !newOrg || !newNome) {
            console.warn("UpdateDossier: Faltando dados originais ou novos.");
            return;
        }

        // Procura pelo registro de dossi√™ antigo
        const dossierQuery = query(ref(db, `dossies/${oldOrg}`), orderByChild('nome'), equalTo(oldNome));
        
        try {
            const snapshot = await get(dossierQuery);
            
            if (!snapshot.exists()) {
                // N√£o existia um dossi√™...
                // **** MUDAN√áA (v12): Verifica se o nome existe em outro lugar antes de criar
                // (Cen√°rio: Editou uma venda que n√£o tinha dossi√™, para um nome que j√° existe em outra org)
                const globalEntry = await findDossierEntryGlobal(newNome);
                
                let dadosAntigos = null;
                if (globalEntry && globalEntry.oldOrg !== newOrg) {
                    // Encontrou em outra org, vamos mov√™-lo
                    dadosAntigos = globalEntry.personData;
                    await remove(ref(db, `dossies/${globalEntry.oldOrg}/${globalEntry.personId}`));
                    showToast(`"${newNome}" movido de "${globalEntry.oldOrg}" para "${newOrg}".`, "default", 4000);
                }
                
                // Cria um novo (com ou sem dados antigos)
                addDossierEntry(newVendaData, dadosAntigos);
                return;
            }

            let existingEntryId;
            let existingEntryData;
            snapshot.forEach(child => { 
                existingEntryId = child.key;
                existingEntryData = child.val();
            });
            
            // Cria o objeto de dados do dossi√™ com base na venda ATUALIZADA
            // (Esta l√≥gica j√° preserva os dados antigos, est√° correta)
            const newDossierData = {
                ...existingEntryData, // Preserva foto, insta, hierarquia
                nome: newVendaData.cliente,
                numero: newVendaData.telefone,
                organizacao: newVendaData.organizacao,
                cargo: newVendaData.vendaValorObs || 'N/A',
                data: newVendaData.dataHora,
                // Mescla ve√≠culos antigos com os da venda atualizada
                veiculos: parseAndMergeVeiculos(newVendaData, existingEntryData.veiculos || {}),
            };

            if (oldOrg === newOrg) {
                // Org √© a mesma. Apenas atualiza o registro existente
                const updateRef = ref(db, `dossies/${newOrg}/${existingEntryId}`);
                await set(updateRef, newDossierData); // 'set' para sobrescrever tudo
            } else {
                // Org mudou. Apaga o antigo e cria um novo (com a l√≥gica de deduplica√ß√£o).
                await remove(ref(db, `dossies/${oldOrg}/${existingEntryId}`));
                
                // Roda a l√≥gica de add para verificar se o nome j√° existe na *nova* org
                // **** MUDAN√áA (v12): Passa os dados preservados para o addDossierEntry
                addDossierEntry(newVendaData, existingEntryData); 
            }

        } catch (err) {
            console.error("Erro ao sincronizar edi√ß√£o da venda com dossi√™:", err);
            // N√ÉO MOSTRAR ERRO DE PERMISS√ÉO PARA VISITANTES
            if(err.code !== "PERMISSION_DENIED") {
                showToast(`Erro ao sincronizar dossi√™: ${err.message}`, "error");
            }
        }
    };

    // =================================================================
    // FIM: L√ìGICA DE SINCRONIZA√á√ÉO DO DOSSI√ä
    // =================================================================
    
    // =================================================================
    // IN√çCIO: FUN√á√ÉO DE AUTO-PREENCHIMENTO (NOVA v13)
    // =================================================================
    const autoFillFromDossier = async () => {
        // N√£o preencher automaticamente se estivermos editando uma venda (ela j√° tem seus dados)
        if (vendaEmEdicaoId) return; 
        
        const nome = els.nomeCliente.value.trim();
        
        // Se o nome for limpo, n√£o faz nada (deixa o usu√°rio limpar os campos manualmente se quiser)
        if (!nome) return; 

        try {
            const foundEntry = await findDossierEntryGlobal(nome);
            
            if (foundEntry && foundEntry.personData) {
                const data = foundEntry.personData;
                const orgBase = foundEntry.oldOrg;

                // Preenche os campos
                els.telefone.value = data.numero || '';
                els.vendaValorObs.value = data.cargo || ''; // Campo "Cargo"
                
                // Mapeia a Base do Dossi√™ para os campos Organiza√ß√£o/Tipo
                if (orgBase.toUpperCase() === 'CPF') {
                    els.organizacaoTipo.value = 'CPF';
                    els.organizacao.value = ''; // CPF n√£o usa o campo de nome de org
                } else if (orgBase.toUpperCase() === 'OUTROS') {
                    els.organizacaoTipo.value = 'OUTROS';
                    els.organizacao.value = ''; // Outros n√£o usa o campo de nome de org
                } else {
                    // √â um CNPJ, preenche o nome da organiza√ß√£o
                    els.organizacaoTipo.value = 'CNPJ';
                    els.organizacao.value = orgBase; 
                }
                
                showToast(`Dados de "${nome}" preenchidos do dossi√™.`, "success");
            }
            // Se n√£o for encontrado (else), n√£o faz nada. 
            // O usu√°rio continua com o preenchimento manual.
            
        } catch (error) {
            // N√£o trava a aplica√ß√£o se a busca falhar, apenas loga.
            if(error.code !== "PERMISSION_DENIED") {
                console.error("Erro ao tentar auto-preencher:", error);
                showToast("Erro ao buscar dados do dossi√™.", "error");
            }
        }
    };
    // =================================================================
    // FIM: FUN√á√ÉO DE AUTO-PREENCHIMENTO
    // =================================================================

    // **** MODIFICADO (v12): Tornou-se uma fun√ß√£o 'async' ****
    const registerVenda = async () => {
      const { qtyTickets, qtyTablets, qtyNitro, totalValue, tipoValor, hasQuantities } = calculate();
      if (!hasQuantities) {
        showToast("√â necess√°rio calcular a venda antes de registrar.", "error");
        return;
      }
      if (!validateFields()) {
          showToast("Preencha os campos obrigat√≥rios (marcados em vermelho).", "error");
          return;
      }
      if (!currentUser || !currentUser.displayName) {
          showToast("Erro: Usu√°rio n√£o autenticado.", "error");
          return;
      }
      
      const carro = els.carroVeiculo.value.trim();
      const placas = els.placaVeiculo.value.trim().toUpperCase();
      
      const newVenda = {
        timestamp: vendaEmEdicaoId ? vendaOriginalTimestamp : Date.now(), 
        dataHora: vendaEmEdicaoId ? vendaOriginalDataHora : new Date().toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' }),
        cliente: els.nomeCliente.value.trim(),
        organizacao: els.organizacao.value.trim(),
        organizacaoTipo: els.organizacaoTipo.value,
        telefone: els.telefone.value.trim(),
        negociadoras: els.negociadoras.value.trim(),
        vendaValorObs: els.vendaValorObs.value.trim(),
        carro: carro, 
        placas: placas,
        qtyTickets, qtyTablets, qtyNitro,
        valorTotal: totalValue,
        tipoValor,
        registradoPor: vendaEmEdicaoId ? vendaOriginalRegistradoPor : currentUser.displayName,
        registradoPorId: vendaEmEdicaoId ? vendaOriginalRegistradoPorId : currentUser.uid 
      };
      
      // --- IN√çCIO DA L√ìGICA DE MOVIMENTA√á√ÉO DE DOSSI√ä (v12) ---
      
      // 1. Determina a Base (Organiza√ß√£o) de destino do Dossi√™
      let dossierOrgDestino = '';
      if (newVenda.organizacaoTipo === 'CPF') {
          dossierOrgDestino = 'CPF';
      } else if (newVenda.organizacaoTipo === 'OUTROS') {
          dossierOrgDestino = 'Outros';
      } else { // 'CNPJ'
          dossierOrgDestino = newVenda.organizacao.trim();
      }
      
      // 2. Vari√°vel para armazenar os dados do registro antigo, se for movido
      let dadosAntigosParaMover = null;
      
      // 3. Verifica se √© um NOVO REGISTRO e se o cliente precisa ser movido
      if (!vendaEmEdicaoId && dossierOrgDestino !== '' && newVenda.cliente !== '') {
          try {
              const existingEntry = await findDossierEntryGlobal(newVenda.cliente);
              
              if (existingEntry && existingEntry.oldOrg !== dossierOrgDestino) {
                  // ENCONTRADO EM OUTRA ORG! Esta √© a 'move operation'.
                  
                  // 1. Salva os dados antigos para mover
                  dadosAntigosParaMover = { ...existingEntry.personData };
                  
                  // 2. Remove da organiza√ß√£o antiga
                  await remove(ref(db, `dossies/${existingEntry.oldOrg}/${existingEntry.personId}`));
                  
                  showToast(`"${newVenda.cliente}" movido de "${existingEntry.oldOrg}" para "${dossierOrgDestino}".`, "default", 4000);
              }
          } catch (e) {
              if (e.code !== "PERMISSION_DENIED") {
                  showToast(`Erro ao verificar dossi√™ global: ${e.message}`, "error");
              }
          }
      }
      // --- FIM DA L√ìGICA DE MOVIMENTA√á√ÉO ---
      

      const operation = vendaEmEdicaoId ? set(ref(db, `vendas/${vendaEmEdicaoId}`), newVenda) : push(ref(db, 'vendas'), newVenda);
      
      operation
          .then(() => {
              showToast(`Venda ${vendaEmEdicaoId ? 'atualizada' : 'registrada'} com sucesso!`, "success");
              
              // --- L√ìGICA DE SINCRONIZA√á√ÉO (Atualizada v12) ---
              
              const dossierVendaData = { ...newVenda }; 
              // Usa o 'dossierOrgDestino' que j√° calculamos
              dossierVendaData.organizacao = dossierOrgDestino;

              if (dossierOrgDestino !== '') {
                  if (vendaEmEdicaoId) {
                      // √â uma ATUALIZA√á√ÉO de venda
                      updateDossierEntryOnEdit(vendaOriginalCliente, vendaOriginalDossierOrg, dossierVendaData);
                  } else {
                      // √â um NOVO registro
                      // **** MUDAN√áA (v12): Passa os dados antigos (se houver) para a fun√ß√£o
                      addDossierEntry(dossierVendaData, dadosAntigosParaMover);
                  }
              }
              // --- FIM DA L√ìGICA DE SINCRONIZA√á√ÉO ---
              
              clearAllFields();
          })
          .catch((error) => {
              showToast(`Erro ao registrar venda: ${error.message}`, "error");
          });
    };

    const editVenda = (id) => {
        const venda = vendas.find(v => v.id === id);
        if (!venda) return;
        
        els.nomeCliente.value = venda.cliente || '';
        els.organizacao.value = venda.organizacao || '';
        els.organizacaoTipo.value = venda.organizacaoTipo || 'CNPJ';
        els.telefone.value = venda.telefone || '';
        els.negociadoras.value = venda.negociadoras || '';
        els.vendaValorObs.value = venda.vendaValorObs || '';
        els.tipoValor.value = venda.tipoValor || 'limpo';
        
        els.carroVeiculo.value = venda.carro || ''; 
        els.placaVeiculo.value = venda.placas || ''; 
        
        els.qtyTickets.value = venda.qtyTickets || 0;
        els.qtyTablets.value = venda.qtyTablets || 0;
        els.qtyNitro.value = venda.qtyNitro || 0;
        
        calculate(); 
        
        vendaEmEdicaoId = id;
        vendaOriginalRegistradoPor = venda.registradoPor;
        vendaOriginalRegistradoPorId = venda.registradoPorId;
        vendaOriginalTimestamp = venda.timestamp;
        vendaOriginalDataHora = venda.dataHora;
        
        // --- ALTERA√á√ÉO 3: L√≥gica Dossi√™ v9 ---
        // SALVA DADOS ORIGINAIS PARA SINCRONIZA√á√ÉO
        vendaOriginalCliente = venda.cliente;
        vendaOriginalOrganizacao = venda.organizacao; // Para o registro de venda
        
        // Determina qual era a Base (Dossi√™) original da pessoa
        if (venda.organizacaoTipo === 'CPF') {
            vendaOriginalDossierOrg = 'CPF';
        } else if (venda.organizacaoTipo === 'OUTROS') {
            vendaOriginalDossierOrg = 'Outros';
        } else {
            // √â CNPJ, usa o nome da organiza√ß√£o da venda
            vendaOriginalDossierOrg = venda.organizacao;
        }
        // --- FIM DA ALTERA√á√ÉO 3 ---
        
        els.registerBtn.textContent = 'Atualizar Venda';
        toggleView('main'); 
        showToast(`Editando venda de ${venda.cliente}`, "default");
    };

    const removeVenda = (id) => {
        if (confirm("Tem certeza que deseja remover esta venda?")) {
            // (Futuramente, podemos adicionar a remo√ß√£o do dossi√™ aqui, mas por enquanto √© melhor n√£o)
            remove(ref(db, `vendas/${id}`))
                .then(() => {
                    showToast("Venda removida.", "success");
                })
                .catch((error) => {
                    showToast(`Erro ao remover: ${error.message}`, "error");
                });
        }
    };

    const copyToClipboard = (text) => {
        if (!text) return;
        navigator.clipboard.writeText(text)
          .then(() => {
            showToast("Mensagem copiada para o Discord!", "success");
          })
          .catch(err => {
            showToast("Erro ao copiar.", "error");
          });
    };

    const buildDiscordMessage = (vendaData) => {
        const { cliente, data, orgTipo, org, tel, produtos, valor, obs, negociadoras, cargo } = vendaData;
        return `
\`\`\`
Nome: ${cliente}
Data: ${data}
Organiza√ß√£o: ${orgTipo} - ${org}
Telefone: ${tel}
Cargo: ${cargo}
Produto (Unidade): ${produtos}
Venda Valor: ${valor} (${obs})
Negociadoras: ${negociadoras}
\`\`\`
        `.trim();
    };

    const copyDiscordMessage = (isFromHistory = false, venda = null) => {
        let messageData;
        if (isFromHistory) {
            let produtos = [];
            if (venda.qtyTickets > 0) produtos.push(`Tickets (${venda.qtyTickets})`);
            if (venda.qtyTablets > 0) produtos.push(`Tablet (${venda.qtyTablets})`);
            if (venda.qtyNitro > 0) produtos.push(`Nitros (${venda.qtyNitro})`);
            
            messageData = {
                cliente: venda.cliente,
                data: venda.dataHora.split(', ')[0],
                orgTipo: venda.organizacaoTipo,
                org: venda.organizacao,
                tel: venda.telefone,
                cargo: venda.vendaValorObs || 'N/A',
                produtos: produtos.join(', '),
                valor: formatCurrency(venda.valorTotal || 0),
                obs: valorDescricao[venda.tipoValor],
                negociadoras: venda.negociadoras
            };
        } else {
            const { qtyTickets, qtyTablets, qtyNitro, totalValue, tipoValor, hasQuantities } = calculate();
            if (!hasQuantities) { showToast("Calcule uma venda antes de copiar.", "error"); return; }
            if (!validateFields()) { showToast("Preencha os dados da venda antes de copiar.", "error"); return; }
            
            let produtos = [];
            if (qtyTickets > 0) produtos.push(`Tickets (${qtyTickets})`);
            if (qtyTablets > 0) produtos.push(`Tablet (${qtyTablets})`);
            if (qtyNitro > 0) produtos.push(`Nitros (${qtyNitro})`);
            
            const dataAtual = new Date().toLocaleDateString('pt-BR');

            messageData = {
                cliente: els.nomeCliente.value.trim(),
                data: dataAtual,
                orgTipo: els.organizacaoTipo.value,
                org: els.organizacao.value.trim(),
                tel: els.telefone.value.trim(),
                cargo: els.vendaValorObs.value.trim() || 'N/A',
                produtos: produtos.join(', '),
                valor: formatCurrency(totalValue),
                obs: valorDescricao[tipoValor],
                negociadoras: els.negociadoras.value.trim()
            };
        }
        copyToClipboard(buildDiscordMessage(messageData));
    };

    const toggleView = (viewName) => {
        els.mainCard.style.display = 'none';
        els.historyCard.style.display = 'none';
        els.adminPanel.style.display = 'none';
        els.dossierCard.style.display = 'none';
        
        document.body.classList.remove('history-view-active', 'dossier-view-active');

        if (viewName === 'history') {
            document.body.classList.add('history-view-active');
            els.historyCard.style.display = 'block';
            els.historyImg.src = historyBackgroundSrc;
            els.filtroHistorico.value = ''; 
            displaySalesHistory(vendas); 
        } else if (viewName === 'admin') {
            els.adminPanel.style.display = 'block';
            loadAdminPanel();
        } else if (viewName === 'dossier') {
            document.body.classList.add('dossier-view-active');
            els.dossierCard.style.display = 'block';
            showDossierOrgs(); 
        } else {
            els.mainCard.style.display = 'block';
        }
    };

    const displaySalesHistory = (history) => {
        els.salesHistory.innerHTML = '';
        if (!currentUserData) { 
             return;
        }

        let vendasFiltradas = history;
        const userTagUpper = currentUserData.tag.toUpperCase();
        
        if (userTagUpper === 'VISITANTE') {
            vendasFiltradas = history.filter(v => v.registradoPorId === currentUser.uid);
        }

        if (vendasFiltradas.length === 0) {
            const row = els.salesHistory.insertRow();
            row.insertCell().colSpan = 9; 
            row.cells[0].textContent = "Nenhuma venda para exibir.";
            row.cells[0].style.textAlign = 'center';
            row.cells[0].style.padding = '20px';
            return;
        }

        vendasFiltradas.sort((a, b) => b.timestamp - a.timestamp);

        vendasFiltradas.forEach(venda => {
            const row = els.salesHistory.insertRow();
            
            const [data, hora] = venda.dataHora.split(', ');
            row.insertCell().innerHTML = `<span class="history-datetime-line">${data}</span><span class="history-datetime-line">${hora}</span>`;
            row.insertCell().textContent = capitalizeText(venda.cliente);
            row.insertCell().textContent = `${capitalizeText(venda.organizacao)} (${venda.organizacaoTipo})`;
            row.insertCell().textContent = venda.telefone;

            let produtos = [];
            if (venda.qtyTickets > 0) produtos.push(`${venda.qtyTickets} Tickets`);
            if (venda.qtyTablets > 0) produtos.push(`${venda.qtyTablets} Tablets`);
            if (venda.qtyNitro > 0) produtos.push(`${venda.qtyNitro} Nitro`);
            row.insertCell().textContent = capitalizeText(produtos.join(', '));
            
            const valorCell = row.insertCell();
            valorCell.className = 'valor-total-cell';
            valorCell.innerHTML = `<span>${formatCurrency(venda.valorTotal || 0)}</span><span class="valor-obs-text">(${valorDescricao[venda.tipoValor] || 'N/A'})`;

            row.insertCell().textContent = capitalizeText(venda.negociadoras);
            
            const registradoPorCell = row.insertCell();
            if (venda.registradoPor && venda.registradoPor.toLowerCase() === 'snow') {
                registradoPorCell.textContent = '???';
                registradoPorCell.style.fontStyle = 'italic';
                registradoPorCell.style.color = '#aaa';
            } else {
                registradoPorCell.textContent = venda.registradoPor || 'Desconhecido';
            }
            
            const actionsCell = row.insertCell();
            actionsCell.className = 'history-actions-cell';

            const podeModificar = 
                (userTagUpper === 'ADMIN') ||
                (userTagUpper === 'HELLS' && venda.registradoPorId === currentUser.uid) ||
                (userTagUpper === 'VISITANTE' && venda.registradoPorId === currentUser.uid);

            actionsCell.innerHTML = `
                <button class="action-btn muted edit-btn" ${!podeModificar ? 'disabled' : ''}>Editar</button>
                <button class="action-btn danger delete-btn" ${!podeModificar ? 'disabled' : ''}>Deletar</button>
                <button class="action-btn muted discord-btn">Discord</button>
            `;
            if(podeModificar){
                actionsCell.querySelector('.edit-btn').onclick = () => editVenda(venda.id);
                actionsCell.querySelector('.delete-btn').onclick = () => removeVenda(venda.id);
            }
            actionsCell.querySelector('.discord-btn').onclick = () => copyDiscordMessage(true, venda);
        });
    };

    const filterHistory = () => {
        const query = els.filtroHistorico.value.toLowerCase().trim();
        const filteredVendas = vendas.filter(v => 
            Object.values(v).some(val => String(val).toLowerCase().includes(query)) ||
            (v.qtyTickets > 0 && `tickets`.includes(query)) ||
            (v.qtyTablets > 0 && `tablets`.includes(query)) ||
            (v.qtyNitro > 0 && `nitro`.includes(query))
        );
        displaySalesHistory(query ? filteredVendas : vendas);
    };

    const exportToCsv = () => {
        if (vendas.length === 0) {
            showToast("Nenhum dado para exportar.", "error");
            return;
        }
        const headers = ["Data/Hora", "Cliente", "Organiza√ß√£o", "Tipo", "Telefone", "Negociadoras", "Cargo", "Carro", "Placas", "Qtde Tickets", "Qtde Tablets", "Qtde Nitro", "Valor Total", "Tipo Valor", "Registrado Por"];
        const csvRows = vendas.map(v => [`"${v.dataHora}"`, `"${venda.cliente}"`, `"${venda.organizacao}"`, `"${venda.organizacaoTipo}"`, `"${venda.telefone}"`, `"${venda.negociadoras}"`, `"${venda.vendaValorObs}"`, `"${venda.carro || ''}"`, `"${venda.placas || ''}"`, v.qtyTickets, v.qtyTablets, v.qtyNitro, v.valorTotal, `"${valorDescricao[v.tipoValor]}"`, `"${venda.registradoPor}"`].join(','));
        const csvContent = [headers.join(','), ...csvRows].join('\n');
        const link = document.createElement('a');
        link.href = URL.createObjectURL(new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }));
        link.download = `historico_vendas_HA_${new Date().toISOString().slice(0, 10)}.csv`;
        link.click();
        showToast("Hist√≥rico exportado para CSV!", "success");
    };

    const clearHistory = () => {
        if (currentUserData.tag.toUpperCase() !== 'ADMIN') {
            showToast("Apenas administradores podem limpar o hist√≥rico.", "error");
            return;
        }
        if (confirm("ATEN√á√ÉO: Deseja APAGAR TODO o hist√≥rico de vendas? Esta a√ß√£o √© irrevers√≠vel.")) {
            remove(ref(db, 'vendas'))
                .then(() => showToast("Hist√≥rico limpado.", "success"))
                .catch(e => showToast(`Erro: ${e.message}`, "error"));
        }
    };
    
    // **** IN√çCIO DAS FUN√á√ïES DO DOSSI√ä (v12) ****
    
    // =============================================
    // NOVAS FUN√á√ïES DO LIGHTBOX
    // =============================================
    const showImageLightbox = (url) => {
        if (!url) return;
        els.lightboxImg.src = url;
        els.imageLightboxOverlay.style.display = 'block';
        els.imageLightboxModal.style.display = 'block';
    };
    
    const closeImageLightbox = () => {
        els.imageLightboxOverlay.style.display = 'none';
        els.imageLightboxModal.style.display = 'none';
        els.lightboxImg.src = ''; // Limpa para n√£o "piscar" a imagem antiga
    };
    // =============================================
    
    // =============================================
    // IN√çCIO: FUN√á√ïES DE HIERARQUIA DE PESSOAS (SortableJS)
    // =============================================
    
    // Salva a nova ordem da hierarquia no Firebase
    const saveHierarchyOrder = (orgName) => {
        const grid = els.dossierPeopleGrid;
        // Pega todos os cards de pessoa, na ordem atual do DOM
        const children = Array.from(grid.children);
        
        if (children.length === 0 || !children[0].classList.contains('dossier-entry-card')) {
            return; // Grid est√° vazio ou mostrando "carregando..."
        }
        
        const updates = {};
        // Cria um objeto de atualiza√ß√£o multi-path
        children.forEach((card, index) => {
            const personId = card.dataset.id;
            if (personId) {
                // Atualiza o 'hierarquiaIndex' de cada pessoa baseado na sua posi√ß√£o (index)
                updates[`dossies/${orgName}/${personId}/hierarquiaIndex`] = index;
            }
        });
        
        if (Object.keys(updates).length > 0) {
            update(ref(db), updates)
                .then(() => {
                    showToast("Hierarquia atualizada!", "success");
                    // Atualiza os dados locais (globalCurrentPeople) para refletir a nova ordem
                    globalCurrentPeople = children.map((card, index) => {
                        const person = globalCurrentPeople.find(p => p.id === card.dataset.id);
                        if (person) {
                            person.hierarquiaIndex = index;
                        }
                        return person;
                    }).filter(Boolean);
                })
                .catch((err) => {
                    showToast(`Erro ao salvar hierarquia: ${err.message}`, "error");
                    // Se der erro, a UI pode ficar fora de sincronia.
                    // O ideal seria recarregar, mas por enquanto s√≥ avisamos.
                });
        }
    };

    // Inicializa a biblioteca SortableJS no grid de pessoas
    const initSortable = (orgName) => {
        if (sortableInstance) {
            sortableInstance.destroy(); // Destr√≥i a inst√¢ncia anterior (se houver)
        }
        
        const grid = els.dossierPeopleGrid;
        
        // Verifica a permiss√£o do usu√°rio
        const userTagUpper = currentUserData ? currentUserData.tag.toUpperCase() : 'VISITANTE';
        const canDrag = (userTagUpper === 'ADMIN' || userTagUpper === 'HELLS');
        
        sortableInstance = new Sortable(grid, {
            animation: 150,
            handle: '.dossier-entry-card', // Permite arrastar pelo card inteiro
            disabled: !canDrag, // Desabilita o "arrastar" para Visitantes
            ghostClass: 'sortable-ghost', // Classe CSS para o "fantasma"
            onEnd: (evt) => {
                // Quando o usu√°rio solta o card, salva a nova ordem
                saveHierarchyOrder(orgName);
            }
        });
    };
    
    // =============================================
    // FIM: FUN√á√ïES DE HIERARQUIA DE PESSOAS
    // =============================================

    // =============================================
    // IN√çCIO: FUN√á√ïES DE ORDENA√á√ÉO DE BASES (SortableJS para Orgs)
    // =============================================
    
    // Salva a nova ordem das bases no Firebase
    const saveOrgOrder = () => {
        const grid = els.dossierOrgGrid;
        // Filtra para pegar apenas os cards de organiza√ß√£o e ignora os t√≠tulos
        const children = Array.from(grid.children).filter(el => el.classList.contains('dossier-org-card'));
        
        if (children.length === 0) {
            return;
        }
        
        const updates = {};
        // Cria um objeto de atualiza√ß√£o multi-path
        children.forEach((card, index) => {
            const orgId = card.dataset.orgName;
            if (orgId) {
                // Atualiza o 'ordemIndex' de cada organiza√ß√£o
                updates[`organizacoes/${orgId}/ordemIndex`] = index;
            }
        });
        
        if (Object.keys(updates).length > 0) {
            update(ref(db), updates)
                .then(() => {
                    showToast("Ordem das Bases atualizada!", "success");
                    // Atualiza os dados locais (globalAllOrgs) para refletir a nova ordem
                    globalAllOrgs = children.map((card, index) => {
                        const org = globalAllOrgs.find(o => o.id === card.dataset.orgName);
                        if (org) {
                            org.ordemIndex = index;
                        }
                        return org;
                    }).filter(Boolean);
                })
                .catch((err) => {
                    showToast(`Erro ao salvar ordem das Bases: ${err.message}`, "error");
                });
        }
    };
    
    // Inicializa o SortableJS no grid de Bases
    const initOrgSortable = () => {
        if (orgSortableInstance) {
            orgSortableInstance.destroy();
        }
        
        const grid = els.dossierOrgGrid;
        
        // Permiss√£o: Apenas ADMIN ou HELLS podem reorganizar as bases
        const userTagUpper = currentUserData ? currentUserData.tag.toUpperCase() : 'VISITANTE';
        const canDrag = (userTagUpper === 'ADMIN' || userTagUpper === 'HELLS');
        
        orgSortableInstance = new Sortable(grid, {
            animation: 150,
            handle: '.dossier-org-card', 
            group: 'orgs', 
            disabled: !canDrag, 
            ghostClass: 'sortable-ghost',
            // Filtra para ignorar o cabe√ßalho de busca (Bases e Pessoas Encontradas)
            filter: 'h3.dossier-org-title', 
            onEnd: (evt) => {
                // Quando o usu√°rio solta o card, salva a nova ordem
                saveOrgOrder();
            }
        });
    };
    // =============================================
    // FIM: FUN√á√ïES DE ORDENA√á√ÉO DE BASES
    // =============================================
    
    
    // N√≠vel 1: Mostra as Organiza√ß√µes (Bases)
    const showDossierOrgs = async () => {
        els.dossierOrgContainer.style.display = 'block';
        els.dossierPeopleContainer.style.display = 'none';
        els.dossierOrgGrid.innerHTML = '<p>Carregando organiza√ß√µes...</p>';
        globalAllOrgs = [];
        
        try {
            const orgsInfoRef = ref(db, 'organizacoes');
            const orgsInfoSnap = await get(orgsInfoRef);
            const orgsInfo = orgsInfoSnap.exists() ? orgsInfoSnap.val() : {};
            
            const orgsPessoasRef = ref(db, 'dossies');
            const orgsPessoasSnap = await get(orgsPessoasRef);
            const orgsPessoas = orgsPessoasSnap.exists() ? orgsPessoasSnap.val() : {};

            const allOrgNames = new Set([...Object.keys(orgsInfo), ...Object.keys(orgsPessoas)]);
            
            if (allOrgNames.size === 0) {
                els.dossierOrgGrid.innerHTML = '<p>Nenhuma organiza√ß√£o encontrada. Clique em "+ Adicionar Base" para come√ßar.</p>';
                initOrgSortable(); 
                return;
            }
            
            globalAllOrgs = Array.from(allOrgNames).map(orgName => {
                const info = orgsInfo[orgName] || {};
                return {
                    id: orgName,
                    nome: orgName,
                    // Garante que o ordemIndex exista, usando 9999 como fallback
                    ordemIndex: info.ordemIndex !== undefined ? info.ordemIndex : 9999,
                    ...info
                };
            }).sort((a, b) => {
                 // Sort by ordemIndex first, then name
                 const indexA = a.ordemIndex !== undefined ? a.ordemIndex : Infinity;
                 const indexB = b.ordemIndex !== undefined ? b.ordemIndex : Infinity;
                 if (indexA !== indexB) {
                    return indexA - indexB; // Sort by index
                 }
                 return a.nome.localeCompare(b.nome); // Then by name
            });
            
            displayOrgs(globalAllOrgs);
            initOrgSortable(); // <-- Inicializa o sortable para as bases
            
        } catch (error) {
            els.dossierOrgGrid.innerHTML = `<p style="color: var(--cor-erro);">Erro ao carregar organiza√ß√µes: ${error.message}</p>`;
        }
    };
    
    // Renderiza os cards das Organiza√ß√µes (Bases)
    const displayOrgs = (orgs) => {
        els.dossierOrgGrid.innerHTML = '';
        if (orgs.length === 0) {
            els.dossierOrgGrid.innerHTML = '<p>Nenhuma organiza√ß√£o encontrada para este filtro.</p>';
            return;
        }
        
        orgs.forEach(org => {
            const card = document.createElement('div');
            card.className = 'dossier-org-card';
            card.dataset.orgName = org.nome;
            
            const fotoDiv = document.createElement('div');
            fotoDiv.className = 'dossier-org-foto';
            if (org.fotoUrl) {
                const img = document.createElement('img');
                img.src = org.fotoUrl;
                img.alt = `Base de ${org.nome}`;
                fotoDiv.appendChild(img);
            } else {
                fotoDiv.textContent = 'Sem Foto da Base';
            }
            
            const nomeH4 = document.createElement('h4');
            nomeH4.textContent = org.nome;
            
            const infoP = document.createElement('p');
            infoP.textContent = org.info || '(Sem informa√ß√µes da base)';
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'dossier-org-actions';
            actionsDiv.innerHTML = `<button class="action-btn muted edit-org-btn" data-org-id="${org.id}">‚úèÔ∏è Editar Base</button>`;
            
            card.appendChild(fotoDiv);
            card.appendChild(nomeH4);
            card.appendChild(infoP);
            card.appendChild(actionsDiv);
            
            actionsDiv.querySelector('.edit-org-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                openEditOrgModal(org.id);
            });
            
            card.addEventListener('click', () => {
                showDossierPeople(org.nome);
            });
            
            els.dossierOrgGrid.appendChild(card);
        });
    };
    
    // =================================================================
    // IN√çCIO: ALTERA√á√ÉO (Exibi√ß√£o da Busca Global)
    // =================================================================
    /**
     * Exibe os resultados da busca global (Bases e Pessoas) no grid de organiza√ß√µes.
     * Ajustado para que a Base apare√ßa DENTRO do card de Pessoa Encontrada.
     */
    const displayGlobalSearchResults = (orgs, people) => {
        els.dossierOrgGrid.innerHTML = ''; // Limpa o grid
        
        if (orgs.length === 0 && people.length === 0) {
            els.dossierOrgGrid.innerHTML = '<p>Nenhuma organiza√ß√£o ou pessoa encontrada para este filtro.</p>';
            return;
        }

        // 1. Renderiza as Organiza√ß√µes (Bases) encontradas
        if (orgs.length > 0) {
            // T√≠tulo mais compacto para a busca
            const orgsHeader = document.createElement('h3');
            orgsHeader.className = 'dossier-org-title';
            orgsHeader.textContent = 'Bases Encontradas';
            els.dossierOrgGrid.appendChild(orgsHeader);
            
            orgs.forEach(org => {
                // (L√≥gica copiada de displayOrgs)
                const card = document.createElement('div');
                card.className = 'dossier-org-card';
                card.dataset.orgName = org.nome;
                
                // Remove o cursor grab da busca global de orgs para evitar confus√£o se o sortable estiver desabilitado
                card.style.cursor = 'pointer'; 
                
                const fotoDiv = document.createElement('div');
                fotoDiv.className = 'dossier-org-foto';
                if (org.fotoUrl) {
                    const img = document.createElement('img');
                    img.src = org.fotoUrl;
                    img.alt = `Base de ${org.nome}`;
                    fotoDiv.appendChild(img);
                } else {
                    fotoDiv.textContent = 'Sem Foto da Base';
                }
                
                const nomeH4 = document.createElement('h4');
                nomeH4.textContent = org.nome;
                
                const infoP = document.createElement('p');
                infoP.textContent = org.info || '(Sem informa√ß√µes da base)';
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'dossier-org-actions';
                actionsDiv.innerHTML = `<button class="action-btn muted edit-org-btn" data-org-id="${org.id}">‚úèÔ∏è Editar Base</button>`;
                
                card.appendChild(fotoDiv);
                card.appendChild(nomeH4);
                card.appendChild(infoP);
                card.appendChild(actionsDiv);
                
                actionsDiv.querySelector('.edit-org-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    openEditOrgModal(org.id);
                });
                card.addEventListener('click', () => {
                    showDossierPeople(org.nome);
                });
                
                els.dossierOrgGrid.appendChild(card);
            });
        }

        // 2. Renderiza as Pessoas encontradas
        if (people.length > 0) {
            // T√≠tulo "Pessoas Encontradas" mais compacto
            const peopleHeader = document.createElement('h3');
            peopleHeader.className = 'dossier-org-title';
            peopleHeader.textContent = 'Pessoas Encontradas';
            els.dossierOrgGrid.appendChild(peopleHeader);
            
            people.forEach(entry => {
                
                // (L√≥gica copiada de displayPeople)
                const card = document.createElement('div');
                card.className = 'dossier-entry-card';
                card.dataset.id = entry.id; 
                card.style.cursor = 'default'; // O card em si n√£o √© arrast√°vel na busca global
                
                // --- IN√çCIO: ADI√á√ÉO DA BASE DENTRO DO CARD ---
                const baseTitle = document.createElement('h4');
                baseTitle.textContent = `Base: ${entry.org}`;
                baseTitle.style.color = 'var(--cor-principal)'; 
                baseTitle.style.fontSize = '14px';          
                baseTitle.style.textAlign = 'left';       
                baseTitle.style.margin = '0 0 8px 0';       
                baseTitle.style.fontWeight = '600';
                baseTitle.style.borderBottom = '1px solid var(--cor-borda)'; 
                baseTitle.style.paddingBottom = '5px';      
                
                card.appendChild(baseTitle); 
                // --- FIM: ADI√á√ÉO DA BASE DENTRO DO CARD ---

                const fotoDiv = document.createElement('div');
                fotoDiv.className = 'dossier-foto';
                if (entry.fotoUrl) {
                    const img = document.createElement('img');
                    img.src = entry.fotoUrl;
                    img.alt = `Foto de ${entry.nome}`;
                    fotoDiv.appendChild(img);
                } else {
                    fotoDiv.textContent = 'Sem Foto';
                }
                
                const nomeH4 = document.createElement('h4');
                nomeH4.textContent = entry.nome || '(Sem Nome)';
                
                const numeroP = document.createElement('p');
                numeroP.textContent = entry.numero || '(Sem N√∫mero)';

                const cargoP = document.createElement('p');
                cargoP.innerHTML = `<strong>Cargo:</strong> ${entry.cargo || 'N/A'}`;
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'dossier-actions';
                actionsDiv.innerHTML = `
                    <button class="action-btn muted edit-dossier-btn" data-org="${entry.org}" data-id="${entry.id}">‚úèÔ∏è Editar</button>
                    <button class="action-btn danger delete-dossier-btn" data-org="${entry.org}" data-id="${entry.id}">‚ùå Apagar</button>
                `;
                
                card.appendChild(fotoDiv);
                card.appendChild(nomeH4);
                card.appendChild(numeroP);
                card.appendChild(cargoP);
                
                if (entry.instagram) {
                    const instagramP = document.createElement('p');
                    let instaHandle = entry.instagram.startsWith('@') ? entry.instagram.substring(1) : entry.instagram;
                    instaHandle = instaHandle.split('/')[0]; 
                    instagramP.innerHTML = `<strong>Instagram:</strong> <span style="color: var(--cor-principal); font-weight: 500;">@${instaHandle}</span>`;
                    instagramP.style.fontSize = '13px';
                    card.appendChild(instagramP);
                }
                
                const veiculos = entry.veiculos || {};
                const veiculosCount = Object.keys(veiculos).length;

                if (veiculosCount > 0) {
                    const details = document.createElement('details');
                    details.style.marginTop = '5px';
                    const summary = document.createElement('summary');
                    summary.innerHTML = `<strong>Ve√≠culos (${veiculosCount})</strong> (Clique para ver)`;
                    summary.style.cursor = 'pointer';
                    summary.style.fontWeight = '600';
                    summary.style.color = 'var(--cor-principal)';
                    summary.style.fontSize = '13px';
                    details.appendChild(summary);
                    for (const id in veiculos) {
                        const veiculo = veiculos[id];
                        const p = document.createElement('p');
                        let fotoLink = '';
                        if (veiculo.fotoUrl) {
                            fotoLink = ` <a href="#" class="veiculo-foto-link" data-url="${veiculo.fotoUrl}" style="font-size: 11px; color: var(--cor-principal); text-decoration: none; font-weight: 600;">[Ver Foto]</a>`;
                        } else {
                            fotoLink = ` <span style="font-size: 11px; color: #888; font-weight: normal;">[Sem Foto]</span>`;
                        }
                        p.innerHTML = `<strong>${veiculo.carro || 'N/A'}:</strong> ${veiculo.placa || 'N/A'}${fotoLink}`;
                        p.style.fontWeight = 'normal';
                        p.style.color = 'var(--cor-texto)';
                        p.style.marginTop = '5px';
                        p.style.textAlign = 'left';
                        details.appendChild(p);
                    }
                    card.appendChild(details);
                } else {
                    const p = document.createElement('p');
                    p.innerHTML = '<strong>Ve√≠culos:</strong> N/A';
                    p.style.fontWeight = 'normal';
                    p.style.color = 'var(--cor-texto)';
                    card.appendChild(p);
                }
                
                card.appendChild(actionsDiv);
                els.dossierOrgGrid.appendChild(card);
            });
            
            // N√£o deve ter Sortable ativo quando h√° resultados de busca mista.
            if (orgSortableInstance) {
                orgSortableInstance.destroy();
                orgSortableInstance = null;
            }
        }
    };
    // =================================================================
    // FIM: ALTERA√á√ÉO
    // =================================================================
    
    // Filtra a lista de Organiza√ß√µes (Bases)
    const filterOrgs = async () => {
        const query = els.filtroDossierOrgs.value.toLowerCase().trim();
        
        // Se a busca estiver vazia, volta para a exibi√ß√£o normal ordenada.
        if (!query) {
            displayOrgs(globalAllOrgs); // Mostra todas as orgs (do cache)
            initOrgSortable(); // Re-inicializa o Sortable para ordena√ß√£o
            return;
        }
        
        els.dossierOrgGrid.innerHTML = '<p>Buscando...</p>'; // Feedback de carregamento
        
        // 1. Filtra as Organiza√ß√µes (do cache)
        const filteredOrgs = globalAllOrgs.filter(org => 
            org.nome.toLowerCase().includes(query)
        );
        
        // 2. Busca Pessoas (do Banco de Dados)
        const filteredPeople = await searchAllPeopleGlobal(query);
        
        // 3. Exibe ambos os resultados
        displayGlobalSearchResults(filteredOrgs, filteredPeople);
        
        // Destr√≥i o sortable de bases quando a busca mista est√° ativa
        if (orgSortableInstance) {
            orgSortableInstance.destroy();
            orgSortableInstance = null;
        }
    };

    // N√≠vel 2: Mostra as Pessoas (Membros) de uma Org
    const showDossierPeople = async (orgName) => {
        els.dossierOrgContainer.style.display = 'none';
        els.dossierPeopleContainer.style.display = 'block';
        els.dossierPeopleTitle.textContent = `Membros: ${orgName}`;
        els.dossierPeopleGrid.innerHTML = '<p>Carregando membros...</p>';
        
        els.addPessoaBtn.dataset.orgName = orgName;
        
        globalCurrentPeople = [];
        
        // Destr√≥i o sortable de bases antes de mudar a view
        if (orgSortableInstance) {
            orgSortableInstance.destroy();
            orgSortableInstance = null;
        }
        
        try {
            const peopleRef = ref(db, `dossies/${orgName}`);
            const snapshot = await get(peopleRef);
            
            if (!snapshot.exists()) {
                els.dossierPeopleGrid.innerHTML = '<p>Nenhum membro registrado para esta organiza√ß√£o.</p>';
                initSortable(orgName); // <-- MUDAN√áA: HIERARQUIA (Inicializa mesmo se vazio)
                return;
            }
            
            const peopleData = snapshot.val();
            for (const personId in peopleData) {
                globalCurrentPeople.push({
                    id: personId,
                    org: orgName,
                    ...peopleData[personId]
                });
            }
            
            // --- MUDAN√áA: HIERARQUIA (Ordena pelo √≠ndice) ---
            globalCurrentPeople.sort((a, b) => {
                const indexA = a.hierarquiaIndex !== undefined ? a.hierarquiaIndex : Infinity;
                const indexB = b.hierarquiaIndex !== undefined ? b.hierarquiaIndex : Infinity;
                if (indexA !== indexB) {
                    return indexA - indexB; // Ordena pelo √≠ndice
                }
                // Se o √≠ndice for o mesmo (ou n√£o existir), ordena por nome
                return (a.nome || '').localeCompare(b.nome || ''); 
            });
            // --- FIM DA MUDAN√áA ---
            
            displayPeople(globalCurrentPeople);
            
            initSortable(orgName); // <-- MUDAN√áA: HIERARQUIA (Inicializa o SortableJS)
            
        } catch (error) {
            els.dossierPeopleGrid.innerHTML = `<p style="color: var(--cor-erro);">Erro ao carregar membros: ${error.message}</p>`;
        }
    };
    
    // Renderiza os cards das Pessoas (Membros)
    const displayPeople = (people) => {
        els.dossierPeopleGrid.innerHTML = '';
        if (people.length === 0) {
            els.dossierPeopleGrid.innerHTML = '<p>Nenhum membro encontrado para este filtro.</p>';
            return;
        }

        people.forEach(entry => {
            const card = document.createElement('div');
            card.className = 'dossier-entry-card';
            card.dataset.id = entry.id; // <-- MUDAN√áA: HIERARQUIA (Necess√°rio para salvar)
            
            const fotoDiv = document.createElement('div');
            fotoDiv.className = 'dossier-foto';
            if (entry.fotoUrl) {
                const img = document.createElement('img');
                img.src = entry.fotoUrl;
                img.alt = `Foto de ${entry.nome}`;
                fotoDiv.appendChild(img);
            } else {
                fotoDiv.textContent = 'Sem Foto';
            }
            
            const nomeH4 = document.createElement('h4');
            nomeH4.textContent = entry.nome || '(Sem Nome)';
            
            const numeroP = document.createElement('p');
            numeroP.textContent = entry.numero || '(Sem N√∫mero)';

            const cargoP = document.createElement('p');
            cargoP.innerHTML = `<strong>Cargo:</strong> ${entry.cargo || 'N/A'}`;
            
            
            // --- Bloco de A√ß√µes (Criado antes) ---
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'dossier-actions';
            actionsDiv.innerHTML = `
                <button class="action-btn muted edit-dossier-btn" data-org="${entry.org}" data-id="${entry.id}">‚úèÔ∏è Editar</button>
                <button class="action-btn danger delete-dossier-btn" data-org="${entry.org}" data-id="${entry.id}">‚ùå Apagar</button>
            `;
            
            // --- Ordem de Apresenta√ß√£o no Card ---
            card.appendChild(fotoDiv);
            card.appendChild(nomeH4);
            card.appendChild(numeroP);
            card.appendChild(cargoP);
            
            // --- MUDAN√áA: INSTAGRAM (Adiciona o campo no card) ---
            if (entry.instagram) {
                const instagramP = document.createElement('p');
                // Limpa o @ ou URL
                let instaHandle = entry.instagram.startsWith('@') ? entry.instagram.substring(1) : entry.instagram;
                instaHandle = instaHandle.split('/')[0]; // Remove barras caso seja URL
                
                // --- MUDAN√áA: INSTAGRAM N√ÉO CLIC√ÅVEL ---
                instagramP.innerHTML = `<strong>Instagram:</strong> <span style="color: var(--cor-principal); font-weight: 500;">@${instaHandle}</span>`;
                // --- FIM DA MUDAN√áA ---
                
                instagramP.style.fontSize = '13px';
                card.appendChild(instagramP);
            }
            // --- FIM DA MUDAN√áA ---
            
            // --- IN√çCIO DA ALTERA√á√ÉO 1: Mover Ve√≠culos para baixo do Cargo ---
            const veiculos = entry.veiculos || {};
            const veiculosCount = Object.keys(veiculos).length;

            if (veiculosCount > 0) {
                const details = document.createElement('details');
                details.style.marginTop = '5px';
                
                const summary = document.createElement('summary');
                summary.innerHTML = `<strong>Ve√≠culos (${veiculosCount})</strong> (Clique para ver)`;
                summary.style.cursor = 'pointer';
                summary.style.fontWeight = '600';
                summary.style.color = 'var(--cor-principal)';
                summary.style.fontSize = '13px';
                
                details.appendChild(summary);
                
                for (const id in veiculos) {
                    const veiculo = veiculos[id];
                    const p = document.createElement('p');
                    
                    // --- L√ìGICA DA FOTO DO VE√çCULO (MODIFICADA P/ LIGHTBOX) ---
                    let fotoLink = '';
                    if (veiculo.fotoUrl) {
                        fotoLink = ` <a href="#" class="veiculo-foto-link" data-url="${veiculo.fotoUrl}" style="font-size: 11px; color: var(--cor-principal); text-decoration: none; font-weight: 600;">[Ver Foto]</a>`;
                    } else {
                        fotoLink = ` <span style="font-size: 11px; color: #888; font-weight: normal;">[Sem Foto]</span>`;
                    }
                    // --- FIM DA L√ìGICA DA FOTO ---
                    
                    p.innerHTML = `<strong>${veiculo.carro || 'N/A'}:</strong> ${veiculo.placa || 'N/A'}${fotoLink}`;
                    p.style.fontWeight = 'normal';
                    p.style.color = 'var(--cor-texto)';
                    p.style.marginTop = '5px';
                    p.style.textAlign = 'left';
                    details.appendChild(p);
                }
                card.appendChild(details);
            } else {
                const p = document.createElement('p');
                p.innerHTML = '<strong>Ve√≠culos:</strong> N/A';
                // Adicionando estilos para consist√™ncia
                p.style.fontWeight = 'normal';
                p.style.color = 'var(--cor-texto)';
                card.appendChild(p);
            }
            // --- FIM DA ALTERA√á√ÉO 1 ---
            
            card.appendChild(actionsDiv); // Adiciona as a√ß√µes no final
            
            els.dossierPeopleGrid.appendChild(card);
        });
    };

    // Filtra a lista de Pessoas (Membros)
    const filterPeople = () => {
        const query = els.filtroDossierPeople.value.toLowerCase().trim();
        if (!query) {
            displayPeople(globalCurrentPeople);
            return;
        }
        
        const filteredPeople = globalCurrentPeople.filter(entry => {
            const nome = entry.nome ? entry.nome.toLowerCase() : '';
            const cargo = entry.cargo ? entry.cargo.toLowerCase() : '';
            const instagram = entry.instagram ? entry.instagram.toLowerCase() : ''; // <-- MUDAN√áA: INSTAGRAM (Filtro)
            
            let veiculoMatch = false;
            if (entry.veiculos) {
                for (const id in entry.veiculos) {
                    const v = entry.veiculos[id];
                    if ((v.carro && v.carro.toLowerCase().includes(query)) || (v.placa && v.placa.toLowerCase().includes(query))) {
                        veiculoMatch = true;
                        break;
                    }
                }
            }
            
            return nome.includes(query) || cargo.includes(query) || instagram.includes(query) || veiculoMatch; 
        });
        
        displayPeople(filteredPeople);
    };
    
    // --- Fun√ß√µes dos Modais de Organiza√ß√£o (Base) ---
    
    const openAddOrgModal = () => {
        els.orgModalTitle.textContent = "Adicionar Nova Base";
        els.editOrgId.value = '';
        els.orgNome.value = '';
        els.orgNome.disabled = false;
        els.orgFotoUrl.value = '';
        els.orgInfo.value = '';
        els.deleteOrgBtn.style.display = 'none';
        
        document.querySelectorAll('.input-invalido').forEach(el => el.classList.remove('input-invalido'));
        
        els.orgModalOverlay.style.display = 'block';
        els.orgModal.style.display = 'block';
        els.orgNome.focus();
    };
    
    const openEditOrgModal = (orgId) => {
        const org = globalAllOrgs.find(o => o.id === orgId);
        if (!org) {
            showToast("Erro: Organiza√ß√£o n√£o encontrada.", "error");
            return;
        }
        
        els.orgModalTitle.textContent = "Editar Base";
        els.editOrgId.value = org.id;
        els.orgNome.value = org.nome;
        els.orgNome.disabled = true;
        els.orgFotoUrl.value = org.fotoUrl || '';
        els.orgInfo.value = org.info || '';
        els.deleteOrgBtn.style.display = 'inline-block';
        
        document.querySelectorAll('.input-invalido').forEach(el => el.classList.remove('input-invalido'));

        els.orgModalOverlay.style.display = 'block';
        els.orgModal.style.display = 'block';
        els.orgFotoUrl.focus();
    };
    
    const closeOrgModal = () => {
        els.orgModalOverlay.style.display = 'none';
        els.orgModal.style.display = 'none';
    };
    
    // =================================================================
    // IN√çCIO: ALTERA√á√ÉO (saveOrg para adicionar ordemIndex)
    // =================================================================
    const saveOrg = async () => {
        const orgNome = capitalizeText(els.orgNome.value.trim());
        const orgId = els.editOrgId.value || orgNome;
        
        if (!orgId) {
            showToast("O Nome da Organiza√ß√£o √© obrigat√≥rio.", "error");
            els.orgNome.classList.add('input-invalido');
            return;
        }
        els.orgNome.classList.remove('input-invalido');
        
        const orgRef = ref(db, `organizacoes/${orgId}`);
        
        let existingIndex = 9999;
        // Se estiver editando, busca o √≠ndice existente para preserv√°-lo
        if (els.editOrgId.value) {
            try {
                const snapshot = await get(orgRef);
                if (snapshot.exists()) {
                    // Preserva o √≠ndice se ele existir, sen√£o usa 9999
                    existingIndex = snapshot.val().ordemIndex !== undefined ? snapshot.val().ordemIndex : 9999;
                }
            } catch (e) {
                console.error("Erro ao buscar ordemIndex:", e);
            }
        } 
        // Se estiver adicionando, ele usa o 9999 default (vai para o final)

        const orgData = {
            nome: orgNome,
            fotoUrl: els.orgFotoUrl.value.trim(),
            info: els.orgInfo.value.trim(),
            ordemIndex: existingIndex // Adiciona o √≠ndice de ordena√ß√£o
        };
        
        set(orgRef, orgData)
            .then(() => {
                showToast("Base salva com sucesso!", "success");
                closeOrgModal();
                showDossierOrgs();
            })
            .catch(err => showToast(`Erro ao salvar: ${err.message}`, "error"));
    };
    // =================================================================
    // FIM: ALTERA√á√ÉO
    // =================================================================
    
    const deleteOrg = () => {
        const orgId = els.editOrgId.value;
        if (!orgId) return;
        
        if (confirm(`ATEN√á√ÉO:\n\nIsso apagar√° as INFORMA√á√ïES DA BASE "${orgId}".\n\NIsso N√ÉO apagar√° os membros (pessoas) que est√£o dentro dela.\n\nDeseja continuar?`)) {
            remove(ref(db, `organizacoes/${orgId}`))
                .then(() => {
                    showToast("Informa√ß√µes da base removidas.", "success");
                    closeOrgModal();
                    showDossierOrgs();
                })
                .catch(err => showToast(`Erro: ${err.message}`, "error"));
        }
    };
    
    // --- Fun√ß√µes dos Modais de Pessoa (Membros) ---
    
    // --- IN√çCIO: NOVAS FUN√á√ïES DO GERENCIADOR DE VE√çCULOS (Com Edi√ß√£o) ---
    
    // Renderiza a lista de ve√≠culos no modal
    const renderModalVeiculos = (listaElement) => {
        listaElement.innerHTML = ''; // Limpa a lista
        if (Object.keys(tempVeiculos).length === 0) {
            listaElement.innerHTML = '<p style="font-size: 13px; text-align: center; margin: 0; padding: 5px;">Nenhum ve√≠culo adicionado.</p>';
            return;
        }
        
        for (const key in tempVeiculos) {
            const veiculo = tempVeiculos[key];
            const itemDiv = document.createElement('div');
            itemDiv.className = 'veiculo-item-modal';
            // Adicionado bot√£o de Editar
            itemDiv.innerHTML = `
                <span style="flex-grow: 1;"><strong>${veiculo.carro || 'N/A'}:</strong> ${veiculo.placa || 'N/A'}</span>
                <button class="muted action-btn edit-veiculo-btn" data-key="${key}">Editar</button>
                <button class="danger action-btn remove-veiculo-btn" data-key="${key}">Remover</button>
            `;
            listaElement.appendChild(itemDiv);
        }
    };
    
    // Inicia a edi√ß√£o de um ve√≠culo (preenche os campos)
    const iniciarEdicaoVeiculo = (key, modalPrefix) => {
        if (!tempVeiculos[key]) return;
        
        const veiculo = tempVeiculos[key];
        veiculoEmEdicaoKey = key; // Define a chave global
        
        // Preenche os campos do modal correto
        els[modalPrefix + 'CarroNome'].value = veiculo.carro;
        els[modalPrefix + 'CarroPlaca'].value = veiculo.placa;
        els[modalPrefix + 'CarroFoto'].value = veiculo.fotoUrl;
        
        // Muda os bot√µes
        els[modalPrefix + 'AddVeiculoBtn'].textContent = 'Atualizar Ve√≠culo';
        els[modalPrefix + 'CancelVeiculoBtn'].style.display = 'inline-block';
        
        els[modalPrefix + 'CarroNome'].focus();
    };
    
    // Cancela a edi√ß√£o de um ve√≠culo (limpa campos e reseta bot√µes)
    const cancelarEdicaoVeiculo = (modalPrefix) => {
        veiculoEmEdicaoKey = null; // Limpa a chave global
        
        // Limpa os campos
        els[modalPrefix + 'CarroNome'].value = '';
        els[modalPrefix + 'CarroPlaca'].value = '';
        els[modalPrefix + 'CarroFoto'].value = '';
        
        // Reseta os bot√µes
        els[modalPrefix + 'AddVeiculoBtn'].textContent = '+ Adicionar Ve√≠culo';
        els[modalPrefix + 'CancelVeiculoBtn'].style.display = 'none';
    };

    // Adiciona OU Atualiza um ve√≠culo no objeto tempVeiculos
    const adicionarOuAtualizarVeiculoTemp = (modalPrefix) => {
        const carroEl = els[modalPrefix + 'CarroNome'];
        const placaEl = els[modalPrefix + 'CarroPlaca'];
        const fotoEl = els[modalPrefix + 'CarroFoto'];
        const listaEl = els[modalPrefix + 'ListaVeiculos'];

        const carro = carroEl.value.trim();
        const placa = placaEl.value.trim().toUpperCase();
        const fotoUrl = fotoEl.value.trim();
        
        if (!carro || !placa) {
            showToast("Preencha o nome do carro e a placa.", "error");
            return;
        }
        
        if (veiculoEmEdicaoKey) {
            // --- MODO DE ATUALIZA√á√ÉO ---
            if (tempVeiculos[veiculoEmEdicaoKey]) {
                tempVeiculos[veiculoEmEdicaoKey] = { carro, placa, fotoUrl };
            }
        } else {
            // --- MODO DE ADI√á√ÉO ---
            const tempKey = `temp_${Date.now()}`;
            tempVeiculos[tempKey] = { carro, placa, fotoUrl };
        }
        
        renderModalVeiculos(listaEl); // Re-renderiza a lista
        cancelarEdicaoVeiculo(modalPrefix); // Limpa campos e reseta bot√µes/chave
    };
    
    // Remove um ve√≠culo do objeto tempVeiculos
    const removerVeiculoTemp = (key, listaEl) => {
        if (tempVeiculos[key]) {
            delete tempVeiculos[key];
            renderModalVeiculos(listaEl);
        }
    };
    // --- FIM: Fun√ß√µes do Gerenciador de Ve√≠culos ---

    
    const openAddDossierModal = (orgName) => {
        els.addDossierOrganizacao.value = orgName;
        els.addDossierNome.value = '';
        els.addDossierNumero.value = '';
        els.addDossierCargo.value = '';
        els.addDossierFotoUrl.value = '';
        // N√£o h√° campo instagram aqui (conforme solicitado)
        
        tempVeiculos = {}; // Limpa os ve√≠culos tempor√°rios
        cancelarEdicaoVeiculo('addModal'); // Garante que o estado de edi√ß√£o seja resetado
        renderModalVeiculos(els.addModalListaVeiculos); // Renderiza a lista vazia
        
        document.querySelectorAll('.input-invalido').forEach(el => el.classList.remove('input-invalido'));
        
        els.addDossierOverlay.style.display = 'block';
        els.addDossierModal.style.display = 'block';
        els.addDossierNome.focus();
    };
    
    const closeAddDossierModal = () => {
        els.addDossierOverlay.style.display = 'none';
        els.addDossierModal.style.display = 'none';
        cancelarEdicaoVeiculo('addModal'); // Limpa o estado de edi√ß√£o ao fechar
    };
    
    const saveNewDossierEntry = () => {
        const org = els.addDossierOrganizacao.value.trim();
        if (!org) {
            showToast("Erro: Organiza√ß√£o n√£o definida.", "error");
            return;
        }
        
        const nome = els.addDossierNome.value.trim();
        if (!nome) {
            showToast("O Nome da pessoa √© obrigat√≥rio.", "error");
            els.addDossierNome.classList.add('input-invalido');
            return;
        }
        els.addDossierNome.classList.remove('input-invalido');

        const agora = new Date();
        const dia = String(agora.getDate()).padStart(2, '0');
        const mes = String(agora.getMonth() + 1).padStart(2, '0');
        const ano = agora.getFullYear();
        const horas = String(agora.getHours()).padStart(2, '0');
        const minutos = String(agora.getMinutes()).padStart(2, '0');

        const newEntry = {
            organizacao: org,
            nome: nome,
            numero: els.addDossierNumero.value.trim(),
            cargo: els.addDossierCargo.value.trim(),
            fotoUrl: els.addDossierFotoUrl.value.trim(),
            instagram: "", // <-- MUDAN√áA: INSTAGRAM (Inicializa vazio)
            veiculos: tempVeiculos, // Salva o objeto de ve√≠culos
            hierarquiaIndex: 9999, // <-- MUDAN√áA: HIERARQUIA (Novo membro vai para o fim)
            data: `${dia}/${mes}/${ano} ${horas}:${minutos}`
        };
        
        // Push para o banco de dados
        push(ref(db, `dossies/${org}`), newEntry)
            .then(() => {
                 showToast("Nova pessoa salva no dossi√™!", "success");
                 closeAddDossierModal();
                 showDossierPeople(org);
            })
            .catch(err => showToast(`Erro ao salvar: ${err.message}`, "error"));
    };
    
    // =================================================================
    // IN√çCIO: ALTERA√á√ÉO (Corre√ß√£o do Modal de Edi√ß√£o)
    // =================================================================
    // **** MODIFICADO (Request 1): Agora √© async e busca dados se n√£o estiverem em cache ****
    const openEditDossierModal = async (org, id) => {
        // Tenta encontrar a pessoa no cache (globalCurrentPeople)
        let entry = globalCurrentPeople.find(e => e.id === id && e.org === org);
        
        // Se n√£o encontrar (ex: vindo da busca global), busca no Firebase
        if (!entry) {
            try {
                const entryRef = ref(db, `dossies/${org}/${id}`);
                const snapshot = await get(entryRef);
                if (snapshot.exists()) {
                    entry = { id: snapshot.key, org: org, ...snapshot.val() };
                    // Define o cache temporariamente para esta pessoa
                    // para que a fun√ß√£o 'Salvar' funcione
                    globalCurrentPeople = [entry];
                } else {
                    showToast("Erro: Entrada n√£o encontrada no Banco de Dados.", "error");
                    return;
                }
            } catch (e) {
                showToast(`Erro ao buscar dados da pessoa: ${e.message}`, "error");
                return;
            }
        }
        
        // Continua√ß√£o normal da fun√ß√£o...
        
        els.editDossierOrg.value = entry.org;
        els.editDossierId.value = entry.id;
        els.editDossierNome.value = entry.nome || '';
        els.editDossierNumero.value = entry.numero || '';
        els.editDossierCargo.value = entry.cargo || '';
        els.editDossierFotoUrl.value = entry.fotoUrl || '';
        els.editDossierInstagram.value = entry.instagram || ''; // <-- MUDAN√áA: INSTAGRAM
        
        // Carrega os ve√≠culos existentes para o gerenciador
        tempVeiculos = { ...(entry.veiculos || {}) };
        cancelarEdicaoVeiculo('editModal'); // Garante que o estado de edi√ß√£o seja resetado
        renderModalVeiculos(els.editModalListaVeiculos);
        
        els.editDossierOverlay.style.display = 'block';
        els.editDossierModal.style.display = 'block';
    };
    // =================================================================
    // FIM: ALTERA√á√ÉO
    // =================================================================

    const closeEditDossierModal = () => {
        els.editDossierOverlay.style.display = 'none';
        els.editDossierModal.style.display = 'none';
        cancelarEdicaoVeiculo('editModal'); // Limpa o estado de edi√ß√£o ao fechar
    };
    
    const saveDossierChanges = () => {
        const org = els.editDossierOrg.value;
        const id = els.editDossierId.value;
        
        if (!org || !id) {
            showToast("Erro: ID da entrada perdido.", "error");
            return;
        }
        
        const originalEntry = globalCurrentPeople.find(e => e.id === id && e.org === org);
        if (!originalEntry) {
            showToast("Erro: Entrada original n√£o encontrada.", "error");
            return;
        }
        
        const updatedEntry = {
            ...originalEntry,
            nome: els.editDossierNome.value.trim(),
            numero: els.editDossierNumero.value.trim(),
            cargo: els.editDossierCargo.value.trim(),
            fotoUrl: els.editDossierFotoUrl.value.trim(),
            instagram: els.editDossierInstagram.value.trim(), // <-- MUDAN√áA: INSTAGRAM
            veiculos: tempVeiculos // Salva o objeto de ve√≠culos atualizado
            // O hierarquiaIndex √© preservado pelo spread (...originalEntry)
        };
        
        delete updatedEntry.id;
        delete updatedEntry.org;

        const entryRef = ref(db, `dossies/${org}/${id}`);
        set(entryRef, updatedEntry)
            .then(() => {
                showToast("Dossi√™ atualizado com sucesso!", "success");
                closeEditDossierModal();
                showDossierPeople(org);
            })
            .catch((error) => {
                showToast(`Erro ao salvar: ${error.message}`, "error");
            });
    };
    
    const removeDossierEntry = (orgName, entryId) => {
        const userTagUpper = currentUserData.tag.toUpperCase();
        if (!currentUserData || (userTagUpper !== 'ADMIN' && userTagUpper !== 'HELLS')) {
            showToast("Apenas Admin/Hells podem remover entradas.", "error");
            return;
        }
        
        if (confirm("Tem certeza que deseja remover esta PESSOA do dossi√™?")) {
            const entryRef = ref(db, `dossies/${orgName}/${entryId}`);
            remove(entryRef)
                .then(() => {
                    showToast("Pessoa removida do dossi√™.", "success");
                    showDossierPeople(orgName);
                })
                .catch((error) => {
                    showToast(`Erro ao remover: ${error.message}`, "error");
                });
        }
    };
    
    const migrateVendasToDossier = async () => {
        if (!confirm("Isso ir√° copiar *todas* as vendas com organiza√ß√£o para o Dossi√™ de Pessoas. (J√° faz verifica√ß√£o de duplicados). Deseja continuar?")) {
            return;
        }
        
        showToast("Iniciando migra√ß√£o... Isso pode demorar.", "default", 5000);
        els.migrateDossierBtn.disabled = true;
        els.migrateDossierBtn.textContent = "Migrando...";
        
        try {
            const vendasRef = ref(db, 'vendas');
            const snapshot = await get(vendasRef);
            
            if (!snapshot.exists()) {
                showToast("Nenhuma venda encontrada para migrar.", "error");
                return;
            }
            
            const vendas = snapshot.val();
            let count = 0;
            
            for (const vendaId in vendas) {
                const venda = vendas[vendaId];
                
                // Transforma a venda no formato esperado por addDossierEntry
                const vendaData = {
                    cliente: venda.cliente,
                    organizacao: venda.organizacao,
                    telefone: venda.telefone,
                    vendaValorObs: venda.vendaValorObs || 'N/A (Migrado)',
                    dataHora: venda.dataHora,
                    // *** MODIFICA√á√ÉO: Passa os dados de ve√≠culo para a fun√ß√£o de migra√ß√£o ***
                    carro: venda.carro,
                    placas: venda.placas
                };

                // Roda a l√≥gica de add (que j√° faz a deduplica√ß√£o E mescla ve√≠culos)
                // **** MODIFICA√á√ÉO (v12): Passa 'null' para dadosAntigos
                await addDossierEntry(vendaData, null);
                count++;
            }
            
            showToast(`Migra√ß√£o conclu√≠da! ${count} registros verificados/migrados.`, "success");
            
        } catch (error) {
            showToast(`Erro na migra√ß√£o: ${error.message}`, "error");
        } finally {
            els.migrateDossierBtn.disabled = false;
            els.migrateDossierBtn.textContent = "Migrar Vendas Antigas para Dossi√™";
        }
    };
    
    // --- FUN√á√ÉO DE MIGRA√á√ÉO DE VE√çCULOS (v9 - Atualizada) ---
    const migrateVeiculosData = async () => {
        if (!confirm("ATEN√á√ÉO: Isso ir√° converter TODOS os campos 'carro' e 'placas' (com v√≠rgulas) para o novo sistema de ve√≠culos. Fa√ßa isso APENAS UMA VEZ.\n\nDeseja continuar?")) {
            return;
        }
        
        showToast("Iniciando migra√ß√£o de ve√≠culos... Isso pode demorar.", "default", 5000);
        els.migrateVeiculosBtn.disabled = true;
        els.migrateVeiculosBtn.textContent = "Migrando...";
        
        try {
            const dossiesRef = ref(db, 'dossies');
            const snapshot = await get(dossiesRef);
            
            if (!snapshot.exists()) {
                showToast("Nenhum dossi√™ encontrado.", "error");
                return;
            }
            
            const dossies = snapshot.val();
            let count = 0;
            const updates = {};
            
            for (const org in dossies) {
                for (const personId in dossies[org]) {
                    const person = dossies[org][personId];
                    
                    // Verifica se a pessoa tem os campos antigos (carro/placas)
                    // E se ainda N√ÉO tem o campo novo (veiculos)
                    if ((person.carro || person.placas) && !person.veiculos) {
                        const newVeiculos = {};
                        const carros = person.carro ? person.carro.split(',').map(c => c.trim()) : [];
                        const placas = person.placas ? person.placas.split(',').map(p => p.trim()) : [];
                        
                        const maxLen = Math.max(carros.length, placas.length);
                        
                        for (let i = 0; i < maxLen; i++) {
                            const newKey = `mig_${i}`;
                            newVeiculos[newKey] = {
                                carro: carros[i] || 'N/A',
                                placa: placas[i] || 'N/A',
                                fotoUrl: '' // ADICIONA O CAMPO DE FOTO VAZIO
                            };
                        }
                        
                        // Prepara o update para esta pessoa
                        const path = `dossies/${org}/${personId}`;
                        updates[`${path}/veiculos`] = newVeiculos;
                        updates[`${path}/carro`] = null; // Remove o campo antigo
                        updates[`${path}/placas`] = null; // Remove o campo antigo
                        count++;
                    }
                }
            }
            
            if (count > 0) {
                await update(ref(db), updates);
                showToast(`Migra√ß√£o de ve√≠culos conclu√≠da! ${count} registros atualizados.`, "success");
            } else {
                showToast("Nenhum registro antigo para migrar.", "default");
            }
            
        } catch (error) {
            showToast(`Erro na migra√ß√£o de ve√≠culos: ${error.message}`, "error");
        } finally {
            els.migrateVeiculosBtn.disabled = false;
            els.migrateVeiculosBtn.textContent = "Migrar Ve√≠culos Antigos (Dossi√™)";
        }
    };
    // --- FIM ---
    
    // **** FIM DAS FUN√á√ïES DO DOSSI√ä (v12) ****
    
    const toggleTheme = () => {
        const isDarkMode = document.body.classList.toggle('dark');
        localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        updateLogoAndThemeButton(isDarkMode);
    };

    const updateLogoAndThemeButton = (isDarkMode) => {
        els.themeBtn.textContent = isDarkMode ? '‚òÄÔ∏è Modo Claro' : 'üåô Modo Noturno';
        els.appLogo.src = isDarkMode ? logoDarkModeSrc : logoLightModeSrc;
        els.welcomeLogo.src = welcomeLogoSrc;
        els.historyImg.src = historyBackgroundSrc;
    };

    const tourSteps = [
        { element: 'qtyTickets', title: '1/5: Quantidades', content: 'Comece inserindo a quantidade de produtos que deseja calcular ou vender.' },
        { element: 'tipoValor', title: '2/5: Tipo de Valor', content: 'Selecione o tipo de pagamento. Isso afeta o pre√ßo final de cada item.' },
        { element: 'calcBtn', title: '3/5: Calcular', content: 'Clique aqui para ver os materiais necess√°rios e o valor total da venda.' },
        { element: 'registerBtn', title: '4.5: Registrar Venda', content: 'Ap√≥s calcular, preencha os dados do cliente e clique para salvar no hist√≥rico.' },
        { element: 'toggleHistoryBtn', title: '5/5: Ver Hist√≥rico', content: 'Acesse o hist√≥rico para ver, editar, apagar ou copiar vendas antigas.' }
    ];
    let currentStepIndex = -1; let currentTooltip = null; let tourOverlay = null;
    const clearTour = () => { if(tourOverlay) { tourOverlay.classList.remove('active'); setTimeout(() => { if (tourOverlay && tourOverlay.parentNode) tourOverlay.parentNode.removeChild(tourOverlay); tourOverlay = null; }, 300); } if (currentTooltip) { currentTooltip.classList.remove('active'); setTimeout(() => { if (currentTooltip && currentTooltip.parentNode) currentTooltip.parentNode.removeChild(currentTooltip); currentTooltip = null; }, 300); } document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight')); currentStepIndex = -1; };
    const showNextTourStep = () => { if (currentStepIndex >= 0) { document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight')); if(currentTooltip) currentTooltip.classList.remove('active'); } currentStepIndex++; if (currentStepIndex >= tourSteps.length) { showToast("Tutorial conclu√≠do!", "success"); clearTour(); return; } const step = tourSteps[currentStepIndex]; const targetElement = els[step.element]; if (!targetElement) { clearTour(); return; } if (currentStepIndex === 0) { tourOverlay = document.createElement('div'); tourOverlay.id = 'tour-overlay'; document.body.appendChild(tourOverlay); setTimeout(() => tourOverlay.classList.add('active'), 10); } targetElement.classList.add('tour-highlight'); if(currentTooltip && currentTooltip.parentNode) document.body.removeChild(currentTooltip); currentTooltip = document.createElement('div'); currentTooltip.className = 'tour-tooltip'; currentTooltip.innerHTML = `<h4>${step.title}</h4><p>${step.content}</p><div><button class="tourNextBtn">${currentStepIndex === tourSteps.length - 1 ? 'Finalizar' : 'Pr√≥ximo'}</button><button class="tourSkipBtn">Pular</button></div>`; document.body.appendChild(currentTooltip); const rect = targetElement.getBoundingClientRect(); let top = rect.top < currentTooltip.offsetHeight + 20 ? rect.bottom + window.scrollY + 10 : rect.top + window.scrollY - currentTooltip.offsetHeight - 10; let left = Math.max(10, Math.min(rect.left + window.scrollX, window.innerWidth - currentTooltip.offsetWidth - 20)); currentTooltip.style.top = `${top}px`; currentTooltip.style.left = `${left}px`; setTimeout(() => currentTooltip.classList.add('active'), 10); currentTooltip.querySelector('.tourNextBtn').onclick = showNextTourStep; currentTooltip.querySelector('.tourSkipBtn').onclick = clearTour; targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); };

    // Event Listeners (Calculadora)
    els.calcBtn.onclick = calculate;
    els.resetBtn.onclick = clearAllFields;
    els.registerBtn.onclick = registerVenda;
    els.toggleHistoryBtn.onclick = () => toggleView('history');
    els.toggleCalcBtn.onclick = () => toggleView('main');
    els.clearHistoryBtn.onclick = clearHistory;
    els.csvBtn.onclick = exportToCsv;
    els.themeBtn.onclick = toggleTheme;
    els.tutorialBtn.onclick = () => { if (!currentUser) { showToast("Fa√ßa login para iniciar o tutorial.", "default"); return; } toggleView('main'); showNextTourStep(); };
    els.discordBtnCalc.onclick = () => copyDiscordMessage(false, null);
    els.filtroHistorico.addEventListener('input', filterHistory);
    
    // --- NOVO EVENT LISTENER (v13) ---
    els.nomeCliente.addEventListener('change', autoFillFromDossier);
    
    // Event Listeners (Dossi√™ v8)
    els.investigacaoBtn.onclick = () => toggleView('dossier');
    els.toggleCalcBtnDossier.onclick = () => toggleView('main');
    
    // N√≠vel 1 (Orgs)
    els.filtroDossierOrgs.addEventListener('input', filterOrgs);
    els.addOrgBtn.onclick = openAddOrgModal;
    
    // N√≠vel 2 (Pessoas)
    els.dossierVoltarBtn.onclick = () => showDossierOrgs();
    els.filtroDossierPeople.addEventListener('input', filterPeople);
    els.addPessoaBtn.onclick = () => {
        const orgName = els.addPessoaBtn.dataset.orgName;
        if(orgName) { openAddDossierModal(orgName); }
    };

    els.dossierPeopleGrid.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-dossier-btn');
        const deleteBtn = e.target.closest('.delete-dossier-btn');
        const fotoLinkBtn = e.target.closest('.veiculo-foto-link'); // NOVO (Lightbox)
        
        // NOVO (Lightbox)
        if (fotoLinkBtn) {
            e.preventDefault(); // Impede o link href="#" de rolar a p√°gina
            const url = fotoLinkBtn.dataset.url;
            showImageLightbox(url);
        }
        
        if (deleteBtn) {
            const org = deleteBtn.dataset.org;
            const id = deleteBtn.dataset.id;
            removeDossierEntry(org, id);
        }
        if (editBtn) {
            const org = editBtn.dataset.org;
            const id = editBtn.dataset.id;
            openEditDossierModal(org, id);
        }
    });
    
    // Adiciona listener no grid de Orgs (para os bot√µes nos resultados da busca de pessoas)
    els.dossierOrgGrid.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-dossier-btn');
        const deleteBtn = e.target.closest('.delete-dossier-btn');
        const fotoLinkBtn = e.target.closest('.veiculo-foto-link');
        
        if (fotoLinkBtn) {
            e.preventDefault();
            const url = fotoLinkBtn.dataset.url;
            showImageLightbox(url);
        }
        
        if (deleteBtn) {
            const org = deleteBtn.dataset.org;
            const id = deleteBtn.dataset.id;
            removeDossierEntry(org, id);
        }
        if (editBtn) {
            const org = editBtn.dataset.org;
            const id = editBtn.dataset.id;
            openEditDossierModal(org, id);
        }
    });
    
    // Modais de Pessoas (Salvar/Cancelar)
    els.saveDossierBtn.onclick = saveDossierChanges;
    els.cancelDossierBtn.onclick = closeEditDossierModal;
    els.editDossierOverlay.onclick = closeEditDossierModal;
    
    els.saveNewDossierBtn.onclick = saveNewDossierEntry;
    els.cancelNewDossierBtn.onclick = closeAddDossierModal;
    els.addDossierOverlay.onclick = closeAddDossierModal;
    
    // --- NOVOS Listeners do Gerenciador de Ve√≠culos (Com Edi√ß√£o) ---
    
    // Bot√µes de Adicionar/Atualizar
    els.addModalAddVeiculoBtn.onclick = () => adicionarOuAtualizarVeiculoTemp('addModal');
    els.editModalAddVeiculoBtn.onclick = () => adicionarOuAtualizarVeiculoTemp('editModal');
    
    // Bot√µes de Cancelar Edi√ß√£o
    els.addModalCancelVeiculoBtn.onclick = () => cancelarEdicaoVeiculo('addModal');
    els.editModalCancelVeiculoBtn.onclick = () => cancelarEdicaoVeiculo('editModal');
    
    // Listeners das listas para bot√µes de Editar/Remover
    els.addModalListaVeiculos.onclick = (e) => {
        const removeBtn = e.target.closest('.remove-veiculo-btn');
        const editBtn = e.target.closest('.edit-veiculo-btn');
        
        if (removeBtn) {
            removerVeiculoTemp(removeBtn.dataset.key, els.addModalListaVeiculos);
        }
        if (editBtn) {
            iniciarEdicaoVeiculo(editBtn.dataset.key, 'addModal');
        }
    };
    els.editModalListaVeiculos.onclick = (e) => {
        const removeBtn = e.target.closest('.remove-veiculo-btn');
        const editBtn = e.target.closest('.edit-veiculo-btn');
        
        if (removeBtn) {
            removerVeiculoTemp(removeBtn.dataset.key, els.editModalListaVeiculos);
        }
        if (editBtn) {
            iniciarEdicaoVeiculo(editBtn.dataset.key, 'editModal');
        }
    };
    // --- FIM ---
    
    // Modais de Orgs
    els.saveOrgBtn.onclick = saveOrg;
    els.deleteOrgBtn.onclick = deleteOrg;
    els.cancelOrgBtn.onclick = closeOrgModal;
    els.orgModalOverlay.onclick = closeOrgModal;

    // NOVO (Lightbox)
    els.imageLightboxOverlay.onclick = closeImageLightbox;
    
    // Admin
    els.migrateDossierBtn.onclick = migrateVendasToDossier;
    els.migrateVeiculosBtn.onclick = migrateVeiculosData; // Novo listener
    els.toggleCalcBtnAdmin.onclick = () => toggleView('main'); 
    
    const deleteUser = (uid, displayName) => {
        if (confirm(`ATEN√á√ÉO:\n\nTem certeza que deseja apagar o usu√°rio "${displayName}"?\n\nIsso remover√° o registro dele do banco de dados (e suas permiss√µes).\n\nIMPORTANTE: Para apagar o LOGIN dele permanentemente, voc√™ ainda precisar√° ir ao painel "Authentication" do Firebase.`)) {
            
            const userRef = ref(db, `usuarios/${uid}`);
            remove(userRef)
                .then(() => {
                    showToast(`Usu√°rio "${displayName}" apagado do banco de dados.`, 'success');
                    loadAdminPanel();
                })
                .catch((error) => {
                    showToast(`Erro ao apagar usu√°rio: ${error.message}`, 'error');
                });
        }
    };

    const loadAdminPanel = async () => {
        els.adminUserListBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">Carregando...</td></tr>';
        
        try {
            const usersSnapshot = await get(ref(db, 'usuarios'));
            if (!usersSnapshot.exists()) {
                els.adminUserListBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">Nenhum usu√°rio encontrado.</td></tr>';
                return;
            }
            
            const usersList = [];
            usersSnapshot.forEach(userSnap => {
                const userData = userSnap.val();
                if (userData.displayName && userData.displayName.toLowerCase() === 'snow') {
                    return;
                }
                usersList.push({ uid: userSnap.key, ...userData });
            });

            const tagOrder = { 'ADMIN': 1, 'HELLS': 2, 'Visitante': 3 };
            usersList.sort((a, b) => {
                const tagA = (tagOrder[a.tag.toUpperCase()] || 4);
                const tagB = (tagOrder[b.tag.toUpperCase()] || 4);
                if (tagA !== tagB) {
                    return tagA - tagB;
                }
                return (a.displayName || '').localeCompare(b.displayName || '');
            });

            els.adminUserListBody.innerHTML = '';
            
            usersList.forEach(user => {
                const uid = user.uid;
                const userData = user;
                
                const row = els.adminUserListBody.insertRow();
                row.insertCell().textContent = userData.displayName || '(Sem nome)';
                
                const tagCell = row.insertCell();
                
                if (uid === currentUser.uid) {
                    tagCell.textContent = `üëë ${userData.tag} (Voc√™)`;
                } else {
                    const select = document.createElement('select');
                    select.style.width = '100%';
                    select.dataset.uid = uid; 
                    
                    const optVisitante = document.createElement('option');
                    optVisitante.value = 'Visitante';
                    optVisitante.textContent = 'Visitante';
                    select.appendChild(optVisitante);
                    
                    const optHells = document.createElement('option');
                    optHells.value = 'HELLS';
                    optHells.textContent = 'Hells';
                    select.appendChild(optHells);
                    
                    const optAdmin = document.createElement('option');
                    optAdmin.value = 'ADMIN';
                    optAdmin.textContent = 'üëë Administrador';
                    select.appendChild(optAdmin);
                    
                    select.value = userData.tag.toUpperCase() === 'HELLS' ? 'HELLS' : (userData.tag.toUpperCase() === 'ADMIN' ? 'ADMIN' : 'Visitante');
                    select.onchange = (e) => updateUserTag(e.target.dataset.uid, e.target.value);
                    tagCell.appendChild(select);
                }
                
                const actionsCell = row.insertCell();
                actionsCell.style.textAlign = 'center';
                actionsCell.style.verticalAlign = 'middle';

                if (uid === currentUser.uid) {
                    actionsCell.textContent = '---';
                } else {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = '‚ùå';
                    deleteBtn.className = 'danger action-btn'; 
                    deleteBtn.style.padding = '5px 8px';
                    deleteBtn.style.fontSize = '14px';
                    deleteBtn.style.lineHeight = '1';
                    
                    deleteBtn.addEventListener('click', () => {
                        deleteUser(uid, userData.displayName);
                    });
                    
                    actionsCell.appendChild(deleteBtn);
                }
            });
            
        } catch (error) {
            showToast(`Erro ao carregar usu√°rios: ${error.message}`, 'error');
            els.adminUserListBody.innerHTML = `<tr><td colspan="3" style="text-align: center;">Erro ao carregar. ${error.message}</td></tr>`;
        }
        
        try {
            const layoutSnapshot = await get(ref(db, 'configuracoesGlobais/layout'));
            if (layoutSnapshot.exists()) {
                const settings = layoutSnapshot.val();
                els.layoutToggleNightMode.checked = settings.enableNightMode;
                els.layoutToggleBottomPanel.checked = settings.enableBottomPanel;
            }
        } catch (error) {
            if(error.code !== "PERMISSION_DENIED") {
                showToast(`Erro ao carregar configura√ß√µes de layout: ${error.message}`, 'error');
            }
        }
    };
    
    const updateUserTag = (uid, newTag) => {
        const tagRef = ref(db, `usuarios/${uid}/tag`);
        set(tagRef, newTag)
            .then(() => {
                showToast("Permiss√£o do usu√°rio atualizada!", 'success');
            })
            .catch((error) => {
                showToast(`Erro ao atualizar tag: ${error.message}`, 'error');
            });
    };
    
    const updateGlobalLayout = (key, value) => {
        const layoutRef = ref(db, `configuracoesGlobais/layout/${key}`);
        set(layoutRef, value)
            .catch((error) => {
                showToast(`Erro ao salvar configura√ß√£o: ${error.message}`, 'error');
            });
    };
    
    els.adminPanelBtn.onclick = () => toggleView('admin');
    els.layoutToggleNightMode.onchange = (e) => updateGlobalLayout('enableNightMode', e.target.checked);
    els.layoutToggleBottomPanel.onchange = (e) => updateGlobalLayout('enableBottomPanel', e.target.checked);
    
    
    const handleAuthAction = (isLogin, creds) => {
        const email = creds.username.trim() + "@ha.com";
        const password = creds.password;
        const displayName = creds.username.trim();

        if ((isLogin && (!email || password.length < 6)) || (!isLogin && (!displayName || password.length < 6))) {
            showToast("Verifique os campos. A senha precisa ter no m√≠nimo 6 caracteres.", "error");
            return;
        }

        if (isLogin) {
            signInWithEmailAndPassword(auth, email, password)
                .catch((error) => {
                    const code = error.code;
                    const msg = code === 'auth/invalid-credential' ? "Usu√°rio ou senha incorretos." : `Erro: ${code}`;
                    showToast(msg, "error");
                });
        } else {
            createUserWithEmailAndPassword(auth, email, password)
                .then(userCredential => {
                    const user = userCredential.user;
                    return updateProfile(user, { displayName: displayName })
                        .then(() => {
                            const userRef = ref(db, `usuarios/${user.uid}`);
                            const newUserProfile = { 
                                displayName: displayName,
                                email: user.email,
                                tag: 'Visitante'
                            };
                            return set(userRef, newUserProfile); 
                        });
                })
                .catch((error) => {
                    const code = error.code;
                    const msg = code === 'auth/email-already-in-use' ? "Nome de usu√°rio j√° existe." : `Erro: ${code}`;
                    showToast(msg, "error");
                });
        }
    };
    
    const authAction = (isLogin) => handleAuthAction(isLogin, {username: els.username.value, password: els.password.value});

    els.loginBtn.onclick = () => authAction(true);
    els.registerUserBtn.onclick = () => authAction(false);
    els.logoutBtn.onclick = () => signOut(auth);
    els.password.addEventListener('keydown', (e) => { if(e.key === 'Enter') authAction(true); });

    els.forgotPasswordLink.onclick = async () => {
        const username = prompt("Digite seu nome de usu√°rio para solicitar a redefini√ß√£o de senha:");
        if (!username) return;

        const usersRef = ref(db, 'usuarios');
        const snapshot = await get(usersRef);
        let userEmail = null;
        if(snapshot.exists()) {
            snapshot.forEach(child => {
                const userData = child.val();
                if(userData.displayName.toLowerCase() === username.toLowerCase().trim()) {
                    userEmail = userData.email;
                }
            });
        }

        if (userEmail) {
            sendPasswordResetEmail(auth, userEmail)
                .then(() => {
                    alert("Um e-mail de redefini√ß√£o de senha foi enviado para o endere√ßo associado a este usu√°rio.");
                    showToast("E-mail de redefini√ß√£o enviado!", "success");
                })
                .catch(err => showToast(`Erro: ${err.message}`, "error"));
        } else {
            showToast("Nome de usu√°rio n√£o encontrado.", "error");
        }
    };


    const configurarInterfacePorTag = (tag) => {
      const tagUpper = tag ? tag.toUpperCase() : 'VISITANTE';
      
      const userStatusEl = els.userStatus;
      if (currentUser && userStatusEl) {
          
          if (currentUser.displayName.toLowerCase() === 'snow') {
              userStatusEl.style.display = 'none';
          } else {
              userStatusEl.textContent = `${currentUser.displayName} (${tag})`;
              userStatusEl.className = 'user-status-display';
              if (tagUpper === 'ADMIN') {
                  userStatusEl.classList.add('tag-admin');
              } else if (tagUpper === 'HELLS') {
                  userStatusEl.classList.add('tag-hells');
              } else {
                  userStatusEl.classList.add('tag-visitante');
              }
              userStatusEl.style.display = 'block';
          }
      }

      if (tagUpper === 'ADMIN') {
        els.clearHistoryBtn.style.display = 'inline-block';
        els.adminPanelBtn.style.display = 'inline-block';
      } else {
        els.clearHistoryBtn.style.display = 'none';
        els.adminPanelBtn.style.display = 'none';
      }
      
      if (tagUpper === 'ADMIN' || tagUpper === 'HELLS') {
          els.investigacaoBtn.style.display = 'block';
      } else {
          els.investigacaoBtn.style.display = 'none';
      }
      
      if (tagUpper !== 'ADMIN') {
          els.adminPanel.style.display = 'none';
      }
    };


    let vendasListener = null; 

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user; 
            const userRef = ref(db, `usuarios/${user.uid}`);
            
            onValue(userRef, (snapshot) => {
                if (snapshot.exists()) {
                    currentUserData = snapshot.val(); 
                } else {
                    const newUserProfile = {
                        displayName: user.displayName, 
                        email: user.email,
                        tag: 'Visitante' 
                    };
                    set(userRef, newUserProfile);
                    currentUserData = newUserProfile; 
                }
                
                configurarInterfacePorTag(currentUserData.tag);
                 
                if(vendasListener) vendasListener(); 
                
                let vendasRef;
                const userTagUpper = currentUserData.tag.toUpperCase();
                
                if (userTagUpper === 'ADMIN' || userTagUpper === 'HELLS') {
                    vendasRef = ref(db, 'vendas');
                } else {
                    vendasRef = query(ref(db, 'vendas'), orderByChild('registradoPorId'), equalTo(currentUser.uid));
                }

                vendasListener = onValue(vendasRef, (vendasSnapshot) => {
                    vendas = [];
                    vendasSnapshot.forEach((child) => {
                        vendas.push({ id: child.key, ...child.val() });
                    });
                    if (els.historyCard.style.display !== 'none') {
                        displaySalesHistory(vendas);
                    }
                }, (error) => {
                    console.error("Erro ao carregar vendas: ", error);
                    if(error.code !== "PERMISSION_DENIED") {
                        showToast("Erro de permiss√£o ao carregar hist√≥rico.", "error");
                    }
                });
            }, (error) => {
                console.error("Erro ao ler dados do usu√°rio:", error);
                showToast("Erro fatal ao ler permiss√µes do usu√°rio.", "error");
                configurarInterfacePorTag('Visitante'); 
            });

            els.authScreen.style.display = 'none';
            toggleView('main');

        } else {
            currentUser = null;
            currentUserData = null;
            vendaOriginalCliente = null; // LIMPA
            vendaOriginalOrganizacao = null; // LIMPA
            if (vendasListener) vendasListener(); 
            vendas = []; 
            
            els.authScreen.style.display = 'block';
            els.mainCard.style.display = 'none';
            els.historyCard.style.display = 'none';
            els.adminPanel.style.display = 'none'; 
            els.dossierCard.style.display = 'none';
            if(els.userStatus) els.userStatus.style.display = 'none';
            if(els.investigacaoBtn) els.investigacaoBtn.style.display = 'none';
        }
    });

    // --- Inicializa√ß√£o da UI ---
    const savedTheme = localStorage.getItem('theme') || 'light';
    if(savedTheme === 'dark') {
        document.body.classList.add('dark');
    }
    updateLogoAndThemeButton(savedTheme === 'dark');

    if (localStorage.getItem('hasVisited')) {
        els.welcomeScreen.style.display = 'none';
    } else {
        els.welcomeScreen.classList.add('show');
        els.authScreen.style.display = 'none';
        els.mainCard.style.display = 'none';
    }

    els.enterBtn.onclick = () => {
        localStorage.setItem('hasVisited', 'true');
        els.welcomeScreen.classList.add('hidden');
        setTimeout(() => {
            els.welcomeScreen.style.display = 'none';
        }, 500);
    };
  </script>
</body>
</html>
