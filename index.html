<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <link rel="icon" type="image/png" href="logo-dark.png">
  
  <title>Hells Angels</title>
  <style>
    :root {
      --cor-fundo: #fff0f6;
      --cor-texto: #4a0033;
      --cor-principal: #e60073;
      --cor-card: #ffffff;
      --cor-borda: #ffb3d9;
      --cor-btn-primario: #e60073;
      --cor-btn-texto: #fff;
      --cor-btn-secundario: #ffd6eb;
      --cor-btn-secundario-texto: #4a0033;
      --cor-erro: #cc0000;
      /* NOVO: Cor para o brilho pulsante */
      --cor-glow-pulsante: rgba(230, 0, 115, 0.8); /* Cor Principal com opacidade */
    }

    body.dark {
      --cor-fundo: #1a000d; 
      --cor-texto: #ffccf0; 
      --cor-principal: #ff0080; 
      --cor-card: #2c001a; 
      --cor-borda: #e60073; 
      --cor-btn-primario: #ff0080; 
      --cor-btn-texto: #fff;
      --cor-btn-secundario: #4d002a; 
      --cor-btn-secundario-texto: #ffccf0; 
      /* NOVO: Cor para o brilho pulsante no modo escuro */
      --cor-glow-pulsante: rgba(255, 0, 128, 0.6); /* Cor Principal Escura com opacidade */
    }
    
    body.dark input[type=number], body.dark input[type=text], body.dark select, body.dark input[type=password] {
      background: #33001f;
      color: var(--cor-texto);
      border: 1px solid var(--cor-borda);
    }
    
    /* --- ESTILO PARA INPUT DATALIST (Foco Rosa/Roxo) --- */
    input[list]:focus, input[list]:hover {
        border-color: var(--cor-principal) !important; 
        box-shadow: 0 0 5px rgba(230, 0, 115, 0.4); 
    }
    
    /* --- NOVO ESTILO PARA DATALIST (Sugestões de Organização) --- */
    input[list] {
        position: relative;
        z-index: 1; 
    }
    
    input[list]::-webkit-calendar-picker-indicator {
        display: none;
    }
    /* --- FIM NOVO ESTILO PARA DATALIST --- */
    
    /* --- NOVO: Estilo para a dica de sugestão da Organização --- */
    .suggestion-tip {
        font-size: 11px;
        color: var(--cor-principal); /* Usa a cor principal para destaque */
        margin-top: 4px;
        margin-bottom: 0;
        font-weight: 500;
        opacity: 0.8;
    }
    /* --- FIM NOVO: Estilo para a dica de sugestão da Organização --- */
    
    /* --- ESTILOS TOUR --- */
    .tour-tooltip {
      position: absolute;
      background: var(--cor-principal);
      color: var(--cor-btn-texto);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      max-width: 300px;
      text-align: left;
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 10002;
    }

    .tour-tooltip.active {
      opacity: 1;
      transform: translateY(0);
    }

    .tour-tooltip h4 {
        margin: 0 0 5px;
        font-size: 16px;
        color: var(--cor-btn-texto);
    }
    .tour-tooltip p {
        margin: 0;
        font-size: 14px;
        margin-bottom: 10px;
    }
    
    .tour-tooltip button {
        background: var(--cor-btn-secundario);
        color: var(--cor-btn-secundario-texto);
        padding: 6px 10px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        margin-right: 8px;
    }
    
    .tour-highlight {
      box-shadow: 0 0 0 3px rgba(230,0,115,0.6), 0 0 10px rgba(230,0,115,0.5);
      position: relative;
      z-index: 10001;
    }
    /* --- FIM ESTILOS TOUR --- */
    
    /* --- ESTILO PARA CAMPO INVÁLIDO --- */
    input.input-invalido, select.input-invalido {
        border: 2px solid var(--cor-erro) !important;
        box-shadow: 0 0 4px var(--cor-erro);
    }
    /* --- FIM ESTILO PARA CAMPO INVÁLIDO --- */

    
    /* Container para a logo */
    #logoLink {
        position: fixed;
        top: 16px; 
        left: 16px; 
        width: auto; 
        max-height: 80px; 
        cursor: pointer;
        z-index: 9998; 
    }
    
    /* Ajuste na logo superior */
    .app-logo {
      max-height: 80px; 
      width: auto;
      transition: opacity 0.3s ease, filter 0.3s ease; /* Adicionado filter para a transição do hover */
      display: block; 
    }
    
    /* NOVO: Efeito de iluminação ao passar o mouse na Logo (na calculadora) */
    #appLogo:hover {
        /* Brilho da logo ao passar o mouse */
        filter: drop-shadow(0 0 8px var(--cor-principal)) drop-shadow(0 0 15px var(--cor-glow-pulsante));
        opacity: 0.9;
    }

    
    /* --- Estilo para a imagem na tela de boas-vindas --- */
    #welcomeLogo {
      max-width: 80%;
      max-height: 120px; 
      margin-bottom: 25px;
      display: block;
      /* NÃO ADICIONAR EFEITO DE HOVER AQUI */
    }
    
    #welcomeScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--cor-card);
      z-index: 10000; 
      display: none; 
      flex-direction: column;
      justify-content: center; 
      align-items: center;
      text-align: center;
      transition: opacity 0.5s ease;
      padding: 20px; 
      box-sizing: border-box; 
    }
    
    #welcomeScreen.show {
        display: flex; 
    }

    #welcomeScreen.hidden {
      opacity: 0;
      pointer-events: none; 
    }
    
    #welcomeScreen h2 {
      font-size: 36px;
      margin-top: 10px; 
      margin-bottom: 20px;
      color: var(--cor-principal);
    }
    
    #welcomeScreen button {
      padding: 12px 24px;
      font-size: 18px;
      border-radius: 10px;
      margin-top: 10px;
    }


    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 960px;
      margin: 24px auto;
      padding: 20px;
      background: var(--cor-fundo);
      color: var(--cor-texto);
      transition: background 0.25s ease, color 0.25s ease;
    }
    
    /* CORREÇÃO: Conteúdo principal escondido por padrão. O listener do Firebase irá exibi-lo. */
    #mainCard {
        display: none; 
    }

    h1 {
      margin: 0 0 12px;
      font-size: 24px;
      font-weight: 700;
      color: var(--cor-principal);
      text-align: center;
    }

    h2 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--cor-principal);
    }
    
    h3 {
        color: var(--cor-principal); 
        font-weight:600; 
        margin-top: 16px;
    }

    .card {
      background: var(--cor-card);
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border: 1px solid var(--cor-borda);
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin: 10px 0 6px;
      font-weight: 600;
      color: var(--cor-principal);
    }
    
    /* NOVO ESTILO PARA INPUTS DA TELA DE LOGIN */
    /* Incluindo input[type=text] para o Nome de Usuário */
    #loginScreen input[type=text], #loginScreen input[type=password] {
        height: 40px;
        font-size: 16px;
    }
    /* FIM NOVO ESTILO PARA INPUTS DA TELA DE LOGIN */

    input[type=number], input[type=text], select {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid var(--cor-borda);
      background: #fff;
      color: var(--cor-texto);
      font-size: 14px;
      box-sizing: border-box;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    
    input[type=number] {
        width: 140px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
      margin-top: 12px;
    }
    
    .grid-venda {
        grid-template-columns: 1fr 1fr;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 14px;
    }

    th, td {
      padding: 6px; /* Reduzido o padding para caber mais na tela do celular */
      border-bottom: 1px solid var(--cor-borda);
      text-align: left;
    }

    th {
      background: var(--cor-btn-secundario);
      color: var(--cor-btn-secundario-texto);
      font-weight: 600;
    }
    
    
/* --- NOVO ESTILO PARA RESPONSIVIDADE DA TABELA --- */
.history-table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    width: 100%;
    margin-top: 8px;
}

/* Garante que o container interno não atrapalhe a rolagem */
#historyBackground {
    overflow: hidden;
}

/* Mantém a tabela com comportamento de tabela e largura controlada */
#historyCard table {
    width: 100%;
    display: table;
    border-collapse: collapse;
    table-layout: fixed; /* ajuda a manter colunas alinhadas */
    min-width: 900px; /* força scroll em telas pequenas mantendo alinhamento */
}

/* Estilo base para células */
#historyCard th, #historyCard td {
    padding: 8px 10px;
    vertical-align: middle;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 13px;
}

/* Definição de larguras e alinhamentos por coluna - ajustáveis conforme necessidade */
#historyCard th:nth-child(1), #historyCard td:nth-child(1) { width: 90px; text-align: center; } /* Data/Hora */
#historyCard th:nth-child(2), #historyCard td:nth-child(2) { width: 160px; text-align: left; }   /* Cliente */
#historyCard th:nth-child(3), #historyCard td:nth-child(3) { width: 160px; text-align: center; } /* Organização/Tipo */
#historyCard th:nth-child(4), #historyCard td:nth-child(4) { width: 110px; text-align: center; } /* Telefone */
#historyCard th:nth-child(5), #historyCard td:nth-child(5) { width: 280px; text-align: left; }   /* Produtos */
#historyCard th:nth-child(6), #historyCard td:nth-child(6) { width: 140px; text-align: center; } /* Valor */
#historyCard th:nth-child(7), #historyCard td:nth-child(7) { width: 140px; text-align: center; } /* Negociadoras */
#historyCard th:nth-child(8), #historyCard td:nth-child(8) { width: 150px; text-align: center; } /* Ações */

/* Ajuste para a linha de data/hora (duas linhas dentro da mesma célula) */
.history-datetime-line {
    display: block;
    line-height: 1.1;
    font-size: 12px;
}

/* Faz com que valores longos quebrem visualmente melhor em células menores quando necessário */
@media (max-width: 700px) {
    #historyCard th, #historyCard td {
        font-size: 12px;
    }
    #historyCard th:nth-child(5), #historyCard td:nth-child(5) { width: 320px; }
}
/* --- FIM NOVO ESTILO PARA RESPONSIVIDADE DA TABELA --- */



    .actions {
      margin-top: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    button {
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: opacity 0.2s ease, box-shadow 0.3s ease; /* Adicionado box-shadow para transição do glow */
    }

    button:hover { opacity: 0.85; }
    
    /* NOVO: Efeito de brilho pulsante para o botão principal (Calcular/Registrar) */
    .primary, .success {
        animation: pulse-glow 2s infinite ease-in-out;
    }
    
    /* NOVO: Keyframes para o brilho pulsante */
    @keyframes pulse-glow {
        0% {
            box-shadow: 0 0 0 rgba(0, 0, 0, 0); 
        }
        50% {
            box-shadow: 0 0 10px var(--cor-glow-pulsante), 0 0 20px var(--cor-glow-pulsante); 
        }
        100% {
            box-shadow: 0 0 0 rgba(0, 0, 0, 0); 
        }
    }

    .primary { background: var(--cor-btn-primario); color: var(--cor-btn-texto); }
    .muted { background: var(--cor-btn-secundario); color: var(--cor-btn-secundario-texto); }
    .success { background: #00b33c; color: #fff; }

    /* Container para agrupar e posicionar botões (Modo Noturno e Tutorial) */
    .top-right-controls {
        position: fixed;
        top: 16px;
        right: 16px;
        display: flex;
        gap: 10px;
        z-index: 9999;
    }
    
    /* NOVO: Ajuste do Container para incluir o botão de Logout */
    .top-right-controls button {
        height: 40px; /* Garante que todos os botões no topo tenham altura uniforme */
    }
    

    /* Estilo base para botões de controle fixos */
    .control-btn {
        padding: 10px 14px;
        border-radius: 10px;
        background: var(--cor-btn-primario);
        color: var(--cor-btn-texto);
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        border: none;
        transition: opacity 0.2s ease;
        /* ANIMAÇÃO pulse-glow REMOVIDA DAQUI */
    }
    .control-btn:hover {
        opacity: 0.85;
    }
    
    /* --- Estilo para o Fundo do Histórico --- */
    #historyBackground {
      /* ALTERAÇÃO: Fundo semi-transparente (70%) */
      background: rgba(255, 255, 255, 0.7); 
      position: relative; 
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border: 1px solid var(--cor-borda);
      margin-bottom: 20px;
      min-height: 400px;
      overflow: hidden;
    }
    
    /* NOVO: Estilo para o background do histórico no modo escuro */
    body.dark #historyBackground {
        background: rgba(44, 0, 26, 0.7); /* Cor do Card Escuro com transparência */
    }

    #historyBackground img {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      height: auto;
      opacity: 0.3; /* ALTERAÇÃO: Aumentado para maior visibilidade */
      z-index: 1;
      object-fit: contain;
    }
    #historyBackground > * {
      position: relative;
      z-index: 2;
    }
    #historyCard table {
      font-size: 12px;
    }
    /* --- CORREÇÃO DE ALINHAMENTO DAS CÉLULAS (Principal Alteração) --- */
    /* Garante que o conteúdo fique no topo para alinhar a borda inferior */
    #historyCard th, #historyCard td {
      padding: 8px 6px;
      text-align: center;
      vertical-align: middle; /* Centraliza verticalmente */
      white-space: nowrap; /* Evita quebras desnecessárias */
    }
    /* Corrige o bloco de data/hora */
    #historyCard tr td:first-child {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      line-height: 1.2;
      padding: 4px 0;
    }
    .history-datetime-line {
      display: block;
      font-size: 12px;
    }
    /* Estilo para cada linha do texto dentro da célula de Data/Hora */
    .history-datetime-line {
      display: block;
      line-height: 1.2;
      padding: 6px 0 0 6px; /* Adiciona o padding de volta (topo e esquerda) */
    }
    /* Reduz o espaçamento vertical para compactar o texto na célula de Valor Total (que tem quebra de linha) */
    .valor-total-cell {
      display: flex;
      flex-direction: column;
      align-items: center; /* Centraliza horizontalmente */
      justify-content: center; /* Centraliza verticalmente */
      padding: 4px 0;
      line-height: 1.3;
      text-align: center;
    }
    .valor-total-cell span {
      display: block;
    }
    .valor-obs-text {
      font-size: 11px;
      color: var(--cor-principal);
      margin-top: 2px; /* Pequeno espaçamento entre o valor e a observação */
    }
    /* --- FIM CORREÇÃO DE ALINHAMENTO --- */
    /* Estilo para colocar os botões do histórico na mesma linha (Responsivo) */
    .history-actions-cell {
      display: flex;
      gap: 5px; /* Espaçamento entre os botões */
      flex-wrap: nowrap; /* Garante que fiquem na mesma linha */
      padding-top: 4px; /* Ajuste para o padding das outras células */
    }
    .history-actions-cell button {
      padding: 4px 8px;
      font-size: 11px;
      margin-top: 2px; /* Pequeno ajuste de margem */
      border-radius: 4px;
      white-space: nowrap; /* Impede a quebra de linha dos botões */
    }
    /* --- Estilos para Notificação Toast --- */
    #toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 10005;
      display: flex;
      flex-direction: column-reverse;
      gap: 10px;
      align-items: flex-end;
    }
    .toast {
      background-color: var(--cor-principal);
      color: var(--cor-btn-texto);
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      opacity: 0;
      transform: translateY(100%);
      transition: opacity 0.3s ease-out, transform 0.3s ease-out;
      min-width: 250px;
      text-align: center;
      font-weight: 600;
    }
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    .toast.error {
      background-color: var(--cor-erro);
    }
    .toast.success {
      background-color: #00b33c;
    }
    .toast.info {
        background-color: #007bff;
    }
    /* --- FIM Estilos para Notificação Toast --- */
    
    
    /* --- NOVO ESTILO: TELA DE CARREGAMENTO (SPLASH) --- */
    #loadingScreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: var(--cor-fundo);
        z-index: 10006; 
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        transition: opacity 0.5s ease;
    }
    
    .loading-spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-top: 4px solid var(--cor-principal);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    #loadingScreen.hidden {
        opacity: 0;
        pointer-events: none;
    }
    /* --- FIM NOVO ESTILO: TELA DE CARREGAMENTO (SPLASH) --- */
  </style>
</head>
<body class="light">

    <div id="loadingScreen">
        <div class="loading-spinner"></div>
        <p>Carregando...</p>
    </div>
    
    <div id="loginScreen" class="card" style="
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        z-index: 10000; 
        display: none; /* COMEÇA ESCONDIDO */
        flex-direction: column; 
        justify-content: center; 
        align-items: center; 
        padding: 20px; 
        box-sizing: border-box;
        background-color: var(--cor-fundo); 
    ">
        <div id="loginFormCard" style="max-width: 400px; width: 100%; padding: 30px; border-radius: 12px; background: var(--cor-card); box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid var(--cor-borda);">
            <img id="loginLogo" src="logo-dark.png" alt="Hells Angels Logo" style="max-width: 100px; max-height: 100px; display: block; margin: 0 auto 20px;">
            <h2 id="loginTitle" style="text-align: center; margin-bottom: 25px;">Acesso ao Sistema</h2>
            
            <div id="emailField" style="display: none;">
                <label for="registerEmail">E-mail (Necessário para o Firebase)</label>
                <input type="email" id="registerEmail" placeholder="seu@email.com">
            </div>

            <label for="loginUsername">Nome de Usuário</label>
            <input type="text" id="loginUsername" placeholder="Ex: meuusuario" required>

            <label for="loginPassword" style="margin-top: 15px;">Senha</label>
            <input type="password" id="loginPassword" placeholder="******" required>
            
            <button id="authActionBtn" class="primary" style="width: 100%; margin-top: 25px;">
                Entrar
            </button>

            <button id="toggleAuthModeBtn" class="muted" style="width: 100%; margin-top: 10px;">
                Quero me Cadastrar
            </button>
            
            <p id="passwordTip" style="text-align: center; margin-top: 15px; font-size: 12px; color: var(--cor-texto);">
                A senha deve ter no mínimo 6 caracteres.
            </p>
        </div>
    </div>
    <div class="top-right-controls">
    <button id="logoutBtn" class="control-btn muted" style="display: none;">Sair</button> 
    <button id="themeBtn" class="control-btn">🌙 Modo Noturno</button>
    <button id="tourBtn" class="control-btn primary">Tour</button>
  </div>

  <a id="logoLink" href="#">
    <img id="appLogo" class="app-logo" src="logo-dark.png" alt="Hells Angels Logo">
  </a>

  <div id="welcomeScreen">
    <img id="welcomeLogo" src="logo-dark.png" alt="Hells Angels Logo">
    <h2>Bem-vindo(a)!</h2>
    <p>Este sistema ajuda você a calcular seus ganhos e a manter o histórico de suas vendas e negociações.</p>
    <button id="startAppBtn" class="primary">Começar!</button>
  </div>
  <div id="mainCard" style="display: none;"> 
      
      <div id="calcCard" class="card">
        <h1>Calculadora de Vendas</h1>
        
        <div class="grid grid-venda">
            
            <div>
                <label for="clienteName">Nome do Cliente</label>
                <input type="text" id="clienteName" list="clientesList" placeholder="Ex: Maria da Silva" required>
                <datalist id="clientesList"></datalist>
            </div>

            <div>
                <label for="organizacao">Organização/Tipo</label>
                <input type="text" id="organizacao" list="organizacoesList" placeholder="Ex: Cliente Fixo, Aniversário, Bar" required>
                <datalist id="organizacoesList"></datalist>
                <p id="organizacaoTip" class="suggestion-tip" style="display: none;">Pressione **Enter** ou clique para usar uma sugestão salva.</p>
            </div>
            
            <div>
                <label for="telefone">Telefone</label>
                <input type="text" id="telefone" placeholder="Opcional">
            </div>

            <div>
                <label for="produtos">Produtos</label>
                <input type="text" id="produtos" placeholder="Ex: 5 Vestidos P, 2 Camisetas M" required>
            </div>

        </div>

        <div class="grid">
            <div>
                <label for="valorTotal">Valor Total (R$)</label>
                <input type="number" id="valorTotal" placeholder="0.00" step="0.01" required>
            </div>

            <div>
                <label for="negociadoras">Negociadoras</label>
                <select id="negociadoras" required>
                    <option value="">Selecione</option>
                    <option value="1">1 Negociadora</option>
                    <option value="2">2 Negociadoras</option>
                    <option value="3">3 Negociadoras</option>
                </select>
            </div>
            
            <div>
                <label for="taxaComissao">Taxa de Comissão (%)</label>
                <input type="number" id="taxaComissao" placeholder="0" value="15" step="0.01" required>
            </div>
            
            <div>
                <label for="observacoes">Observações</label>
                <input type="text" id="observacoes" placeholder="Opcional">
            </div>
        </div>

        <h3>Resultados:</h3>
        <p>Comissão Total: <strong id="comissaoTotal" class="resultado">R$ 0,00</strong></p>
        <p>Gasto por Pessoa: <strong id="gastoPorPessoa" class="resultado">R$ 0,00</strong></p>

        <div class="actions">
            <button id="calculateBtn" class="primary">Calcular</button>
            <button id="registerBtn" class="success" style="display: none;">Registrar Venda</button>
            <button id="clearBtn" class="muted">Limpar Campos</button>
            <button id="toggleHistoryBtn" class="muted">Ver Histórico</button>
        </div>
      </div>
      <div id="historyCard" class="card" style="display: none;">
        <h2>Histórico de Vendas</h2>
        
        <div id="historyBackground">
            <img src="logo-dark.png" alt="Fundo Hells Angels">
            <p id="historicoVazio" style="text-align: center; margin-top: 20px; color: var(--cor-principal); font-weight: 600; display: none;">O histórico de vendas está vazio.</p>

            <div class="history-table-wrapper">
                <table id="historicoTabela">
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Cliente</th>
                            <th>Organização/Tipo</th>
                            <th>Telefone</th>
                            <th>Produtos</th>
                            <th>Valor</th>
                            <th>Negociadoras</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>

            <div class="actions" style="justify-content: space-between;">
                <button id="toggleCalcBtn" class="muted">Voltar para Calculadora</button>
                <button id="clearHistoryBtn" class="primary">Apagar Histórico</button>
            </div>
        </div>
      </div>
      </div>
  <div id="toast-container"></div>
  <script type="module">
    
    // =====================================================================================
    //               CONFIGURAÇÃO E FUNÇÕES DO FIREBASE AUTHENTICATION (SDK v9)
    // =====================================================================================
    
    // *************************************************************************************
    // ** ATENÇÃO: SUBSTITUA OS VALORES ABAIXO PELOS DADOS DO SEU PROJETO FIREBASE REAL! **
    // *************************************************************************************
const firebaseConfig = {
  apiKey: "AIzaSyAhDVBfXoO_Rdi3e-trdbaaPppwDkTDgVc", 
  authDomain: "hells-angels-438c2.firebaseapp.com", 
  projectId: "hells-angels-438c2", 
  storageBucket: "hells-angels-438c2.firebasestorage.app", 
  messagingSenderId: "429406215315", 
  appId: "1:429406215315:web:b9a153138589ba52308166" 
};

    // Importações do Firebase SDK v9 (Modular)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { 
      getAuth, 
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword, 
      signOut,
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    
    // Importações do Cloud Firestore (Necessário para armazenar o Nome de Usuário)
    import { 
        getFirestore, 
        collection, 
        addDoc, 
        query, 
        where, 
        getDocs,
        limit
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";


    // Inicializa o Firebase, o Auth e o Firestore
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const USERS_COLLECTION = "usernames"; // Coleção para mapear username -> email
    
    // Função global showToast (Definida para ser usada em todo o script)
    window.showToast = window.showToast || function(message, type = 'info', duration = 3000) {
        console.log(`[Toast ${type.toUpperCase()}]: ${message}`);
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) return;

        const toast = document.createElement('div');
        toast.classList.add('toast', type);
        toast.textContent = message;
        toastContainer.prepend(toast);

        void toast.offsetWidth; 
        toast.classList.add('show');

        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => toast.remove());
        }, duration);
    };

    
    /**
     * Tenta fazer login com Nome de Usuário e Senha.
     * @param {string} username 
     * @param {string} password 
     */
    window.loginUser = async function(username, password) {
      document.getElementById('loadingScreen').classList.remove('hidden');
      
      try {
        // 1. Consultar o Firestore para encontrar o e-mail
        const userQuery = query(
            collection(db, USERS_COLLECTION),
            where("username", "==", username.toLowerCase().trim()),
            limit(1)
        );
        
        const snapshot = await getDocs(userQuery);
        
        if (snapshot.empty) {
            throw new Error('auth/user-not-found-custom');
        }
        
        const userData = snapshot.docs[0].data();
        const email = userData.email;
        
        // 2. Fazer login com o e-mail e senha encontrados
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        
        console.log("Login OK:", userCredential.user.email);
        window.showToast(`Bem-vinda(o), ${username}!`, "success");
        
      } catch (error) {
        document.getElementById('loadingScreen').classList.add('hidden');
        
        let msg = "Erro desconhecido ao fazer login.";
        if (error.code === 'auth/wrong-password') {
          msg = "Senha incorreta.";
        } else if (error.code === 'auth/user-not-found-custom') {
          msg = `Nome de usuário "${username}" não encontrado.`;
        } else if (error.code === 'auth/invalid-credential') {
            msg = "Nome de usuário ou senha inválidos.";
        } else {
            // Outros erros, como rede, etc.
            msg = "Erro no login. Verifique sua conexão e tente novamente.";
        }
        
        console.error("Erro de Login:", error.code, error.message);
        window.showToast(msg, "error");
      }
    }

    /**
     * Tenta cadastrar um novo usuário (E-mail, Nome de Usuário e Senha).
     * @param {string} username
     * @param {string} email 
     * @param {string} password 
     */
    window.registerUser = async function(username, email, password) {
        document.getElementById('loadingScreen').classList.remove('hidden');
        const sanitizedUsername = username.toLowerCase().trim();
        
        try {
            // 1. Verificar se o Nome de Usuário já existe
            const checkQuery = query(
                collection(db, USERS_COLLECTION),
                where("username", "==", sanitizedUsername),
                limit(1)
            );
            
            const checkSnapshot = await getDocs(checkQuery);
            if (!checkSnapshot.empty) {
                throw new Error('auth/username-already-in-use');
            }
            
            // 2. Criar o usuário no Firebase Auth (usando e-mail)
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            
            // 3. Salvar o mapeamento (username -> email) no Firestore
            await addDoc(collection(db, USERS_COLLECTION), {
                uid: userCredential.user.uid,
                username: sanitizedUsername,
                email: email
            });
            
            console.log("Cadastro OK:", userCredential.user.email);
            window.showToast(`Conta criada! Bem-vinda(o), ${username}!`, "success");
            
        } catch (error) {
            document.getElementById('loadingScreen').classList.add('hidden');
            
            let msg = "Erro desconhecido ao cadastrar.";
            if (error.code === 'auth/username-already-in-use') {
                msg = `Nome de Usuário "${username}" já está em uso.`;
            } else if (error.code === 'auth/email-already-in-use') {
                msg = "Este e-mail já está em uso.";
            } else if (error.code === 'auth/weak-password') {
                msg = "A senha deve ter no mínimo 6 caracteres.";
            } else if (error.code === 'auth/invalid-email') {
                msg = "Formato de e-mail inválido.";
            }
            
            console.error("Erro de Cadastro:", error.code, error.message);
            window.showToast(msg, "error");
        }
    }
    
    /**
     * Desloga o usuário
     */
    window.logoutUser = async function() {
      document.getElementById('loadingScreen').classList.remove('hidden');
      await signOut(auth);
      window.showToast("Logout realizado.", "info");
    }

    /**
     * Monitora o estado de autenticação e decide qual tela mostrar.
     */
    window.setupAuthStateListener = function() {
      onAuthStateChanged(auth, (user) => {
        const loginScreen = document.getElementById('loginScreen');
        const mainContent = document.getElementById('mainCard');
        const logoutBtn = document.getElementById('logoutBtn');
        const loadingScreen = document.getElementById('loadingScreen');
        
        if (user) {
          // Usuário logado
          mainContent.style.display = 'block';
          loginScreen.style.display = 'none';
          logoutBtn.style.display = 'block'; 
          
          // Opcional: Salvar o username atual na sessão se necessário
          // console.log("Usuário logado:", user.email, "UID:", user.uid); 
        } else {
          // Usuário deslogado
          mainContent.style.display = 'none';
          loginScreen.style.display = 'flex'; 
          logoutBtn.style.display = 'none'; 
          
          // Volta para o modo de Login
          setAuthMode('login'); 
          console.log("Nenhum usuário logado.");
        }
        
        loadingScreen.classList.add('hidden');
      });
    }

    // Chama a função para monitorar o estado ao iniciar.
    window.setupAuthStateListener(); 
    
    
    // =====================================================================================
    //                    CÓDIGO JAVASCRIPT PRINCIPAL DO APP (Continuação)
    // =====================================================================================
    
    document.addEventListener('DOMContentLoaded', () => {
    
        const els = {
            // Campos da Calculadora (Mantidos)
            clienteName: document.getElementById('clienteName'),
            organizacao: document.getElementById('organizacao'),
            telefone: document.getElementById('telefone'),
            produtos: document.getElementById('produtos'),
            valorTotal: document.getElementById('valorTotal'),
            negociadoras: document.getElementById('negociadoras'),
            taxaComissao: document.getElementById('taxaComissao'),
            observacoes: document.getElementById('observacoes'),

            // Resultados (Mantidos)
            comissaoTotal: document.getElementById('comissaoTotal'),
            gastoPorPessoa: document.getElementById('gastoPorPessoa'),

            // Botões (Mantidos)
            calculateBtn: document.getElementById('calculateBtn'),
            registerBtn: document.getElementById('registerBtn'),
            clearBtn: document.getElementById('clearBtn'),
            toggleHistoryBtn: document.getElementById('toggleHistoryBtn'),
            toggleCalcBtn: document.getElementById('toggleCalcBtn'),
            clearHistoryBtn: document.getElementById('clearHistoryBtn'),
            themeBtn: document.getElementById('themeBtn'),
            tourBtn: document.getElementById('tourBtn'),
            
            // Novos/Alterados elementos do Login
            logoutBtn: document.getElementById('logoutBtn'), 
            loginUsername: document.getElementById('loginUsername'), // Nome de Usuário
            loginPassword: document.getElementById('loginPassword'), 
            registerEmail: document.getElementById('registerEmail'), // Email para cadastro (oculto)
            authActionBtn: document.getElementById('authActionBtn'), // Botão de Ação (Entrar/Cadastrar)
            toggleAuthModeBtn: document.getElementById('toggleAuthModeBtn'), // Botão de alternar modo
            loginTitle: document.getElementById('loginTitle'),
            emailField: document.getElementById('emailField'), // Div do campo Email

            // Telas/Containers (Mantidos)
            calcCard: document.getElementById('calcCard'),
            historyCard: document.getElementById('historyCard'),
            historicoTabela: document.getElementById('historicoTabela').getElementsByTagName('tbody')[0],
            historicoVazio: document.getElementById('historicoVazio'),
            welcomeScreen: document.getElementById('welcomeScreen'),
            startAppBtn: document.getElementById('startAppBtn'),
            logoLink: document.getElementById('logoLink'),
            
            // Datalists (Mantidos)
            clientesList: document.getElementById('clientesList'),
            organizacoesList: document.getElementById('organizacoesList'),
            organizacaoTip: document.getElementById('organizacaoTip')
        };
        
        // Estado Global
        let vendas = [];
        let vendaEmEdicaoId = null;
        const LOCAL_STORAGE_KEY = 'vendasHA';
        const CONFIG_STORAGE_KEY = 'configHA';
        let isFirstTimeUser = localStorage.getItem(CONFIG_STORAGE_KEY) === null;
        let authMode = 'login'; // 'login' ou 'register'
        
        // --- FUNÇÕES DE UTILIDADE (Mantidas) ---

        /**
         * Formata um número para a moeda brasileira.
         * @param {number} valor 
         * @returns {string}
         */
        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(valor);
        }
        
        // showToast já está definido no escopo global acima.

        // ... (Resto das Funções: loadVendas, saveVendas, calculateCommission, renderHistorico, 
        //       clearAllFields, toggleView, clearTour, updateThemeLogo, startTour, etc.) ...
        
        
        // --- NOVO: Função para alternar o modo Login/Cadastro ---
        
        /**
         * Alterna a interface entre Login e Cadastro.
         * @param {string} mode 'login' ou 'register'
         */
        function setAuthMode(mode) {
            authMode = mode;
            els.loginTitle.textContent = mode === 'login' ? 'Acesso ao Sistema' : 'Criar Nova Conta';
            els.authActionBtn.textContent = mode === 'login' ? 'Entrar' : 'Cadastrar';
            els.toggleAuthModeBtn.textContent = mode === 'login' ? 'Quero me Cadastrar' : 'Voltar para Login';
            els.emailField.style.display = mode === 'register' ? 'block' : 'none';
            els.loginUsername.focus();
        }
        
        /**
         * Listener de evento para a tela de login/cadastro.
         */
        function setupLoginListeners() {
            // Alternar entre Login e Cadastro
            els.toggleAuthModeBtn.addEventListener('click', (e) => {
                e.preventDefault();
                setAuthMode(authMode === 'login' ? 'register' : 'login');
            });
            
            // Ação principal (Login ou Cadastro)
            els.authActionBtn.addEventListener('click', (e) => {
                e.preventDefault();
                const username = els.loginUsername.value.trim();
                const password = els.loginPassword.value;
                
                if (!username || !password) {
                    window.showToast("Preencha o nome de usuário e a senha.", "error");
                    return;
                }
                
                if (authMode === 'login') {
                    // Tenta Fazer Login
                    window.loginUser(username, password); 
                } else {
                    // Tenta Cadastrar
                    const email = els.registerEmail.value.trim();
                    if (!email) {
                        window.showToast("Preencha o e-mail para o cadastro.", "error");
                        return;
                    }
                    if (password.length < 6) {
                        window.showToast("A senha deve ter no mínimo 6 caracteres.", "error");
                        return;
                    }
                    window.registerUser(username, email, password);
                }
            });
            
            // Listener para LOGOUT
            els.logoutBtn.addEventListener('click', (e) => {
                 e.preventDefault();
                 if (confirm('Tem certeza que deseja sair do sistema?')) {
                    window.logoutUser();
                 }
            });
        }
        
        // --- CHAMADAS INICIAIS ---
        
        // 1. Inicializa o estado do tema
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.body.classList.remove('light', 'dark');
            document.body.classList.add(savedTheme);
            els.themeBtn.textContent = savedTheme === 'dark' ? '☀️ Modo Claro' : '🌙 Modo Noturno';
        } else {
            document.body.classList.add('light');
        }
        updateThemeLogo(); 
        
        // 2. Carrega os dados (Simulando o carregamento, isso será substituído por Firestore/Realtime DB)
        loadVendas();
        renderHistorico();
        
        // 3. Adiciona os Listeners de Login
        setupLoginListeners();
        
        // ... (Resto dos Listeners e chamadas originais) ...
        
        
        // --- Listeners de Eventos (Adaptados) ---
        
        els.clearHistoryBtn.addEventListener('click', () => {
          if (confirm('Tem certeza que deseja apagar todo o Histórico de Vendas? Esta ação não pode ser desfeita.')) {
            vendas = []; 
            saveVendas(); 
            renderHistorico(); 
            window.showToast("Histórico de vendas completamente apagado!", "error");
          }
        });

        els.themeBtn.addEventListener('click',() => {
          const isDark = document.body.classList.toggle('dark');
          document.body.classList.toggle('light', !isDark);
          localStorage.setItem('theme', isDark ? 'dark' : 'light');
          els.themeBtn.textContent = isDark ? '☀️ Modo Claro' : '🌙 Modo Noturno';
          
          updateThemeLogo(); 
        });
        
        // ... (Outros Listeners) ...
    
    }); 
    // FIM document.addEventListener('DOMContentLoaded')
    
    // (Resto das funções que não precisam de `els` para funcionar - Mantenha todas as funções utilitárias do seu código original aqui, exceto a showToast que foi adaptada)
    // ...
    
    
  </script>
  
  <script nomodule>
      // Fallback para navegadores que não suportam módulos (Firebase modular requer módulo)
      document.getElementById('loadingScreen').innerHTML = '<h2>Seu navegador não suporta o sistema.</h2><p>Por favor, use a versão mais recente do Chrome, Firefox ou Safari.</p>';
      document.getElementById('loadingScreen').classList.remove('hidden');
      document.getElementById('mainCard').style.display = 'none';
  </script>
</body>
</html>
