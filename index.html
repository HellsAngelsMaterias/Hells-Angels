<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <link rel="icon" type="image/png" href="logo-dark.png">
  
  <title>Hells Angels</title>
  <style>
    :root {
      --cor-fundo: #fff0f6;
      --cor-texto: #4a0033;
      --cor-principal: #e60073;
      --cor-card: #ffffff;
      --cor-borda: #ffb3d9;
      --cor-btn-primario: #e60073;
      --cor-btn-texto: #fff;
      --cor-btn-secundario: #ffd6eb;
      --cor-btn-secundario-texto: #4a0033;
      --cor-erro: #cc0000;
      /* NOVO: Cor para o brilho pulsante */
      --cor-glow-pulsante: rgba(230, 0, 115, 0.8); /* Cor Principal com opacidade */
    }

    body.dark {
      --cor-fundo: #1a000d; 
      --cor-texto: #ffccf0; 
      --cor-principal: #ff0080; 
      --cor-card: #2c001a; 
      --cor-borda: #e60073; 
      --cor-btn-primario: #ff0080; 
      --cor-btn-texto: #fff;
      --cor-btn-secundario: #4d002a; 
      --cor-btn-secundario-texto: #ffccf0; 
      /* NOVO: Cor para o brilho pulsante no modo escuro */
      --cor-glow-pulsante: rgba(255, 0, 128, 0.6); /* Cor Principal Escura com opacidade */
    }
    
    body.dark input[type=number], body.dark input[type=text], body.dark select {
      background: #33001f;
      color: var(--cor-texto);
      border: 1px solid var(--cor-borda);
    }
    
    /* --- ESTILO PARA INPUT DATALIST (Foco Rosa/Roxo) --- */
    input[list]:focus, input[list]:hover {
        border-color: var(--cor-principal) !important; 
        box-shadow: 0 0 5px rgba(230, 0, 115, 0.4); 
    }
    
    /* --- NOVO ESTILO PARA DATALIST (Sugest√µes de Organiza√ß√£o) --- */
    input[list] {
        position: relative;
        z-index: 1; 
    }
    
    input[list]::-webkit-calendar-picker-indicator {
        display: none;
    }
    /* --- FIM NOVO ESTILO PARA DATALIST --- */
    
    /* --- NOVO: Estilo para a dica de sugest√£o da Organiza√ß√£o --- */
    .suggestion-tip {
        font-size: 11px;
        color: var(--cor-principal); /* Usa a cor principal para destaque */
        margin-top: 4px;
        margin-bottom: 0;
        font-weight: 500;
        opacity: 0.8;
    }
    /* --- FIM NOVO: Estilo para a dica de sugest√£o da Organiza√ß√£o --- */
    
    /* --- ESTILOS TOUR --- */
    .tour-tooltip {
      position: absolute;
      background: var(--cor-principal);
      color: var(--cor-btn-texto);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      max-width: 300px;
      text-align: left;
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 10002;
    }

    .tour-tooltip.active {
      opacity: 1;
      transform: translateY(0);
    }

    .tour-tooltip h4 {
        margin: 0 0 5px;
        font-size: 16px;
        color: var(--cor-btn-texto);
    }
    .tour-tooltip p {
        margin: 0;
        font-size: 14px;
        margin-bottom: 10px;
    }
    
    .tour-tooltip button {
        background: var(--cor-btn-secundario);
        color: var(--cor-btn-secundario-texto);
        padding: 6px 10px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        margin-right: 8px;
    }
    
    .tour-highlight {
      box-shadow: 0 0 0 3px rgba(230,0,115,0.6), 0 0 10px rgba(230,0,115,0.5);
      position: relative;
      z-index: 10001;
    }
    /* --- FIM ESTILOS TOUR --- */
    
    /* --- ESTILO PARA CAMPO INV√ÅLIDO --- */
    input.input-invalido, select.input-invalido {
        border: 2px solid var(--cor-erro) !important;
        box-shadow: 0 0 4px var(--cor-erro);
    }
    /* --- FIM ESTILO PARA CAMPO INV√ÅLIDO --- */

    
    /* Container para a logo */
    #logoLink {
        position: fixed;
        top: 16px; 
        left: 16px; 
        width: auto; 
        max-height: 80px; 
        cursor: pointer;
        z-index: 9998; 
    }
    
    /* Ajuste na logo superior */
    .app-logo {
      max-height: 80px; 
      width: auto;
      transition: opacity 0.3s ease, filter 0.3s ease; /* Adicionado filter para a transi√ß√£o do hover */
      display: block; 
    }
    
    /* NOVO: Efeito de ilumina√ß√£o ao passar o mouse na Logo (na calculadora) */
    #appLogo:hover {
        /* Brilho da logo ao passar o mouse */
        filter: drop-shadow(0 0 8px var(--cor-principal)) drop-shadow(0 0 15px var(--cor-glow-pulsante));
        opacity: 0.9;
    }

    
    /* --- Estilo para a imagem na tela de boas-vindas --- */
    #welcomeLogo {
      max-width: 80%;
      max-height: 120px; 
      margin-bottom: 25px;
      display: block;
      /* N√ÉO ADICIONAR EFEITO DE HOVER AQUI */
    }
    
    #welcomeScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--cor-card);
      z-index: 10000; 
      display: none; 
      flex-direction: column;
      justify-content: center; 
      align-items: center;
      text-align: center;
      transition: opacity 0.5s ease;
      padding: 20px; 
      box-sizing: border-box; 
    }
    
    #welcomeScreen.show {
        display: flex; 
    }

    #welcomeScreen.hidden {
      opacity: 0;
      pointer-events: none; 
    }
    
    #welcomeScreen h2 {
      font-size: 36px;
      margin-top: 10px; 
      margin-bottom: 20px;
      color: var(--cor-principal);
    }
    
    #welcomeScreen button {
      padding: 12px 24px;
      font-size: 18px;
      border-radius: 10px;
      margin-top: 10px;
    }


    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 960px;
      margin: 24px auto;
      padding: 20px;
      background: var(--cor-fundo);
      color: var(--cor-texto);
      transition: background 0.25s ease, color 0.25s ease;
    }
    
    /* Garante que o conte√∫do principal comece escondido e s√≥ apare√ßa se JS/Welcome Screen n√£o funcionar */
    #mainCard {
        display: block; 
    }

    h1 {
      margin: 0 0 12px;
      font-size: 24px;
      font-weight: 700;
      color: var(--cor-principal);
      text-align: center;
    }

    h2 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--cor-principal);
    }
    
    h3 {
        color: var(--cor-principal); 
        font-weight:600; 
        margin-top: 16px;
    }

    .card {
      background: var(--cor-card);
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border: 1px solid var(--cor-borda);
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin: 10px 0 6px;
      font-weight: 600;
      color: var(--cor-principal);
    }

    input[type=number], input[type=text], select {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid var(--cor-borda);
      background: #fff;
      color: var(--cor-texto);
      font-size: 14px;
      box-sizing: border-box;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    
    input[type=number] {
        width: 140px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
      margin-top: 12px;
    }
    
    .grid-venda {
        grid-template-columns: 1fr 1fr;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 14px;
    }

    th, td {
      padding: 6px; /* Reduzido o padding para caber mais na tela do celular */
      border-bottom: 1px solid var(--cor-borda);
      text-align: left;
    }

    th {
      background: var(--cor-btn-secundario);
      color: var(--cor-btn-secundario-texto);
      font-weight: 600;
    }
    
    
/* --- NOVO ESTILO PARA RESPONSIVIDADE DA TABELA --- */
.history-table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    width: 100%;
    margin-top: 8px;
}

/* Garante que o container interno n√£o atrapalhe a rolagem */
#historyBackground {
    overflow: hidden;
}

/* Mant√©m a tabela com comportamento de tabela e largura controlada */
#historyCard table {
    width: 100%;
    display: table;
    border-collapse: collapse;
    table-layout: fixed; /* ajuda a manter colunas alinhadas */
    min-width: 900px; /* for√ßa scroll em telas pequenas mantendo alinhamento */
}

/* Estilo base para c√©lulas */
#historyCard th, #historyCard td {
    padding: 8px 10px;
    vertical-align: middle;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 13px;
}

/* Ajuste para a linha de data/hora (duas linhas dentro da mesma c√©lula) */
.history-datetime-line {
    display: block;
    line-height: 1.1;
    font-size: 12px;
}

/* Faz com que valores longos quebrem visualmente melhor em c√©lulas menores quando necess√°rio */
@media (max-width: 700px) {
    #historyCard th, #historyCard td {
        font-size: 12px;
    }
    #historyCard th:nth-child(5), #historyCard td:nth-child(5) { width: 320px; }
}
/* --- FIM NOVO ESTILO PARA RESPONSIVIDADE DA TABELA --- */



    .actions {
      margin-top: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    button {
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: opacity 0.2s ease, box-shadow 0.3s ease; /* Adicionado box-shadow para transi√ß√£o do glow */
    }

    button:hover { opacity: 0.85; }
    
    /* NOVO: Efeito de brilho pulsante para o bot√£o principal (Calcular/Registrar) */
    .primary, .success {
        animation: pulse-glow 2s infinite ease-in-out;
    }
    
    /* NOVO: Keyframes para o brilho pulsante */
    @keyframes pulse-glow {
        0% {
            box-shadow: 0 0 0 rgba(0, 0, 0, 0); 
        }
        50% {
            box-shadow: 0 0 10px var(--cor-glow-pulsante), 0 0 20px var(--cor-glow-pulsante); 
        }
        100% {
            box-shadow: 0 0 0 rgba(0, 0, 0, 0); 
        }
    }

    .primary { background: var(--cor-btn-primario); color: var(--cor-btn-texto); }
    .muted { background: var(--cor-btn-secundario); color: var(--cor-btn-secundario-texto); }
    .success { background: #00b33c; color: #fff; }
    .danger { background: var(--cor-erro); color: #fff; } /* Novo: Bot√£o de Perigo */

    /* Container para agrupar e posicionar bot√µes (Modo Noturno e Tutorial) */
    .top-right-controls {
        position: fixed;
        top: 16px;
        right: 16px;
        display: flex;
        gap: 10px;
        z-index: 9999;
    }

    /* Estilo base para bot√µes de controle fixos */
    .control-btn {
        padding: 10px 14px;
        border-radius: 10px;
        background: var(--cor-btn-primario);
        color: var(--cor-btn-texto);
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        border: none;
        transition: opacity 0.2s ease;
        /* ANIMA√á√ÉO pulse-glow REMOVIDA DAQUI */
    }
    .control-btn:hover {
        opacity: 0.85;
    }
    
    /* --- Estilo para o Fundo do Hist√≥rico --- */
    #historyBackground {
      /* ALTERA√á√ÉO: Fundo semi-transparente (70%) */
      background: rgba(255, 255, 255, 0.7); 
      position: relative; 
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border: 1px solid var(--cor-borda);
      margin-bottom: 20px;
      min-height: 400px; 
      overflow: hidden;
    }
    
    #historyBackground img {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      height: auto;
      opacity: 0.3; /* ALTERA√á√ÉO: Aumentado para maior visibilidade */ 
      z-index: 1; 
      object-fit: contain; 
    }
    
    #historyBackground > * {
      position: relative; 
      z-index: 2;
    }
    
    #historyCard table {
        font-size: 12px;
    }
    
    /* --- CORRE√á√ÉO DE ALINHAMENTO DAS C√âLULAS (Principal Altera√ß√£o) --- */
    /* Garante que o conte√∫do fique no topo para alinhar a borda inferior */
    
#historyCard th, #historyCard td {
    padding: 8px 6px;
    text-align: center;
    vertical-align: middle; /* Centraliza verticalmente */
    white-space: nowrap;    /* Evita quebras desnecess√°rias */
}

/* Corrige o bloco de data/hora */
#historyCard tr td:first-child {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    line-height: 1.2;
    padding: 4px 0;
}

.history-datetime-line {
    display: block;
    font-size: 12px;
}

    
    /* Estilo para cada linha do texto dentro da c√©lula de Data/Hora */
    .history-datetime-line {
        display: block;
        line-height: 1.2; 
        padding: 6px 0 0 6px; /* Adiciona o padding de volta (topo e esquerda) */
    }
    
    /* Reduz o espa√ßamento vertical para compactar o texto na c√©lula de Valor Total (que tem quebra de linha) */
    
.valor-total-cell {
    display: flex;
    flex-direction: column;
    align-items: center;      /* Centraliza horizontalmente */
    justify-content: center;  /* Centraliza verticalmente */
    padding: 4px 0;
    line-height: 1.3;
    text-align: center;
}

.valor-total-cell span {
    display: block;
}

.valor-obs-text {
    font-size: 11px;
    color: var(--cor-principal);
    margin-top: 2px; /* Pequeno espa√ßamento entre o valor e a observa√ß√£o */
}

    
    /* --- FIM CORRE√á√ÉO DE ALINHAMENTO --- */
    
    
    /* Estilo para colocar os bot√µes do hist√≥rico na mesma linha (Responsivo) */
    .history-actions-cell {
        display: flex;
        gap: 5px; /* Espa√ßamento entre os bot√µes */
        flex-wrap: nowrap; /* Garante que fiquem na mesma linha */
        padding-top: 4px; /* Ajuste para o padding das outras c√©lulas */
    }
    
    .history-actions-cell button {
        padding: 4px 8px;
        font-size: 11px;
        margin-top: 2px; /* Pequeno ajuste de margem */
        border-radius: 4px;
        white-space: nowrap; /* Impede a quebra de linha dos bot√µes */
    }

    /* --- Estilos para Notifica√ß√£o Toast --- */
    #toast-container {
        position: fixed;
        bottom: 20px; 
        right: 20px; 
        z-index: 10005; 
        display: flex;
        flex-direction: column-reverse; 
        gap: 10px; 
        align-items: flex-end; 
    }

    .toast {
        background-color: var(--cor-principal); 
        color: var(--cor-btn-texto);
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        opacity: 0;
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        transform: translateY(20px); 
        max-width: 300px;
        min-width: 150px;
        text-align: center;
    }

    .toast.show {
        opacity: 1;
        transform: translateY(0);
    }
    
    .toast.success {
        background-color: #00b33c; 
    }

    .toast.error {
        background-color: var(--cor-erro); 
    }
    
    .action-btn {
        padding: 4px 8px;
        font-size: 12px;
        margin-right: 0px; 
        border-radius: 4px;
    }
    
    /* Otimiza√ß√£o para telas muito pequenas */
    @media (max-width: 500px) {
        body {
            padding: 10px;
            margin: 10px auto;
        }
        .top-right-controls {
            top: 10px;
            right: 10px;
        }
        .control-btn {
            padding: 8px 10px;
            font-size: 12px;
        }
        .grid {
            grid-template-columns: 1fr;
        }
        .grid-venda {
            grid-template-columns: 1fr;
        }
    }
    /* --- FIM Estilos para Notifica√ß√£o Toast --- */
  
/* --- ESTILO FINAL DA TABELA DE HIST√ìRICO --- */
.history-table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    width: 100%;
    margin-top: 8px;
}

#historyCard table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    min-width: 900px;
    background: transparent; 
}

#historyCard th, #historyCard td {
    padding: 6px 8px; /* Aumentado de 4px 6px */
    text-align: center;
    vertical-align: middle;
    white-space: nowrap;
    font-size: 14px; /* Aumentado de 13px */
    border-bottom: 1px solid var(--cor-borda);
}

/* NOVO: Fundo para as c√©lulas de dados para garantir a legibilidade */
#historyCard td {
    background: var(--cor-card); 
    opacity: 0.95; /* Leve transpar√™ncia para manter o efeito do fundo */
}

body.dark #historyCard td {
    background: var(--cor-card); /* Cor do card escuro */
    opacity: 0.95;
}


/* Alinhamento individual por coluna - larguras ajustadas */
#historyCard th:nth-child(1), #historyCard td:nth-child(1) { width: 100px; }   /* Data/Hora - Aumentado */
#historyCard th:nth-child(2), #historyCard td:nth-child(2) { width: 140px; }  /* Cliente - Aumentado */
#historyCard th:nth-child(3), #historyCard td:nth-child(3) { width: 160px; }  /* Organiza√ß√£o */
#historyCard th:nth-child(4), #historyCard td:nth-child(4) { width: 110px; }  /* Telefone */
#historyCard th:nth-child(5), #historyCard td:nth-child(5) { width: 280px; }  /* Produtos - Aumentado */
#historyCard th:nth-child(6), #historyCard td:nth-child(6) { width: 150px; }  /* Valor - Aumentado */
#historyCard th:nth-child(7), #historyCard td:nth-child(7) { width: 130px; }  /* Negociadoras */
#historyCard th:nth-child(8), #historyCard td:nth-child(8) { width: 150px; }  /* A√ß√µes */

/* Data e hora */
.history-datetime-line {
    display: block;
    line-height: 1.2; /* Aumentado */
    font-size: 13px; /* Aumentado */
}

/* Valor Total - tornando o valor em negrito */
.valor-total-cell span:first-child {
    font-weight: 700; /* Negrito */
}

.valor-obs-text {
    font-size: 12px; /* Aumentado */
    color: var(--cor-principal);
}

/* Bot√µes de a√ß√µes */
.history-actions-cell {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
}

.history-actions-cell button {
    padding: 3px 6px;
    font-size: 11px;
    border-radius: 4px;
    white-space: nowrap;
}

/* Aumenta altura total da linha */
#historyCard tr {
    height: 40px;
}

/* NOVO: Estilo para o cabe√ßalho TH */
#historyCard th {
    background: var(--cor-principal); /* Usa a cor principal para o cabe√ßalho */
    color: var(--cor-btn-texto);     /* Texto branco */
}

/* NOVO: Fundo semi-transparente para modo escuro */
body.dark #historyBackground {
  /* Cor escura do card #2c001a (que √© 44, 0, 26 em RGB) com 70% de opacidade */
  background: rgba(44, 0, 26, 0.7); 
}
/* --- FIM DO ESTILO FINAL DA TABELA DE HIST√ìRICO --- */

/* --- NOVO ESTILO PARA TELA DE LOGIN (#authScreen) --- */
#authScreen {
    /* Melhorar o visual do card de login */
    padding: 25px; /* Mais padding */
    border-radius: 16px; /* Mais arredondado */
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); /* Sombra mais profunda */
}

/* T√≠tulo com divisor */
#authScreen h2 {
    text-align: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--cor-borda); /* Linha divis√≥ria */
    font-size: 26px; /* Maior */
}

/* Melhorar inputs do login */
#authScreen input[type=text], 
#authScreen input[type=password] {
    padding: 12px;
    font-size: 16px;
    border-radius: 8px;
    border: 1px solid var(--cor-borda);
    /* Transi√ß√£o de foco mais suave */
    transition: all 0.3s ease;
}

#authScreen input[type=text]:focus, 
#authScreen input[type=password]:focus {
    border-color: var(--cor-principal) !important;
    box-shadow: 0 0 10px rgba(230, 0, 115, 0.5); /* Brilho mais intenso */
}

/* Fazer bot√µes ocuparem a largura total na tela de login */
#authScreen .actions {
    margin-top: 20px;
    display: flex;
    flex-direction: column; /* Pilha de bot√µes */
    gap: 10px;
}

#authScreen .actions button {
    width: 100%;
    padding: 12px;
    font-size: 16px;
}

/* Ajuste fino para a mensagem de erro */
#authMessage {
    text-align: center;
    font-weight: 600;
}
/* --- FIM NOVO ESTILO PARA TELA DE LOGIN (#authScreen) --- */

</style>
</head>
<body class="light">
  
  <a href="#" id="logoLink">
    <img id="appLogo" src="logo-dark.png" alt="Hells Angels Logo" class="app-logo">
  </a>

  <div id="welcomeScreen"> 
      <img id="welcomeLogo" src="logo-dark.png" alt="Welcome Logo"> 
      <h2 style="font-weight: 900;">Bem-vindo(a)</h2>
      <p style="margin-bottom: 20px; font-size: 16px;">Calculadora e Registro de Vendas Hells Angels</p>
      <button id="enterBtn" class="primary">Entrar no Site</button>
  </div>
  
  <div class="top-right-controls">
      <button class="control-btn" id="tutorialBtn">üí° Tutorial</button> 
      <button class="control-btn" id="themeBtn">üåô Modo Noturno</button>
  </div>

  <div id="authScreen" class="card" style="max-width: 400px; margin: 100px auto 20px auto; display: none;">
      <img src="logo-dark.png" alt="Hells Angels Logo" style="display: block; max-height: 100px; margin: 0 auto 20px auto;">
      
      <h2>Autentica√ß√£o de Usu√°rio</h2>
      
      <label for="username">Nome de Usu√°rio:</label>
      <input id="username" type="text" placeholder="Seu nome de usu√°rio">
      
      <label for="password">Senha:</label>
      <input id="password" type="password" placeholder="Sua senha">
      
      <div class="actions">
          <button id="loginBtn" class="primary">Entrar</button>
          <button id="registerUserBtn" class="muted">Cadastrar</button>
      </div>
      <p id="authMessage" style="color: var(--cor-erro); margin-top: 10px;"></p>
  </div>
  <div class="card" id="mainCard" style="display:none">
    <div style="display:flex; justify-content: space-between; align-items: center;">
        <h1>Calculadora e Registro de Vendas Hells Angels</h1>
        <button id="logoutBtn" class="danger" style="animation: none;">Sair</button>
    </div>
    
    <div class="card-venda">
        <h2>Dados da Venda</h2>
        <div class="grid grid-venda">
            <div>
                <label for="nomeCliente">Nome:</label>
                <input id="nomeCliente" type="text" value="">
            </div>
            <div>
                <label for="dataVenda">Data:</label>
                <input id="dataVenda" type="text" readonly> 
            </div>
            
            <div>
                <label for="organizacao">Organiza√ß√£o:</label>
                <input id="organizacao" type="text" value="" list="sugestoesOrganizacao">
                
                <p class="suggestion-tip">Digite para ver sugest√µes de organiza√ß√µes.</p>
                
                <datalist id="sugestoesOrganizacao">
                    <option value="Serpents"></option>
                    <option value="Nox"></option>
                    <option value="NKT"></option>
                    <option value="Ruptura"></option>
                    <option value="Midnight"></option>
                    <option value="Meraki"></option>
                    <option value="Lotus"></option>
                    <option value="Hydra"></option>
                    <option value="Hooligans"></option>
                    <option value="Families"></option>
                    <option value="Cartel"></option>
                    <option value="Blood Street"></option>
                    <option value="Blood Reapers"></option>
                    <option value="Blue Diamond"></option>
                    <option value="Black Heart"></option>
                    <option value="Ballas"></option>
                    <option value="Aura"></option>
                    <option value="Anarquia"></option>
                    <option value="8 Anjo"></option>
                    <option value="Vagos"></option>
                    <option value="Vertice"></option>
                    <option value="Void"></option>
                    <option value="Solo"></option>
                </datalist>
            </div>
            <div>
                <label for="organizacaoTipo">Op√ß√£o (CNPJ/CPF):</label>
                <select id="organizacaoTipo">
                    <option value="CNPJ">CNPJ</option>
                    <option value="CPF">CPF</option>
                    <option value="OUTROS">Outros</option>
                </select>
            </div>
            
            <div>
                <label for="telefone">Telefone:</label>
                <input id="telefone" type="text" value="" maxlength="13"> 
            </div>
            
            <div>
                <label for="negociadoras">Negociadoras:</label>
                <input id="negociadoras" type="text" value="">
            </div>
            <div style="grid-column: 1 / -1;">
                <label for="vendaValorObs">Valor - Observa√ß√£o (Como foi o pagamento):</label>
                <input id="vendaValorObs" type="text" value="">
            </div>
        </div>
    </div>
    
    <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--cor-borda);">

    <h2>C√°lculo de Produtos</h2>
    <p class="small">Informe quantos produtos deseja fabricar/vender e escolha o tipo de valor.</p>

    <div class="grid">
      <div>
        <label for="qtyTickets">Quantidade de Tickets</label>
        <input id="qtyTickets" type="number" min="0" value="">
      </div>
      <div>
        <label for="qtyTablets">Quantidade de Tablets</label>
        <input id="qtyTablets" type="number" min="0" value="">
      </div>
      <div>
        <label for="qtyNitro">Quantidade de Nitro</label>
        <input id="qtyNitro" type="number" min="0" value="">
      </div>
      <div>
        <label for="tipoValor">Tipo de Valor</label>
        <select id="tipoValor">
          <option value="limpo">Dinheiro Limpo</option>
          <option value="sujo">Dinheiro Sujo</option>
          <option value="limpo_alianca">Limpo (Alian√ßa)</option>
          <option value="sujo_alianca">Sujo (Alian√ßa)</option>
        </select>
      </div>
    </div>

    <div class="actions">
      <button id="calcBtn" class="primary">Calcular</button>
      <button id="resetBtn" class="muted">Limpar Campos</button>
      <button id="registerBtn" class="success">Registrar Venda</button>
      <button id="toggleHistoryBtn" class="muted">Ver Hist√≥rico</button>
      <button id="csvBtn" class="muted">Exportar CSV</button>
      <button id="discordBtnCalc" class="muted">Discord</button> 
    </div>

    <div id="resultsContainer">
      <div id="results" style="margin-top:16px;display:none">
        <h3>Totais necess√°rios</h3>
        <table>
          <thead><tr><th>Material</th><th>Quantidade total</th></tr></thead>
          <tbody id="resultsBody"></tbody>
        </table>

        <h3>Valores Estimados</h3>
        <table>
          <thead><tr><th>Produto</th><th>Valor Total</th></tr></thead>
          <tbody id="valuesBody"></tbody>
          <tfoot>
            <tr><th>Total Geral</th><th id="valorTotalGeral">R$ 0</th></tr>
          </tfoot>
        </table>
        <p class="result-note" style="font-size: 12px; margin-top: 8px;">Os valores variam conforme o tipo selecionado (limpo, sujo, alian√ßa).</p>
      </div>
    </div>
  </div>

  <div class="card" id="historyCard" style="display:none">
      <div id="historyBackground" class="card">
        <h2>Hist√≥rico de Vendas Registradas</h2>
        <img id="historyImg" src="logo-dark.png" alt="Fundo Hist√≥rico"> 
        
        <input type="text" id="filtroHistorico" placeholder="üîç Pesquisar no hist√≥rico (Nome, Data, Item, etc.)" style="margin-bottom: 10px; width: 100%;">
        
        <div class="actions">
          <button id="clearHistoryBtn" class="muted">Limpar Hist√≥rico</button>
          <button id="toggleCalcBtn" class="muted">Voltar √† Calculadora</button>
        </div>
        <div class="history-table-wrapper"><table id="historicoVendas">
          <thead>
              <tr>
                  <th>Data/Hora</th>
                  <th>Cliente</th>
                  <th>Organiza√ß√£o/Tipo</th>
                  <th>Telefone</th>
                  <th>Produtos (Unidade)</th>
                  <th>Valor Total</th>
                  <th>Negociadoras</th>
                  <th>Registrado Por</th> <th>A√ß√µes</th> 
              </tr>
          </thead>
          <tbody id="salesHistory"></tbody>
        </table></div>
      </div>
  </div>
  
  <div id="toast-container"></div>
  
  <script type="module">
    // ------------------------------------
    // 1. IMPORTA√á√ïES E CONFIGURA√á√ÉO FIREBASE
    // ------------------------------------
    // URLs de importa√ß√£o do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, set, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    
    // Configura√ß√£o do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAhDVBfXoO_Rdi3e-trdbaaPppwDkTDgVc",
      authDomain: "hells-angels-438c2.firebaseapp.com",
      databaseURL: "https://hells-angels-438c2-default-rtdb.firebaseio.com/",
      projectId: "hells-angels-438c2",
      storageBucket: "hells-angels-438c2.firebasestorage.app",
      messagingSenderId: "429406215315",
      appId: "1:429406215315:web:96b68b172247824b308166",
      measurementId: "G-CR415MEY32"
    };
    
    // Inicializa√ß√£o
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    
    // VARI√ÅVEIS GLOBAIS
    let vendas = []; // O hist√≥rico ser√° preenchido pelo Firebase
    let vendaEmEdicaoId = null; // ID da venda sendo editada
    let currentUser = null; // Para guardar o usu√°rio logado
    
    // ------------------------------------
    // 2. CONSTANTES E VALORES
    // ------------------------------------
    
    const perUnit = {
      tickets: { moneyBruto: 525 },
      tablets: { cobre: 20, plastico: 40, fita_adesiva: 2, lixo_eletronico: 2 },
      nitro: { aluminio: 20, cobre: 20, vidro: 45, fita_adesiva: 1, porca: 1, parafuso: 1 }
    };
    
    const valores = {
      tablets: { limpo: 17000, sujo: 20000, limpo_alianca: 15000, sujo_alianca: 18000 },
      tickets: { limpo: 9800, sujo: 11700, limpo_alianca: 8000, sujo_alianca: 10000 },
      nitro: { limpo: 42500, sujo: 50000, limpo_alianca: 38000, sujo_alianca: 45000 }
    };
    
    const valorDescricao = {
        'limpo': 'Dinheiro Limpo',
        'sujo': 'Dinheiro Sujo',
        'limpo_alianca': 'Limpo (Alian√ßa)',
        'sujo_alianca': 'Sujo (Alian√ßa)'
    };

    // Usando 'logo-dark.png' como placeholder para todas as imagens
    const logoLightModeSrc = "logo-dark.png";
    const logoDarkModeSrc = "logo-dark.png";
    const historyBackgroundSrc = "logo-dark.png";
    const welcomeLogoSrc = "logo-dark.png";
    
    // Mapeamento de elementos DOM
    const els = {
      // Inputs da Venda
      qtyTickets: document.getElementById('qtyTickets'),
      qtyTablets: document.getElementById('qtyTablets'),
      qtyNitro: document.getElementById('qtyNitro'),
      tipoValor: document.getElementById('tipoValor'),
      nomeCliente: document.getElementById('nomeCliente'),
      organizacao: document.getElementById('organizacao'),
      organizacaoTipo: document.getElementById('organizacaoTipo'),
      telefone: document.getElementById('telefone'),
      negociadoras: document.getElementById('negociadoras'),
      vendaValorObs: document.getElementById('vendaValorObs'),
      dataVenda: document.getElementById('dataVenda'),
      filtroHistorico: document.getElementById('filtroHistorico'),
      
      // Containers e Resultados
      resultsBody: document.getElementById('resultsBody'),
      valuesBody: document.getElementById('valuesBody'),
      valorTotalGeral: document.getElementById('valorTotalGeral'),
      results: document.getElementById('results'),
      mainCard: document.getElementById('mainCard'),
      historyCard: document.getElementById('historyCard'),
      salesHistory: document.getElementById('salesHistory'),
      
      // Bot√µes
      calcBtn: document.getElementById('calcBtn'),
      resetBtn: document.getElementById('resetBtn'),
      registerBtn: document.getElementById('registerBtn'),
      toggleHistoryBtn: document.getElementById('toggleHistoryBtn'),
      toggleCalcBtn: document.getElementById('toggleCalcBtn'),
      clearHistoryBtn: document.getElementById('clearHistoryBtn'),
      csvBtn: document.getElementById('csvBtn'),
      discordBtnCalc: document.getElementById('discordBtnCalc'),
      
      // Controles Globais
      themeBtn: document.getElementById('themeBtn'),
      tutorialBtn: document.getElementById('tutorialBtn'),
      logoLink: document.getElementById('logoLink'),
      appLogo: document.getElementById('appLogo'),
      historyImg: document.getElementById('historyImg'),
      
      // Autentica√ß√£o e Boas-Vindas
      welcomeScreen: document.getElementById('welcomeScreen'),
      enterBtn: document.getElementById('enterBtn'),
      welcomeLogo: document.getElementById('welcomeLogo'),
      authScreen: document.getElementById('authScreen'),
      username: document.getElementById('username'),
      password: document.getElementById('password'),
      loginBtn: document.getElementById('loginBtn'),
      registerUserBtn: document.getElementById('registerUserBtn'),
      authMessage: document.getElementById('authMessage'),
      logoutBtn: document.getElementById('logoutBtn')
    };
    
    // ------------------------------------
    // 3. FUN√á√ïES DE UTILIDADE E FORMATO
    // ------------------------------------
    
    /** Formata um n√∫mero para o formato de moeda brasileira (R$) */
    const formatCurrency = (value) => {
      if (typeof value !== 'number' || isNaN(value)) {
        return 'R$ 0';
      }
      return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 0, maximumFractionDigits: 0 });
    };

    /** Capitaliza o primeiro caractere de cada palavra. */
    const capitalizeText = (text) => {
        if (!text) return '';
        // Esta vers√£o n√£o usa .trim() para permitir o uso da tecla de espa√ßo
        // e garante que a primeira letra de cada palavra seja mai√∫scula.
        return text.split(' ').map(word => 
            word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
        ).join(' ');
    };
    
    /** Fun√ß√£o para mostrar uma notifica√ß√£o de "brinde" */
    const showToast = (message, type = 'default', duration = 3000) => {
      const toastContainer = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      toastContainer.appendChild(toast);
      
      // Mostra o toast
      setTimeout(() => {
        toast.classList.add('show');
      }, 10);
      
      // Remove o toast ap√≥s a dura√ß√£o
      setTimeout(() => {
        toast.classList.remove('show');
        // Espera a transi√ß√£o acabar antes de remover do DOM
        setTimeout(() => {
          toastContainer.removeChild(toast);
        }, 300);
      }, duration);
    };
    
    /** Fun√ß√£o para obter o valor de um campo de quantidade (garante que √© um n√∫mero >= 0) */
    const getQty = (element) => {
      const value = parseInt(element.value) || 0;
      return Math.max(0, value);
    };

    // --- C√ìDIGO FINAL PARA A M√ÅSCARA DE TELEFONE NO FORMATO (055) XXX-XXX (GTA RP) ---

    const PREFIX = "(055) "; // Prefixo fixo de GTA RP

    /** Fun√ß√£o que aplica a m√°scara (055) XXX-XXX */
    const phoneMask = (value) => {
        // 1. Remove tudo que n√£o for d√≠gito da entrada do usu√°rio
        let digits = value.replace(/\D/g, ""); 
        
        // 2. Remove o DDD '055' se estiver l√°, para podermos for√ß√°-lo depois
        if (digits.startsWith("055")) {
            digits = digits.substring(3);
        }
        
        // 3. Limita o n√∫mero de d√≠gitos (apenas 6 para o n√∫mero principal)
        digits = digits.substring(0, 6); 
        
        // 4. Constr√≥i o n√∫mero principal
        let formattedNumber = "";
        if (digits.length > 3) {
            // Aplica o h√≠fen: XXX-XXX
            formattedNumber = digits.substring(0, 3) + "-" + digits.substring(3);
        } else {
            formattedNumber = digits;
        }
        
        // 5. Adiciona o prefixo fixo
        return PREFIX + formattedNumber;
    }

    // Adiciona o formatador de telefone ao evento input e focus
    if (els.telefone) {
        els.telefone.addEventListener('input', (e) => {
            let rawValue = e.target.value;
            let maskedValue = phoneMask(rawValue);

            // Se o valor de entrada for menor que o prefixo fixo, for√ßa o prefixo
            if (rawValue.length < PREFIX.length) {
                e.target.value = PREFIX;
            } else {
                e.target.value = maskedValue;
            }
        });

        // Garante que o campo comece com o prefixo ao ser focado
        els.telefone.addEventListener('focus', (e) => {
            if (!e.target.value || e.target.value.length < PREFIX.length) {
                e.target.value = PREFIX;
            }
        });
    }

    // --- FIM DO C√ìDIGO ---

    /** Define a data da venda para a data atual */
    const updateDataVenda = () => {
      const now = new Date();
      const dateString = now.toLocaleDateString('pt-BR');
      els.dataVenda.value = dateString;
    };
    
    // Atualiza a data ao carregar
    updateDataVenda();
    
    // --- NOVO: L√ìGICA DE CAPITALIZA√á√ÉO AUTOM√ÅTICA ---
    const camposParaCapitalizar = [
      els.nomeCliente,
      els.organizacao,
      els.negociadoras,
      els.vendaValorObs
    ];

    camposParaCapitalizar.forEach(campo => {
      if (campo) {
        campo.addEventListener('input', (e) => {
          // Pega a posi√ß√£o do cursor para n√£o atrapalhar a digita√ß√£o
          const start = e.target.selectionStart;
          const end = e.target.selectionEnd;
          // Aplica a capitaliza√ß√£o
          e.target.value = capitalizeText(e.target.value);
          // Restaura a posi√ß√£o do cursor
          e.target.setSelectionRange(start, end);
        });
      }
    });
    // --- FIM DO C√ìDIGO NOVO ---
    
    // ------------------------------------
    // 4. L√ìGICA DE C√ÅLCULO
    // ------------------------------------
    
    /** Calcula os materiais necess√°rios para a produ√ß√£o e os valores de venda */
    const calculate = () => {
      const qtyTickets = getQty(els.qtyTickets);
      const qtyTablets = getQty(els.qtyTablets);
      const qtyNitro = getQty(els.qtyNitro);
      const tipoValor = els.tipoValor.value;
      
      const totalQuantities = {
        cobre: 0,
        plastico: 0,
        fita_adesiva: 0,
        lixo_eletronico: 0,
        aluminio: 0,
        vidro: 0,
        porca: 0,
        parafuso: 0,
        moneyBruto: 0,
      };
      
      let totalValue = 0;
      const productValues = [];
      
      // C√°lculo de Tablets
      totalQuantities.cobre += qtyTablets * perUnit.tablets.cobre;
      totalQuantities.plastico += qtyTablets * perUnit.tablets.plastico;
      totalQuantities.fita_adesiva += qtyTablets * perUnit.tablets.fita_adesiva;
      totalQuantities.lixo_eletronico += qtyTablets * perUnit.tablets.lixo_eletronico;
      const tabletValue = qtyTablets * valores.tablets[tipoValor];
      totalValue += tabletValue;
      if (qtyTablets > 0) productValues.push({ product: `Tablets (${qtyTablets} und.)`, value: tabletValue });
      
      // C√°lculo de Tickets
      totalQuantities.moneyBruto += qtyTickets * perUnit.tickets.moneyBruto;
      const ticketValue = qtyTickets * valores.tickets[tipoValor];
      totalValue += ticketValue;
      if (qtyTickets > 0) productValues.push({ product: `Tickets (${qtyTickets} und.)`, value: ticketValue });
      
      // C√°lculo de Nitro
      totalQuantities.aluminio += qtyNitro * perUnit.nitro.aluminio;
      totalQuantities.cobre += qtyNitro * perUnit.nitro.cobre;
      totalQuantities.vidro += qtyNitro * perUnit.nitro.vidro;
      totalQuantities.fita_adesiva += qtyNitro * perUnit.nitro.fita_adesiva;
      totalQuantities.porca += qtyNitro * perUnit.nitro.porca;
      totalQuantities.parafuso += qtyNitro * perUnit.nitro.parafuso;
      const nitroValue = qtyNitro * valores.nitro[tipoValor];
      totalValue += nitroValue;
      if (qtyNitro > 0) productValues.push({ product: `Nitro (${qtyNitro} und.)`, value: nitroValue });
      
      const hasQuantities = qtyTickets > 0 || qtyTablets > 0 || qtyNitro > 0;
      
      // Atualiza a interface
      if (hasQuantities) {
        updateResults(totalQuantities, productValues, totalValue);
      } else {
        els.results.style.display = 'none';
        showToast("Nenhuma quantidade inserida. Insira a quantidade para calcular.", "error", 2000);
      }
      
      return { qtyTickets, qtyTablets, qtyNitro, totalValue, tipoValor, hasQuantities };
    };
    
    /** Atualiza o DOM com os resultados do c√°lculo */
    const updateResults = (totals, productValues, totalValue) => {
      els.results.style.display = 'block';
      
      // 1. Materiais
      els.resultsBody.innerHTML = '';
      for (const material in totals) {
        if (totals[material] > 0) {
          const row = els.resultsBody.insertRow();
          // Garante que os nomes de material tamb√©m comecem com mai√∫scula
          row.insertCell().textContent = capitalizeText(material.replace(/([a-z])([A-Z])/g, '$1 $2').replace(/_/g, ' '));
          row.insertCell().textContent = totals[material].toLocaleString('pt-BR');
        }
      }
      
      // 2. Valores por Produto
      els.valuesBody.innerHTML = '';
      productValues.forEach(item => {
        const row = els.valuesBody.insertRow();
        row.insertCell().textContent = item.product;
        row.insertCell().textContent = formatCurrency(item.value);
      });
      
      // 3. Valor Total Geral
      els.valorTotalGeral.textContent = formatCurrency(totalValue);
    };
    
    /** Limpa todos os campos de entrada */
    const clearAllFields = () => {
      els.qtyTickets.value = '';
      els.qtyTablets.value = '';
      els.qtyNitro.value = '';
      els.tipoValor.value = 'limpo';
      els.nomeCliente.value = '';
      els.organizacao.value = '';
      els.organizacaoTipo.value = 'CNPJ';
      els.telefone.value = '';
      els.negociadoras.value = '';
      els.vendaValorObs.value = '';
      els.results.style.display = 'none';
      
      // Limpa valida√ß√£o
      const inputs = document.querySelectorAll('.input-invalido');
      inputs.forEach(input => input.classList.remove('input-invalido'));

      // Reset da edi√ß√£o
      if (vendaEmEdicaoId) {
          vendaEmEdicaoId = null;
          els.registerBtn.textContent = 'Registrar Venda';
      }
    };
    
    // ------------------------------------
    // 5. L√ìGICA DE REGISTRO DE VENDAS
    // ------------------------------------
    
    /** Valida se os campos de venda est√£o preenchidos */
    const validateFields = () => {
        // Lista de campos que S√ÉO OBRIGAT√ìRIOS: todos, exceto vendaValorObs
        const fields = [
            els.nomeCliente,
            els.organizacao, // <-- OBRIGAT√ìRIO
            els.telefone,    // <-- OBRIGAT√ìRIO
            els.negociadoras,
            // els.vendaValorObs, <--- N√ÉO OBRIGAT√ìRIO
        ];
        let isValid = true;
        
        fields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('input-invalido');
                isValid = false;
            } else {
                field.classList.remove('input-invalido');
            }
        });

        // A valida√ß√£o espec√≠fica da m√°scara do telefone foi removida.
        
        return isValid;
    };
    
    /** Registra ou atualiza uma venda no Firebase */
    const registerVenda = () => {
      const { qtyTickets, qtyTablets, qtyNitro, totalValue, tipoValor, hasQuantities } = calculate();
      
      if (!hasQuantities) {
        showToast("√â necess√°rio calcular a venda antes de registrar (adicione quantidades).", "error", 3000);
        return;
      }

      if (!validateFields()) {
          showToast("Por favor, preencha todos os campos obrigat√≥rios.", "error", 3000);
          return;
      }
      
      if (!currentUser || !currentUser.displayName) {
          showToast("Erro: Usu√°rio n√£o autenticado ou nome n√£o definido.", "error", 3000);
          return;
      }
      
      const now = new Date();
      
      const newVenda = {
        timestamp: Date.now(),
        dataHora: now.toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' }),
        cliente: els.nomeCliente.value.trim() || 'N/A',
        organizacao: els.organizacao.value.trim() || 'N/A',
        organizacaoTipo: els.organizacaoTipo.value,
        telefone: els.telefone.value.trim() || 'N/A',
        negociadoras: els.negociadoras.value.trim() || 'N/A',
        vendaValorObs: els.vendaValorObs.value.trim() || 'N/A',
        
        // Dados do C√°lculo
        qtyTickets: qtyTickets,
        qtyTablets: qtyTablets,
        qtyNitro: qtyNitro,
        valorTotal: totalValue,
        tipoValor: tipoValor,
        
        // Dados do Usu√°rio
        registradoPor: currentUser.displayName,
      };

      const dbRef = ref(db, 'vendas');

      if (vendaEmEdicaoId) {
          // L√≥gica de EDI√á√ÉO (Substitui o item existente)
          set(ref(db, `vendas/${vendaEmEdicaoId}`), newVenda)
              .then(() => {
                  showToast("Venda atualizada com sucesso!", "success");
                  clearAllFields();
                  vendaEmEdicaoId = null;
                  els.registerBtn.textContent = 'Registrar Venda';
              })
              .catch((error) => {
                  console.error("Erro ao atualizar venda:", error);
                  showToast(`Erro ao atualizar venda: ${error.message}`, "error", 5000);
              });
      } else {
          // L√≥gica de NOVO REGISTRO (Adiciona um novo item)
          push(dbRef, newVenda)
              .then(() => {
                  showToast("Venda registrada com sucesso!", "success");
                  clearAllFields();
              })
              .catch((error) => {
                  console.error("Erro ao registrar venda:", error);
                  showToast(`Erro ao registrar venda: ${error.message}`, "error", 5000);
              });
      }
    };

    /** Prepara os campos para a edi√ß√£o de uma venda */
    const editVenda = (id) => {
        const venda = vendas.find(v => v.id === id);
        if (!venda) return;
        
        // 1. Preenche os campos de venda
        els.qtyTickets.value = venda.qtyTickets || 0;
        els.qtyTablets.value = venda.qtyTablets || 0;
        els.qtyNitro.value = venda.qtyNitro || 0;
        els.tipoValor.value = venda.tipoValor || 'limpo';
        
        els.nomeCliente.value = venda.cliente || '';
        els.organizacao.value = venda.organizacao || '';
        els.organizacaoTipo.value = venda.organizacaoTipo || 'CNPJ';
        els.telefone.value = venda.telefone || '';
        els.negociadoras.value = venda.negociadoras || '';
        els.vendaValorObs.value = venda.vendaValorObs || '';
        
        // 2. Calcula e exibe os resultados (opcional)
        calculate();

        // 3. Marca a venda como em edi√ß√£o e atualiza o bot√£o
        vendaEmEdicaoId = id;
        els.registerBtn.textContent = 'Atualizar Venda';

        // 4. Volta para a tela da calculadora
        toggleView(false);
        showToast(`Editando venda de ${venda.cliente}`, "default", 3000);
    };

    /** Remove uma venda do Firebase */
    const removeVenda = (id) => {
        if (confirm("Tem certeza que deseja remover esta venda do hist√≥rico?")) {
            remove(ref(db, `vendas/${id}`))
                .then(() => {
                    showToast("Venda removida com sucesso.", "success");
                    // O onValue se encarrega de atualizar a lista.
                })
                .catch((error) => {
                    console.error("Erro ao remover venda:", error);
                    showToast(`Erro ao remover venda: ${error.message}`, "error", 5000);
                });
        }
    };

    /** Constr√≥i a mensagem de Discord para a venda atual */
    const buildDiscordMessage = () => {
        const { qtyTickets, qtyTablets, qtyNitro, totalValue, tipoValor, hasQuantities } = calculate();

        if (!hasQuantities) {
            showToast("Calcule uma venda antes de tentar gerar a mensagem.", "error", 3000);
            return;
        }
        
        const valorTipoTexto = valorDescricao[tipoValor] || 'N/A';
        const valorTotalTexto = formatCurrency(totalValue);
        const nomeCliente = els.nomeCliente.value.trim() || 'N/A';
        const organizacao = els.organizacao.value.trim() || 'N/A';
        const telefone = els.telefone.value.trim() || 'N/A';
        const negociadoras = els.negociadoras.value.trim() || 'N/A';
        const observacao = els.vendaValorObs.value.trim() || 'N/A';

        let produtos = [];
        if (qtyTickets > 0) produtos.push(`${qtyTickets} Tickets`);
        if (qtyTablets > 0) produtos.push(`${qtyTablets} Tablets`);
        if (qtyNitro > 0) produtos.push(`${qtyNitro} Nitro`);
        const listaProdutos = produtos.join(', ');

        const message = `
**[VENDA - HELLS ANGELS]**
\`\`\`
CLIENTE: ${nomeCliente}
ORGANIZA√á√ÉO: ${organizacao}
TELEFONE: ${telefone}

PRODUTOS: ${listaProdutos}
VALOR FINAL: ${valorTotalTexto} (${valorTipoTexto})
NEGOCIADORAS: ${negociadoras}
OBS: ${observacao}
\`\`\`
        `.trim();
        
        return message;
    };
    
    /** Copia o texto para a √°rea de transfer√™ncia */
    const copyToClipboard = (text) => {
        navigator.clipboard.writeText(text).then(() => {
            showToast("Mensagem copiada para o Discord!", "success");
        }).catch(err => {
            console.error('Erro ao copiar: ', err);
            showToast("Erro ao copiar. Tente novamente ou copie manualmente.", "error", 3000);
        });
    };
    
    // --- NOVA FUN√á√ÉO: Gera mensagem para Discord a partir do Hist√≥rico ---
    const buildDiscordMessageFromHistory = (venda) => {
        // Formata a data para pegar apenas a parte "dd/mm/aaaa"
        const dataFormatada = venda.dataHora.split(', ')[0];

        // Formata a lista de produtos
        let produtos = [];
        if (venda.qtyTickets > 0) produtos.push(`Tickets (${venda.qtyTickets})`);
        if (venda.qtyTablets > 0) produtos.push(`Tablet (${venda.qtyTablets})`);
        if (venda.qtyNitro > 0) produtos.push(`Nitros (${venda.qtyNitro})`);
        const listaProdutos = produtos.join(', ');

        // Formata o valor total e o tipo de pagamento
        const valorTotalTexto = formatCurrency(venda.valorTotal || 0);
        // Usa a observa√ß√£o do campo de valor, se n√£o houver, usa o tipo (limpo/sujo)
        const tipoValorTexto = venda.vendaValorObs || valorDescricao[venda.tipoValor] || 'Valor n√£o especificado';

        const message = `
\`\`\`
Nome: ${venda.cliente}
Data: ${dataFormatada}
Organiza√ß√£o: ${venda.organizacaoTipo} - ${venda.organizacao}
Telefone: ${venda.telefone}
Produto (Unidade): ${listaProdutos}
Venda Valor: ${valorTotalTexto} (${tipoValorTexto})
Negociadoras: ${venda.negociadoras}
\`\`\`
        `.trim();
        
        return message;
    };
    // --- FIM DA NOVA FUN√á√ÉO ---

    // ------------------------------------
    // 6. L√ìGICA DE EXIBI√á√ÉO E HIST√ìRICO
    // ------------------------------------
    
    /** Alterna entre a visualiza√ß√£o da calculadora e do hist√≥rico */
    const toggleView = (showHistory) => {
        if (showHistory) {
            els.mainCard.style.display = 'none';
            els.historyCard.style.display = 'block';
            els.historyImg.src = historyBackgroundSrc;
            // Limpa o filtro ao abrir a lista completa
            els.filtroHistorico.value = ''; 
            displaySalesHistory(vendas); 
        } else {
            els.mainCard.style.display = 'block';
            els.historyCard.style.display = 'none';
        }
    };

    /** Renderiza o hist√≥rico de vendas na tabela */
    const displaySalesHistory = (history) => {
        els.salesHistory.innerHTML = '';
        if (history.length === 0) {
            const row = els.salesHistory.insertRow();
            const cell = row.insertCell();
            cell.colSpan = 9; 
            cell.textContent = "Nenhuma venda registrada ainda.";
            cell.style.textAlign = 'center';
            cell.style.padding = '20px';
            return;
        }

        history.sort((a, b) => b.timestamp - a.timestamp); // Mais recente primeiro

        history.forEach(venda => {
            const row = els.salesHistory.insertRow();
            row.setAttribute('data-id', venda.id);

            // C√©lula 1: Data/Hora
            const dateCell = row.insertCell();
            const [data, hora] = venda.dataHora.split(', ');
            dateCell.innerHTML = `<span class="history-datetime-line">${data}</span><span class="history-datetime-line">${hora}</span>`;

            // C√©lula 2: Cliente
            row.insertCell().textContent = capitalizeText(venda.cliente);

            // C√©lula 3: Organiza√ß√£o/Tipo
            row.insertCell().textContent = `${capitalizeText(venda.organizacao)} (${venda.organizacaoTipo})`;
            
            // C√©lula 4: Telefone
            row.insertCell().textContent = venda.telefone;

            // C√©lula 5: Produtos (Unidade)
            let produtos = [];
            if (venda.qtyTickets > 0) produtos.push(`${venda.qtyTickets} Tickets`);
            if (venda.qtyTablets > 0) produtos.push(`${venda.qtyTablets} Tablets`);
            if (venda.qtyNitro > 0) produtos.push(`${venda.qtyNitro} Nitro`);
            row.insertCell().textContent = capitalizeText(produtos.join(', '));
            
            // C√©lula 6: Valor Total
            const valorCell = row.insertCell();
            valorCell.className = 'valor-total-cell';
            const valorTotalTexto = formatCurrency(venda.valorTotal || 0);
            const obsTexto = capitalizeText(venda.vendaValorObs) || 'S/ Obs';
            const tipoTexto = valorDescricao[venda.tipoValor] || 'N/A';
            valorCell.innerHTML = `<span>${valorTotalTexto}</span><span class="valor-obs-text">(${tipoTexto})</span>`;

            // C√©lula 7: Negociadoras
            row.insertCell().textContent = capitalizeText(venda.negociadoras);
            
            // C√©lula 8: Registrado Por
            row.insertCell().textContent = venda.registradoPor || 'Desconhecido';
            
            // C√©lula 9: A√ß√µes
            const actionsCell = row.insertCell();
            actionsCell.className = 'history-actions-cell';
            
            const editBtn = document.createElement('button');
            editBtn.textContent = 'Editar';
            editBtn.className = 'action-btn muted';
            editBtn.onclick = () => editVenda(venda.id);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Deletar';
            deleteBtn.className = 'action-btn danger';
            deleteBtn.onclick = () => removeVenda(venda.id);

            // --- IN√çCIO DO C√ìDIGO NOVO (PONTO 2) ---
            const discordBtn = document.createElement('button');
            discordBtn.textContent = 'Discord';
            discordBtn.className = 'action-btn muted'; 
            discordBtn.onclick = () => {
                const mensagem = buildDiscordMessageFromHistory(venda);
                copyToClipboard(mensagem);
            };
            // --- FIM DO C√ìDIGO NOVO ---
            
            actionsCell.appendChild(editBtn);
            actionsCell.appendChild(deleteBtn);
            actionsCell.appendChild(discordBtn); // Adiciona o novo bot√£o na c√©lula
        });
    };

    /** Filtra o hist√≥rico com base no texto de pesquisa */
    const filterHistory = () => {
        const query = els.filtroHistorico.value.toLowerCase().trim();
        if (!query) {
            displaySalesHistory(vendas);
            return;
        }

        const filteredVendas = vendas.filter(venda => 
            (venda.cliente && venda.cliente.toLowerCase().includes(query)) ||
            (venda.organizacao && venda.organizacao.toLowerCase().includes(query)) ||
            (venda.telefone && venda.telefone.toLowerCase().includes(query)) ||
            (venda.negociadoras && venda.negociadoras.toLowerCase().includes(query)) ||
            (venda.vendaValorObs && venda.vendaValorObs.toLowerCase().includes(query)) ||
            (venda.dataHora && venda.dataHora.toLowerCase().includes(query)) ||
            (venda.registradoPor && venda.registradoPor.toLowerCase().includes(query)) ||
            (venda.qtyTickets > 0 && `tickets`.includes(query)) ||
            (venda.qtyTablets > 0 && `tablets`.includes(query)) ||
            (venda.qtyNitro > 0 && `nitro`.includes(query))
        );

        displaySalesHistory(filteredVendas);
    };

    /** Exporta o hist√≥rico para CSV */
    const exportToCsv = () => {
        if (vendas.length === 0) {
            showToast("Nenhum dado para exportar.", "error", 2000);
            return;
        }
        
        // Define o cabe√ßalho do CSV
        const headers = [
            "Data/Hora", "Cliente", "Organiza√ß√£o", "Tipo", "Telefone", "Negociadoras", 
            "Observa√ß√£o", "Qtde Tickets", "Qtde Tablets", "Qtde Nitro", 
            "Valor Total", "Tipo Valor", "Registrado Por"
        ];
        
        // Mapeia os dados da venda para linhas CSV
        const csvRows = vendas.map(v => [
            `"${v.dataHora}"`,
            `"${v.cliente}"`,
            `"${v.organizacao}"`,
            `"${v.organizacaoTipo}"`,
            `"${v.telefone}"`,
            `"${v.negociadoras}"`,
            `"${v.vendaValorObs}"`,
            v.qtyTickets,
            v.qtyTablets,
            v.qtyNitro,
            v.valorTotal,
            `"${valorDescricao[v.tipoValor]}"`,
            `"${v.registradoPor}"`
        ].join(','));

        // Combina cabe√ßalho e linhas
        const csvContent = [
            headers.join(','),
            ...csvRows
        ].join('\n');

        // Cria e baixa o arquivo
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', `historico_vendas_HA_${new Date().toISOString().slice(0, 10)}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast("Hist√≥rico exportado para CSV!", "success");
    };

    /** Limpa todo o hist√≥rico de vendas do Firebase */
    const clearHistory = () => {
        if (confirm("ATEN√á√ÉO: Voc√™ tem certeza que deseja APAGAR TODO o hist√≥rico de vendas? Esta a√ß√£o √© irrevers√≠vel.")) {
            // Remove o n√≥ principal das vendas
            remove(ref(db, 'vendas'))
                .then(() => {
                    showToast("Hist√≥rico de vendas limpado com sucesso.", "success", 4000);
                    // O onValue ir√° atualizar a tela automaticamente.
                })
                .catch((error) => {
                    console.error("Erro ao limpar hist√≥rico:", error);
                    showToast(`Erro ao limpar hist√≥rico: ${error.message}`, "error", 5000);
                });
        }
    };
    
    // ------------------------------------
    // 7. L√ìGICA DE TEMA E TOUR
    // ------------------------------------
    
    /** Alterna entre o modo claro e escuro */
    const toggleTheme = () => {
        const body = document.body;
        const isDarkMode = body.classList.toggle('dark');
        localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        updateLogoAndThemeButton(isDarkMode);
    };

    /** Atualiza a imagem da logo e o texto do bot√£o do tema */
    const updateLogoAndThemeButton = (isDarkMode) => {
        if (isDarkMode) {
            els.themeBtn.textContent = '‚òÄÔ∏è Modo Claro';
            els.appLogo.src = logoDarkModeSrc;
            els.welcomeLogo.src = welcomeLogoSrc;
            els.historyImg.src = historyBackgroundSrc; 
        } else {
            els.themeBtn.textContent = 'üåô Modo Noturno';
            els.appLogo.src = logoLightModeSrc;
            els.welcomeLogo.src = welcomeLogoSrc;
            els.historyImg.src = historyBackgroundSrc;
        }
    };

    // Aplica o tema salvo no localStorage
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.body.classList.add(savedTheme);
    updateLogoAndThemeButton(savedTheme === 'dark');

    // --- L√≥gica do Tour/Tutorial ---
    const tourSteps = [
        { 
            id: 'passo1', 
            element: 'qtyTickets', 
            title: '1/5: Quantidades', 
            content: 'Comece inserindo a quantidade de produtos que deseja negociar. Use zero se n√£o for vender um item espec√≠fico.' 
        },
        { 
            id: 'passo2', 
            element: 'tipoValor', 
            title: '2/5: Tipo de Valor', 
            content: 'Selecione o tipo de pagamento (Limpo/Sujo) e se √© para um cliente Alian√ßa. Isso afeta o c√°lculo do pre√ßo final.' 
        },
        { 
            id: 'passo3', 
            element: 'calcBtn', 
            title: '3/5: Calcular Totais', 
            content: 'Clique em "Calcular" para ver o total de materiais necess√°rios para a produ√ß√£o e o valor final estimado da venda.' 
        },
        { 
            id: 'passo4', 
            element: 'registerBtn', 
            title: '4/5: Registrar Venda', 
            content: 'Ap√≥s o c√°lculo, preencha os dados da venda (Cliente, Telefone, Obs) e clique aqui para registrar no banco de dados (Firebase).', 
            beforeAction: () => els.results.style.display = 'block' // Garante que os resultados estejam vis√≠veis para a etapa 4
        },
        { 
            id: 'passo5', 
            element: 'toggleHistoryBtn', 
            title: '5/5: Hist√≥rico', 
            content: 'Acesse o hist√≥rico de todas as vendas registradas. Voc√™ pode pesquisar, editar ou deletar vendas aqui.', 
            afterAction: () => els.results.style.display = 'none' // Limpa resultados ap√≥s a etapa 4
        }
    ];

    let currentStepIndex = -1;
    let currentTooltip = null;
    
    /** Remove qualquer destaque ou dica de tutorial */
    const clearTour = () => {
        if (currentTooltip) {
            currentTooltip.classList.remove('active');
            // D√° tempo para a transi√ß√£o (opacidade) antes de remover o elemento
            setTimeout(() => {
                if (currentTooltip && currentTooltip.parentNode) {
                    currentTooltip.parentNode.removeChild(currentTooltip);
                }
                currentTooltip = null;
            }, 300);
        }
        
        const highlights = document.querySelectorAll('.tour-highlight');
        highlights.forEach(el => el.classList.remove('tour-highlight'));
        
        currentStepIndex = -1;
    };
    
    /** Mostra o pr√≥ximo passo do tutorial */
    const showNextTourStep = () => {
        // Limpa o passo anterior
        if (currentStepIndex >= 0) {
            clearTour(); 
        }
        
        currentStepIndex++;
        
        if (currentStepIndex >= tourSteps.length) {
            showToast("Tutorial conclu√≠do!", "success", 3000);
            return;
        }
        
        const step = tourSteps[currentStepIndex];
        const targetElement = els[step.element];
        
        if (!targetElement) {
            console.error(`Elemento alvo n√£o encontrado para o passo ${step.id}`);
            showNextTourStep(); // Pula para o pr√≥ximo passo
            return;
        }

        // 1. Executa a a√ß√£o pr√©via, se houver
        if (step.beforeAction) {
            step.beforeAction();
        }

        // Garante que o usu√°rio est√° na tela certa (Calculadora)
        if (step.element !== 'toggleHistoryBtn' && els.historyCard.style.display !== 'none') {
            toggleView(false); 
        } else if (step.element === 'toggleHistoryBtn') {
            // Se for o passo do hist√≥rico, precisa estar na calculadora para o bot√£o ser vis√≠vel
            toggleView(false); 
        }
        
        // 2. Adiciona destaque
        targetElement.classList.add('tour-highlight');
        
        // 3. Cria a dica (tooltip)
        currentTooltip = document.createElement('div');
        currentTooltip.className = 'tour-tooltip';
        currentTooltip.innerHTML = `
            <h4>${step.title}</h4>
            <p>${step.content}</p>
            <div style="display: flex; justify-content: space-between;">
                <button id="tourNextBtn" class="primary">${currentStepIndex === tourSteps.length - 1 ? 'Finalizar' : 'Pr√≥ximo'}</button>
                <button id="tourSkipBtn" class="muted">Pular Tutorial</button>
            </div>
        `;
        document.body.appendChild(currentTooltip);
        
        // 4. Posiciona a dica
        const rect = targetElement.getBoundingClientRect();
        
        // Tenta posicionar acima ou abaixo (cuidado com bordas)
        let top = rect.top + window.scrollY - currentTooltip.offsetHeight - 10;
        let left = rect.left + window.scrollX;

        // Se n√£o houver espa√ßo acima, posiciona abaixo
        if (rect.top < currentTooltip.offsetHeight + 20) {
            top = rect.bottom + window.scrollY + 10;
        }
        
        // Garante que n√£o saia da tela horizontalmente
        if (left + currentTooltip.offsetWidth > window.innerWidth - 20) {
            left = window.innerWidth - currentTooltip.offsetWidth - 20;
        }
        if (left < 10) {
            left = 10;
        }

        currentTooltip.style.top = `${top}px`;
        currentTooltip.style.left = `${left}px`;

        // 5. Ativa a transi√ß√£o
        setTimeout(() => {
            currentTooltip.classList.add('active');
        }, 10);
        
        // 6. Configura bot√µes da dica
        document.getElementById('tourNextBtn').onclick = () => {
            if (step.afterAction) {
                step.afterAction();
            }
            showNextTourStep();
        };
        document.getElementById('tourSkipBtn').onclick = clearTour;

        // 7. Scrolla para o elemento
        targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
    };

    // ------------------------------------
    // 8. L√ìGICA DE AUTENTICA√á√ÉO E EVENTOS
    // ------------------------------------

    /** Lida com o registro de novos usu√°rios */
    const handleRegister = () => {
        const email = els.username.value.trim() + "@ha.com"; // Email dummy
        const password = els.password.value;
        const displayName = els.username.value.trim();

        if (password.length < 6) {
            els.authMessage.textContent = "A senha deve ter pelo menos 6 caracteres.";
            els.password.classList.add('input-invalido');
            return;
        }

        els.authMessage.textContent = "Cadastrando...";
        els.password.classList.remove('input-invalido');

        createUserWithEmailAndPassword(auth, email, password)
            .then((userCredential) => {
                const user = userCredential.user;
                // Define o nome de exibi√ß√£o do usu√°rio
                updateProfile(user, { displayName: displayName })
                    .then(() => {
                        // Sucesso. O onAuthStateChanged far√° o resto.
                        els.authMessage.textContent = `Usu√°rio ${displayName} registrado com sucesso. Logando...`;
                    })
                    .catch((error) => {
                        els.authMessage.textContent = `Erro ao definir nome: ${error.message}`;
                    });
            })
            .catch((error) => {
                let msg = error.code === 'auth/email-already-in-use' 
                    ? "Nome de usu√°rio j√° existe. Tente outro." 
                    : `Erro no cadastro: ${error.message}`;
                els.authMessage.textContent = msg;
            });
    };

    /** Lida com o login de usu√°rios existentes */
    const handleLogin = () => {
        const email = els.username.value.trim() + "@ha.com"; // Email dummy
        const password = els.password.value;

        els.authMessage.textContent = "Entrando...";

        signInWithEmailAndPassword(auth, email, password)
            .then(() => {
                // Sucesso. O onAuthStateChanged far√° o resto.
                els.authMessage.textContent = "Login bem-sucedido!";
            })
            .catch((error) => {
                let msg = error.code === 'auth/invalid-credential' 
                    ? "Nome de usu√°rio ou senha incorretos." 
                    : `Erro no login: ${error.message}`;
                els.authMessage.textContent = msg;
            });
    };
    
    /** Lida com o logout */
    const handleLogout = () => {
        auth.signOut().then(() => {
            showToast("Desconectado com sucesso.", "success", 2000);
            // onAuthStateChanged ir√° gerenciar a transi√ß√£o para a tela de login
        }).catch((error) => {
            console.error("Erro ao fazer logout:", error);
            showToast(`Erro ao fazer logout: ${error.message}`, "error", 3000);
        });
    };

    /** Escuta as mudan√ßas no estado de autentica√ß√£o (login/logout) */
    onAuthStateChanged(auth, (user) => {
        if (user) {
            // Usu√°rio logado
            currentUser = user;
            
            // Verifica se o displayName est√° definido
            if (!user.displayName) {
                // Se n√£o estiver, usa a parte do email antes do @ para o displayName
                const defaultName = user.email.split('@')[0];
                updateProfile(user, { displayName: defaultName })
                    .then(() => {
                        currentUser = {...user, displayName: defaultName}; // Atualiza a vari√°vel
                        els.authScreen.style.display = 'none';
                        els.mainCard.style.display = 'block';
                    });
            } else {
                els.authScreen.style.display = 'none';
                els.mainCard.style.display = 'block';
            }
            
            // Inicia o listener de vendas (somente quando logado)
            onValue(ref(db, 'vendas'), (snapshot) => {
                vendas = [];
                snapshot.forEach((childSnapshot) => {
                    vendas.push({ id: childSnapshot.key, ...childSnapshot.val() });
                });
                // Garante que o hist√≥rico seja atualizado se a lista estiver aberta
                if (els.historyCard.style.display !== 'none') {
                    displaySalesHistory(vendas);
                }
            }, {
                onlyOnce: false // Continua escutando
            });

        } else {
            // Usu√°rio deslogado
            currentUser = null;
            els.authScreen.style.display = 'block';
            els.mainCard.style.display = 'none';
            els.historyCard.style.display = 'none';
            els.username.value = '';
            els.password.value = '';
            els.authMessage.textContent = "";
            els.loginBtn.textContent = 'Entrar';
        }
    });

    // ------------------------------------
    // 9. LISTENERS DE EVENTOS
    // ------------------------------------
    
    els.calcBtn.onclick = calculate;
    els.resetBtn.onclick = clearAllFields;
    els.registerBtn.onclick = registerVenda;
    els.toggleHistoryBtn.onclick = () => toggleView(true);
    els.toggleCalcBtn.onclick = () => toggleView(false);
    els.clearHistoryBtn.onclick = clearHistory;
    els.csvBtn.onclick = exportToCsv;
    els.themeBtn.onclick = toggleTheme;
    els.tutorialBtn.onclick = () => {
        if (els.mainCard.style.display === 'none') {
            showToast("Fa√ßa login para iniciar o tutorial.", "default", 3000);
            return;
        }
        showNextTourStep();
    };
    els.discordBtnCalc.onclick = () => {
        if (!els.nomeCliente.value.trim() && !els.organizacao.value.trim()) {
            showToast("Preencha ao menos o Cliente ou Organiza√ß√£o antes de copiar.", "error", 3000);
            // N√£o retorna, permite copiar mesmo assim, mas alerta
        }
        const message = buildDiscordMessage();
        copyToClipboard(message);
    };
    
    // Listener do filtro
    els.filtroHistorico.addEventListener('input', filterHistory);
    
    // Autentica√ß√£o
    els.loginBtn.onclick = handleLogin;
    els.logoutBtn.onclick = handleLogout;
    
    els.registerUserBtn.onclick = () => {
        if (els.registerUserBtn.textContent.includes('Cadastrar')) {
            els.registerUserBtn.textContent = 'Voltar';
            els.loginBtn.textContent = 'Finalizar Cadastro';
            els.authMessage.textContent = "Criando uma nova conta...";
            els.username.value = '';
            els.password.value = '';
        } else {
            els.registerUserBtn.textContent = 'Cadastrar';
            els.loginBtn.textContent = 'Entrar';
            els.authMessage.textContent = "";
            els.username.value = '';
            els.password.value = '';
        }
    };
    
    // Adiciona o listener para o bot√£o de login (que muda de texto)
    els.loginBtn.addEventListener('click', () => {
        if (els.loginBtn.textContent.includes('Entrar')) {
            handleLogin();
        } else {
            handleRegister();
        }
    });

    // L√≥gica para a tela de boas-vindas
    els.enterBtn.onclick = () => {
        // Marca que o usu√°rio visitou e esconde a tela
        localStorage.setItem('hasVisited', 'true');
        els.welcomeScreen.classList.add('hidden');
        
        // Dispara o estado de autentica√ß√£o ap√≥s a transi√ß√£o
        setTimeout(() => {
            els.welcomeScreen.style.display = 'none';
        }, 500); // 500ms √© o tempo da transi√ß√£o CSS

        // For√ßa a atualiza√ß√£o do estado para mostrar login/mainCard
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Se j√° estiver logado, garante que a tela principal apare√ßa
                els.authScreen.style.display = 'none';
                els.mainCard.style.display = 'block';
            } else {
                 // Se n√£o logado, apenas mostra a tela de login
                els.authScreen.style.display = 'block';
                els.mainCard.style.display = 'none';
                els.historyCard.style.display = 'none';
            }

            clearTour(); 
        });
    };
    
    // Permite login/cadastro por Enter nos campos de senha
    els.password.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            if (els.loginBtn.textContent.includes('Entrar')) {
                handleLogin();
            } else {
                handleRegister();
            }
        }
    });
    
    // --- Chamadas Iniciais e L√≥gica de Estado do Firebase ---
    
    // A l√≥gica de estado inicial √© toda controlada pelo onAuthStateChanged acima.
    
    // L√≥gica para esconder a tela de boas-vindas na primeira visita
    if (localStorage.getItem('hasVisited')) {
        els.welcomeScreen.classList.add('hidden');
        els.welcomeScreen.style.display = 'none';
    } else {
        els.welcomeScreen.classList.remove('hidden');
        els.welcomeScreen.classList.add('show');
        els.authScreen.style.display = 'none'; // Garante que a tela de login n√£o apare√ßa por cima
        els.mainCard.style.display = 'none';
    }
  </script>
</body>
</html>
