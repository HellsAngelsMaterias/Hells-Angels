<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <link rel="icon" type="image/png" href="logo-dark.png">
  
  <title>Hells Angels - Calculadora e Login</title>
  
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  
  <style>
    /* ---------------------- VARI√ÅVEIS DE COR (MANTIDAS DO index_new.html) ---------------------- */
    :root {
      --cor-fundo: #fff0f6;
      --cor-texto: #4a0033;
      --cor-principal: #e60073;
      --cor-card: #ffffff;
      --cor-borda: #ffb3d9;
      --cor-btn-primario: #e60073;
      --cor-btn-texto: #fff;
      --cor-btn-secundario: #ffd6eb;
      --cor-btn-secundario-texto: #4a0033;
      --cor-erro: #cc0000;
      /* NOVO: Cor para o brilho pulsante */
      --cor-glow-pulsante: rgba(230, 0, 115, 0.8); /* Cor Principal com opacidade */
    }

    body.dark {
      --cor-fundo: #1a000d; 
      --cor-texto: #ffccf0; 
      --cor-principal: #ff0080; 
      --cor-card: #2c001a; 
      --cor-borda: #e60073; 
      --cor-btn-primario: #ff0080; 
      --cor-btn-texto: #fff;
      --cor-btn-secundario: #4d002a; 
      --cor-btn-secundario-texto: #ffccf0; 
      /* NOVO: Cor para o brilho pulsante no modo escuro */
      --cor-glow-pulsante: rgba(255, 0, 128, 0.6); /* Cor Principal Escura com opacidade */
    }
    
    body.dark input[type=number], body.dark input[type=text], body.dark select {
      background: #33001f;
      color: var(--cor-texto);
      border: 1px solid var(--cor-borda);
    }
    
    /* ---------------------- ESTILOS LOGIN (ADICIONADOS DO ARQUIVO DE LOGIN) ---------------------- */
    .login-container {
      width: 100%;
      max-width: 400px;
      background: var(--cor-card);
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      border: 1px solid var(--cor-borda);
      text-align: center;
    }

    /* A logo no login tem um tamanho maior */
    .login-container .app-logo {
      max-height: 100px; 
      margin-bottom: 25px;
    }

    .login-container h1 {
      margin: 0 0 25px;
      font-size: 28px;
      font-weight: 700;
      color: var(--cor-principal);
    }
    
    .login-container label {
      margin: 15px 0 6px;
      font-weight: 600;
      color: var(--cor-principal);
      text-align: left;
    }

    .login-container input[type=text], .login-container input[type=password] {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid var(--cor-borda);
      background: #fff;
      color: var(--cor-texto);
      font-size: 16px;
      box-sizing: border-box;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    
    body.dark .login-container input[type=text], body.dark .login-container input[type=password] {
      background: #33001f;
      color: var(--cor-texto);
      border: 1px solid var(--cor-borda);
    }
    
    .login-container input:focus {
        border-color: var(--cor-principal) !important; 
        box-shadow: 0 0 5px rgba(230, 0, 115, 0.4); 
        outline: none;
    }

    .login-container button {
      width: 100%;
      padding: 12px 20px;
      margin-top: 25px;
      border-radius: 8px;
      font-size: 16px;
    }
    
    /* Ajustado para ser reutilizado como errorMessage e regErrorMessage */
    #errorMessage, #regErrorMessage {
      color: var(--cor-erro);
      margin-top: 15px;
      font-weight: 600;
      min-height: 18px;
    }
    /* ---------------------- FIM ESTILOS LOGIN ---------------------- */

    
    /* --- ESTILO PARA INPUT DATALIST (Foco Rosa/Roxo) --- (MANTIDO DO index_new.html) */
    input[list]:focus, input[list]:hover {
        border-color: var(--cor-principal) !important; 
        box-shadow: 0 0 5px rgba(230, 0, 115, 0.4); 
    }
    
    /* --- NOVO ESTILO PARA DATALIST (Sugest√µes de Organiza√ß√£o) --- */
    input[list] {
        position: relative;
        z-index: 1; 
    }
    
    input[list]::-webkit-calendar-picker-indicator {
        display: none;
    }
    /* --- FIM NOVO ESTILO PARA DATALIST --- */
    
    /* --- NOVO: Estilo para a dica de sugest√£o da Organiza√ß√£o --- */
    .suggestion-tip {
        font-size: 11px;
        color: var(--cor-principal); /* Usa a cor principal para destaque */
        margin-top: 4px;
        margin-bottom: 0;
        font-weight: 500;
        opacity: 0.8;
    }
    /* --- FIM NOVO: Estilo para a dica de sugest√£o da Organiza√ß√£o --- */
    
    /* --- ESTILOS TOUR --- */
    .tour-tooltip {
      position: absolute;
      background: var(--cor-principal);
      color: var(--cor-btn-texto);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      max-width: 300px;
      text-align: left;
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 10002;
    }

    .tour-tooltip.active {
      opacity: 1;
      transform: translateY(0);
    }

    .tour-tooltip h4 {
        margin: 0 0 5px;
        font-size: 16px;
        color: var(--cor-btn-texto);
    }
    .tour-tooltip p {
        margin: 0;
        font-size: 14px;
        margin-bottom: 10px;
    }
    
    .tour-tooltip button {
        background: var(--cor-btn-secundario);
        color: var(--cor-btn-secundario-texto);
        padding: 6px 10px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        margin-right: 8px;
    }
    
    .tour-highlight {
      box-shadow: 0 0 0 3px rgba(230,0,115,0.6), 0 0 10px rgba(230,0,115,0.5);
      position: relative;
      z-index: 10001;
    }
    /* --- FIM ESTILOS TOUR --- */
    
    /* --- ESTILO PARA CAMPO INV√ÅLIDO --- */
    input.input-invalido, select.input-invalido {
        border: 2px solid var(--cor-erro) !important;
        box-shadow: 0 0 4px var(--cor-erro);
    }
    /* --- FIM ESTILO PARA CAMPO INV√ÅLIDO --- */

    
    /* Container para a logo (do index_new.html) */
    #logoLink {
        position: fixed;
        top: 16px; 
        left: 16px; 
        width: auto; 
        max-height: 80px; 
        cursor: pointer;
        z-index: 9998; 
    }
    
    /* Ajuste na logo superior */
    .app-logo {
      max-height: 80px; 
      width: auto;
      transition: opacity 0.3s ease, filter 0.3s ease;
      display: block; 
    }
    
    /* NOVO: Efeito de ilumina√ß√£o ao passar o mouse na Logo (na calculadora) */
    #appLogo:hover {
        /* Brilho da logo ao passar o mouse */
        filter: drop-shadow(0 0 8px var(--cor-principal)) drop-shadow(0 0 15px var(--cor-glow-pulsante));
        opacity: 0.9;
    }

    
    /* Estilos Gerais do Corpo do index_new.html (aplicados somente ap√≥s o login) */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 960px;
      margin: 24px auto;
      padding: 20px;
      background: var(--cor-fundo);
      color: var(--cor-texto);
      transition: background 0.25s ease, color 0.25s ease;
    }
    
    /* Garante que o conte√∫do principal comece escondido e s√≥ apare√ßa se JS/Welcome Screen n√£o funcionar */
    #mainCard {
        display: none; /* Alterado para come√ßar escondido */
    }

    h1 {
      margin: 0 0 12px;
      font-size: 24px;
      font-weight: 700;
      color: var(--cor-principal);
      text-align: center;
    }

    h2 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--cor-principal);
    }
    
    h3 {
        color: var(--cor-principal); 
        font-weight:600; 
        margin-top: 16px;
    }

    .card {
      background: var(--cor-card);
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border: 1px solid var(--cor-borda);
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin: 10px 0 6px;
      font-weight: 600;
      color: var(--cor-principal);
    }

    input[type=number], input[type=text], select {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid var(--cor-borda);
      background: #fff;
      color: var(--cor-texto);
      font-size: 14px;
      box-sizing: border-box;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    
    input[type=number] {
        width: 140px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
      margin-top: 12px;
    }
    
    .grid-venda {
        grid-template-columns: 1fr 1fr;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 14px;
    }

    th, td {
      padding: 6px; 
      border-bottom: 1px solid var(--cor-borda);
      text-align: left;
    }

    th {
      background: var(--cor-btn-secundario);
      color: var(--cor-btn-secundario-texto);
      font-weight: 600;
    }
    
    
/* --- NOVO ESTILO PARA RESPONSIVIDADE DA TABELA --- */
.history-table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    width: 100%;
    margin-top: 8px;
}

/* Garante que o container interno n√£o atrapalhe a rolagem */
#historyBackground {
    overflow: hidden;
}

/* Mant√©m a tabela com comportamento de tabela e largura controlada */
#historyCard table {
    width: 100%;
    display: table;
    border-collapse: collapse;
    table-layout: fixed; /* ajuda a manter colunas alinhadas */
    min-width: 900px; /* for√ßa scroll em telas pequenas mantendo alinhamento */
}

/* Estilo base para c√©lulas */
#historyCard th, #historyCard td {
    padding: 8px 10px;
    vertical-align: middle;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 13px;
}

/* Defini√ß√£o de larguras e alinhamentos por coluna - ajust√°veis conforme necessidade */
#historyCard th:nth-child(1), #historyCard td:nth-child(1) { width: 90px; text-align: center; } /* Data/Hora */
#historyCard th:nth-child(2), #historyCard td:nth-child(2) { width: 160px; text-align: left; }   /* Cliente */
#historyCard th:nth-child(3), #historyCard td:nth-child(3) { width: 160px; text-align: center; } /* Organiza√ß√£o/Tipo */
#historyCard th:nth-child(4), #historyCard td:nth-child(4) { width: 110px; text-align: center; } /* Telefone */
#historyCard th:nth-child(5), #historyCard td:nth-child(5) { width: 280px; text-align: left; }   /* Produtos */
#historyCard th:nth-child(6), #historyCard td:nth-child(6) { width: 140px; text-align: center; } /* Valor */
#historyCard th:nth-child(7), #historyCard td:nth-child(7) { width: 140px; text-align: center; } /* Negociadoras */
#historyCard th:nth-child(8), #historyCard td:nth-child(8) { width: 150px; text-align: center; } /* A√ß√µes */

/* Ajuste para a linha de data/hora (duas linhas dentro da mesma c√©lula) */
.history-datetime-line {
    display: block;
    line-height: 1.1;
    font-size: 12px;
}

/* Faz com que valores longos quebrem visualmente melhor em c√©lulas menores quando necess√°rio */
@media (max-width: 700px) {
    #historyCard th, #historyCard td {
        font-size: 12px;
    }
    #historyCard th:nth-child(5), #historyCard td:nth-child(5) { width: 320px; }
}
/* --- FIM NOVO ESTILO PARA RESPONSIVIDADE DA TABELA --- */



    .actions {
      margin-top: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    button {
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: opacity 0.2s ease, box-shadow 0.3s ease; /* Adicionado box-shadow para transi√ß√£o do glow */
    }

    button:hover { opacity: 0.85; }
    
    /* NOVO: Efeito de brilho pulsante para o bot√£o principal (Calcular/Registrar) */
    .primary, .success {
        animation: pulse-glow 2s infinite ease-in-out;
    }
    
    /* NOVO: Keyframes para o brilho pulsante */
    @keyframes pulse-glow {
        0% {
            box-shadow: 0 0 0 rgba(0, 0, 0, 0); 
        }
        50% {
            box-shadow: 0 0 10px var(--cor-glow-pulsante), 0 0 20px var(--cor-glow-pulsante); 
        }
        100% {
            box-shadow: 0 0 0 rgba(0, 0, 0, 0); 
        }
    }

    .primary { background: var(--cor-btn-primario); color: var(--cor-btn-texto); }
    .muted { background: var(--cor-btn-secundario); color: var(--cor-btn-secundario-texto); }
    .success { background: #00b33c; color: #fff; }

    /* Container para agrupar e posicionar bot√µes (Modo Noturno e Tutorial) */
    .top-right-controls {
        position: fixed;
        top: 16px;
        right: 16px;
        display: flex;
        gap: 10px;
        z-index: 9999;
    }

    /* Estilo base para bot√µes de controle fixos */
    .control-btn {
        padding: 10px 14px;
        border-radius: 10px;
        background: var(--cor-btn-primario);
        color: var(--cor-btn-texto);
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        border: none;
        transition: opacity 0.2s ease;
    }
    .control-btn:hover {
        opacity: 0.85;
    }
    
    /* --- Estilo para o Fundo do Hist√≥rico --- */
    #historyBackground {
      /* ALTERA√á√ÉO: Fundo semi-transparente (70%) */
      background: rgba(255, 255, 255, 0.7); 
      position: relative; 
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border: 1px solid var(--cor-borda);
      margin-bottom: 20px;
      min-height: 400px; 
      overflow: hidden;
    }
    
    #historyBackground img {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      height: auto;
      opacity: 0.3; /* ALTERA√á√ÉO: Aumentado para maior visibilidade */ 
      z-index: 1; 
      object-fit: contain; 
    }
    
    #historyBackground > * {
      position: relative; 
      z-index: 2;
    }
    
    #historyCard table {
        font-size: 12px;
    }
    
    /* --- CORRE√á√ÉO DE ALINHAMENTO DAS C√âLULAS (Principal Altera√ß√£o) --- */
    
#historyCard th, #historyCard td {
    padding: 8px 6px;
    text-align: center;
    vertical-align: middle; /* Centraliza verticalmente */
    white-space: nowrap;    /* Evita quebras desnecess√°rias */
}

/* Corrige o bloco de data/hora */
#historyCard tr td:first-child {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    line-height: 1.2;
    padding: 4px 0;
}

.history-datetime-line {
    display: block;
    font-size: 12px;
}

/* Estilo para cada linha do texto dentro da c√©lula de Data/Hora */
.history-datetime-line {
    display: block;
    line-height: 1.2; 
    padding: 6px 0 0 6px; /* Adiciona o padding de volta (topo e esquerda) */
}

/* Reduz o espa√ßamento vertical para compactar o texto na c√©lula de Valor Total (que tem quebra de linha) */
    
.valor-total-cell {
    display: flex;
    flex-direction: column;
    align-items: center;      /* Centraliza horizontalmente */
    justify-content: center;  /* Centraliza verticalmente */
    padding: 4px 0;
    line-height: 1.3;
    text-align: center;
}

.valor-total-cell span {
    display: block;
}

.valor-obs-text {
    font-size: 11px;
    color: var(--cor-principal);
    margin-top: 2px; /* Pequeno espa√ßamento entre o valor e a observa√ß√£o */
}

    
    /* --- FIM CORRE√á√ÉO DE ALINHAMENTO --- */
    
    
    /* Estilo para colocar os bot√µes do hist√≥rico na mesma linha (Responsivo) */
    .history-actions-cell {
        display: flex;
        gap: 5px; /* Espa√ßamento entre os bot√µes */
        flex-wrap: nowrap; /* Garante que fiquem na mesma linha */
        padding-top: 4px; /* Ajuste para o padding das outras c√©lulas */
    }
    
    .history-actions-cell button {
        padding: 4px 8px;
        font-size: 11px;
        margin-top: 2px; /* Pequeno ajuste de margem */
        border-radius: 4px;
        white-space: nowrap; /* Impede a quebra de linha dos bot√µes */
    }

    /* --- Estilos para Notifica√ß√£o Toast --- */
    #toast-container {
        position: fixed;
        bottom: 20px; 
        right: 20px; 
        z-index: 10005; 
        display: flex;
        flex-direction: column-reverse; 
        gap: 10px; 
        align-items: flex-end; 
    }

    .toast {
        background-color: var(--cor-principal); 
        color: var(--cor-btn-texto);
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        opacity: 0;
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        transform: translateY(20px); 
        max-width: 300px;
        min-width: 150px;
        text-align: center;
    }

    .toast.show {
        opacity: 1;
        transform: translateY(0);
    }
    
    .toast.success {
        background-color: #00b33c; 
    }

    .toast.error {
        background-color: var(--cor-erro); 
    }
    
    .action-btn {
        padding: 4px 8px;
        font-size: 12px;
        margin-right: 0px; 
        border-radius: 4px;
    }
    
    /* Otimiza√ß√£o para telas muito pequenas */
    @media (max-width: 500px) {
        body {
            padding: 10px;
            margin: 10px auto;
        }
        .top-right-controls {
            top: 10px;
            right: 10px;
        }
        .control-btn {
            padding: 8px 10px;
            font-size: 12px;
        }
        .grid {
            grid-template-columns: 1fr;
        }
        .grid-venda {
            grid-template-columns: 1fr;
        }
    }
    /* --- FIM Estilos para Notifica√ß√£o Toast --- */
  
/* --- ESTILO FINAL DA TABELA DE HIST√ìRICO --- */
.history-table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    width: 100%;
    margin-top: 8px;
}

#historyCard table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    min-width: 900px;
    background: transparent; 
}

#historyCard th, #historyCard td {
    padding: 6px 8px;
    text-align: center;
    vertical-align: middle;
    white-space: nowrap;
    font-size: 14px; 
    border-bottom: 1px solid var(--cor-borda);
}

/* NOVO: Fundo para as c√©lulas de dados para garantir a legibilidade */
#historyCard td {
    background: var(--cor-card); 
    opacity: 0.95; /* Leve transpar√™ncia para manter o efeito do fundo */
}

body.dark #historyCard td {
    background: var(--cor-card); /* Cor do card escuro */
    opacity: 0.95;
}


/* Alinhamento individual por coluna - larguras ajustadas */
#historyCard th:nth-child(1), #historyCard td:nth-child(1) { width: 100px; }   /* Data/Hora - Aumentado */
#historyCard th:nth-child(2), #historyCard td:nth-child(2) { width: 140px; }  /* Cliente - Aumentado */
#historyCard th:nth-child(3), #historyCard td:nth-child(3) { width: 160px; }  /* Organiza√ß√£o */
#historyCard th:nth-child(4), #historyCard td:nth-child(4) { width: 110px; }  /* Telefone */
#historyCard th:nth-child(5), #historyCard td:nth-child(5) { width: 280px; }  /* Produtos - Aumentado */
#historyCard th:nth-child(6), #historyCard td:nth-child(6) { width: 150px; }  /* Valor - Aumentado */
#historyCard th:nth-child(7), #historyCard td:nth-child(7) { width: 130px; }  /* Negociadoras */
#historyCard th:nth-child(8), #historyCard td:nth-child(8) { width: 150px; }  /* A√ß√µes */

/* Data e hora */
.history-datetime-line {
    display: block;
    line-height: 1.2; 
    font-size: 13px; 
}

/* Valor Total - tornando o valor em negrito */
.valor-total-cell span:first-child {
    font-weight: 700; /* Negrito */
}

.valor-obs-text {
    font-size: 12px; /* Aumentado */
    color: var(--cor-principal);
}

/* Bot√µes de a√ß√µes */
.history-actions-cell {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
}

.history-actions-cell button {
    padding: 3px 6px;
    font-size: 11px;
    border-radius: 4px;
    white-space: nowrap;
}

/* Aumenta altura total da linha */
#historyCard tr {
    height: 40px;
}

/* NOVO: Estilo para o cabe√ßalho TH */
#historyCard th {
    background: var(--cor-principal); /* Usa a cor principal para o cabe√ßalho */
    color: var(--cor-btn-texto);     /* Texto branco */
}

/* NOVO: Fundo semi-transparente para modo escuro */
body.dark #historyBackground {
  /* Cor escura do card #2c001a (que √© 44, 0, 26 em RGB) com 70% de opacidade */
  background: rgba(44, 0, 26, 0.7); 
}
/* --- FIM DO ESTILO FINAL DA TABELA DE HIST√ìRICO --- */
</style>
</head>
<body class="light">
  
  <a href="#" id="logoLink" style="display: none;"> <img id="appLogo" src="logo-dark.png" alt="Hells Angels Logo" class="app-logo">
  </a>

  <div id="loginScreen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--cor-fundo); z-index: 10000; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; box-sizing: border-box;"> 
      <div class="login-container">
          <img src="logo-dark.png" alt="Hells Angels Logo" class="app-logo">
          <h1 id="authTitle">Acesso Restrito</h1>
          
          <form id="loginForm">
              <div>
                  <label for="loginUsername">Usu√°rio:</label>
                  <input id="loginUsername" type="text" placeholder="Digite seu nome de usu√°rio" required>
              </div>
              <div>
                  <label for="loginPassword">Senha:</label>
                  <input id="loginPassword" type="password" placeholder="Digite sua senha" required>
              </div>
              <div id="errorMessage"></div>
              <button type="submit" id="loginBtn" class="primary">Entrar</button>
              
              <p style="margin-top: 15px; font-size: 14px;">N√£o tem uma conta? <a href="#" id="toggleToReg" style="color: var(--cor-principal); font-weight: 600;">Crie uma agora</a></p>
          </form>
          
          <form id="registrationForm" style="display: none;">
              <div>
                  <label for="regUsername">Usu√°rio para Registro:</label>
                  <input id="regUsername" type="text" placeholder="Crie seu nome de usu√°rio" required>
              </div>
              <div>
                  <label for="regPassword">Senha (m√≠nimo 6 caracteres):</label>
                  <input id="regPassword" type="password" placeholder="Crie sua senha" required>
              </div>
              <div>
                  <label for="regConfirmPassword">Confirme a Senha:</label>
                  <input id="regConfirmPassword" type="password" placeholder="Repita a senha" required>
              </div>
              <div id="regErrorMessage"></div>
              <button type="submit" id="regBtn" class="success">Criar Conta</button>
              
              <p style="margin-top: 15px; font-size: 14px;">J√° tem uma conta? <a href="#" id="toggleToLogin" style="color: var(--cor-principal); font-weight: 600;">Fa√ßa Login</a></p>
          </form>
      </div>
  </div>
  <div class="top-right-controls">
      <button class="control-btn" id="logoutBtn" style="display:none;">üîí Sair</button>
      
      <button class="control-btn" id="tutorialBtn" style="display: none;">üí° Tutorial</button> 
      <button class="control-btn" id="themeBtn">üåô Modo Noturno</button>
  </div>
  
  <div class="card" id="mainCard" style="display:none">
    <h1>Calculadora e Registro de Vendas Hells Angels</h1>
    
    <div class="card-venda">
        <h2>Dados da Venda</h2>
        <div class="grid grid-venda">
            <div>
                <label for="nomeCliente">Nome:</label>
                <input id="nomeCliente" type="text" value="">
            </div>
            <div>
                <label for="dataVenda">Data:</label>
                <input id="dataVenda" type="text" readonly> 
            </div>
            
            <div>
                <label for="organizacao">Organiza√ß√£o:</label>
                <input id="organizacao" type="text" value="" list="sugestoesOrganizacao">
                
                <p class="suggestion-tip">Digite para ver sugest√µes de organiza√ß√µes.</p>
                
                <datalist id="sugestoesOrganizacao">
                    <option value="Serpents"></option>
                    <option value="Nox"></option>
                    <option value="NKT"></option>
                    <option value="Ruptura"></option>
                    <option value="Midnight"></option>
                    <option value="Meraki"></option>
                    <option value="Lotus"></option>
                    <option value="Hydra"></option>
                    <option value="Hooligans"></option>
                    <option value="Families"></option>
                    <option value="Cartel"></option>
                    <option value="Blood Street"></option>
                    <option value="Blood Reapers"></option>
                    <option value="Blue Diamond"></option>
                    <option value="Black Heart"></option>
                    <option value="Ballas"></option>
                    <option value="Aura"></option>
                    <option value="Anarquia"></option>
                    <option value="8 Anjo"></option>
                    <option value="Vagos"></option>
                    <option value="Vertice"></option>
                    <option value="Void"></option>
                    <option value="Solo"></option>
                </datalist>
            </div>
            <div>
                <label for="organizacaoTipo">Op√ß√£o (CNPJ/CPF):</label>
                <select id="organizacaoTipo">
                    <option value="CNPJ">CNPJ</option>
                    <option value="CPF">CPF</option>
                    <option value="OUTROS">Outros</option>
                </select>
            </div>
            
            <div>
                <label for="telefone">Telefone:</label>
                <input id="telefone" type="text" value="" maxlength="13"> 
            </div>
            
            <div>
                <label for="negociadoras">Negociadoras:</label>
                <input id="negociadoras" type="text" value="">
            </div>
            <div style="grid-column: 1 / -1;">
                <label for="vendaValorObs">Valor - Observa√ß√£o (Como foi o pagamento):</label>
                <input id="vendaValorObs" type="text" value="">
            </div>
        </div>
    </div>
    
    <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--cor-borda);">

    <h2>C√°lculo de Produtos</h2>
    <p class="small">Informe quantos produtos deseja fabricar/vender e escolha o tipo de valor.</p>

    <div class="grid">
      <div>
        <label for="qtyTickets">Quantidade de Tickets</label>
        <input id="qtyTickets" type="number" min="0" value="">
      </div>
      <div>
        <label for="qtyTablets">Quantidade de Tablets</label>
        <input id="qtyTablets" type="number" min="0" value="">
      </div>
      <div>
        <label for="qtyNitro">Quantidade de Nitro</label>
        <input id="qtyNitro" type="number" min="0" value="">
      </div>
      <div>
        <label for="tipoValor">Tipo de Valor</label>
        <select id="tipoValor">
          <option value="limpo">Dinheiro Limpo</option>
          <option value="sujo">Dinheiro Sujo</option>
          <option value="limpo_alianca">Limpo (Alian√ßa)</option>
          <option value="sujo_alianca">Sujo (Alian√ßa)</option>
        </select>
      </div>
    </div>

    <div class="actions">
      <button id="calcBtn" class="primary">Calcular</button>
      <button id="resetBtn" class="muted">Limpar Campos</button>
      <button id="registerBtn" class="success">Registrar Venda</button>
      <button id="toggleHistoryBtn" class="muted">Ver Hist√≥rico</button>
      <button id="csvBtn" class="muted">Exportar CSV</button>
      <button id="discordBtnCalc" class="muted">Discord</button> 
    </div>

    <div id="resultsContainer">
      <div id="results" style="margin-top:16px;display:none">
        <h3>Totais necess√°rios</h3>
        <table>
          <thead><tr><th>Material</th><th>Quantidade total</th></tr></thead>
          <tbody id="resultsBody"></tbody>
        </table>

        <h3>Valores Estimados</h3>
        <table>
          <thead><tr><th>Produto</th><th>Valor Total</th></tr></thead>
          <tbody id="valuesBody"></tbody>
          <tfoot>
            <tr><th>Total Geral</th><th id="valorTotalGeral">R$ 0</th></tr>
          </tfoot>
        </table>
        <p class="result-note" style="font-size: 12px; margin-top: 8px;">Os valores variam conforme o tipo selecionado (limpo, sujo, alian√ßa).</p>
      </div>
    </div>
  </div>

  <div class="card" id="historyCard" style="display:none">
      <div id="historyBackground" class="card">
        <h2>Hist√≥rico de Vendas Registradas</h2>
        <img id="historyImg" src="logo-dark.png" alt="Fundo Hist√≥rico"> 
        
        <input type="text" id="filtroHistorico" placeholder="üîç Pesquisar no hist√≥rico (Nome, Data, Item, etc.)" style="margin-bottom: 10px; width: 100%;">
        
        <div class="actions">
          <button id="clearHistoryBtn" class="muted">Limpar Hist√≥rico</button>
          <button id="toggleCalcBtn" class="muted">Voltar √† Calculadora</button>
        </div>
        <div class="history-table-wrapper"><table id="historicoVendas">
          <thead>
            <tr>
              <th>Data/Hora</th>
              <th>Cliente</th>
              <th>Organiza√ß√£o/Tipo</th>
              <th>Telefone</th>
              <th>Produtos (Unidade)</th>
              <th>Valor Total</th>
              <th>Negociadoras</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="salesHistory"></tbody>
        </table></div>
      </div>
  </div>
  <div id="toast-container"></div>
  <script>
    // --- FIREBASE CONFIGURA√á√ÉO (ADICIONADO E REQUER ATUALIZA√á√ÉO) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAhDVBfXoO_Rdi3e-trdbaaPppwDkTDgVc",
      authDomain: "hells-angels-438c2.firebaseapp.com",
      databaseURL: "https://hells-angels-438c2-default-rtdb.firebaseio.com",
      projectId: "hells-angels-438c2",
      storageBucket: "hells-angels-438c2.firebasestorage.app",
      messagingSenderId: "429406215315",
      appId: "1:429406215315:web:96b68b172247824b308166",
      measurementId: "G-CR415MEY32"
    };
    // Inicializar o Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    // --- FIM FIREBASE CONFIGURA√á√ÉO ---

    // DOM√çNIO FICT√çCIO PARA MAPEAMENTO DE USU√ÅRIO
    const VIRTUAL_DOMAIN = '@ha-auth.local';

    const perUnit = {
      tickets: { moneyBruto: 525 },
      tablets: { cobre: 20, plastico: 40, fita_adesiva: 2, lixo_eletronico: 2 },
      nitro: { aluminio: 20, cobre: 20, vidro: 45, fita_adesiva: 1, porca: 1, parafuso: 1 }
    };

    const valores = {
      tablets: { limpo: 17000, sujo: 20000, limpo_alianca: 15000, sujo_alianca: 18000 },
      tickets: { limpo: 9800, sujo: 11700, limpo_alianca: 8000, sujo: 10000 },
      nitro: { limpo: 42500, sujo: 50000, limpo_alianca: 38000, sujo_alianca: 45000 }
    };

    const valorDescricao = {
      'limpo': 'Dinheiro Limpo',
      'sujo': 'Dinheiro Sujo',
      'limpo_alianca': 'Limpo (Alian√ßa)',
      'sujo_alianca': 'Sujo (Alian√ßa)'
    };

    // Usando 'logo-dark.png' como placeholder para todas as imagens
    const logoLightModeSrc = "logo-dark.png";
    const logoDarkModeSrc = "logo-dark.png";
    const historyBackgroundSrc = "logo-dark.png";
    
    /**
     * Formata o n√∫mero de telefone para o padr√£o (055) XXX-XXX.
     * Espera que o usu√°rio digite apenas os 6 d√≠gitos finais.
     */
    function formatPhone(value) {
        // 1. Limpa o valor, mantendo apenas d√≠gitos.
        let cleaned = ('' + value).replace(/\D/g, '');

        // 2. Limita o n√∫mero de d√≠gitos que o usu√°rio pode inserir (apenas os 6 vari√°veis).
        if (cleaned.length > 6) {
            cleaned = cleaned.substring(0, 6);
        }

        // 3. Aplica o h√≠fen (XXX-XXX)
        if (cleaned.length > 3) {
            cleaned = cleaned.substring(0, 3) + '-' + cleaned.substring(3, 6);
        }

        // 4. Adiciona o prefixo fixo (055) e retorna.
        if (cleaned.length > 0) {
            return '(055) ' + cleaned;
        }

        return ''; // Retorna vazio se n√£o houver d√≠gitos
    }
    
    function showToast(message, type = 'default', duration = 3000) {
      const container = document.getElementById('toast-container');
      if (!container) return;

      const toast = document.createElement('div');
      toast.classList.add('toast');
      if (type) {
        toast.classList.add(type);
      }
      toast.textContent = message;

      container.appendChild(toast);

      void toast.offsetWidth; // For√ßa reflow para aplicar a transi√ß√£o
      toast.classList.add('show');

      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          toast.remove();
        }, 300); // Tempo da transi√ß√£o
      }, duration);
    }

    let vendas = [];
    let vendaEmEdicaoId = null;

    function loadVendas() {
      const json = localStorage.getItem('ha_vendas');
      if (json) {
        vendas = JSON.parse(json);
      }
    }

    function saveVendas() {
      localStorage.setItem('ha_vendas', JSON.stringify(vendas));
    }

    const els = {
      // Campos do Login (ATUALIZADOS)
      loginScreen: document.getElementById('loginScreen'),
      loginForm: document.getElementById('loginForm'),
      loginUsername: document.getElementById('loginUsername'), // ATUALIZADO
      loginPassword: document.getElementById('loginPassword'),
      loginBtn: document.getElementById('loginBtn'),
      errorMessage: document.getElementById('errorMessage'),
      logoutBtn: document.getElementById('logoutBtn'),

      // NOVOS CAMPOS DE REGISTRO (ATUALIZADOS)
      registrationForm: document.getElementById('registrationForm'),
      regUsername: document.getElementById('regUsername'), // ATUALIZADO
      regPassword: document.getElementById('regPassword'),
      regConfirmPassword: document.getElementById('regConfirmPassword'),
      regBtn: document.getElementById('regBtn'),
      regErrorMessage: document.getElementById('regErrorMessage'),
      toggleToReg: document.getElementById('toggleToReg'),
      toggleToLogin: document.getElementById('toggleToLogin'),
      authTitle: document.getElementById('authTitle'),

      // Campos do C√°lculo
      qtyTickets: document.getElementById('qtyTickets'),
      qtyTablets: document.getElementById('qtyTablets'),
      qtyNitro: document.getElementById('qtyNitro'),
      tipoValor: document.getElementById('tipoValor'),

      // Campos do Cliente/Venda
      nomeCliente: document.getElementById('nomeCliente'),
      dataVenda: document.getElementById('dataVenda'),
      organizacaoTipo: document.getElementById('organizacaoTipo'),
      organizacao: document.getElementById('organizacao'),
      telefone: document.getElementById('telefone'),
      negociadoras: document.getElementById('negociadoras'),
      vendaValorObs: document.getElementById('vendaValorObs'),

      // Bot√µes
      calcBtn: document.getElementById('calcBtn'),
      resetBtn: document.getElementById('resetBtn'),
      csvBtn: document.getElementById('csvBtn'),
      registerBtn: document.getElementById('registerBtn'),
      discordBtnCalc: document.getElementById('discordBtnCalc'),

      // Resultados e Hist√≥rico
      results: document.getElementById('results'),
      resultsBody: document.getElementById('resultsBody'),
      valuesBody: document.getElementById('valuesBody'),
      valorTotalGeral: document.getElementById('valorTotalGeral'),
      salesHistory: document.getElementById('salesHistory'),
      clearHistoryBtn: document.getElementById('clearHistoryBtn'),
      filtroHistorico: document.getElementById('filtroHistorico'),

      // Bot√µes de controle fixos
      themeBtn: document.getElementById('themeBtn'),
      tutorialBtn: document.getElementById('tutorialBtn'),
      mainCard: document.getElementById('mainCard'),
      historyCard: document.getElementById('historyCard'),
      toggleHistoryBtn: document.getElementById('toggleHistoryBtn'),
      toggleCalcBtn: document.getElementById('toggleCalcBtn'),

      // Elemento da Logo
      appLogo: document.getElementById('appLogo'),
      logoLink: document.getElementById('logoLink'),
    };


    // --- FUN√á√ïES DE VISUALIZA√á√ÉO E AUTHENTICA√á√ÉO (NOVAS/ADAPTADAS) ---

    function showLoginScreen() {
      // Altera o estilo do body para centralizar o login
      document.body.style.maxWidth = 'none';
      document.body.style.margin = '0';
      document.body.style.height = '100vh';
      document.body.style.display = 'flex';
      document.body.style.justifyContent = 'center';
      document.body.style.alignItems = 'center';

      els.loginScreen.style.display = 'flex';
      els.mainCard.style.display = 'none';
      els.historyCard.style.display = 'none';
      els.logoLink.style.display = 'none'; // Esconde a logo do app
      els.tutorialBtn.style.display = 'none'; // Esconde o tutorial
      els.logoutBtn.style.display = 'none'; // Esconde o bot√£o de sair

      clearTour(); // Para o tour caso esteja ativo
      toggleAuthView(false); // Garante que a tela de Login √© a primeira a aparecer
    }

    function showMainApp() {
      // Restaura o estilo do body para o layout do app
      document.body.style.maxWidth = '960px';
      document.body.style.margin = '24px auto';
      document.body.style.height = 'auto';
      document.body.style.display = 'block';
      document.body.style.justifyContent = 'initial';
      document.body.style.alignItems = 'initial';

      els.loginScreen.style.display = 'none';
      els.mainCard.style.display = 'block';
      els.historyCard.style.display = 'none';
      els.logoLink.style.display = 'block'; // Mostra a logo
      els.tutorialBtn.style.display = 'block'; // Mostra o tutorial
      els.logoutBtn.style.display = 'block'; // Mostra o bot√£o de sair
      
      renderHistorico(); // Garante que o hist√≥rico est√° carregado
    }

    // Fun√ß√£o para alternar entre Login e Registro
    function toggleAuthView(showRegistration) {
      if (showRegistration) {
        els.loginForm.style.display = 'none';
        els.registrationForm.style.display = 'block';
        els.authTitle.textContent = 'Cria√ß√£o de Conta';
        els.errorMessage.textContent = ''; // Limpa erros de login
      } else {
        els.loginForm.style.display = 'block';
        els.registrationForm.style.display = 'none';
        els.authTitle.textContent = 'Acesso Restrito';
        els.regErrorMessage.textContent = ''; // Limpa erros de registro
      }
    }

    // Fun√ß√£o de Login (ADAPTADA PARA USU√ÅRIO)
    function handleLogin(e) {
      e.preventDefault();
      const username = els.loginUsername.value.trim();
      const password = els.loginPassword.value;
      const virtualEmail = username + VIRTUAL_DOMAIN; // Mapeia para e-mail virtual

      els.errorMessage.textContent = '';
      els.loginBtn.disabled = true;

      auth.signInWithEmailAndPassword(virtualEmail, password)
        .then((userCredential) => {
          showToast(`Bem-vindo(a) ${username}!`, "success");
        })
        .catch((error) => {
          els.loginBtn.disabled = false; // Reativa o bot√£o
          let message = "Ocorreu um erro no login.";
          switch (error.code) {
            case 'auth/user-not-found':
            case 'auth/wrong-password':
              message = "Usu√°rio ou senha incorretos."; // Mensagem gen√©rica para seguran√ßa
              break;
            case 'auth/invalid-email':
              message = "Formato de usu√°rio inv√°lido.";
              break;
            default:
              message = "Erro: " + error.message;
              break;
          }
          els.errorMessage.textContent = message;
        });
    }

    // Fun√ß√£o de Registro (ADAPTADA PARA USU√ÅRIO)
    function handleRegistration(e) {
      e.preventDefault();
      const username = els.regUsername.value.trim();
      const password = els.regPassword.value;
      const confirmPassword = els.regConfirmPassword.value;
      const virtualEmail = username + VIRTUAL_DOMAIN; // Mapeia para e-mail virtual

      els.regErrorMessage.textContent = '';
      els.regPassword.classList.remove('input-invalido');
      els.regConfirmPassword.classList.remove('input-invalido');

      if (username.length < 3) {
          els.regErrorMessage.textContent = "O nome de usu√°rio deve ter no m√≠nimo 3 caracteres.";
          els.regUsername.classList.add('input-invalido');
          return;
      }
      
      if (password !== confirmPassword) {
        els.regErrorMessage.textContent = "As senhas n√£o coincidem.";
        els.regPassword.classList.add('input-invalido');
        els.regConfirmPassword.classList.add('input-invalido');
        return;
      }

      if (password.length < 6) {
          els.regErrorMessage.textContent = "A senha deve ter no m√≠nimo 6 caracteres.";
          els.regPassword.classList.add('input-invalido');
          els.regConfirmPassword.classList.add('input-invalido');
          return;
      }
      

      els.regBtn.disabled = true;

      auth.createUserWithEmailAndPassword(virtualEmail, password)
        .then((userCredential) => {
          showToast(`Conta do usu√°rio ${username} criada com sucesso! Voc√™ ser√° redirecionado para o login.`, "success", 4000);
          toggleAuthView(false); // Volta para a tela de login
          els.regBtn.disabled = false;
        })
        .catch((error) => {
          els.regBtn.disabled = false;
          let message = "Ocorreu um erro no registro.";
          switch (error.code) {
            case 'auth/email-already-in-use':
              message = `O usu√°rio '${username}' j√° est√° em uso.`;
              break;
            case 'auth/weak-password':
              message = "A senha √© muito fraca. Escolha uma mais segura.";
              break;
            default:
              message = "Erro: " + error.message;
              break;
          }
          els.regErrorMessage.textContent = message;
        });
    }

    // Listener para verificar o estado da autentica√ß√£o
    auth.onAuthStateChanged((user) => {
      if (user) {
        // Usu√°rio logado
        showMainApp();
      } else {
        // Usu√°rio deslogado
        showLoginScreen();
      }
    });

    // --- FUN√á√ïES DE L√ìGICA DO APP ---

    function formatNumber(num) {
      return num.toLocaleString('pt-BR');
    }

    function formatCurrency(num) {
      return 'R$ ' + num.toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }
    
    // Calcula os materiais e valores com base nos inputs
    function calculateTotals() {
      const qtyTickets = parseInt(els.qtyTickets.value) || 0;
      const qtyTablets = parseInt(els.qtyTablets.value) || 0;
      const qtyNitro = parseInt(els.qtyNitro.value) || 0;
      const tipoValor = els.tipoValor.value;
      const totalItens = qtyTickets + qtyTablets + qtyNitro;
      
      if (totalItens === 0) {
          els.results.style.display = 'none';
          return;
      }

      const totals = {};
      let totalGeral = 0;

      // 1. Calcular Materiais (Inputs de Tickets n√£o tem materiais al√©m do dinheiro)
      if (qtyTickets > 0) {
          if (!totals.moneyBruto) totals.moneyBruto = 0;
          totals.moneyBruto += qtyTickets * perUnit.tickets.moneyBruto;
      }
      
      if (qtyTablets > 0) {
        for (const material in perUnit.tablets) {
          if (!totals[material]) totals[material] = 0;
          totals[material] += qtyTablets * perUnit.tablets[material];
        }
        totalGeral += qtyTablets * valores.tablets[tipoValor];
      }

      if (qtyNitro > 0) {
        for (const material in perUnit.nitro) {
          if (!totals[material]) totals[material] = 0;
          totals[material] += qtyNitro * perUnit.nitro[material];
        }
        totalGeral += qtyNitro * valores.nitro[tipoValor];
      }
      
      // 2. Adicionar o valor dos tickets ao total geral
      if (qtyTickets > 0) {
          totalGeral += qtyTickets * valores.tickets[tipoValor];
      }

      // 3. Renderizar resultados de Materiais
      let resultsHtml = '';
      for (const material in totals) {
        let materialName = material.replace(/([A-Z])/g, ' $1').toLowerCase().replace('money bruto', 'Dinheiro Bruto');
        materialName = materialName.charAt(0).toUpperCase() + materialName.slice(1);
        resultsHtml += `<tr><td>${materialName}</td><td>${formatNumber(totals[material])}</td></tr>`;
      }
      els.resultsBody.innerHTML = resultsHtml;

      // 4. Renderizar resultados de Valores
      let valuesHtml = '';
      if (qtyTickets > 0) {
        valuesHtml += `<tr><td>Tickets (${formatNumber(qtyTickets)})</td><td>${formatCurrency(qtyTickets * valores.tickets[tipoValor])}</td></tr>`;
      }
      if (qtyTablets > 0) {
        valuesHtml += `<tr><td>Tablets (${formatNumber(qtyTablets)})</td><td>${formatCurrency(qtyTablets * valores.tablets[tipoValor])}</td></tr>`;
      }
      if (qtyNitro > 0) {
        valuesHtml += `<tr><td>Nitro (${formatNumber(qtyNitro)})</td><td>${formatCurrency(qtyNitro * valores.nitro[tipoValor])}</td></tr>`;
      }
      els.valuesBody.innerHTML = valuesHtml;

      els.valorTotalGeral.textContent = formatCurrency(totalGeral);
      els.results.style.display = 'block';
    }

    // Fun√ß√£o para limpar todos os campos da calculadora/venda
    function clearAllFields() {
        // Campos de venda
        els.nomeCliente.value = '';
        els.organizacao.value = '';
        els.organizacaoTipo.value = 'CNPJ';
        els.telefone.value = '';
        els.negociadoras.value = '';
        els.vendaValorObs.value = '';

        // Campos de c√°lculo
        els.qtyTickets.value = '';
        els.qtyTablets.value = '';
        els.qtyNitro.value = '';
        els.tipoValor.value = 'limpo';

        // Resultados
        els.results.style.display = 'none';
        els.resultsBody.innerHTML = '';
        els.valuesBody.innerHTML = '';
        els.valorTotalGeral.textContent = 'R$ 0';
        
        // Limpa valida√ß√£o visual
        removeInvalidClasses();
        
        // Reseta o bot√£o de registro
        els.registerBtn.classList.remove('primary');
        els.registerBtn.classList.add('success');
        els.registerBtn.textContent = 'Registrar Venda';
        
        vendaEmEdicaoId = null;
    }
    
    // Fun√ß√£o para remover as classes de valida√ß√£o de todos os campos
    function removeInvalidClasses() {
        const fields = [
            els.nomeCliente, els.organizacao, els.organizacaoTipo, 
            els.telefone, els.negociadoras, els.vendaValorObs,
            els.qtyTickets, els.qtyTablets, els.qtyNitro
        ];
        fields.forEach(field => field.classList.remove('input-invalido'));
    }

    // Fun√ß√£o de valida√ß√£o para registro
    function validateFields() {
        removeInvalidClasses();
        let isValid = true;
        const totalItens = (parseInt(els.qtyTickets.value) || 0) + 
                         (parseInt(els.qtyTablets.value) || 0) + 
                         (parseInt(els.qtyNitro.value) || 0);

        if (totalItens === 0) {
            showToast('A venda deve ter pelo menos 1 item (Ticket, Tablet ou Nitro).', 'error');
            els.qtyTickets.classList.add('input-invalido');
            els.qtyTablets.classList.add('input-invalido');
            els.qtyNitro.classList.add('input-invalido');
            isValid = false;
        }

        if (!els.nomeCliente.value.trim()) {
            els.nomeCliente.classList.add('input-invalido');
            isValid = false;
        }
        
        if (!els.organizacao.value.trim()) {
            els.organizacao.classList.add('input-invalido');
            isValid = false;
        }
        
        // O telefone n√£o √© obrigat√≥rio, mas se estiver preenchido, deve ter o formato correto (13 caracteres com o prefixo)
        if (els.telefone.value.trim() && els.telefone.value.length !== 13) {
            els.telefone.classList.add('input-invalido');
            isValid = false;
        }

        if (!els.negociadoras.value.trim()) {
            els.negociadoras.classList.add('input-invalido');
            isValid = false;
        }
        
        if (!els.vendaValorObs.value.trim()) {
            els.vendaValorObs.classList.add('input-invalido');
            isValid = false;
        }

        if (!isValid) {
            showToast('Preencha todos os campos obrigat√≥rios (marcados em vermelho) e verifique o Telefone.', 'error', 4000);
        }
        
        return isValid;
    }


    function registerVenda() {
        if (!validateFields()) {
            return;
        }
        
        // Simula√ß√£o de c√°lculo para pegar os valores finais
        calculateTotals();
        
        const totalGeralTexto = els.valorTotalGeral.textContent; // "R$ X.XXX.XXX"
        
        const produtosVendidos = [];
        if (parseInt(els.qtyTickets.value) > 0) {
             produtosVendidos.push(`Tickets: ${els.qtyTickets.value}`);
        }
        if (parseInt(els.qtyTablets.value) > 0) {
             produtosVendidos.push(`Tablets: ${els.qtyTablets.value}`);
        }
        if (parseInt(els.qtyNitro.value) > 0) {
             produtosVendidos.push(`Nitro: ${els.qtyNitro.value}`);
        }
        
        const produtosTexto = produtosVendidos.join('; ');
        
        const novaVenda = {
            id: vendaEmEdicaoId || Date.now(),
            timestamp: new Date().toISOString(), // Usado para ordena√ß√£o e exibi√ß√£o completa
            dataExibicao: new Date().toLocaleDateString('pt-BR'),
            horaExibicao: new Date().toLocaleTimeString('pt-BR'),
            cliente: els.nomeCliente.value.trim(),
            organizacao: els.organizacao.value.trim(),
            organizacaoTipo: els.organizacaoTipo.value,
            telefone: els.telefone.value.trim(),
            negociadoras: els.negociadoras.value.trim(),
            valorTotal: totalGeralTexto,
            valorObs: els.vendaValorObs.value.trim(),
            produtos: produtosTexto,
            tipoValor: valorDescricao[els.tipoValor.value] // Salva o nome do tipo
        };
        
        if (vendaEmEdicaoId) {
            // Edi√ß√£o
            const index = vendas.findIndex(v => v.id === vendaEmEdicaoId);
            if (index !== -1) {
                vendas[index] = novaVenda;
                showToast(`Venda do(a) ${novaVenda.cliente} atualizada com sucesso!`, 'success');
            }
        } else {
            // Nova Venda
            vendas.push(novaVenda);
            showToast(`Venda registrada com sucesso! Cliente: ${novaVenda.cliente}`, 'success');
        }
        
        saveVendas();
        clearAllFields();
        renderHistorico(); // Atualiza a tabela do hist√≥rico
    }
    
    // Fun√ß√£o para renderizar o hist√≥rico na tabela
    function renderHistorico(filtro = '') {
        const tbody = els.salesHistory;
        tbody.innerHTML = ''; // Limpa o conte√∫do anterior
        
        // Filtra e inverte a ordem (mais recente primeiro)
        const vendasFiltradas = vendas.slice().reverse().filter(venda => {
            const termo = filtro.toLowerCase();
            return !filtro || 
                   venda.cliente.toLowerCase().includes(termo) ||
                   venda.organizacao.toLowerCase().includes(termo) ||
                   venda.produtos.toLowerCase().includes(termo) ||
                   venda.dataExibicao.includes(termo) ||
                   venda.telefone.includes(termo) ||
                   venda.negociadoras.toLowerCase().includes(termo);
        });

        if (vendasFiltradas.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding: 20px;">Nenhuma venda encontrada.</td></tr>`;
            return;
        }

        vendasFiltradas.forEach(venda => {
            const row = tbody.insertRow();

            // Coluna 1: Data/Hora
            row.insertCell().innerHTML = 
                `<span class="history-datetime-line">${venda.dataExibicao}</span>` + 
                `<span class="history-datetime-line">${venda.horaExibicao}</span>`;
            
            // Coluna 2: Cliente
            row.insertCell().textContent = venda.cliente;

            // Coluna 3: Organiza√ß√£o/Tipo
            row.insertCell().innerHTML = `<strong>${venda.organizacao}</strong><br><span style="font-size: 11px; opacity: 0.8;">(${venda.organizacaoTipo})</span>`;
            
            // Coluna 4: Telefone
            row.insertCell().textContent = venda.telefone || '-'; 
            
            // Coluna 5: Produtos
            row.insertCell().textContent = venda.produtos;

            // Coluna 6: Valor Total / Observa√ß√£o
            row.insertCell().innerHTML = 
                `<div class="valor-total-cell">` +
                    `<span>${venda.valorTotal}</span>` + 
                    `<span class="valor-obs-text">${venda.valorObs}</span>` + 
                `</div>`;
            
            // Coluna 7: Negociadoras
            row.insertCell().textContent = venda.negociadoras;
            
            // Coluna 8: A√ß√µes
            const actionsCell = row.insertCell();
            actionsCell.classList.add('history-actions-cell');
            actionsCell.innerHTML = `
                <button class="action-btn muted" onclick="editVenda(${venda.id})">Editar</button>
                <button class="action-btn primary" onclick="copyDiscordMessage(${venda.id})">Discord</button>
                <button class="action-btn muted" onclick="deleteVenda(${venda.id})">Excluir</button>
            `;
        });
    }

    // Fun√ß√£o de exclus√£o
    function deleteVenda(id) {
        if (confirm('Tem certeza que deseja excluir este registro de venda?')) {
            vendas = vendas.filter(v => v.id !== id);
            saveVendas();
            renderHistorico();
            showToast('Venda exclu√≠da.', 'error', 2000);
        }
    }
    
    // Fun√ß√£o de Edi√ß√£o
    function editVenda(id) {
        const venda = vendas.find(v => v.id === id);
        if (!venda) return;
        
        // 1. Alterna para a tela de calculadora
        toggleView(false); 
        
        // 2. Limpa os campos e seta o ID de edi√ß√£o
        clearAllFields(); 
        vendaEmEdicaoId = id;

        // 3. Preenche os campos de Dados da Venda
        els.nomeCliente.value = venda.cliente;
        els.organizacao.value = venda.organizacao;
        els.organizacaoTipo.value = venda.organizacaoTipo;
        els.telefone.value = venda.telefone;
        els.negociadoras.value = venda.negociadoras;
        els.vendaValorObs.value = venda.valorObs;
        
        // 4. Preenche os campos de C√°lculo
        const produtos = venda.produtos.split('; ');
        let ticketQty = 0;
        let tabletQty = 0;
        let nitroQty = 0;
        
        produtos.forEach(p => {
            if (p.includes('Tickets:')) {
                ticketQty = parseInt(p.replace('Tickets:', '').trim()) || 0;
            } else if (p.includes('Tablets:')) {
                tabletQty = parseInt(p.replace('Tablets:', '').trim()) || 0;
            } else if (p.includes('Nitro:')) {
                nitroQty = parseInt(p.replace('Nitro:', '').trim()) || 0;
            }
        });

        els.qtyTickets.value = ticketQty;
        els.qtyTablets.value = tabletQty;
        els.qtyNitro.value = nitroQty;
        
        // 5. Preenche o Tipo de Valor (Faz o mapeamento reverso de descri√ß√£o para chave)
        const tipoKey = Object.keys(valorDescricao).find(key => valorDescricao[key] === venda.tipoValor);
        els.tipoValor.value = tipoKey || 'limpo'; // Default para limpo se n√£o achar
        
        // 6. Recalcula os totais para exibir os resultados (Total Geral)
        calculateTotals();
        
        // 7. Atualiza o bot√£o de registro
        els.registerBtn.classList.remove('success');
        els.registerBtn.classList.add('primary');
        els.registerBtn.textContent = 'Salvar Edi√ß√£o';
        
        showToast(`Editando venda de ${venda.cliente}. Salve para confirmar.`, 'default', 3000);
    }
    
    // Fun√ß√£o para copiar o c√≥digo Discord formatado
    function copyDiscordMessage(id) {
        const venda = vendas.find(v => v.id === id);
        if (!venda) return;
        
        const message = `\`\`\`
**[ NOVO REGISTRO HA ]**
‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨
**CLIENTE:** ${venda.cliente}
**ORGANIZA√á√ÉO:** ${venda.organizacao} (${venda.organizacaoTipo})
**TELEFONE:** ${venda.telefone || 'N/A'}
**PRODUTOS:** ${venda.produtos.replace(/; /g, ' | ')}
**VALOR FINAL:** ${venda.valorTotal} (${venda.tipoValor})
**PAGAMENTO:** ${venda.valorObs}
**NEGOCIADOR(ES):** ${venda.negociadoras}
**DATA:** ${venda.dataExibicao} ${venda.horaExibicao}
\`\`\``;

        navigator.clipboard.writeText(message).then(() => {
            showToast('Mensagem Discord copiada para a √°rea de transfer√™ncia!', 'success');
        }).catch(err => {
            showToast('Erro ao copiar a mensagem.', 'error');
            console.error('Erro ao copiar: ', err);
        });
    }

    // Fun√ß√£o para exportar CSV
    function exportCSV() {
        if (vendas.length === 0) {
            showToast('N√£o h√° dados para exportar.', 'default');
            return;
        }

        const header = ["ID", "Data/Hora", "Cliente", "Organiza√ß√£o", "Tipo", "Telefone", "Produtos", "Valor Total", "Observa√ß√£o", "Negociadoras", "Tipo de Valor"];
        const rows = [header];

        vendas.forEach(venda => {
            rows.push([
                venda.id,
                venda.timestamp,
                venda.cliente,
                venda.organizacao,
                venda.organizacaoTipo,
                venda.telefone,
                venda.produtos,
                venda.valorTotal,
                venda.valorObs,
                venda.negociadoras,
                venda.tipoValor
            ]);
        });

        let csvContent = "data:text/csv;charset=utf-8," 
            + rows.map(e => e.join(",")).join("\n");

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `historico_vendas_ha_${new Date().toISOString().slice(0, 10)}.csv`);
        document.body.appendChild(link); // Required for Firefox
        link.click();
        document.body.removeChild(link);
        
        showToast('Exporta√ß√£o CSV iniciada.', 'success');
    }

    // Fun√ß√£o para limpar todo o hist√≥rico
    function clearHistory() {
        if (confirm('ATEN√á√ÉO: Voc√™ tem certeza que deseja APAGAR TODO O HIST√ìRICO DE VENDAS? Esta a√ß√£o n√£o pode ser desfeita.')) {
            vendas = [];
            saveVendas();
            renderHistorico();
            showToast('Hist√≥rico de vendas apagado com sucesso.', 'success', 3000);
        }
    }
    
    // Fun√ß√£o para alternar entre Calculadora e Hist√≥rico
    function toggleView(showHistory) {
        if (showHistory) {
            els.mainCard.style.display = 'none';
            els.historyCard.style.display = 'block';
            renderHistorico();
        } else {
            els.historyCard.style.display = 'none';
            els.mainCard.style.display = 'block';
        }
        clearTour(); // Para o tour ao alternar de tela
    }
    
    // Fun√ß√£o para copiar o c√≥digo Discord do c√°lculo atual
    function copyDiscordMessageCalc() {
        calculateTotals(); // Garante que os resultados est√£o calculados
        const totalItens = (parseInt(els.qtyTickets.value) || 0) + 
                           (parseInt(els.qtyTablets.value) || 0) + 
                           (parseInt(els.qtyNitro.value) || 0);

        if (totalItens === 0) {
            showToast('Nenhum item para calcular/copiar.', 'error');
            return;
        }
        
        const totalGeralTexto = els.valorTotalGeral.textContent; 
        const tipoValorTexto = valorDescricao[els.tipoValor.value];
        
        const produtosVendidos = [];
        if (parseInt(els.qtyTickets.value) > 0) {
             produtosVendidos.push(`Tickets: ${els.qtyTickets.value}`);
        }
        if (parseInt(els.qtyTablets.value) > 0) {
             produtosVendidos.push(`Tablets: ${els.qtyTablets.value}`);
        }
        if (parseInt(els.qtyNitro.value) > 0) {
             produtosVendidos.push(`Nitro: ${els.qtyNitro.value}`);
        }
        
        const produtosTexto = produtosVendidos.join(' | ');

        const message = `\`\`\`
**[ C√ÅLCULO HA ]**
‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨
**CLIENTE:** ${els.nomeCliente.value.trim() || 'N/A'}
**ORGANIZA√á√ÉO:** ${els.organizacao.value.trim() || 'N/A'}
**PRODUTOS:** ${produtosTexto}
**VALOR TOTAL:** ${totalGeralTexto} (${tipoValorTexto})
**OBSERVA√á√ÉO:** ${els.vendaValorObs.value.trim() || 'N/A'}
**NEGOCIADOR(ES):** ${els.negociadoras.value.trim() || 'N/A'}
\`\`\``;

        navigator.clipboard.writeText(message).then(() => {
            showToast('Mensagem Discord de C√ÅLCULO copiada!', 'success');
        }).catch(err => {
            showToast('Erro ao copiar a mensagem.', 'error');
            console.error('Erro ao copiar: ', err);
        });
    }

    // Fun√ß√£o para alternar o tema
    function toggleTheme() {
        if (document.body.classList.contains('light')) {
            document.body.classList.remove('light');
            document.body.classList.add('dark');
            localStorage.setItem('ha_theme', 'dark');
            els.themeBtn.textContent = '‚òÄÔ∏è Modo Claro';
            els.appLogo.src = logoDarkModeSrc;
        } else {
            document.body.classList.remove('dark');
            document.body.classList.add('light');
            localStorage.setItem('ha_theme', 'light');
            els.themeBtn.textContent = 'üåô Modo Noturno';
            els.appLogo.src = logoLightModeSrc;
        }
    }
    
    // --- FUN√á√ïES E VARI√ÅVEIS DO TOUR / TUTORIAL ---
    let tourStep = 0;
    const tourSteps = [
        {
            element: '#nomeCliente',
            title: '1. Dados do Cliente',
            content: 'Comece preenchendo o nome do cliente e a organiza√ß√£o a qual ele pertence. Estes dados s√£o obrigat√≥rios para o registro da venda.',
            position: 'bottom'
        },
        {
            element: '#telefone',
            title: '2. Telefone e Negociadoras',
            content: 'O telefone √© formatado automaticamente para (055) XXX-XXX. Informe tamb√©m as negociadoras envolvidas e as observa√ß√µes sobre o pagamento (Ex: 2x no Pix).',
            position: 'bottom'
        },
        {
            element: '#qtyTickets',
            title: '3. Quantidade de Produtos',
            content: 'Insira a quantidade de Tickets, Tablets e/ou Nitro que deseja calcular ou vender.',
            position: 'top'
        },
        {
            element: '#tipoValor',
            title: '4. Tipo de Valor',
            content: 'Escolha o tipo de dinheiro (Limpo/Sujo) e se √© uma venda para Aliados (pre√ßos especiais).',
            position: 'top'
        },
        {
            element: '#calcBtn',
            title: '5. Calcular e Resultados',
            content: 'Clique em "Calcular" para ver o total de materiais necess√°rios e o valor final estimado da venda.',
            position: 'right'
        },
        {
            element: '#registerBtn',
            title: '6. Registrar Venda',
            content: 'Ap√≥s o c√°lculo, clique aqui para salvar a venda no seu hist√≥rico. Ele vira "Salvar Edi√ß√£o" se voc√™ estiver editando uma venda antiga.',
            position: 'bottom'
        },
        {
            element: '#toggleHistoryBtn',
            title: '7. Hist√≥rico',
            content: 'Visualize todas as suas vendas registradas. A partir da tabela, voc√™ pode Editar, Excluir ou Copiar a mensagem formatada para o Discord.',
            position: 'right'
        },
        {
            element: '#discordBtnCalc',
            title: '8. Mensagem Discord',
            content: 'Use este bot√£o para copiar rapidamente os dados de C√ÅLCULO formatados no padr√£o Discord (ideal para logs ou relat√≥rios).',
            position: 'right'
        }
    ];

    function createTooltip(step) {
        const existingTooltip = document.querySelector('.tour-tooltip');
        if (existingTooltip) existingTooltip.remove();
        
        const targetElement = document.querySelector(step.element);
        if (!targetElement) return;

        const tooltip = document.createElement('div');
        tooltip.classList.add('tour-tooltip');
        tooltip.innerHTML = `
            <h4>${step.title}</h4>
            <p>${step.content}</p>
            <div>
                ${tourStep > 0 ? `<button onclick="prevStep()">Anterior</button>` : ''}
                <button onclick="nextStep()">${tourStep < tourSteps.length - 1 ? 'Pr√≥ximo' : 'Finalizar'}</button>
            </div>
        `;

        document.body.appendChild(tooltip);

        // Adiciona classe de destaque ao elemento
        targetElement.classList.add('tour-highlight');

        // Posicionamento do Tooltip
        const rect = targetElement.getBoundingClientRect();
        
        // Posicionamento padr√£o (ajusta conforme a necessidade)
        let top = 0, left = 0;

        switch (step.position) {
            case 'top':
                top = rect.top - tooltip.offsetHeight - 15;
                left = rect.left + rect.width / 2 - tooltip.offsetWidth / 2;
                break;
            case 'right':
                top = rect.top + rect.height / 2 - tooltip.offsetHeight / 2;
                left = rect.right + 15;
                break;
            case 'left':
                top = rect.top + rect.height / 2 - tooltip.offsetHeight / 2;
                left = rect.left - tooltip.offsetWidth - 15;
                break;
            case 'bottom':
            default:
                top = rect.bottom + 15;
                left = rect.left + rect.width / 2 - tooltip.offsetWidth / 2;
                break;
        }

        // Ajustes para bordas da tela
        if (left < 10) left = 10;
        if (left + tooltip.offsetWidth > window.innerWidth - 10) {
             left = window.innerWidth - tooltip.offsetWidth - 10;
        }
        if (top < 10) top = rect.bottom + 15; // Garante que n√£o suba demais

        tooltip.style.top = `${top + window.scrollY}px`;
        tooltip.style.left = `${left}px`;
        
        // For√ßa a exibi√ß√£o ap√≥s o posicionamento
        setTimeout(() => tooltip.classList.add('active'), 50);
    }
    
    function clearTour() {
        tourStep = 0;
        const existingTooltip = document.querySelector('.tour-tooltip');
        if (existingTooltip) existingTooltip.remove();
        document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));
    }

    function startTour() {
        if (els.historyCard.style.display !== 'none') {
            toggleView(false); // Garante que a calculadora est√° vis√≠vel
            setTimeout(() => {
                tourStep = 0;
                createTooltip(tourSteps[tourStep]);
            }, 300); // D√° um tempo para a transi√ß√£o de tela
        } else {
            tourStep = 0;
            createTooltip(tourSteps[tourStep]);
        }
    }

    function nextStep() {
        document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));
        if (tourStep < tourSteps.length - 1) {
            tourStep++;
            createTooltip(tourSteps[tourStep]);
        } else {
            clearTour();
            showToast('Tutorial finalizado!', 'success', 2000);
        }
    }

    function prevStep() {
        document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));
        if (tourStep > 0) {
            tourStep--;
            createTooltip(tourSteps[tourStep]);
        }
    }
    
    // --- LISTENERS ---
    
    // Listeners do Login/Registro
    els.loginForm.addEventListener('submit', handleLogin);
    els.logoutBtn.addEventListener('click', () => {
        auth.signOut().then(() => {
            showToast("Voc√™ foi desconectado.", "default");
        }).catch((error) => {
            showToast("Erro ao desconectar.", "error");
        });
    });
    els.registrationForm.addEventListener('submit', handleRegistration);
    els.toggleToReg.addEventListener('click', (e) => {
        e.preventDefault();
        toggleAuthView(true);
    });
    els.toggleToLogin.addEventListener('click', (e) => {
        e.preventDefault();
        toggleAuthView(false);
    });
    
    // Listeners da Calculadora/Venda
    els.calcBtn.addEventListener('click', calculateTotals);
    els.resetBtn.addEventListener('click', clearAllFields);
    els.registerBtn.addEventListener('click', registerVenda);
    els.csvBtn.addEventListener('click', exportCSV);
    els.discordBtnCalc.addEventListener('click', copyDiscordMessageCalc);
    
    // Listeners do Hist√≥rico
    els.toggleHistoryBtn.addEventListener('click', () => toggleView(true));
    els.toggleCalcBtn.addEventListener('click', () => toggleView(false));
    els.clearHistoryBtn.addEventListener('click', clearHistory);
    els.filtroHistorico.addEventListener('input', (e) => renderHistorico(e.target.value));

    // Listeners da UI
    els.themeBtn.addEventListener('click', toggleTheme);
    
    // Listener de tutorial
    els.tutorialBtn.addEventListener('click', startTour);
    
    // Listener da Logo Superior (Voltar para calculadora e cancelar edi√ß√£o)
    els.logoLink.addEventListener('click', (e) => {
        e.preventDefault(); 

        if (vendaEmEdicaoId) {
            vendaEmEdicaoId = null;
            els.registerBtn.textContent = 'Registrar Venda';
            clearAllFields();
            showToast("Edi√ß√£o pendente cancelada.", "error", 2000);
        }
        
        toggleView(false); 
        clearTour(); 
    });
    
    // Listener para formata√ß√£o de telefone
    els.telefone.addEventListener('input', (e) => {
        e.target.value = formatPhone(e.target.value);
    });
    
    // --- Chamadas Iniciais ---
    loadVendas(); 
    
    // Aplica o tema salvo (mantido)
    const savedTheme = localStorage.getItem('ha_theme');
    if (savedTheme) {
        document.body.classList.remove('light', 'dark');
        document.body.classList.add(savedTheme);
        els.themeBtn.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è Modo Claro' : 'üåô Modo Noturno';
        els.appLogo.src = savedTheme === 'dark' ? logoDarkModeSrc : logoLightModeSrc;
    } else {
        // Se n√£o houver tema salvo, define o padr√£o
        document.body.classList.add('light');
        els.themeBtn.textContent = 'üåô Modo Noturno';
        els.appLogo.src = logoLightModeSrc;
    }
    
    // Define a data atual no campo
    els.dataVenda.value = new Date().toLocaleDateString('pt-BR');
    
    // Inicia a autentica√ß√£o (ser√° substitu√≠do pelo onAuthStateChanged)
    // showLoginScreen(); 
  </script>
</body>
</html>
