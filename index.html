<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <link rel="icon" type="image/png" href="logo-dark.png">
  
  <title>Hells Angels</title>
  <style>
    :root {
      --cor-fundo: #fff0f6; --cor-texto: #4a0033; --cor-principal: #e60073;
      --cor-card: #ffffff; --cor-borda: #ffb3d9; --cor-btn-primario: #e60073;
      --cor-btn-texto: #fff; --cor-btn-secundario: #ffd6eb;
      --cor-btn-secundario-texto: #4a0033; --cor-erro: #cc0000;
      --cor-glow-pulsante: rgba(230, 0, 115, 0.8);
      --cor-tag-admin: #0056b3; --cor-tag-hells: #e60073; --cor-tag-visitante: #008000;
    }
    body.dark {
      --cor-fundo: #1a000d; --cor-texto: #ffccf0; --cor-principal: #ff0080; 
      --cor-card: #2c001a; --cor-borda: #e60073; --cor-btn-primario: #ff0080; 
      --cor-btn-texto: #fff; --cor-btn-secundario: #4d002a; 
      --cor-btn-secundario-texto: #ffccf0; --cor-glow-pulsante: rgba(255, 0, 128, 0.6);
      --cor-tag-admin: #007bff; --cor-tag-hells: #ff0080; --cor-tag-visitante: #28a745;
    }
    body.dark input[type=number], body.dark input[type=text], body.dark select,
    body.dark .modal-content input[type=text], body.dark .modal-content textarea {
      background: #33001f; color: var(--cor-texto); border: 1px solid var(--cor-borda);
    }
    .modal-content textarea {
        width: 100%; box-sizing: border-box; min-height: 80px;
        padding: 8px; border-radius: 6px; border: 1px solid var(--cor-borda);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    input[list]:focus, input[list]:hover { border-color: var(--cor-principal) !important; box-shadow: 0 0 5px rgba(230, 0, 115, 0.4); }
    input[list] { position: relative; z-index: 1; }
    input[list]::-webkit-calendar-picker-indicator { display: none; }
    .suggestion-tip { font-size: 11px; color: var(--cor-principal); margin-top: 4px; margin-bottom: 0; font-weight: 500; opacity: 0.8; }
    
    #tour-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.6); z-index: 10000; opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }
    #tour-overlay.active { opacity: 1; }
    .tour-tooltip {
      position: absolute; background: var(--cor-principal); color: var(--cor-btn-texto);
      padding: 15px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      max-width: 300px; text-align: left; opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease; z-index: 10002;
    }
    .tour-tooltip.active { opacity: 1; transform: translateY(0); }
    .tour-tooltip h4 { margin: 0 0 5px; font-size: 16px; color: var(--cor-btn-texto); }
    .tour-tooltip p { margin: 0; font-size: 14px; margin-bottom: 10px; }
    .tour-tooltip button {
        background: var(--cor-btn-secundario); color: var(--cor-btn-secundario-texto);
        padding: 6px 10px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; margin-right: 8px;
    }
    .tour-highlight {
      position: relative; z-index: 10001; 
      box-shadow: 0 0 0 3px var(--cor-principal), 0 0 15px var(--cor-principal);
      border-radius: 6px;
    }
    
    input.input-invalido, select.input-invalido, textarea.input-invalido { 
        border: 2px solid var(--cor-erro) !important; 
        box-shadow: 0 0 4px var(--cor-erro); 
    }
    #logoLink { position: fixed; top: 16px; left: 16px; width: auto; max-height: 80px; cursor: pointer; z-index: 9998; }
    .app-logo { max-height: 80px; width: auto; transition: opacity 0.3s ease, filter 0.3s ease; display: block; }
    #appLogo:hover { filter: drop-shadow(0 0 8px var(--cor-principal)) drop-shadow(0 0 15px var(--cor-glow-pulsante)); opacity: 0.9; }
    
    #welcomeLogo { max-width: 80%; max-height: 120px; margin-bottom: 25px; display: block; }
    #welcomeScreen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: var(--cor-card); z-index: 10000; display: none; 
      flex-direction: column; justify-content: center; align-items: center;
      text-align: center; transition: opacity 0.5s ease;
      padding: 20px; box-sizing: border-box; 
    }
    #welcomeScreen.show { display: flex; }
    #welcomeScreen.hidden { opacity: 0; pointer-events: none; }
    #welcomeScreen h2 { font-size: 36px; margin-top: 10px; margin-bottom: 20px; color: var(--cor-principal); }
    #welcomeScreen button { padding: 12px 24px; font-size: 18px; border-radius: 10px; margin-top: 10px; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 960px; margin: 24px auto; padding: 20px;
      background: var(--cor-fundo); color: var(--cor-texto);
      transition: background 0.25s ease, color 0.25s ease, max-width 0.4s ease-in-out;
    }
    body.history-view-active { max-width: 1200px; }
    body.dossier-view-active { max-width: 1200px; }

    #mainCard { display: block; }
    h1 { margin: 0; font-size: 24px; font-weight: 700; color: var(--cor-principal); text-align: center; flex-grow: 1; }
    h2 { font-size: 20px; font-weight: 600; margin-bottom: 10px; color: var(--cor-principal); }
    h3 { color: var(--cor-principal); font-weight:600; margin-top: 16px; }

    .card {
      background: var(--cor-card); padding: 18px; border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid var(--cor-borda);
      margin-bottom: 20px;
    }
    
    .header-container { display:flex; justify-content: space-between; align-items: center; gap: 15px; margin-bottom: 12px; }

    .user-status-display {
      font-size: 14px;
      font-weight: 700;
      padding: 6px 12px;
      border-radius: 8px;
      color: var(--cor-btn-texto);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-left: 10px;
    }
    .user-status-display.tag-admin { background-color: var(--cor-tag-admin); }
    .user-status-display.tag-hells { background-color: var(--cor-tag-hells); }
    .user-status-display.tag-visitante { background-color: var(--cor-tag-visitante); }
    
    label { display: block; margin: 10px 0 6px; font-weight: 600; color: var(--cor-principal); }
    input[type=number], input[type=text], select {
      width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--cor-borda);
      background: #fff; color: var(--cor-texto); font-size: 14px; box-sizing: border-box;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    input[type=number] { width: 140px; }
    
    input#placaVeiculo {
        text-transform: uppercase;
    }

    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 14px; margin-top: 12px; }
    .grid-venda { grid-template-columns: 1fr 1fr; }

    table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 14px; }
    th, td { padding: 6px; border-bottom: 1px solid var(--cor-borda); text-align: left; }
    th { background: var(--cor-btn-secundario); color: var(--cor-btn-secundario-texto); font-weight: 600; }
    
    .actions { margin-top: 14px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    button {
      padding: 8px 14px; border-radius: 8px; border: none; cursor: pointer;
      font-weight: 600; font-size: 14px; transition: opacity 0.2s ease, box-shadow 0.3s ease;
    }
    button:hover { opacity: 0.85; }
    button:disabled { cursor: not-allowed; background-color: #ccc; }
    
    .primary, .success { animation: pulse-glow 2s infinite ease-in-out; }
    @keyframes pulse-glow {
        0% { box-shadow: 0 0 0 rgba(0, 0, 0, 0); }
        50% { box-shadow: 0 0 10px var(--cor-glow-pulsante), 0 0 20px var(--cor-glow-pulsante); }
        100% { box-shadow: 0 0 0 rgba(0, 0, 0, 0); }
    }

    .primary { background: var(--cor-btn-primario); color: var(--cor-btn-texto); }
    .muted { background: var(--cor-btn-secundario); color: var(--cor-btn-secundario-texto); }
    .success { background: #00b33c; color: #fff; }
    .danger { background: var(--cor-erro); color: #fff; }

    .top-right-controls { position: fixed; top: 16px; right: 16px; display: flex; flex-direction: column; gap: 10px; z-index: 9999; }
    .control-btn {
        padding: 10px 14px; border-radius: 10px; background: var(--cor-btn-primario);
        color: var(--cor-btn-texto); font-weight: 700; cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2); border: none;
        transition: opacity 0.2s ease;
    }
    .control-btn:hover { opacity: 0.85; }
    
    #historyBackground {
      background: rgba(255, 255, 255, 0.7); 
      position: relative; padding: 18px; border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid var(--cor-borda);
      margin-bottom: 20px; max-height: 75vh; overflow-y: auto;
    }
    body.dark #historyBackground { background: rgba(44, 0, 26, 0.7); }
    #historyBackground img {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%); width: 100%; height: auto;
      opacity: 0.3; z-index: 1; object-fit: contain; 
    }
    #historyBackground > * { position: relative; z-index: 2; }

    #toast-container {
        position: fixed; bottom: 20px; right: 20px; z-index: 10005; 
        display: flex; flex-direction: column-reverse; gap: 10px; align-items: flex-end; 
    }
    .toast {
        background-color: var(--cor-principal); color: var(--cor-btn-texto);
        padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        opacity: 0; transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        transform: translateY(20px); max-width: 300px; min-width: 150px; text-align: center;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { background-color: #00b33c; }
    .toast.error { background-color: var(--cor-erro); }
    
    .action-btn { padding: 4px 8px; font-size: 12px; margin-right: 0px; border-radius: 4px; }
    
    .history-table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; width: 100%; margin-top: 8px; }
    #historyCard table {
        width: 100%; border-collapse: collapse; table-layout: fixed;
        min-width: 1150px; background: transparent; 
    }
    #historyCard th, #historyCard td {
        padding: 6px 8px; text-align: center; vertical-align: middle;
        white-space: nowrap; font-size: 14px; border-bottom: 1px solid var(--cor-borda);
    }
    #historyCard td { background: var(--cor-card); opacity: 0.95; }
    body.dark #historyCard td { background: var(--cor-card); opacity: 0.95; }
    
    #historyCard th:nth-child(1), #historyCard td:nth-child(1) { width: 100px; }
    #historyCard th:nth-child(2), #historyCard td:nth-child(2) { width: 140px; }
    #historyCard th:nth-child(3), #historyCard td:nth-child(3) { width: 160px; }
    #historyCard th:nth-child(4), #historyCard td:nth-child(4) { width: 120px; }
    #historyCard th:nth-child(5), #historyCard td:nth-child(5) { width: 220px; }
    #historyCard th:nth-child(6), #historyCard td:nth-child(6) { width: 150px; }
    #historyCard th:nth-child(7), #historyCard td:nth-child(7) { width: 130px; }
    #historyCard th:nth-child(8), #historyCard td:nth-child(8) { width: 120px; }
    #historyCard th:nth-child(9), #historyCard td:nth-child(9) { width: 150px; }

    .history-datetime-line { display: block; line-height: 1.2; font-size: 13px; }
    .valor-total-cell span:first-child { font-weight: 700; }
    .valor-obs-text { font-size: 12px; color: var(--cor-principal); }

    .history-actions-cell { display: flex; align-items: center; justify-content: center; gap: 5px; }
    .history-actions-cell button { padding: 4px 8px; font-size: 11px; border-radius: 4px; white-space: nowrap; }

    #historyCard tr { height: 40px; }
    #historyCard th { background: var(--cor-principal); color: var(--cor-btn-texto); }

    #authScreen { padding: 25px; border-radius: 16px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); }
    #authScreen h2 {
        text-align: center; margin-bottom: 20px; padding-bottom: 10px;
        border-bottom: 2px solid var(--cor-borda); font-size: 26px;
    }
    #authScreen input[type=text], #authScreen input[type=password] {
        padding: 12px; font-size: 16px; border-radius: 8px;
        border: 1px solid var(--cor-borda); transition: all 0.3s ease;
    }
    #authScreen input[type=text]:focus, #authScreen input[type=password]:focus {
        border-color: var(--cor-principal) !important;
        box-shadow: 0 0 10px rgba(230, 0, 115, 0.5);
    }
    #authScreen .actions { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
    #authScreen .actions button { width: 100%; padding: 12px; font-size: 16px; }
    #authMessage { text-align: center; font-weight: 600; }
    
    #bottomPanel {
        position: fixed; bottom: 0; left: 0; width: 100%;
        background: var(--cor-card); border-top: 2px solid var(--cor-principal);
        box-shadow: 0 -4px 15px rgba(0,0,0,0.2);
        padding: 10px 20px; z-index: 9997;
        display: none;
        justify-content: center; align-items: center; gap: 20px;
    }
    
    /* --- INÍCIO DOS NOVOS ESTILOS DO DOSSIÊ (v6) --- */
    .dossier-org-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
        gap: 20px;
        margin-top: 15px;
    }
    .dossier-org-card {
        background: var(--cor-card);
        border: 1px solid var(--cor-borda);
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        text-align: center;
        transition: box-shadow 0.2s ease, transform 0.2s ease;
        cursor: pointer;
        overflow: hidden; 
    }
    .dossier-org-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 15px rgba(0,0,0,0.12);
    }
    .dossier-org-card h4 { /* Nome da Org */
        margin: 12px 10px 12px 10px;
        font-size: 20px;
        color: var(--cor-principal);
        font-weight: 700;
        word-wrap: break-word;
    }
    .dossier-org-card .dossier-org-foto {
        width: 100%;
        height: 160px; 
        object-fit: cover; 
        background-color: var(--cor-btn-secundario); 
        color: var(--cor-btn-secundario-texto);
        display: flex;
        align-items: center;
        justify-content: center;
        font-style: italic;
        font-size: 14px;
        overflow: hidden; 
        border-bottom: 1px solid var(--cor-borda);
    }
    .dossier-org-card .dossier-org-foto img {
         width: 100%;
         height: 100%;
         object-fit: cover; 
    }
    .dossier-org-card p { /* Info da Base */
        font-size: 13px;
        color: var(--cor-texto);
        padding: 0 12px 12px 12px;
        margin: 0;
        min-height: 30px;
        white-space: pre-wrap; /* Mantém quebras de linha */
    }
    .dossier-org-card .dossier-org-actions {
        border-top: 1px solid var(--cor-borda);
        padding: 8px;
        background: var(--cor-btn-secundario);
    }
    .dossier-org-card .dossier-org-actions button {
        font-size: 12px;
        padding: 5px 10px;
    }
    
    #dossierPeopleHeader {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    #dossierPeopleHeader h2 {
        margin: 0;
    }
    
    .dossier-people-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
        gap: 16px;
        margin-top: 15px;
    }
    /* --- FIM DOS NOVOS ESTILOS DO DOSSIÊ (v6) --- */
    
    .dossier-org-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--cor-principal);
        margin: 20px 0 5px 0;
        padding-bottom: 5px;
        border-bottom: 2px solid var(--cor-borda);
    }
    
    /* Grid de Pessoas (Estilo antigo, renomeado) */
    .dossier-entry-card {
        background: var(--cor-card);
        border: 1px solid var(--cor-borda);
        border-radius: 10px;
        padding: 12px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.07);
        text-align: center;
        font-size: 14px;
        display: flex;
        flex-direction: column;
        gap: 5px;
        transition: box-shadow 0.2s ease, transform 0.2s ease;
    }
    .dossier-entry-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .dossier-entry-card h4 { /* Nome */
        margin: 5px 0 0 0;
        font-size: 17px;
        color: var(--cor-principal);
        font-weight: 700;
        word-wrap: break-word;
    }
    .dossier-entry-card p {
        margin: 0;
        line-height: 1.4;
        word-wrap: break-word;
    }
    .dossier-entry-card .dossier-foto {
        width: 100%;
        height: 180px; 
        object-fit: cover; 
        border-radius: 8px;
        background-color: var(--cor-btn-secundario); 
        color: var(--cor-btn-secundario-texto);
        display: flex;
        align-items: center;
        justify-content: center;
        font-style: italic;
        font-size: 13px;
        overflow: hidden; 
    }
    .dossier-entry-card .dossier-foto img {
         width: 100%;
         height: 100%;
         object-fit: cover; 
    }
    .dossier-entry-card .dossier-actions {
        margin-top: 10px;
        display: flex;
        justify-content: center;
        gap: 6px;
    }
    .dossier-entry-card .dossier-actions button {
        font-size: 12px;
        padding: 5px 10px;
    }

    .modal-overlay {
        display: none; position: fixed; top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.6);
        z-index: 10010;
    }
    .modal-content {
        display: none; position: fixed;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10011; width: 90%; max-width: 500px;
        max-height: 80vh; overflow-y: auto;
    }
    .modal-content input[type=text] {
        width: 100%; box-sizing: border-box; 
    }
    .modal-content label {
        margin-top: 10px;
    }

    @media (max-width: 500px) {
        body { padding: 10px; margin: 10px auto; }
        .top-right-controls { top: 10px; right: 10px; }
        .control-btn { padding: 8px 10px; font-size: 12px; }
        .grid, .grid-venda { grid-template-columns: 1fr; }
        .user-status-display { display: none; }
        
        .dossier-org-grid, .dossier-people-grid {
             grid-template-columns: 1fr; 
        }
    }
  </style>
</head>
<body class="light">
  
  <a href="#" id="logoLink">
    <img id="appLogo" src="logo-dark.png" alt="Hells Angels Logo" class="app-logo">
  </a>

  <div id="welcomeScreen"> 
      <img id="welcomeLogo" src="logo-dark.png" alt="Welcome Logo"> 
      <h2 style="font-weight: 900;">Bem-vindo(a)</h2>
      <p style="margin-bottom: 20px; font-size: 16px;">Calculadora e Registro de Vendas Hells Angels</p>
      <button id="enterBtn" class="primary">Entrar no Site</button>
  </div>
  
  <div class="top-right-controls">
      <button class="control-btn" id="tutorialBtn">💡 Tutorial</button> 
      <button class="control-btn" id="themeBtn">🌙 Modo Noturno</button>
      <button class="control-btn" id="investigacaoBtn" style="display:none; background-color: #0056b3;">🔎 Investigação</button> 
  </div>

  <div id="authScreen" class="card" style="max-width: 400px; margin: 100px auto 20px auto; display: none;">
      <img src="logo-dark.png" alt="Hells Angels Logo" style="display: block; max-height: 100px; margin: 0 auto 20px auto;">
      <h2>Autenticação de Usuário</h2>
      <label for="username">Nome de Usuário:</label>
      <input id="username" type="text" placeholder="Seu nome de usuário">
      <label for="password">Senha:</label>
      <input id="password" type="password" placeholder="Sua senha">
      <div class="actions">
          <button id="loginBtn" class="primary">Entrar</button>
          <button id="registerUserBtn" class="muted">Cadastrar</button>
      </div>
      <a href="#" id="forgotPasswordLink" style="text-align: center; display: block; margin-top: 15px;">Esqueci a Senha</a>
      <p id="authMessage" style="color: var(--cor-erro); margin-top: 10px;"></p>
  </div>

  <div class="card" id="mainCard" style="display:none">
    <div class="header-container">
        <h1 id="mainTitle">Calculadora e Registro de Vendas</h1>
        <span id="userStatus" class="user-status-display" style="display:none;"></span>
        <button id="logoutBtn" class="danger" style="animation: none;">Sair</button>
    </div>
    
    <div class="card-venda">
        <h2>Dados da Venda</h2>
        <div class="grid grid-venda">
            <div>
                <label for="nomeCliente">Nome:</label>
                <input id="nomeCliente" type="text" value="">
            </div>
            <div>
                <label for="dataVenda">Data e Horário:</label>
                <input id="dataVenda" type="text" readonly> 
            </div>
            <div>
                <label for="organizacao">Organização:</label>
                <input id="organizacao" type="text" value="" list="sugestoesOrganizacao">
                <p class="suggestion-tip">Digite para ver sugestões de organizações.</p>
                <datalist id="sugestoesOrganizacao">
                    <option value="Hells Angels"></option>
                    <option value="Serpents"></option> <option value="Nox"></option> <option value="NKT"></option> <option value="Ruptura"></option> <option value="Midnight"></option> <option value="Meraki"></option> <option value="Lotus"></option> <option value="Hydra"></option> <option value="Hooligans"></option> <option value="Families"></option> <option value="Cartel"></option> <option value="Blood Street"></option> <option value="Blood Reapers"></option> <option value="Blue Diamond"></option> <option value="Black Heart"></option> <option value="Ballas"></option> <option value="Aura"></option> <option value="Anarquia"></option> <option value="8 Anjo"></option> <option value="Vagos"></option> <option value="Vertice"></option> <option value="Void"></option> <option value="Solo"></option>
                </datalist>
            </div>
            <div>
                <label for="organizacaoTipo">Opção (CNPJ/CPF):</label>
                <select id="organizacaoTipo">
                    <option value="CNPJ">CNPJ (Obrigatório)</option>
                    <option value="CPF">CPF (Opcional)</option>
                    <option value="OUTROS">Outros (Opcional)</option>
                </select>
            </div>
            <div>
                <label for="telefone">Telefone:</label>
                <input id="telefone" type="text" value="" maxlength="13"> 
            </div>
            
            <div>
                <label for="negociadoras">Negociadoras:</label>
                <input id="negociadoras" type="text" value="">
            </div>
            
            <div>
                <label for="carroVeiculo">Carro (Opcional):</label>
                <input id="carroVeiculo" type="text" value="">
            </div>
            <div>
                <label for="placaVeiculo">Placa(s) (Opcional):</label>
                <input id="placaVeiculo" type="text" value="">
                <p class="suggestion-tip">Separe múltiplas placas por vírgula.</p>
            </div>
            
            <div>
                <label for="vendaValorObs">Cargo:</label>
                <input id="vendaValorObs" type="text" value="">
            </div>
        </div>
    </div>
    
    <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--cor-borda);">

    <h2>Cálculo de Produtos</h2>
    <p class="small">Informe quantos produtos deseja fabricar/vender e escolha o tipo de valor.</p>

    <div class="grid">
      <div>
        <label for="qtyTickets">Quantidade de Tickets</label>
        <input id="qtyTickets" type="number" min="0" value="">
      </div>
      <div>
        <label for="qtyTablets">Quantidade de Tablets</label>
        <input id="qtyTablets" type="number" min="0" value="">
      </div>
      <div>
        <label for="qtyNitro">Quantidade de Nitro</label>
        <input id="qtyNitro" type="number" min="0" value="">
      </div>
      <div>
        <label for="tipoValor">Tipo de Valor</label>
        <select id="tipoValor">
          <option value="limpo">Dinheiro Limpo</option>
          <option value="sujo">Dinheiro Sujo</option>
          <option value="limpo_alianca">Limpo (Aliança)</option>
          <option value="sujo_alianca">Sujo (Aliança)</option>
        </select>
      </div>
    </div>

    <div class="actions">
      <button id="calcBtn" class="primary">Calcular</button>
      <button id="resetBtn" class="muted">Limpar Campos</button>
      <button id="registerBtn" class="success">Registrar Venda</button>
      <button id="toggleHistoryBtn" class="muted">Ver Histórico</button>
      <button id="csvBtn" class="muted">Exportar CSV</button>
      <button id="discordBtnCalc" class="muted">Discord</button>
      <button id="adminPanelBtn" class="muted" style="display:none; background-color: #ffb3d9;">Painel Admin</button>
    </div>

    <div id="resultsContainer">
      <div id="results" style="margin-top:16px;display:none">
        <h3>Totais necessários</h3>
        <table>
          <thead><tr><th>Material</th><th>Quantidade total</th></tr></thead>
          <tbody id="resultsBody"></tbody>
        </table>

        <h3>Valores Estimados</h3>
        <table>
          <thead><tr><th>Produto</th><th>Valor Total</th></tr></thead>
          <tbody id="valuesBody"></tbody>
          <tfoot>
            <tr><th>Total Geral</th><th id="valorTotalGeral">R$ 0</th></tr>
          </tfoot>
        </table>
        <p class="result-note" style="font-size: 12px; margin-top: 8px;">Os valores variam conforme o tipo selecionado (limpo, sujo, aliança).</p>
      </div>
    </div>
  </div>
  
  <div class="card" id="adminPanel" style="display:none;">
      <h2>Painel do Administrador (Hierarquia)</h2>
      
      <div class="actions" style="margin-top: 0; margin-bottom: 15px; justify-content: flex-end;">
          <button id="toggleCalcBtnAdmin" class="muted">Voltar à Calculadora</button>
      </div>
      
      <h3>Gerenciamento de Usuários</h3>
      <p style="font-size: 13px;">Altere a permissão de usuários. Você não pode alterar sua própria tag. O usuário "snow" está oculto.</p>
      <div class="history-table-wrapper">
          
          <table id="adminUserTable">
              <thead>
                  <tr>
                      <th style="width: 45%;">Usuário (Nome)</th>
                      <th style="width: 40%;">Permissão (Tag)</th>
                      <th style="width: 15%;">Ações</th>
                  </tr>
              </thead>
              <tbody id="adminUserListBody">
                  <tr><td colspan="3" style="text-align: center;">Carregando usuários...</td></tr>
              </tbody>
          </table>

      </div>

      <h3 style="margin-top: 20px;">Controles de Layout Global</h3>
      <p style="font-size: 13px;">Habilite ou desabilite recursos para todos os usuários do site em tempo real.</p>
      <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
          <label style="display: flex; align-items: center; gap: 8px; margin: 0;">
              <input type="checkbox" id="layoutToggleNightMode" style="width: auto;">
              Habilitar o botão "Modo Noturno" para todos
          </label>
          <label style="display: flex; align-items: center; gap: 8px; margin: 0;">
              <input type="checkbox" id="layoutToggleBottomPanel" style="width: auto;">
              Ligar "Painel Inferior" para todos
          </label>
      </div>
      
      <h3 style="margin-top: 20px;">Ações de Dossiê</h3>
      <p style="font-size: 13px;">Se você tem vendas antigas, clique no botão abaixo UMA VEZ para copiá-las para o novo sistema de Dossiê.</p>
      <button id="migrateDossierBtn" class="danger" style="animation: none;">Migrar Vendas Antigas para Dossiê</button>
      
  </div>


  <div class="card" id="historyCard" style="display:none">
      <div id="historyBackground" class="card">
        <h2>Histórico de Vendas Registradas</h2>
        <img id="historyImg" src="logo-dark.png" alt="Fundo Histórico"> 
        <input type="text" id="filtroHistorico" placeholder="🔍 Pesquisar no histórico (Nome, Data, Item, etc.)" style="margin-bottom: 10px; width: 100%;">
        <div class="actions">
          <button id="clearHistoryBtn" class="muted">Limpar Histórico</button>
          <button id="toggleCalcBtn" class="muted">Voltar à Calculadora</button>
        </div>
        <div class="history-table-wrapper"><table id="historicoVendas">
          <thead>
              <tr>
                  <th>Data/Hora</th>
                  <th>Cliente</th>
                  <th>Organização/Tipo</th>
                  <th>Telefone</th>
                  <th>Produtos (Unidade)</th>
                  <th>Valor Total</th>
                  <th>Negociadoras</th>
                  <th>Registrado Por</th> 
                  <th>Ações</th> 
              </tr>
          </thead>
          <tbody id="salesHistory"></tbody>
        </table></div>
      </div>
  </div>
  
  <div class="card" id="dossierCard" style="display:none">
      
      <div id="dossierOrgContainer">
          <h2>Sistema de Investigação (Bases)</h2>
          <div class="actions" style="margin-top: 0; margin-bottom: 10px;">
              <input type="text" id="filtroDossierOrgs" placeholder="🔍 Buscar por Organização..." style="margin: 0; flex-grow: 1;">
              <button id="addOrgBtn" class="success" style="animation: none; margin-left: 10px;">+ Adicionar Base</button>
              <button id="toggleCalcBtnDossier" class="muted">Voltar à Calculadora</button>
          </div>
          <div id="dossierOrgGrid" class="dossier-org-grid" style="margin-top: 15px;">
              <p>Carregando bases...</p>
          </div>
      </div>
      
      <div id="dossierPeopleContainer" style="display:none;">
          <div id="dossierPeopleHeader">
              <h2 id="dossierPeopleTitle">Membros</h2>
              <button id="dossierVoltarBtn" class="muted">← Voltar para Bases</button>
          </div>
           <div class="actions" style="margin-top: 0; margin-bottom: 10px;">
              <input type="text" id="filtroDossierPeople" placeholder="🔍 Buscar por Nome, Carro ou Placa(s)..." style="margin: 0; flex-grow: 1;">
              <button id="addPessoaBtn" class="success" style="animation: none; margin-left: 10px;">+ Adicionar Pessoa</button>
          </div>
          <div id="dossierPeopleGrid" class="dossier-people-grid" style="margin-top: 15px;">
              <p>Carregando membros...</p>
          </div>
      </div>
  </div>
  
  
  <div id="toast-container"></div>
  
  <div id="bottomPanel">
      <span>Este é o painel inferior. O conteúdo pode ser personalizado.</span>
  </div>
  
  <div id="editDossierOverlay" class="modal-overlay"></div>
  <div id="editDossierModal" class="card modal-content">
      <h2>Editar Entrada do Dossiê</h2>
      <input type="hidden" id="editDossierOrg">
      <input type="hidden" id="editDossierId">
      
      <label for="editDossierNome">Nome:</label>
      <input type="text" id="editDossierNome">
      
      <label for="editDossierNumero">Número:</label>
      <input type="text" id="editDossierNumero" maxlength="13">
      
      <label for="editDossierCargo">Cargo:</label>
      <input type="text" id="editDossierCargo">
      
      <label for="editDossierCarro">Carro:</label>
      <input type="text" id="editDossierCarro">
      
      <label for="editDossierPlacas">Placa(s):</label>
      <input type="text" id="editDossierPlacas" style="text-transform: uppercase;">
      
      <label for="editDossierFotoUrl">Foto URL:</label>
      <input type="text" id="editDossierFotoUrl" placeholder="Cole o link da imagem aqui (ex: https://i.imgur.com/...)">
      
      <div class="actions" style="margin-top: 20px;">
          <button id="saveDossierBtn" class="success">Salvar</button>
          <button id="cancelDossierBtn" class="muted">Cancelar</button>
      </div>
  </div>
  
  <div id="addDossierOverlay" class="modal-overlay"></div>
  <div id="addDossierModal" class="card modal-content">
      <h2>Adicionar Pessoa ao Dossiê</h2>
      
      <label for="addDossierOrganizacao">Organização: (Automático)</label>
      <input type="text" id="addDossierOrganizacao" readonly disabled>
      
      <label for="addDossierNome">Nome:</label>
      <input type="text" id="addDossierNome">
      
      <label for="addDossierNumero">Número:</label>
      <input type="text" id="addDossierNumero" maxlength="13">
      
      <label for="addDossierCargo">Cargo:</label>
      <input type="text" id="addDossierCargo">
      
      <label for="addDossierCarro">Carro:</label>
      <input type="text" id="addDossierCarro">
      
      <label for="addDossierPlacas">Placa(s):</label>
      <input type="text" id="addDossierPlacas" style="text-transform: uppercase;">
      
      <label for="addDossierFotoUrl">Foto URL:</label>
      <input type="text" id="addDossierFotoUrl" placeholder="Cole o link da imagem aqui (ex: https://i.imgur.com/...)">
      
      <div class="actions" style="margin-top: 20px;">
          <button id="saveNewDossierBtn" class="success">Salvar Nova Pessoa</button>
          <button id="cancelNewDossierBtn" class="muted">Cancelar</button>
      </div>
  </div>
  
  <div id="orgModalOverlay" class="modal-overlay"></div>
  <div id="orgModal" class="card modal-content">
      <h2 id="orgModalTitle">Adicionar Nova Base</h2>
      <input type="hidden" id="editOrgId">
      
      <label for="orgNome">Nome da Organização:</label>
      <input type="text" id="orgNome">
      
      <label for="orgFotoUrl">Foto URL (Link da imagem da base):</label>
      <input type="text" id="orgFotoUrl" placeholder="Cole o link da imagem aqui (ex: https://i.imgur.com/...)">
      
      <label for="orgInfo">Informações da Base (Opcional):</label>
      <textarea id="orgInfo" placeholder="Qualquer informação relevante sobre a base..."></textarea>
      
      <div class="actions" style="margin-top: 20px;">
          <button id="saveOrgBtn" class="success">Salvar</button>
          <button id="cancelOrgBtn" class="muted">Cancelar</button>
          <button id="deleteOrgBtn" class="danger" style="display: none; margin-left: auto; animation: none;">Apagar Base</button>
      </div>
  </div>
  
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, sendPasswordResetEmail, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, set, push, onValue, remove, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    
    const firebaseConfig = {
      // ########## ATENÇÃO!! ##########
      // COLE SUA NOVA CHAVE DE API AQUI
      apiKey: "AIzaSyCPNd9INqIfqG1-rjaYAlz988RLDZvL528", 
      // ########## ATENÇÃO!! ##########
      authDomain: "hells-angels-438c2.firebaseapp.com",
      databaseURL: "https.://hells-angels-438c2-default-rtdb.firebaseio.com/",
      projectId: "hells-angels-438c2",
      storageBucket: "hells-angels-438c2.firebasestorage.app",
      messagingSenderId: "429406215315",
      appId: "1:429406215315:web:96b68b172247824b308166",
      measurementId: "G-CR415MEY32"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    
    let vendas = [];
    let vendaEmEdicaoId = null;
    let vendaOriginalRegistradoPor = null;
    let vendaOriginalRegistradoPorId = null;
    let vendaOriginalTimestamp = null;
    let vendaOriginalDataHora = null;
    
    let currentUser = null;
    let currentUserData = null; 
    
    // Variáveis Globais do Dossiê
    let globalAllOrgs = []; // Guarda as infos das ORGs (Bases)
    let globalCurrentPeople = []; // Guarda as infos das Pessoas da Org selecionada
    
    const perUnit = {
      tickets: { dinheiro_sujo: 525 },
      tablets: { cobre: 20, plastico: 40, fita_adesiva: 2, lixo_eletronico: 2 },
      nitro: { aluminio: 20, cobre: 20, vidro: 45, fita_adesiva: 1, porca: 1, parafuso: 1 }
    };
    
    const valores = {
      tablets: { limpo: 17000, sujo: 20000, limpo_alianca: 15000, sujo_alianca: 18000 },
      tickets: { limpo: 9800, sujo: 11700, limpo_alianca: 8000, sujo_alianca: 10000 },
      nitro: { limpo: 42500, sujo: 50000, limpo_alianca: 38000, sujo_alianca: 45000 }
    };
    
    const valorDescricao = {
        'limpo': 'Dinheiro Limpo',
        'sujo': 'Dinheiro Sujo',
        'limpo_alianca': 'Limpo (Aliança)',
        'sujo_alianca': 'Sujo (Aliança)'
    };

    const logoLightModeSrc = "logo-dark.png";
    const logoDarkModeSrc = "logo-dark.png";
    const historyBackgroundSrc = "logo-dark.png";
    const welcomeLogoSrc = "logo-dark.png";
    
    const els = {
      qtyTickets: document.getElementById('qtyTickets'),
      qtyTablets: document.getElementById('qtyTablets'),
      qtyNitro: document.getElementById('qtyNitro'),
      tipoValor: document.getElementById('tipoValor'),
      nomeCliente: document.getElementById('nomeCliente'),
      organizacao: document.getElementById('organizacao'),
      organizacaoTipo: document.getElementById('organizacaoTipo'),
      telefone: document.getElementById('telefone'),
      carroVeiculo: document.getElementById('carroVeiculo'), // NOVO
      placaVeiculo: document.getElementById('placaVeiculo'),
      negociadoras: document.getElementById('negociadoras'),
      vendaValorObs: document.getElementById('vendaValorObs'),
      dataVenda: document.getElementById('dataVenda'),
      filtroHistorico: document.getElementById('filtroHistorico'),
      resultsBody: document.getElementById('resultsBody'),
      valuesBody: document.getElementById('valuesBody'),
      valorTotalGeral: document.getElementById('valorTotalGeral'),
      results: document.getElementById('results'),
      mainCard: document.getElementById('mainCard'),
      historyCard: document.getElementById('historyCard'),
      salesHistory: document.getElementById('salesHistory'),
      calcBtn: document.getElementById('calcBtn'),
      resetBtn: document.getElementById('resetBtn'),
      registerBtn: document.getElementById('registerBtn'),
      toggleHistoryBtn: document.getElementById('toggleHistoryBtn'),
      toggleCalcBtn: document.getElementById('toggleCalcBtn'),
      clearHistoryBtn: document.getElementById('clearHistoryBtn'),
      csvBtn: document.getElementById('csvBtn'),
      discordBtnCalc: document.getElementById('discordBtnCalc'),
      themeBtn: document.getElementById('themeBtn'),
      tutorialBtn: document.getElementById('tutorialBtn'),
      logoLink: document.getElementById('logoLink'),
      appLogo: document.getElementById('appLogo'),
      historyImg: document.getElementById('historyImg'),
      welcomeScreen: document.getElementById('welcomeScreen'),
      enterBtn: document.getElementById('enterBtn'),
      welcomeLogo: document.getElementById('welcomeLogo'),
      authScreen: document.getElementById('authScreen'),
      username: document.getElementById('username'),
      password: document.getElementById('password'),
      loginBtn: document.getElementById('loginBtn'),
      registerUserBtn: document.getElementById('registerUserBtn'),
      authMessage: document.getElementById('authMessage'),
      logoutBtn: document.getElementById('logoutBtn'),
      mainTitle: document.getElementById('mainTitle'),
      forgotPasswordLink: document.getElementById('forgotPasswordLink'),
      
      adminPanelBtn: document.getElementById('adminPanelBtn'),
      adminPanel: document.getElementById('adminPanel'),
      adminUserListBody: document.getElementById('adminUserListBody'),
      toggleCalcBtnAdmin: document.getElementById('toggleCalcBtnAdmin'), // NOVO
      layoutToggleNightMode: document.getElementById('layoutToggleNightMode'),
      layoutToggleBottomPanel: document.getElementById('layoutToggleBottomPanel'),
      bottomPanel: document.getElementById('bottomPanel'),
      userStatus: document.getElementById('userStatus'),
      
      // --- Elementos do Dossiê (v6) ---
      investigacaoBtn: document.getElementById('investigacaoBtn'),
      dossierCard: document.getElementById('dossierCard'),
      toggleCalcBtnDossier: document.getElementById('toggleCalcBtnDossier'),
      
      dossierOrgContainer: document.getElementById('dossierOrgContainer'),
      filtroDossierOrgs: document.getElementById('filtroDossierOrgs'),
      addOrgBtn: document.getElementById('addOrgBtn'),
      dossierOrgGrid: document.getElementById('dossierOrgGrid'),
      
      dossierPeopleContainer: document.getElementById('dossierPeopleContainer'),
      dossierPeopleTitle: document.getElementById('dossierPeopleTitle'),
      dossierVoltarBtn: document.getElementById('dossierVoltarBtn'),
      filtroDossierPeople: document.getElementById('filtroDossierPeople'),
      addPessoaBtn: document.getElementById('addPessoaBtn'),
      dossierPeopleGrid: document.getElementById('dossierPeopleGrid'),
      
      migrateDossierBtn: document.getElementById('migrateDossierBtn'),
      
      // Modal de Pessoas
      editDossierOverlay: document.getElementById('editDossierOverlay'),
      editDossierModal: document.getElementById('editDossierModal'),
      editDossierOrg: document.getElementById('editDossierOrg'),
      editDossierId: document.getElementById('editDossierId'),
      editDossierNome: document.getElementById('editDossierNome'),
      editDossierNumero: document.getElementById('editDossierNumero'),
      editDossierCargo: document.getElementById('editDossierCargo'),
      editDossierCarro: document.getElementById('editDossierCarro'), // NOVO
      editDossierPlacas: document.getElementById('editDossierPlacas'),
      editDossierFotoUrl: document.getElementById('editDossierFotoUrl'),
      saveDossierBtn: document.getElementById('saveDossierBtn'),
      cancelDossierBtn: document.getElementById('cancelDossierBtn'),
      
      addDossierOverlay: document.getElementById('addDossierOverlay'),
      addDossierModal: document.getElementById('addDossierModal'),
      addDossierOrganizacao: document.getElementById('addDossierOrganizacao'),
      addDossierNome: document.getElementById('addDossierNome'),
      addDossierNumero: document.getElementById('addDossierNumero'),
      addDossierCargo: document.getElementById('addDossierCargo'),
      addDossierCarro: document.getElementById('addDossierCarro'), // NOVO
      addDossierPlacas: document.getElementById('addDossierPlacas'),
      addDossierFotoUrl: document.getElementById('addDossierFotoUrl'),
      saveNewDossierBtn: document.getElementById('saveNewDossierBtn'),
      cancelNewDossierBtn: document.getElementById('cancelNewDossierBtn'),
      
      // Modal de Organizações
      orgModalOverlay: document.getElementById('orgModalOverlay'),
      orgModal: document.getElementById('orgModal'),
      orgModalTitle: document.getElementById('orgModalTitle'),
      editOrgId: document.getElementById('editOrgId'),
      orgNome: document.getElementById('orgNome'),
      orgFotoUrl: document.getElementById('orgFotoUrl'),
      orgInfo: document.getElementById('orgInfo'),
      saveOrgBtn: document.getElementById('saveOrgBtn'),
      cancelOrgBtn: document.getElementById('cancelOrgBtn'),
      deleteOrgBtn: document.getElementById('deleteOrgBtn')
    };
    
    const globalLayoutRef = ref(db, 'configuracoesGlobais/layout');
    onValue(globalLayoutRef, (snapshot) => {
        if (!snapshot.exists()) {
            console.warn("Nó /configuracoesGlobais/layout não encontrado. Criando...");
            if(currentUserData && currentUserData.tag.toUpperCase() === 'ADMIN') {
                 set(globalLayoutRef, { enableNightMode: true, enableBottomPanel: false });
            }
            return;
        }
        const settings = snapshot.val();
        
        if (els.themeBtn) {
            els.themeBtn.style.display = settings.enableNightMode ? 'block' : 'none';
            if (!settings.enableNightMode) {
                document.body.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            }
        }
        
        if (els.bottomPanel) {
            els.bottomPanel.style.display = settings.enableBottomPanel ? 'flex' : 'none';
        }
    }, (error) => {
        if(error.code !== "PERMISSION_DENIED") {
            showToast(`Erro ao carregar configurações de layout: ${error.message}`, 'error');
        }
    });
    
    
    const formatCurrency = (value) => {
      if (typeof value !== 'number' || isNaN(value)) { return 'R$ 0'; }
      return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 0, maximumFractionDigits: 0 });
    };

    const capitalizeText = (text) => {
        if (!text) return '';
        if (text === 'dinheiro sujo') return 'Dinheiro Sujo';
        return text.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
    };
    
    const showToast = (message, type = 'default', duration = 3000) => {
      const toastContainer = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      toastContainer.appendChild(toast);
      setTimeout(() => { toast.classList.add('show'); }, 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 300);
      }, duration);
    };
    
    const getQty = (element) => Math.max(0, parseInt(element.value) || 0);

    const PREFIX = "(055) ";
    const phoneMask = (value) => {
        let digits = value.replace(/\D/g, ""); 
        if (digits.startsWith("055")) { digits = digits.substring(3); }
        digits = digits.substring(0, 6); 
        let formattedNumber = digits.length > 3 ? `${digits.substring(0, 3)}-${digits.substring(3)}` : digits;
        return PREFIX + formattedNumber;
    }

    const camposTelefone = [els.telefone, els.editDossierNumero, els.addDossierNumero];
    
    camposTelefone.forEach(campo => {
        if (campo) {
            campo.addEventListener('input', (e) => {
                e.target.value = e.target.value.length < PREFIX.length ? PREFIX : phoneMask(e.target.value);
            });
            campo.addEventListener('focus', (e) => {
                if (!e.target.value || e.target.value.length < PREFIX.length) { e.target.value = PREFIX; }
            });
        }
    });

    const atualizarRelogio = () => {
        const agora = new Date();
        const dia = String(agora.getDate()).padStart(2, '0');
        const mes = String(agora.getMonth() + 1).padStart(2, '0');
        const ano = agora.getFullYear();
        const horas = String(agora.getHours()).padStart(2, '0');
        const minutos = String(agora.getMinutes()).padStart(2, '0');
        els.dataVenda.value = `${dia}/${mes}/${ano} ${horas}:${minutos}`;
    };
    atualizarRelogio();
    setInterval(atualizarRelogio, 30000);
    
    const camposParaCapitalizar = [ 
        els.nomeCliente, els.organizacao, els.negociadoras, els.vendaValorObs, 
        els.carroVeiculo, // NOVO
        els.addDossierNome, els.addDossierOrganizacao, els.addDossierCargo, 
        els.addDossierCarro, // NOVO
        els.editDossierNome, els.editDossierCargo, 
        els.editDossierCarro, // NOVO
        els.orgNome 
    ];
    camposParaCapitalizar.forEach(campo => {
      if (campo) {
        campo.addEventListener('input', (e) => {
          const { selectionStart, selectionEnd } = e.target;
          e.target.value = capitalizeText(e.target.value);
          e.target.setSelectionRange(selectionStart, selectionEnd);
        });
      }
    });
    
    const calculate = () => {
      const { qtyTickets, qtyTablets, qtyNitro, tipoValor } = {
        qtyTickets: getQty(els.qtyTickets),
        qtyTablets: getQty(els.qtyTablets),
        qtyNitro: getQty(els.qtyNitro),
        tipoValor: els.tipoValor.value
      };
      const totalQuantities = { cobre: 0, plastico: 0, fita_adesiva: 0, lixo_eletronico: 0, aluminio: 0, vidro: 0, porca: 0, parafuso: 0, dinheiro_sujo: 0 };
      let totalValue = 0;
      const productValues = [];
      
      if (qtyTablets > 0) {
        totalQuantities.cobre += qtyTablets * perUnit.tablets.cobre;
        totalQuantities.plastico += qtyTablets * perUnit.tablets.plastico;
        totalQuantities.fita_adesiva += qtyTablets * perUnit.tablets.fita_adesiva;
        totalQuantities.lixo_eletronico += qtyTablets * perUnit.tablets.lixo_eletronico;
        const value = qtyTablets * valores.tablets[tipoValor];
        totalValue += value;
        productValues.push({ product: `Tablets (${qtyTablets} und.)`, value });
      }
      if (qtyTickets > 0) {
        totalQuantities.dinheiro_sujo += qtyTickets * perUnit.tickets.dinheiro_sujo;
        const value = qtyTickets * valores.tickets[tipoValor];
        totalValue += value;
        productValues.push({ product: `Tickets (${qtyTickets} und.)`, value });
      }
      if (qtyNitro > 0) {
        totalQuantities.aluminio += qtyNitro * perUnit.nitro.aluminio;
        totalQuantities.cobre += qtyNitro * perUnit.nitro.cobre;
        totalQuantities.vidro += qtyNitro * perUnit.nitro.vidro;
        totalQuantities.fita_adesiva += qtyNitro * perUnit.nitro.fita_adesiva;
        totalQuantities.porca += qtyNitro * perUnit.nitro.porca;
        totalQuantities.parafuso += qtyNitro * perUnit.nitro.parafuso;
        const value = qtyNitro * valores.nitro[tipoValor];
        totalValue += value;
        productValues.push({ product: `Nitro (${qtyNitro} und.)`, value });
      }
      
      const hasQuantities = qtyTickets > 0 || qtyTablets > 0 || qtyNitro > 0;
      if (hasQuantities) {
        updateResults(totalQuantities, productValues, totalValue);
      } else {
        els.results.style.display = 'none';
      }
      return { qtyTickets, qtyTablets, qtyNitro, totalValue, tipoValor, hasQuantities };
    };
    
    const updateResults = (totals, productValues, totalValue) => {
      els.results.style.display = 'block';
      els.resultsBody.innerHTML = Object.entries(totals)
        .filter(([, value]) => value > 0)
        .map(([material, value]) => `<tr><td>${capitalizeText(material.replace(/_/g, ' '))}</td><td>${value.toLocaleString('pt-BR')}</td></tr>`)
        .join('');
      els.valuesBody.innerHTML = productValues.map(item => `<tr><td>${item.product}</td><td>${formatCurrency(item.value)}</td></tr>`).join('');
      els.valorTotalGeral.textContent = formatCurrency(totalValue);
    };
    
    const clearAllFields = () => {
      ['qtyTickets', 'qtyTablets', 'qtyNitro', 'nomeCliente', 'organizacao', 'negociadoras', 'vendaValorObs', 'carroVeiculo', 'placaVeiculo'].forEach(id => els[id].value = ''); // 'carroVeiculo' adicionado
      els.tipoValor.value = 'limpo';
      els.organizacaoTipo.value = 'CNPJ';
      els.telefone.value = '';
      els.results.style.display = 'none';
      document.querySelectorAll('.input-invalido').forEach(input => input.classList.remove('input-invalido'));
      
      if (vendaEmEdicaoId) {
        vendaEmEdicaoId = null;
        vendaOriginalRegistradoPor = null;
        vendaOriginalRegistradoPorId = null;
        vendaOriginalTimestamp = null;
        vendaOriginalDataHora = null;
        els.registerBtn.textContent = 'Registrar Venda';
      }
    };
    
    const validateFields = () => {
        let isValid = true;
        const camposObrigatorios = [ els.nomeCliente, els.telefone, els.negociadoras ];
        
        camposObrigatorios.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('input-invalido');
                isValid = false;
            } else {
                field.classList.remove('input-invalido');
            }
        });
        
        const tipoOrg = els.organizacaoTipo.value;
        if (tipoOrg === 'CNPJ') {
            if (!els.organizacao.value.trim()) {
                els.organizacao.classList.add('input-invalido');
                isValid = false;
            } else {
                els.organizacao.classList.remove('input-invalido');
            }
        } else {
            els.organizacao.classList.remove('input-invalido');
        }
        
        return isValid;
    };
    
    // Adiciona entrada de pessoa ao dossiê (caminho: /dossies/{orgName})
    const addDossierEntry = (vendaData) => { // Assinatura mudada
        const org = vendaData.organizacao.trim();
        if (!org) {
            return;
        }
        
        const dossierEntry = {
            nome: vendaData.cliente,
            numero: vendaData.telefone,
            organizacao: org,
            cargo: vendaData.vendaValorObs || 'N/A',
            carro: vendaData.carro || 'N/A', // NOVO
            placas: vendaData.placas || 'N/A', // MODIFICADO
            fotoUrl: '',
            data: vendaData.dataHora
        };
        
        // Salva a PESSOA no nó /dossies/
        const dossierRef = ref(db, `dossies/${org}`);
        push(dossierRef, dossierEntry)
            .catch(err => console.error("Erro ao salvar dossiê:", err));
            
        // Garante que a ORGANIZAÇÃO exista no nó /organizacoes/
        const orgRef = ref(db, `organizacoes/${org}`);
        get(orgRef).then(snapshot => {
            if (!snapshot.exists()) {
                set(orgRef, {
                    nome: org,
                    fotoUrl: '',
                    info: 'Base registrada automaticamente via Venda.'
                });
            }
        });
    };
    
    
    const registerVenda = () => {
      const { qtyTickets, qtyTablets, qtyNitro, totalValue, tipoValor, hasQuantities } = calculate();
      if (!hasQuantities) {
        showToast("É necessário calcular a venda antes de registrar.", "error");
        return;
      }
      if (!validateFields()) {
          showToast("Preencha os campos obrigatórios (marcados em vermelho).", "error");
          return;
      }
      if (!currentUser || !currentUser.displayName) {
          showToast("Erro: Usuário não autenticado.", "error");
          return;
      }
      
      const carro = els.carroVeiculo.value.trim(); // NOVO
      const placas = els.placaVeiculo.value.trim().toUpperCase();
      
      const newVenda = {
        timestamp: vendaEmEdicaoId ? vendaOriginalTimestamp : Date.now(), 
        dataHora: vendaEmEdicaoId ? vendaOriginalDataHora : new Date().toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' }),
        cliente: els.nomeCliente.value.trim(),
        organizacao: els.organizacao.value.trim(),
        organizacaoTipo: els.organizacaoTipo.value,
        telefone: els.telefone.value.trim(),
        negociadoras: els.negociadoras.value.trim(),
        vendaValorObs: els.vendaValorObs.value.trim(),
        carro: carro, // NOVO
        placas: placas, // NOVO
        qtyTickets, qtyTablets, qtyNitro,
        valorTotal: totalValue,
        tipoValor,
        registradoPor: vendaEmEdicaoId ? vendaOriginalRegistradoPor : currentUser.displayName,
        registradoPorId: vendaEmEdicaoId ? vendaOriginalRegistradoPorId : currentUser.uid 
      };

      const operation = vendaEmEdicaoId ? set(ref(db, `vendas/${vendaEmEdicaoId}`), newVenda) : push(ref(db, 'vendas'), newVenda);
      operation
          .then(() => {
              showToast(`Venda ${vendaEmEdicaoId ? 'atualizada' : 'registrada'} com sucesso!`, "success");
              
              if (!vendaEmEdicaoId) {
                  addDossierEntry(newVenda); // Assinatura mudada
              }
              
              clearAllFields();
          })
          .catch((error) => {
              showToast(`Erro ao registrar venda: ${error.message}`, "error");
          });
    };

    const editVenda = (id) => {
        const venda = vendas.find(v => v.id === id);
        if (!venda) return;
        
        els.nomeCliente.value = venda.cliente || '';
        els.organizacao.value = venda.organizacao || '';
        els.organizacaoTipo.value = venda.organizacaoTipo || 'CNPJ';
        els.telefone.value = venda.telefone || '';
        els.negociadoras.value = venda.negociadoras || '';
        els.vendaValorObs.value = venda.vendaValorObs || '';
        els.tipoValor.value = venda.tipoValor || 'limpo';
        
        els.carroVeiculo.value = venda.carro || ''; // NOVO
        els.placaVeiculo.value = venda.placas || ''; // CORRIGIDO
        
        els.qtyTickets.value = venda.qtyTickets || 0;
        els.qtyTablets.value = venda.qtyTablets || 0;
        els.qtyNitro.value = venda.qtyNitro || 0;
        
        calculate(); 
        
        vendaEmEdicaoId = id;
        vendaOriginalRegistradoPor = venda.registradoPor;
        vendaOriginalRegistradoPorId = venda.registradoPorId;
        vendaOriginalTimestamp = venda.timestamp;
        vendaOriginalDataHora = venda.dataHora;
        
        els.registerBtn.textContent = 'Atualizar Venda';
        toggleView('main'); 
        showToast(`Editando venda de ${venda.cliente}`, "default");
    };

    const removeVenda = (id) => {
        if (confirm("Tem certeza que deseja remover esta venda?")) {
            remove(ref(db, `vendas/${id}`))
                .then(() => {
                    showToast("Venda removida.", "success");
                })
                .catch((error) => {
                    showToast(`Erro ao remover: ${error.message}`, "error");
                });
        }
    };

    const copyToClipboard = (text) => {
        if (!text) return;
        navigator.clipboard.writeText(text)
          .then(() => {
            showToast("Mensagem copiada para o Discord!", "success");
          })
          .catch(err => {
            showToast("Erro ao copiar.", "error");
          });
    };

    const buildDiscordMessage = (vendaData) => {
        // 'carro' e 'placas' removidos do Discord por enquanto
        const { cliente, data, orgTipo, org, tel, produtos, valor, obs, negociadoras, cargo } = vendaData;
        return `
\`\`\`
Nome: ${cliente}
Data: ${data}
Organização: ${orgTipo} - ${org}
Telefone: ${tel}
Cargo: ${cargo}
Produto (Unidade): ${produtos}
Venda Valor: ${valor} (${obs})
Negociadoras: ${negociadoras}
\`\`\`
        `.trim();
    };

    const copyDiscordMessage = (isFromHistory = false, venda = null) => {
        let messageData;
        if (isFromHistory) {
            let produtos = [];
            if (venda.qtyTickets > 0) produtos.push(`Tickets (${venda.qtyTickets})`);
            if (venda.qtyTablets > 0) produtos.push(`Tablet (${venda.qtyTablets})`);
            if (venda.qtyNitro > 0) produtos.push(`Nitros (${venda.qtyNitro})`);
            
            messageData = {
                cliente: venda.cliente,
                data: venda.dataHora.split(', ')[0],
                orgTipo: venda.organizacaoTipo,
                org: venda.organizacao,
                tel: venda.telefone,
                cargo: venda.vendaValorObs || 'N/A',
                produtos: produtos.join(', '),
                valor: formatCurrency(venda.valorTotal || 0),
                obs: valorDescricao[venda.tipoValor],
                negociadoras: venda.negociadoras
            };
        } else {
            const { qtyTickets, qtyTablets, qtyNitro, totalValue, tipoValor, hasQuantities } = calculate();
            if (!hasQuantities) { showToast("Calcule uma venda antes de copiar.", "error"); return; }
            if (!validateFields()) { showToast("Preencha os dados da venda antes de copiar.", "error"); return; }
            
            let produtos = [];
            if (qtyTickets > 0) produtos.push(`Tickets (${qtyTickets})`);
            if (qtyTablets > 0) produtos.push(`Tablet (${qtyTablets})`);
            if (qtyNitro > 0) produtos.push(`Nitros (${qtyNitro})`);
            
            const dataAtual = new Date().toLocaleDateString('pt-BR');

            messageData = {
                cliente: els.nomeCliente.value.trim(),
                data: dataAtual,
                orgTipo: els.organizacaoTipo.value,
                org: els.organizacao.value.trim(),
                tel: els.telefone.value.trim(),
                cargo: els.vendaValorObs.value.trim() || 'N/A',
                produtos: produtos.join(', '),
                valor: formatCurrency(totalValue),
                obs: valorDescricao[tipoValor],
                negociadoras: els.negociadoras.value.trim()
            };
        }
        copyToClipboard(buildDiscordMessage(messageData));
    };

    const toggleView = (viewName) => {
        els.mainCard.style.display = 'none';
        els.historyCard.style.display = 'none';
        els.adminPanel.style.display = 'none';
        els.dossierCard.style.display = 'none';
        
        document.body.classList.remove('history-view-active', 'dossier-view-active');

        if (viewName === 'history') {
            document.body.classList.add('history-view-active');
            els.historyCard.style.display = 'block';
            els.historyImg.src = historyBackgroundSrc;
            els.filtroHistorico.value = ''; 
            displaySalesHistory(vendas); 
        } else if (viewName === 'admin') {
            els.adminPanel.style.display = 'block';
            loadAdminPanel();
        } else if (viewName === 'dossier') {
            document.body.classList.add('dossier-view-active');
            els.dossierCard.style.display = 'block';
            showDossierOrgs(); // Ponto de entrada do Dossiê v6
        } else {
            els.mainCard.style.display = 'block';
        }
    };

    const displaySalesHistory = (history) => {
        els.salesHistory.innerHTML = '';
        if (!currentUserData) { 
             return;
        }

        let vendasFiltradas = history;
        const userTagUpper = currentUserData.tag.toUpperCase();
        
        if (userTagUpper === 'VISITANTE') {
            vendasFiltradas = history.filter(v => v.registradoPorId === currentUser.uid);
        }

        if (vendasFiltradas.length === 0) {
            const row = els.salesHistory.insertRow();
            row.insertCell().colSpan = 9; 
            row.cells[0].textContent = "Nenhuma venda para exibir.";
            row.cells[0].style.textAlign = 'center';
            row.cells[0].style.padding = '20px';
            return;
        }

        vendasFiltradas.sort((a, b) => b.timestamp - a.timestamp);

        vendasFiltradas.forEach(venda => {
            const row = els.salesHistory.insertRow();
            
            const [data, hora] = venda.dataHora.split(', ');
            row.insertCell().innerHTML = `<span class="history-datetime-line">${data}</span><span class="history-datetime-line">${hora}</span>`;
            row.insertCell().textContent = capitalizeText(venda.cliente);
            row.insertCell().textContent = `${capitalizeText(venda.organizacao)} (${venda.organizacaoTipo})`;
            row.insertCell().textContent = venda.telefone;

            let produtos = [];
            if (venda.qtyTickets > 0) produtos.push(`${venda.qtyTickets} Tickets`);
            if (venda.qtyTablets > 0) produtos.push(`${venda.qtyTablets} Tablets`);
            if (venda.qtyNitro > 0) produtos.push(`${venda.qtyNitro} Nitro`);
            row.insertCell().textContent = capitalizeText(produtos.join(', '));
            
            const valorCell = row.insertCell();
            valorCell.className = 'valor-total-cell';
            valorCell.innerHTML = `<span>${formatCurrency(venda.valorTotal || 0)}</span><span class="valor-obs-text">(${valorDescricao[venda.tipoValor] || 'N/A'})</span>`;

            row.insertCell().textContent = capitalizeText(venda.negociadoras);
            
            const registradoPorCell = row.insertCell();
            if (venda.registradoPor && venda.registradoPor.toLowerCase() === 'snow') {
                registradoPorCell.textContent = '???';
                registradoPorCell.style.fontStyle = 'italic';
                registradoPorCell.style.color = '#aaa';
            } else {
                registradoPorCell.textContent = venda.registradoPor || 'Desconhecido';
            }
            
            const actionsCell = row.insertCell();
            actionsCell.className = 'history-actions-cell';

            const podeModificar = 
                (userTagUpper === 'ADMIN') ||
                (userTagUpper === 'HELLS' && venda.registradoPorId === currentUser.uid) ||
                (userTagUpper === 'VISITANTE' && venda.registradoPorId === currentUser.uid);

            actionsCell.innerHTML = `
                <button class="action-btn muted edit-btn" ${!podeModificar ? 'disabled' : ''}>Editar</button>
                <button class="action-btn danger delete-btn" ${!podeModificar ? 'disabled' : ''}>Deletar</button>
                <button class="action-btn muted discord-btn">Discord</button>
            `;
            if(podeModificar){
                actionsCell.querySelector('.edit-btn').onclick = () => editVenda(venda.id);
                actionsCell.querySelector('.delete-btn').onclick = () => removeVenda(venda.id);
            }
            actionsCell.querySelector('.discord-btn').onclick = () => copyDiscordMessage(true, venda);
        });
    };

    const filterHistory = () => {
        const query = els.filtroHistorico.value.toLowerCase().trim();
        const filteredVendas = vendas.filter(v => 
            Object.values(v).some(val => String(val).toLowerCase().includes(query)) ||
            (v.qtyTickets > 0 && `tickets`.includes(query)) ||
            (v.qtyTablets > 0 && `tablets`.includes(query)) ||
            (v.qtyNitro > 0 && `nitro`.includes(query))
        );
        displaySalesHistory(query ? filteredVendas : vendas);
    };

    const exportToCsv = () => {
        if (vendas.length === 0) {
            showToast("Nenhum dado para exportar.", "error");
            return;
        }
        const headers = ["Data/Hora", "Cliente", "Organização", "Tipo", "Telefone", "Negociadoras", "Cargo", "Carro", "Placas", "Qtde Tickets", "Qtde Tablets", "Qtde Nitro", "Valor Total", "Tipo Valor", "Registrado Por"];
        const csvRows = vendas.map(v => [`"${v.dataHora}"`, `"${v.cliente}"`, `"${v.organizacao}"`, `"${v.organizacaoTipo}"`, `"${v.telefone}"`, `"${v.negociadoras}"`, `"${v.vendaValorObs}"`, `"${v.carro}"`, `"${v.placas}"`, v.qtyTickets, v.qtyTablets, v.qtyNitro, v.valorTotal, `"${valorDescricao[v.tipoValor]}"`, `"${v.registradoPor}"`].join(','));
        const csvContent = [headers.join(','), ...csvRows].join('\n');
        const link = document.createElement('a');
        link.href = URL.createObjectURL(new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }));
        link.download = `historico_vendas_HA_${new Date().toISOString().slice(0, 10)}.csv`;
        link.click();
        showToast("Histórico exportado para CSV!", "success");
    };

    const clearHistory = () => {
        if (currentUserData.tag.toUpperCase() !== 'ADMIN') {
            showToast("Apenas administradores podem limpar o histórico.", "error");
            return;
        }
        if (confirm("ATENÇÃO: Deseja APAGAR TODO o histórico de vendas? Esta ação é irreversível.")) {
            remove(ref(db, 'vendas'))
                .then(() => showToast("Histórico limpado.", "success"))
                .catch(e => showToast(`Erro: ${e.message}`, "error"));
        }
    };
    
    // **** INÍCIO DAS FUNÇÕES DO DOSSIÊ (v6) ****
    
    // Nível 1: Mostra as Organizações (Bases)
    const showDossierOrgs = async () => {
        els.dossierOrgContainer.style.display = 'block';
        els.dossierPeopleContainer.style.display = 'none';
        els.dossierOrgGrid.innerHTML = '<p>Carregando organizações...</p>';
        globalAllOrgs = [];
        
        try {
            const orgsInfoRef = ref(db, 'organizacoes');
            const orgsInfoSnap = await get(orgsInfoRef);
            const orgsInfo = orgsInfoSnap.exists() ? orgsInfoSnap.val() : {};
            
            const orgsPessoasRef = ref(db, 'dossies');
            const orgsPessoasSnap = await get(orgsPessoasRef);
            const orgsPessoas = orgsPessoasSnap.exists() ? orgsPessoasSnap.val() : {};

            const allOrgNames = new Set([...Object.keys(orgsInfo), ...Object.keys(orgsPessoas)]);
            
            if (allOrgNames.size === 0) {
                els.dossierOrgGrid.innerHTML = '<p>Nenhuma organização encontrada. Clique em "+ Adicionar Base" para começar.</p>';
                return;
            }
            
            globalAllOrgs = Array.from(allOrgNames).map(orgName => {
                return {
                    id: orgName,
                    nome: orgName,
                    ...orgsInfo[orgName]
                };
            }).sort((a, b) => a.nome.localeCompare(b.nome));
            
            displayOrgs(globalAllOrgs);
            
        } catch (error) {
            els.dossierOrgGrid.innerHTML = `<p style="color: var(--cor-erro);">Erro ao carregar organizações: ${error.message}</p>`;
        }
    };
    
    // Renderiza os cards das Organizações (Bases)
    const displayOrgs = (orgs) => {
        els.dossierOrgGrid.innerHTML = '';
        if (orgs.length === 0) {
            els.dossierOrgGrid.innerHTML = '<p>Nenhuma organização encontrada para este filtro.</p>';
            return;
        }
        
        orgs.forEach(org => {
            const card = document.createElement('div');
            card.className = 'dossier-org-card';
            card.dataset.orgName = org.nome;
            
            const fotoDiv = document.createElement('div');
            fotoDiv.className = 'dossier-org-foto';
            if (org.fotoUrl) {
                const img = document.createElement('img');
                img.src = org.fotoUrl;
                img.alt = `Base de ${org.nome}`;
                fotoDiv.appendChild(img);
            } else {
                fotoDiv.textContent = 'Sem Foto da Base';
            }
            
            const nomeH4 = document.createElement('h4');
            nomeH4.textContent = org.nome;
            
            const infoP = document.createElement('p');
            infoP.textContent = org.info || '(Sem informações da base)';
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'dossier-org-actions';
            actionsDiv.innerHTML = `<button class="action-btn muted edit-org-btn" data-org-id="${org.id}">✏️ Editar Base</button>`;
            
            card.appendChild(fotoDiv);
            card.appendChild(nomeH4);
            card.appendChild(infoP);
            card.appendChild(actionsDiv);
            
            actionsDiv.querySelector('.edit-org-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                openEditOrgModal(org.id);
            });
            
            card.addEventListener('click', () => {
                showDossierPeople(org.nome);
            });
            
            els.dossierOrgGrid.appendChild(card);
        });
    };
    
    // Filtra a lista de Organizações (Bases)
    const filterOrgs = () => {
        const query = els.filtroDossierOrgs.value.toLowerCase().trim();
        if (!query) {
            displayOrgs(globalAllOrgs);
            return;
        }
        const filteredOrgs = globalAllOrgs.filter(org => 
            org.nome.toLowerCase().includes(query)
        );
        displayOrgs(filteredOrgs);
    };

    // Nível 2: Mostra as Pessoas (Membros) de uma Org
    const showDossierPeople = async (orgName) => {
        els.dossierOrgContainer.style.display = 'none';
        els.dossierPeopleContainer.style.display = 'block';
        els.dossierPeopleTitle.textContent = `Membros: ${orgName}`;
        els.dossierPeopleGrid.innerHTML = '<p>Carregando membros...</p>';
        
        els.addPessoaBtn.dataset.orgName = orgName;
        
        globalCurrentPeople = [];
        
        try {
            const peopleRef = ref(db, `dossies/${orgName}`);
            const snapshot = await get(peopleRef);
            
            if (!snapshot.exists()) {
                els.dossierPeopleGrid.innerHTML = '<p>Nenhum membro registrado para esta organização.</p>';
                return;
            }
            
            const peopleData = snapshot.val();
            for (const personId in peopleData) {
                globalCurrentPeople.push({
                    id: personId,
                    org: orgName,
                    ...peopleData[personId]
                });
            }
            
            globalCurrentPeople.sort((a, b) => (a.nome || '').localeCompare(b.nome || ''));
            displayPeople(globalCurrentPeople);
            
        } catch (error) {
            els.dossierPeopleGrid.innerHTML = `<p style="color: var(--cor-erro);">Erro ao carregar membros: ${error.message}</p>`;
        }
    };
    
    // Renderiza os cards das Pessoas (Membros)
    const displayPeople = (people) => {
        els.dossierPeopleGrid.innerHTML = '';
        if (people.length === 0) {
            els.dossierPeopleGrid.innerHTML = '<p>Nenhum membro encontrado para este filtro.</p>';
            return;
        }

        people.forEach(entry => {
            const card = document.createElement('div');
            card.className = 'dossier-entry-card';
            
            const fotoDiv = document.createElement('div');
            fotoDiv.className = 'dossier-foto';
            if (entry.fotoUrl) {
                const img = document.createElement('img');
                img.src = entry.fotoUrl;
                img.alt = `Foto de ${entry.nome}`;
                fotoDiv.appendChild(img);
            } else {
                fotoDiv.textContent = 'Sem Foto';
            }
            
            const nomeH4 = document.createElement('h4');
            nomeH4.textContent = entry.nome || '(Sem Nome)';
            
            const numeroP = document.createElement('p');
            numeroP.textContent = entry.numero || '(Sem Número)';

            const cargoP = document.createElement('p');
            cargoP.innerHTML = `<strong>Cargo:</strong> ${entry.cargo || 'N/A'}`;
            
            const carroP = document.createElement('p'); // NOVO
            carroP.innerHTML = `<strong>Carro:</strong> ${entry.carro || 'N/A'}`;
            
            const placasP = document.createElement('p');
            placasP.innerHTML = `<strong>Placa(s):</strong> ${entry.placas || 'N/A'}`;
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'dossier-actions';
            actionsDiv.innerHTML = `
                <button class="action-btn muted edit-dossier-btn" data-org="${entry.org}" data-id="${entry.id}">✏️ Editar</button>
                <button class="action-btn danger delete-dossier-btn" data-org="${entry.org}" data-id="${entry.id}">❌ Apagar</button>
            `;
            
            card.appendChild(fotoDiv);
            card.appendChild(nomeH4);
            card.appendChild(numeroP);
            card.appendChild(cargoP);
            card.appendChild(carroP); // NOVO
            card.appendChild(placasP);
            card.appendChild(actionsDiv);
            
            els.dossierPeopleGrid.appendChild(card);
        });
    };

    // Filtra a lista de Pessoas (Membros)
    const filterPeople = () => {
        const query = els.filtroDossierPeople.value.toLowerCase().trim();
        if (!query) {
            displayPeople(globalCurrentPeople);
            return;
        }
        
        const filteredPeople = globalCurrentPeople.filter(entry => {
            const nome = entry.nome ? entry.nome.toLowerCase() : '';
            const placas = entry.placas ? entry.placas.toLowerCase() : '';
            const cargo = entry.cargo ? entry.cargo.toLowerCase() : '';
            const carro = entry.carro ? entry.carro.toLowerCase() : ''; // NOVO
            return nome.includes(query) || placas.includes(query) || cargo.includes(query) || carro.includes(query); // NOVO
        });
        
        displayPeople(filteredPeople);
    };
    
    // --- Funções dos Modais de Organização (Base) ---
    
    const openAddOrgModal = () => {
        els.orgModalTitle.textContent = "Adicionar Nova Base";
        els.editOrgId.value = '';
        els.orgNome.value = '';
        els.orgNome.disabled = false;
        els.orgFotoUrl.value = '';
        els.orgInfo.value = '';
        els.deleteOrgBtn.style.display = 'none';
        
        document.querySelectorAll('.input-invalido').forEach(el => el.classList.remove('input-invalido'));
        
        els.orgModalOverlay.style.display = 'block';
        els.orgModal.style.display = 'block';
        els.orgNome.focus();
    };
    
    const openEditOrgModal = (orgId) => {
        const org = globalAllOrgs.find(o => o.id === orgId);
        if (!org) {
            showToast("Erro: Organização não encontrada.", "error");
            return;
        }
        
        els.orgModalTitle.textContent = "Editar Base";
        els.editOrgId.value = org.id;
        els.orgNome.value = org.nome;
        els.orgNome.disabled = true;
        els.orgFotoUrl.value = org.fotoUrl || '';
        els.orgInfo.value = org.info || '';
        els.deleteOrgBtn.style.display = 'inline-block';
        
        document.querySelectorAll('.input-invalido').forEach(el => el.classList.remove('input-invalido'));

        els.orgModalOverlay.style.display = 'block';
        els.orgModal.style.display = 'block';
        els.orgFotoUrl.focus();
    };
    
    const closeOrgModal = () => {
        els.orgModalOverlay.style.display = 'none';
        els.orgModal.style.display = 'none';
    };
    
    const saveOrg = () => {
        const orgNome = capitalizeText(els.orgNome.value.trim());
        const orgId = els.editOrgId.value || orgNome;
        
        if (!orgId) {
            showToast("O Nome da Organização é obrigatório.", "error");
            els.orgNome.classList.add('input-invalido');
            return;
        }
        els.orgNome.classList.remove('input-invalido');
        
        const orgData = {
            nome: orgNome,
            fotoUrl: els.orgFotoUrl.value.trim(),
            info: els.orgInfo.value.trim()
        };
        
        const orgRef = ref(db, `organizacoes/${orgId}`);
        set(orgRef, orgData)
            .then(() => {
                showToast("Base salva com sucesso!", "success");
                closeOrgModal();
                showDossierOrgs();
            })
            .catch(err => showToast(`Erro ao salvar: ${err.message}`, "error"));
    };
    
    const deleteOrg = () => {
        const orgId = els.editOrgId.value;
        if (!orgId) return;
        
        if (confirm(`ATENÇÃO:\n\nIsso apagará as INFORMAÇÕES DA BASE "${orgId}".\n\nIsso NÃO apagará os membros (pessoas) que estão dentro dela.\n\nDeseja continuar?`)) {
            remove(ref(db, `organizacoes/${orgId}`))
                .then(() => {
                    showToast("Informações da base removidas.", "success");
                    closeOrgModal();
                    showDossierOrgs();
                })
                .catch(err => showToast(`Erro: ${err.message}`, "error"));
        }
    };
    
    // --- Funções dos Modais de Pessoa (Membros) ---
    
    const openAddDossierModal = (orgName) => {
        els.addDossierOrganizacao.value = orgName;
        els.addDossierNome.value = '';
        els.addDossierNumero.value = '';
        els.addDossierCargo.value = '';
        els.addDossierCarro.value = ''; // NOVO
        els.addDossierPlacas.value = '';
        els.addDossierFotoUrl.value = '';
        
        document.querySelectorAll('.input-invalido').forEach(el => el.classList.remove('input-invalido'));
        
        els.addDossierOverlay.style.display = 'block';
        els.addDossierModal.style.display = 'block';
        els.addDossierNome.focus();
    };
    
    const closeAddDossierModal = () => {
        els.addDossierOverlay.style.display = 'none';
        els.addDossierModal.style.display = 'none';
    };
    
    const saveNewDossierEntry = () => {
        const org = els.addDossierOrganizacao.value.trim();
        if (!org) {
            showToast("Erro: Organização não definida.", "error");
            return;
        }

        const agora = new Date();
        const dia = String(agora.getDate()).padStart(2, '0');
        const mes = String(agora.getMonth() + 1).padStart(2, '0');
        const ano = agora.getFullYear();
        const horas = String(agora.getHours()).padStart(2, '0');
        const minutos = String(agora.getMinutes()).padStart(2, '0');

        const newEntry = {
            organizacao: org,
            nome: els.addDossierNome.value.trim(),
            numero: els.addDossierNumero.value.trim(),
            cargo: els.addDossierCargo.value.trim(),
            carro: els.addDossierCarro.value.trim(), // NOVO
            placas: els.addDossierPlacas.value.trim().toUpperCase(),
            fotoUrl: els.addDossierFotoUrl.value.trim(),
            data: `${dia}/${mes}/${ano} ${horas}:${minutos}`
        };
        
        const dossierRef = ref(db, `dossies/${org}`);
        push(dossierRef, newEntry)
            .then(() => {
                showToast("Nova pessoa salva no dossiê!", "success");
                closeAddDossierModal();
                showDossierPeople(org);
            })
            .catch((error) => {
                showToast(`Erro ao salvar: ${error.message}`, "error");
            });
    };
    
    const openEditDossierModal = (org, id) => {
        const entry = globalCurrentPeople.find(e => e.id === id && e.org === org);
        if (!entry) {
            showToast("Erro: Entrada não encontrada.", "error");
            return;
        }
        
        els.editDossierOrg.value = entry.org;
        els.editDossierId.value = entry.id;
        els.editDossierNome.value = entry.nome || '';
        els.editDossierNumero.value = entry.numero || '';
        els.editDossierCargo.value = entry.cargo || '';
        els.editDossierCarro.value = entry.carro || ''; // NOVO
        els.editDossierPlacas.value = entry.placas || '';
        els.editDossierFotoUrl.value = entry.fotoUrl || '';
        
        els.editDossierOverlay.style.display = 'block';
        els.editDossierModal.style.display = 'block';
    };

    const closeEditDossierModal = () => {
        els.editDossierOverlay.style.display = 'none';
        els.editDossierModal.style.display = 'none';
    };
    
    const saveDossierChanges = () => {
        const org = els.editDossierOrg.value;
        const id = els.editDossierId.value;
        
        if (!org || !id) {
            showToast("Erro: ID da entrada perdido.", "error");
            return;
        }
        
        const originalEntry = globalCurrentPeople.find(e => e.id === id && e.org === org);
        if (!originalEntry) {
            showToast("Erro: Entrada original não encontrada.", "error");
            return;
        }
        
        const updatedEntry = {
            ...originalEntry,
            nome: els.editDossierNome.value.trim(),
            numero: els.editDossierNumero.value.trim(),
            cargo: els.editDossierCargo.value.trim(),
            carro: els.editDossierCarro.value.trim(), // NOVO
            placas: els.editDossierPlacas.value.trim().toUpperCase(),
            fotoUrl: els.editDossierFotoUrl.value.trim()
        };
        
        delete updatedEntry.id;
        delete updatedEntry.org;

        const entryRef = ref(db, `dossies/${org}/${id}`);
        set(entryRef, updatedEntry)
            .then(() => {
                showToast("Dossiê atualizado com sucesso!", "success");
                closeEditDossierModal();
                showDossierPeople(org);
            })
            .catch((error) => {
                showToast(`Erro ao salvar: ${error.message}`, "error");
            });
    };
    
    const removeDossierEntry = (orgName, entryId) => {
        const userTagUpper = currentUserData.tag.toUpperCase();
        if (!currentUserData || (userTagUpper !== 'ADMIN' && userTagUpper !== 'HELLS')) {
            showToast("Apenas Admin/Hells podem remover entradas.", "error");
            return;
        }
        
        if (confirm("Tem certeza que deseja remover esta PESSOA do dossiê?")) {
            const entryRef = ref(db, `dossies/${orgName}/${entryId}`);
            remove(entryRef)
                .then(() => {
                    showToast("Pessoa removida do dossiê.", "success");
                    showDossierPeople(orgName);
                })
                .catch((error) => {
                    showToast(`Erro ao remover: ${error.message}`, "error");
                });
        }
    };
    
    const migrateVendasToDossier = async () => {
        if (!confirm("Isso irá copiar *todas* as vendas com organização para o Dossiê de Pessoas. Deseja continuar?")) {
            return;
        }
        
        showToast("Iniciando migração... Isso pode demorar.", "default", 5000);
        els.migrateDossierBtn.disabled = true;
        els.migrateDossierBtn.textContent = "Migrando...";
        
        try {
            const vendasRef = ref(db, 'vendas');
            const snapshot = await get(vendasRef);
            
            if (!snapshot.exists()) {
                showToast("Nenhuma venda encontrada para migrar.", "error");
                return;
            }
            
            const vendas = snapshot.val();
            let count = 0;
            
            for (const vendaId in vendas) {
                const venda = vendas[vendaId];
                const org = venda.organizacao ? venda.organizacao.trim() : null;
                
                if (org) {
                    const dossierEntry = {
                        nome: venda.cliente,
                        numero: venda.telefone,
                        organizacao: org,
                        cargo: venda.vendaValorObs || 'N/A (Migrado)',
                        carro: venda.carro || 'N/A (Migrado)', // NOVO
                        placas: venda.placas || 'N/A (Migrado)', // CORRIGIDO
                        fotoUrl: '',
                        data: venda.dataHora
                    };
                    
                    const dossierRef = ref(db, `dossies/${org}/${vendaId}`);
                    await set(dossierRef, dossierEntry);
                    
                    const orgRef = ref(db, `organizacoes/${org}`);
                    const orgSnap = await get(orgRef);
                    if (!orgSnap.exists()) {
                         await set(orgRef, {
                            nome: org,
                            fotoUrl: '',
                            info: 'Base registrada automaticamente via Migração.'
                        });
                    }
                    
                    count++;
                }
            }
            
            showToast(`Migração concluída! ${count} registros adicionados/atualizados.`, "success");
            
        } catch (error) {
            showToast(`Erro na migração: ${error.message}`, "error");
        } finally {
            els.migrateDossierBtn.disabled = false;
            els.migrateDossierBtn.textContent = "Migrar Vendas Antigas para Dossiê";
        }
    };
    
    // **** FIM DAS FUNÇÕES DO DOSSIÊ (v6) ****
    
    const toggleTheme = () => {
        const isDarkMode = document.body.classList.toggle('dark');
        localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        updateLogoAndThemeButton(isDarkMode);
    };

    const updateLogoAndThemeButton = (isDarkMode) => {
        els.themeBtn.textContent = isDarkMode ? '☀️ Modo Claro' : '🌙 Modo Noturno';
        els.appLogo.src = isDarkMode ? logoDarkModeSrc : logoLightModeSrc;
        els.welcomeLogo.src = welcomeLogoSrc;
        els.historyImg.src = historyBackgroundSrc;
    };

    const tourSteps = [
        { element: 'qtyTickets', title: '1/5: Quantidades', content: 'Comece inserindo a quantidade de produtos que deseja calcular ou vender.' },
        { element: 'tipoValor', title: '2/5: Tipo de Valor', content: 'Selecione o tipo de pagamento. Isso afeta o preço final de cada item.' },
        { element: 'calcBtn', title: '3/5: Calcular', content: 'Clique aqui para ver os materiais necessários e o valor total da venda.' },
        { element: 'registerBtn', title: '4.5: Registrar Venda', content: 'Após calcular, preencha os dados do cliente e clique para salvar no histórico.' },
        { element: 'toggleHistoryBtn', title: '5/5: Ver Histórico', content: 'Acesse o histórico para ver, editar, apagar ou copiar vendas antigas.' }
    ];
    let currentStepIndex = -1; let currentTooltip = null; let tourOverlay = null;
    const clearTour = () => { if(tourOverlay) { tourOverlay.classList.remove('active'); setTimeout(() => { if (tourOverlay && tourOverlay.parentNode) tourOverlay.parentNode.removeChild(tourOverlay); tourOverlay = null; }, 300); } if (currentTooltip) { currentTooltip.classList.remove('active'); setTimeout(() => { if (currentTooltip && currentTooltip.parentNode) currentTooltip.parentNode.removeChild(currentTooltip); currentTooltip = null; }, 300); } document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight')); currentStepIndex = -1; };
    const showNextTourStep = () => { if (currentStepIndex >= 0) { document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight')); if(currentTooltip) currentTooltip.classList.remove('active'); } currentStepIndex++; if (currentStepIndex >= tourSteps.length) { showToast("Tutorial concluído!", "success"); clearTour(); return; } const step = tourSteps[currentStepIndex]; const targetElement = els[step.element]; if (!targetElement) { clearTour(); return; } if (currentStepIndex === 0) { tourOverlay = document.createElement('div'); tourOverlay.id = 'tour-overlay'; document.body.appendChild(tourOverlay); setTimeout(() => tourOverlay.classList.add('active'), 10); } targetElement.classList.add('tour-highlight'); if(currentTooltip && currentTooltip.parentNode) document.body.removeChild(currentTooltip); currentTooltip = document.createElement('div'); currentTooltip.className = 'tour-tooltip'; currentTooltip.innerHTML = `<h4>${step.title}</h4><p>${step.content}</p><div><button class="tourNextBtn">${currentStepIndex === tourSteps.length - 1 ? 'Finalizar' : 'Próximo'}</button><button class="tourSkipBtn">Pular</button></div>`; document.body.appendChild(currentTooltip); const rect = targetElement.getBoundingClientRect(); let top = rect.top < currentTooltip.offsetHeight + 20 ? rect.bottom + window.scrollY + 10 : rect.top + window.scrollY - currentTooltip.offsetHeight - 10; let left = Math.max(10, Math.min(rect.left + window.scrollX, window.innerWidth - currentTooltip.offsetWidth - 20)); currentTooltip.style.top = `${top}px`; currentTooltip.style.left = `${left}px`; setTimeout(() => currentTooltip.classList.add('active'), 10); currentTooltip.querySelector('.tourNextBtn').onclick = showNextTourStep; currentTooltip.querySelector('.tourSkipBtn').onclick = clearTour; targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); };

    // Event Listeners (Calculadora)
    els.calcBtn.onclick = calculate;
    els.resetBtn.onclick = clearAllFields;
    els.registerBtn.onclick = registerVenda;
    els.toggleHistoryBtn.onclick = () => toggleView('history');
    els.toggleCalcBtn.onclick = () => toggleView('main');
    els.clearHistoryBtn.onclick = clearHistory;
    els.csvBtn.onclick = exportToCsv;
    els.themeBtn.onclick = toggleTheme;
    els.tutorialBtn.onclick = () => { if (!currentUser) { showToast("Faça login para iniciar o tutorial.", "default"); return; } toggleView('main'); showNextTourStep(); };
    els.discordBtnCalc.onclick = () => copyDiscordMessage(false, null);
    els.filtroHistorico.addEventListener('input', filterHistory);
    
    // Event Listeners (Dossiê v6)
    els.investigacaoBtn.onclick = () => toggleView('dossier');
    els.toggleCalcBtnDossier.onclick = () => toggleView('main');
    
    // Nível 1 (Orgs)
    els.filtroDossierOrgs.addEventListener('input', filterOrgs);
    els.addOrgBtn.onclick = openAddOrgModal;
    
    // Nível 2 (Pessoas)
    els.dossierVoltarBtn.onclick = () => showDossierOrgs();
    els.filtroDossierPeople.addEventListener('input', filterPeople);
    els.addPessoaBtn.onclick = () => {
        const orgName = els.addPessoaBtn.dataset.orgName;
        if(orgName) { openAddDossierModal(orgName); }
    };

    els.dossierPeopleGrid.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-dossier-btn');
        const deleteBtn = e.target.closest('.delete-dossier-btn');
        
        if (deleteBtn) {
            const org = deleteBtn.dataset.org;
            const id = deleteBtn.dataset.id;
            removeDossierEntry(org, id);
        }
        if (editBtn) {
            const org = editBtn.dataset.org;
            const id = editBtn.dataset.id;
            openEditDossierModal(org, id);
        }
    });
    
    // Modais de Pessoas
    els.saveDossierBtn.onclick = saveDossierChanges;
    els.cancelDossierBtn.onclick = closeEditDossierModal;
    els.editDossierOverlay.onclick = closeEditDossierModal;
    
    els.saveNewDossierBtn.onclick = saveNewDossierEntry;
    els.cancelNewDossierBtn.onclick = closeAddDossierModal;
    els.addDossierOverlay.onclick = closeAddDossierModal;
    
    // Modais de Orgs
    els.saveOrgBtn.onclick = saveOrg;
    els.deleteOrgBtn.onclick = deleteOrg;
    els.cancelOrgBtn.onclick = closeOrgModal;
    els.orgModalOverlay.onclick = closeOrgModal;

    // Admin
    els.migrateDossierBtn.onclick = migrateVendasToDossier;
    els.toggleCalcBtnAdmin.onclick = () => toggleView('main'); // NOVO
    
    const deleteUser = (uid, displayName) => {
        if (confirm(`ATENÇÃO:\n\nTem certeza que deseja apagar o usuário "${displayName}"?\n\nIsso removerá o registro dele do banco de dados (e suas permissões).\n\nIMPORTANTE: Para apagar o LOGIN dele permanentemente, você ainda precisará ir ao painel "Authentication" do Firebase.`)) {
            
            const userRef = ref(db, `usuarios/${uid}`);
            remove(userRef)
                .then(() => {
                    showToast(`Usuário "${displayName}" apagado do banco de dados.`, 'success');
                    loadAdminPanel();
                })
                .catch((error) => {
                    showToast(`Erro ao apagar usuário: ${error.message}`, 'error');
                });
        }
    };

    const loadAdminPanel = async () => {
        els.adminUserListBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">Carregando...</td></tr>';
        
        try {
            const usersSnapshot = await get(ref(db, 'usuarios'));
            if (!usersSnapshot.exists()) {
                els.adminUserListBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">Nenhum usuário encontrado.</td></tr>';
                return;
            }
            
            const usersList = [];
            usersSnapshot.forEach(userSnap => {
                const userData = userSnap.val();
                if (userData.displayName && userData.displayName.toLowerCase() === 'snow') {
                    return;
                }
                usersList.push({ uid: userSnap.key, ...userData });
            });

            const tagOrder = { 'ADMIN': 1, 'HELLS': 2, 'Visitante': 3 };
            usersList.sort((a, b) => {
                const tagA = (tagOrder[a.tag.toUpperCase()] || 4);
                const tagB = (tagOrder[b.tag.toUpperCase()] || 4);
                if (tagA !== tagB) {
                    return tagA - tagB;
                }
                return (a.displayName || '').localeCompare(b.displayName || '');
            });

            els.adminUserListBody.innerHTML = '';
            
            usersList.forEach(user => {
                const uid = user.uid;
                const userData = user;
                
                const row = els.adminUserListBody.insertRow();
                row.insertCell().textContent = userData.displayName || '(Sem nome)';
                
                const tagCell = row.insertCell();
                
                if (uid === currentUser.uid) {
                    tagCell.textContent = `👑 ${userData.tag} (Você)`;
                } else {
                    const select = document.createElement('select');
                    select.style.width = '100%';
                    select.dataset.uid = uid; 
                    
                    const optVisitante = document.createElement('option');
                    optVisitante.value = 'Visitante';
                    optVisitante.textContent = 'Visitante';
                    select.appendChild(optVisitante);
                    
                    const optHells = document.createElement('option');
                    optHells.value = 'HELLS';
                    optHells.textContent = 'Hells';
                    select.appendChild(optHells);
                    
                    const optAdmin = document.createElement('option');
                    optAdmin.value = 'ADMIN';
                    optAdmin.textContent = '👑 Administrador';
                    select.appendChild(optAdmin);
                    
                    select.value = userData.tag.toUpperCase() === 'HELLS' ? 'HELLS' : (userData.tag.toUpperCase() === 'ADMIN' ? 'ADMIN' : 'Visitante');
                    select.onchange = (e) => updateUserTag(e.target.dataset.uid, e.target.value);
                    tagCell.appendChild(select);
                }
                
                const actionsCell = row.insertCell();
                actionsCell.style.textAlign = 'center';
                actionsCell.style.verticalAlign = 'middle';

                if (uid === currentUser.uid) {
                    actionsCell.textContent = '---';
                } else {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = '❌';
                    deleteBtn.className = 'danger action-btn'; 
                    deleteBtn.style.padding = '5px 8px';
                    deleteBtn.style.fontSize = '14px';
                    deleteBtn.style.lineHeight = '1';
                    
                    deleteBtn.addEventListener('click', () => {
                        deleteUser(uid, userData.displayName);
                    });
                    
                    actionsCell.appendChild(deleteBtn);
                }
            });
            
        } catch (error) {
            showToast(`Erro ao carregar usuários: ${error.message}`, 'error');
            els.adminUserListBody.innerHTML = `<tr><td colspan="3" style="text-align: center;">Erro ao carregar. ${error.message}</td></tr>`;
        }
        
        try {
            const layoutSnapshot = await get(ref(db, 'configuracoesGlobais/layout'));
            if (layoutSnapshot.exists()) {
                const settings = layoutSnapshot.val();
                els.layoutToggleNightMode.checked = settings.enableNightMode;
                els.layoutToggleBottomPanel.checked = settings.enableBottomPanel;
            }
        } catch (error) {
            if(error.code !== "PERMISSION_DENIED") {
                showToast(`Erro ao carregar configurações de layout: ${error.message}`, 'error');
            }
        }
    };
    
    const updateUserTag = (uid, newTag) => {
        const tagRef = ref(db, `usuarios/${uid}/tag`);
        set(tagRef, newTag)
            .then(() => {
                showToast("Permissão do usuário atualizada!", 'success');
            })
            .catch((error) => {
                showToast(`Erro ao atualizar tag: ${error.message}`, 'error');
            });
    };
    
    const updateGlobalLayout = (key, value) => {
        const layoutRef = ref(db, `configuracoesGlobais/layout/${key}`);
        set(layoutRef, value)
            .catch((error) => {
                showToast(`Erro ao salvar configuração: ${error.message}`, 'error');
            });
    };
    
    els.adminPanelBtn.onclick = () => toggleView('admin');
    els.layoutToggleNightMode.onchange = (e) => updateGlobalLayout('enableNightMode', e.target.checked);
    els.layoutToggleBottomPanel.onchange = (e) => updateGlobalLayout('enableBottomPanel', e.target.checked);
    
    
    const handleAuthAction = (isLogin, creds) => {
        const email = creds.username.trim() + "@ha.com";
        const password = creds.password;
        const displayName = creds.username.trim();

        if ((isLogin && (!email || password.length < 6)) || (!isLogin && (!displayName || password.length < 6))) {
            showToast("Verifique os campos. A senha precisa ter no mínimo 6 caracteres.", "error");
            return;
        }

        if (isLogin) {
            signInWithEmailAndPassword(auth, email, password)
                .catch((error) => {
                    const code = error.code;
                    const msg = code === 'auth/invalid-credential' ? "Usuário ou senha incorretos." : `Erro: ${code}`;
                    showToast(msg, "error");
                });
        } else {
            createUserWithEmailAndPassword(auth, email, password)
                .then(userCredential => {
                    const user = userCredential.user;
                    return updateProfile(user, { displayName: displayName })
                        .then(() => {
                            const userRef = ref(db, `usuarios/${user.uid}`);
                            const newUserProfile = { 
                                displayName: displayName,
                                email: user.email,
                                tag: 'Visitante'
                            };
                            return set(userRef, newUserProfile); 
                        });
                })
                .catch((error) => {
                    const code = error.code;
                    const msg = code === 'auth/email-already-in-use' ? "Nome de usuário já existe." : `Erro: ${code}`;
                    showToast(msg, "error");
                });
        }
    };
    
    const authAction = (isLogin) => handleAuthAction(isLogin, {username: els.username.value, password: els.password.value});

    els.loginBtn.onclick = () => authAction(true);
    els.registerUserBtn.onclick = () => authAction(false);
    els.logoutBtn.onclick = () => signOut(auth);
    els.password.addEventListener('keydown', (e) => { if(e.key === 'Enter') authAction(true); });

    els.forgotPasswordLink.onclick = async () => {
        const username = prompt("Digite seu nome de usuário para solicitar a redefinição de senha:");
        if (!username) return;

        const usersRef = ref(db, 'usuarios');
        const snapshot = await get(usersRef);
        let userEmail = null;
        if(snapshot.exists()) {
            snapshot.forEach(child => {
                const userData = child.val();
                if(userData.displayName.toLowerCase() === username.toLowerCase().trim()) {
                    userEmail = userData.email;
                }
            });
        }

        if (userEmail) {
            sendPasswordResetEmail(auth, userEmail)
                .then(() => {
                    alert("Um e-mail de redefinição de senha foi enviado para o endereço associado a este usuário.");
                    showToast("E-mail de redefinição enviado!", "success");
                })
                .catch(err => showToast(`Erro: ${err.message}`, "error"));
        } else {
            showToast("Nome de usuário não encontrado.", "error");
        }
    };


    const configurarInterfacePorTag = (tag) => {
      const tagUpper = tag ? tag.toUpperCase() : 'VISITANTE';
      
      const userStatusEl = els.userStatus;
      if (currentUser && userStatusEl) {
          
          if (currentUser.displayName.toLowerCase() === 'snow') {
              userStatusEl.style.display = 'none';
          } else {
              userStatusEl.textContent = `${currentUser.displayName} (${tag})`;
              userStatusEl.className = 'user-status-display';
              if (tagUpper === 'ADMIN') {
                  userStatusEl.classList.add('tag-admin');
              } else if (tagUpper === 'HELLS') {
                  userStatusEl.classList.add('tag-hells');
              } else {
                  userStatusEl.classList.add('tag-visitante');
              }
              userStatusEl.style.display = 'block';
          }
      }

      if (tagUpper === 'ADMIN') {
        els.clearHistoryBtn.style.display = 'inline-block';
        els.adminPanelBtn.style.display = 'inline-block';
      } else {
        els.clearHistoryBtn.style.display = 'none';
        els.adminPanelBtn.style.display = 'none';
      }
      
      if (tagUpper === 'ADMIN' || tagUpper === 'HELLS') {
          els.investigacaoBtn.style.display = 'block';
      } else {
          els.investigacaoBtn.style.display = 'none';
      }
      
      if (tagUpper !== 'ADMIN') {
          els.adminPanel.style.display = 'none';
      }
    };


    let vendasListener = null; 

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user; 
            const userRef = ref(db, `usuarios/${user.uid}`);
            
            onValue(userRef, (snapshot) => {
                if (snapshot.exists()) {
                    currentUserData = snapshot.val(); 
                } else {
                    const newUserProfile = {
                        displayName: user.displayName, 
                        email: user.email,
                        tag: 'Visitante' 
                    };
                    set(userRef, newUserProfile);
                    currentUserData = newUserProfile; 
                }
                
                configurarInterfacePorTag(currentUserData.tag);
                 
                if(vendasListener) vendasListener(); 
                
                let vendasRef;
                const userTagUpper = currentUserData.tag.toUpperCase();
                
                if (userTagUpper === 'ADMIN' || userTagUpper === 'HELLS') {
                    vendasRef = ref(db, 'vendas');
                } else {
                    vendasRef = query(ref(db, 'vendas'), orderByChild('registradoPorId'), equalTo(currentUser.uid));
                }

                vendasListener = onValue(vendasRef, (vendasSnapshot) => {
                    vendas = [];
                    vendasSnapshot.forEach((child) => {
                        vendas.push({ id: child.key, ...child.val() });
                    });
                    if (els.historyCard.style.display !== 'none') {
                        displaySalesHistory(vendas);
                    }
                }, (error) => {
                    console.error("Erro ao carregar vendas: ", error);
                    if(error.code !== "PERMISSION_DENIED") {
                        showToast("Erro de permissão ao carregar histórico.", "error");
                    }
                });
            }, (error) => {
                console.error("Erro ao ler dados do usuário:", error);
                showToast("Erro fatal ao ler permissões do usuário.", "error");
                configurarInterfacePorTag('Visitante'); 
            });

            els.authScreen.style.display = 'none';
            toggleView('main');

        } else {
            currentUser = null;
            currentUserData = null;
            if (vendasListener) vendasListener(); 
            vendas = []; 
            
            els.authScreen.style.display = 'block';
            els.mainCard.style.display = 'none';
            els.historyCard.style.display = 'none';
            els.adminPanel.style.display = 'none'; 
            els.dossierCard.style.display = 'none';
            if(els.userStatus) els.userStatus.style.display = 'none';
            if(els.investigacaoBtn) els.investigacaoBtn.style.display = 'none';
        }
    });

    // --- Inicialização da UI ---
    const savedTheme = localStorage.getItem('theme') || 'light';
    if(savedTheme === 'dark') {
        document.body.classList.add('dark');
    }
    updateLogoAndThemeButton(savedTheme === 'dark');

    if (localStorage.getItem('hasVisited')) {
        els.welcomeScreen.style.display = 'none';
    } else {
        els.welcomeScreen.classList.add('show');
        els.authScreen.style.display = 'none';
        els.mainCard.style.display = 'none';
    }

    els.enterBtn.onclick = () => {
        localStorage.setItem('hasVisited', 'true');
        els.welcomeScreen.classList.add('hidden');
        setTimeout(() => {
            els.welcomeScreen.style.display = 'none';
        }, 500);
    };
  </script>
</body>
</html>
