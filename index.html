<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <link rel="icon" type="image/png" href="logo-dark.png">
  
  <title>Hells Angels</title>
  <style>
    /* TODO O SEU CSS ORIGINAL FOI MANTIDO AQUI */
    :root {
      --cor-fundo: #fff0f6; --cor-texto: #4a0033; --cor-principal: #e60073;
      --cor-card: #ffffff; --cor-borda: #ffb3d9; --cor-btn-primario: #e60073;
      --cor-btn-texto: #fff; --cor-btn-secundario: #ffd6eb;
      --cor-btn-secundario-texto: #4a0033; --cor-erro: #cc0000;
      --cor-glow-pulsante: rgba(230, 0, 115, 0.8);
    }
    body.dark {
      --cor-fundo: #1a000d; --cor-texto: #ffccf0; --cor-principal: #ff0080; 
      --cor-card: #2c001a; --cor-borda: #e60073; --cor-btn-primario: #ff0080; 
      --cor-btn-texto: #fff; --cor-btn-secundario: #4d002a; 
      --cor-btn-secundario-texto: #ffccf0; --cor-glow-pulsante: rgba(255, 0, 128, 0.6);
    }
    body.dark input[type=number], body.dark input[type=text], body.dark select { background: #33001f; color: var(--cor-texto); border: 1px solid var(--cor-borda); }
    input[list]:focus, input[list]:hover { border-color: var(--cor-principal) !important; box-shadow: 0 0 5px rgba(230, 0, 115, 0.4); }
    input[list] { position: relative; z-index: 1; }
    input[list]::-webkit-calendar-picker-indicator { display: none; }
    .suggestion-tip { font-size: 11px; color: var(--cor-principal); margin-top: 4px; margin-bottom: 0; font-weight: 500; opacity: 0.8; }
    .tour-tooltip { position: absolute; background: var(--cor-principal); color: var(--cor-btn-texto); padding: 15px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-width: 300px; text-align: left; opacity: 0; transition: opacity 0.3s ease, transform 0.3s ease; z-index: 10002; }
    .tour-tooltip.active { opacity: 1; transform: translateY(0); }
    .tour-tooltip h4 { margin: 0 0 5px; font-size: 16px; color: var(--cor-btn-texto); }
    .tour-tooltip p { margin: 0; font-size: 14px; margin-bottom: 10px; }
    .tour-tooltip button { background: var(--cor-btn-secundario); color: var(--cor-btn-secundario-texto); padding: 6px 10px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; margin-right: 8px; }
    .tour-highlight { box-shadow: 0 0 0 3px rgba(230,0,115,0.6), 0 0 10px rgba(230,0,115,0.5); position: relative; z-index: 10001; }
    input.input-invalido, select.input-invalido { border: 2px solid var(--cor-erro) !important; box-shadow: 0 0 4px var(--cor-erro); }
    #logoLink { position: fixed; top: 16px; left: 16px; width: auto; max-height: 80px; cursor: pointer; z-index: 9998; }
    .app-logo { max-height: 80px; width: auto; transition: opacity 0.3s ease, filter 0.3s ease; display: block; }
    #appLogo:hover { filter: drop-shadow(0 0 8px var(--cor-principal)) drop-shadow(0 0 15px var(--cor-glow-pulsante)); opacity: 0.9; }
    #welcomeLogo { max-width: 80%; max-height: 120px; margin-bottom: 25px; display: block; }
    #welcomeScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--cor-card); z-index: 10000; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; transition: opacity 0.5s ease; padding: 20px; box-sizing: border-box; }
    #welcomeScreen.show { display: flex; }
    #welcomeScreen.hidden { opacity: 0; pointer-events: none; }
    #welcomeScreen h2 { font-size: 36px; margin-top: 10px; margin-bottom: 20px; color: var(--cor-principal); }
    #welcomeScreen button { padding: 12px 24px; font-size: 18px; border-radius: 10px; margin-top: 10px; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 960px; margin: 24px auto; padding: 20px; background: var(--cor-fundo); color: var(--cor-texto); transition: background 0.25s ease, color 0.25s ease; }
    h1 { margin: 0 0 12px; font-size: 24px; font-weight: 700; color: var(--cor-principal); text-align: center; flex-grow: 1; }
    h2 { font-size: 20px; font-weight: 600; margin-bottom: 10px; color: var(--cor-principal); }
    h3 { color: var(--cor-principal); font-weight:600; margin-top: 16px; }
    .card { background: var(--cor-card); padding: 18px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid var(--cor-borda); margin-bottom: 20px; }
    label { display: block; margin: 10px 0 6px; font-weight: 600; color: var(--cor-principal); }
    input[type=number], input[type=text], select { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--cor-borda); background: #fff; color: var(--cor-texto); font-size: 14px; box-sizing: border-box; transition: border-color 0.15s ease, box-shadow 0.15s ease; }
    input[type=number] { width: 140px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 14px; margin-top: 12px; }
    .grid-venda { grid-template-columns: 1fr 1fr; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 14px; }
    th, td { padding: 6px; border-bottom: 1px solid var(--cor-borda); text-align: left; }
    th { background: var(--cor-btn-secundario); color: var(--cor-btn-secundario-texto); font-weight: 600; }
    .actions { margin-top: 14px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    button { padding: 8px 14px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 14px; transition: opacity 0.2s ease, box-shadow 0.3s ease; }
    button:hover { opacity: 0.85; }
    .primary, .success { animation: pulse-glow 2s infinite ease-in-out; }
    @keyframes pulse-glow { 0% { box-shadow: 0 0 0 rgba(0, 0, 0, 0); } 50% { box-shadow: 0 0 10px var(--cor-glow-pulsante), 0 0 20px var(--cor-glow-pulsante); } 100% { box-shadow: 0 0 0 rgba(0, 0, 0, 0); } }
    .primary { background: var(--cor-btn-primario); color: var(--cor-btn-texto); }
    .muted { background: var(--cor-btn-secundario); color: var(--cor-btn-secundario-texto); }
    .success { background: #00b33c; color: #fff; }
    .danger { background: var(--cor-erro); color: #fff; }
    .top-right-controls { position: fixed; top: 16px; right: 16px; display: flex; gap: 10px; z-index: 9999; }
    .control-btn { padding: 10px 14px; border-radius: 10px; background: var(--cor-btn-primario); color: var(--cor-btn-texto); font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border: none; transition: opacity 0.2s ease; }
    .control-btn:hover { opacity: 0.85; }
    #historyBackground { background: rgba(255, 255, 255, 0.7); position: relative; padding: 18px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid var(--cor-borda); margin-bottom: 20px; min-height: 400px; overflow: hidden; }
    body.dark #historyBackground { background: rgba(44, 0, 26, 0.7); }
    #historyBackground img { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; height: auto; opacity: 0.3; z-index: 1; object-fit: contain; }
    #historyBackground > * { position: relative; z-index: 2; }
    #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 10005; display: flex; flex-direction: column-reverse; gap: 10px; align-items: flex-end; }
    .toast { background-color: var(--cor-principal); color: var(--cor-btn-texto); padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; transform: translateY(20px); max-width: 300px; min-width: 150px; text-align: center; }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { background-color: #00b33c; }
    .toast.error { background-color: var(--cor-erro); }
    .action-btn { padding: 4px 8px; font-size: 12px; margin-right: 0px; border-radius: 4px; }
    .history-table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; width: 100%; margin-top: 8px; }
    #historyCard table { width: 100%; border-collapse: collapse; table-layout: fixed; min-width: 900px; background: transparent; }
    #historyCard th, #historyCard td { padding: 6px 8px; text-align: center; vertical-align: middle; white-space: nowrap; font-size: 14px; border-bottom: 1px solid var(--cor-borda); }
    #historyCard td { background: var(--cor-card); opacity: 0.95; }
    body.dark #historyCard td { background: var(--cor-card); opacity: 0.95; }
    #historyCard th:nth-child(1), #historyCard td:nth-child(1) { width: 100px; }
    #historyCard th:nth-child(2), #historyCard td:nth-child(2) { width: 140px; }
    #historyCard th:nth-child(3), #historyCard td:nth-child(3) { width: 160px; }
    #historyCard th:nth-child(4), #historyCard td:nth-child(4) { width: 110px; }
    #historyCard th:nth-child(5), #historyCard td:nth-child(5) { width: 280px; }
    #historyCard th:nth-child(6), #historyCard td:nth-child(6) { width: 150px; }
    #historyCard th:nth-child(7), #historyCard td:nth-child(7) { width: 130px; }
    #historyCard th:nth-child(8), #historyCard td:nth-child(8) { width: 120px; }
    #historyCard th:nth-child(9), #historyCard td:nth-child(9) { width: 150px; }
    .history-datetime-line { display: block; line-height: 1.2; font-size: 13px; }
    .valor-total-cell span:first-child { font-weight: 700; }
    .valor-obs-text { font-size: 12px; color: var(--cor-principal); }
    .history-actions-cell { display: flex; align-items: center; justify-content: center; gap: 5px; }
    .history-actions-cell button { padding: 3px 6px; font-size: 11px; border-radius: 4px; white-space: nowrap; }
    #historyCard tr { height: 40px; }
    #historyCard th { background: var(--cor-principal); color: var(--cor-btn-texto); }
    #authScreen { padding: 25px; border-radius: 16px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); }
    #authScreen h2 { text-align: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--cor-borda); font-size: 26px; }
    #authScreen input[type=text], #authScreen input[type=password] { padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid var(--cor-borda); transition: all 0.3s ease; }
    #authScreen input[type=text]:focus, #authScreen input[type=password]:focus { border-color: var(--cor-principal) !important; box-shadow: 0 0 10px rgba(230, 0, 115, 0.5); }
    #authScreen .actions { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
    #authScreen .actions button { width: 100%; padding: 12px; font-size: 16px; }
    #authMessage { text-align: center; font-weight: 600; }
    @media (max-width: 500px) { body { padding: 10px; margin: 10px auto; } .top-right-controls { top: 10px; right: 10px; } .control-btn { padding: 8px 10px; font-size: 12px; } .grid, .grid-venda { grid-template-columns: 1fr; } }
  </style>
</head>
<body class="light">
  
  <a href="#" id="logoLink">
    <img id="appLogo" src="logo-dark.png" alt="Hells Angels Logo" class="app-logo">
  </a>

  <div id="welcomeScreen"> 
      <img id="welcomeLogo" src="logo-dark.png" alt="Welcome Logo"> 
      <h2 style="font-weight: 900;">Bem-vindo(a)</h2>
      <p style="margin-bottom: 20px; font-size: 16px;">Calculadora e Registro de Vendas Hells Angels</p>
      <button id="enterBtn" class="primary">Entrar no Site</button>
  </div>
  
  <div class="top-right-controls">
      <button class="control-btn" id="tutorialBtn">💡 Tutorial</button> 
      <button class="control-btn" id="themeBtn">🌙 Modo Noturno</button>
  </div>

  <div id="authScreen" class="card" style="max-width: 400px; margin: 100px auto 20px auto; display: none;">
      <img src="logo-dark.png" alt="Hells Angels Logo" style="display: block; max-height: 100px; margin: 0 auto 20px auto;">
      <h2>Autenticação de Usuário</h2>
      <label for="username">Nome de Usuário:</label>
      <input id="username" type="text" placeholder="Seu nome de usuário">
      <label for="password">Senha:</label>
      <input id="password" type="password" placeholder="Sua senha">
      <div class="actions">
          <button id="loginBtn" class="primary">Entrar</button>
          <button id="registerUserBtn" class="muted">Cadastrar</button>
      </div>
      <p id="authMessage" style="color: var(--cor-erro); margin-top: 10px;"></p>
  </div>

  <div class="card" id="mainCard" style="display:none">
    <div style="display:flex; justify-content: space-between; align-items: center;">
        <h1>Calculadora e Registro de Vendas Hells Angels</h1>
        <div>
            <button id="adminPanelBtn" class="muted" style="display:none; margin-right: 10px;">Painel Admin</button>
            <button id="logoutBtn" class="danger" style="animation: none;">Sair</button>
        </div>
    </div>
    
    <div class="card-venda">
        <h2>Dados da Venda</h2>
        <div class="grid grid-venda">
            <div> <label for="nomeCliente">Nome:</label> <input id="nomeCliente" type="text" value=""> </div>
            <div> <label for="dataVenda">Data:</label> <input id="dataVenda" type="text" readonly> </div>
            <div> <label for="organizacao">Organização:</label> <input id="organizacao" type="text" value="" list="sugestoesOrganizacao"> <p class="suggestion-tip">Digite para ver sugestões de organizações.</p> <datalist id="sugestoesOrganizacao"> <option value="Serpents"></option><option value="Nox"></option><option value="NKT"></option><option value="Ruptura"></option><option value="Midnight"></option><option value="Meraki"></option><option value="Lotus"></option><option value="Hydra"></option><option value="Hooligans"></option><option value="Families"></option><option value="Cartel"></option><option value="Blood Street"></option><option value="Blood Reapers"></option><option value="Blue Diamond"></option><option value="Black Heart"></option><option value="Ballas"></option><option value="Aura"></option><option value="Anarquia"></option><option value="8 Anjo"></option><option value="Vagos"></option><option value="Vertice"></option><option value="Void"></option><option value="Solo"></option> </datalist> </div>
            <div> <label for="organizacaoTipo">Opção (CNPJ/CPF):</label> <select id="organizacaoTipo"> <option value="CNPJ">CNPJ</option> <option value="CPF">CPF</option> <option value="OUTROS">Outros</option> </select> </div>
            <div> <label for="telefone">Telefone:</label> <input id="telefone" type="text" value="" maxlength="13"> </div>
            <div> <label for="negociadoras">Negociadoras:</label> <input id="negociadoras" type="text" value=""> </div>
            <div style="grid-column: 1 / -1;"> <label for="vendaValorObs">Valor - Observação (Como foi o pagamento):</label> <input id="vendaValorObs" type="text" value=""> </div>
        </div>
    </div>
    
    <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--cor-borda);">

    <h2>Cálculo de Produtos</h2>
    <p class="small">Informe quantos produtos deseja fabricar/vender e escolha o tipo de valor.</p>

    <div class="grid">
      <div> <label for="qtyTickets">Quantidade de Tickets</label> <input id="qtyTickets" type="number" min="0" value=""> </div>
      <div> <label for="qtyTablets">Quantidade de Tablets</label> <input id="qtyTablets" type="number" min="0" value=""> </div>
      <div> <label for="qtyNitro">Quantidade de Nitro</label> <input id="qtyNitro" type="number" min="0" value=""> </div>
      <div> <label for="tipoValor">Tipo de Valor</label> <select id="tipoValor"> <option value="limpo">Dinheiro Limpo</option> <option value="sujo">Dinheiro Sujo</option> <option value="limpo_alianca">Limpo (Aliança)</option> <option value="sujo_alianca">Sujo (Aliança)</option> </select> </div>
    </div>

    <div class="actions">
      <button id="calcBtn" class="primary">Calcular</button>
      <button id="resetBtn" class="muted">Limpar Campos</button>
      <button id="registerBtn" class="success">Registrar Venda</button>
      <button id="toggleHistoryBtn" class="muted">Ver Histórico</button>
      <button id="csvBtn" class="muted">Exportar CSV</button>
      <button id="discordBtnCalc" class="muted">Discord</button> 
    </div>

    <div id="resultsContainer">
      <div id="results" style="margin-top:16px;display:none">
        <h3>Totais necessários</h3>
        <table> <thead><tr><th>Material</th><th>Quantidade total</th></tr></thead> <tbody id="resultsBody"></tbody> </table>
        <h3>Valores Estimados</h3>
        <table> <thead><tr><th>Produto</th><th>Valor Total</th></tr></thead> <tbody id="valuesBody"></tbody> <tfoot> <tr><th>Total Geral</th><th id="valorTotalGeral">R$ 0</th></tr> </tfoot> </table>
        <p class="result-note" style="font-size: 12px; margin-top: 8px;">Os valores variam conforme o tipo selecionado (limpo, sujo, aliança).</p>
      </div>
    </div>
  </div>

  <div class="card" id="historyCard" style="display:none">
      <div id="historyBackground" class="card">
        <h2>Histórico de Vendas Registradas</h2>
        <img id="historyImg" src="logo-dark.png" alt="Fundo Histórico"> 
        <input type="text" id="filtroHistorico" placeholder="🔍 Pesquisar no histórico (Nome, Data, Item, etc.)" style="margin-bottom: 10px; width: 100%;">
        <div class="actions">
          <button id="clearHistoryBtn" class="muted">Limpar Histórico</button>
          <button id="toggleCalcBtn" class="muted">Voltar à Calculadora</button>
        </div>
        <div class="history-table-wrapper">
          <table id="historicoVendas">
            <thead>
              <tr>
                  <th>Data/Hora</th><th>Cliente</th><th>Organização/Tipo</th><th>Telefone</th>
                  <th>Produtos (Unidade)</th><th>Valor Total</th><th>Negociadoras</th>
                  <th>Registrado Por</th><th>Ações</th> 
              </tr>
            </thead>
            <tbody id="salesHistory"></tbody>
          </table>
        </div>
      </div>
  </div>
  
  <div class="card" id="adminPanel" style="display:none;">
    <h2>Painel de Administração</h2>
    <p>Funcionalidades futuras de gestão de utilizadores e configurações aparecerão aqui.</p>
    <button id="closeAdminPanelBtn" class="muted">Voltar à Calculadora</button>
  </div>
  
  <div id="toast-container"></div>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, set, push, onValue, remove, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyAhDVBfXoO_Rdi3e-trdbaaPppwDkTDgVc",
      authDomain: "hells-angels-438c2.firebaseapp.com",
      databaseURL: "https://hells-angels-438c2-default-rtdb.firebaseio.com/",
      projectId: "hells-angels-438c2",
      storageBucket: "hells-angels-438c2.firebasestorage.app",
      messagingSenderId: "429406215315",
      appId: "1:429406215315:web:96b68b172247824b308166"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    
    let vendas = [];
    let vendaEmEdicaoId = null;
    let currentUser = null;
    let currentUserTag = 'Visitante'; // Padrão

    const els = {
      qtyTickets: document.getElementById('qtyTickets'), qtyTablets: document.getElementById('qtyTablets'), qtyNitro: document.getElementById('qtyNitro'), tipoValor: document.getElementById('tipoValor'), nomeCliente: document.getElementById('nomeCliente'), organizacao: document.getElementById('organizacao'), organizacaoTipo: document.getElementById('organizacaoTipo'), telefone: document.getElementById('telefone'), negociadoras: document.getElementById('negociadoras'), vendaValorObs: document.getElementById('vendaValorObs'), dataVenda: document.getElementById('dataVenda'), filtroHistorico: document.getElementById('filtroHistorico'), resultsBody: document.getElementById('resultsBody'), valuesBody: document.getElementById('valuesBody'), valorTotalGeral: document.getElementById('valorTotalGeral'), results: document.getElementById('results'), mainCard: document.getElementById('mainCard'), historyCard: document.getElementById('historyCard'), salesHistory: document.getElementById('salesHistory'), calcBtn: document.getElementById('calcBtn'), resetBtn: document.getElementById('resetBtn'), registerBtn: document.getElementById('registerBtn'), toggleHistoryBtn: document.getElementById('toggleHistoryBtn'), toggleCalcBtn: document.getElementById('toggleCalcBtn'), clearHistoryBtn: document.getElementById('clearHistoryBtn'), csvBtn: document.getElementById('csvBtn'), discordBtnCalc: document.getElementById('discordBtnCalc'), themeBtn: document.getElementById('themeBtn'), tutorialBtn: document.getElementById('tutorialBtn'), logoLink: document.getElementById('logoLink'), appLogo: document.getElementById('appLogo'), historyImg: document.getElementById('historyImg'), welcomeScreen: document.getElementById('welcomeScreen'), enterBtn: document.getElementById('enterBtn'), welcomeLogo: document.getElementById('welcomeLogo'), authScreen: document.getElementById('authScreen'), username: document.getElementById('username'), password: document.getElementById('password'), loginBtn: document.getElementById('loginBtn'), registerUserBtn: document.getElementById('registerUserBtn'), authMessage: document.getElementById('authMessage'), logoutBtn: document.getElementById('logoutBtn'), adminPanel: document.getElementById('adminPanel'), adminPanelBtn: document.getElementById('adminPanelBtn'), closeAdminPanelBtn: document.getElementById('closeAdminPanelBtn')
    };

    // --- CÓPIAS DAS SUAS FUNÇÕES ORIGINAIS ---
    // (A maioria das suas funções de utilidade e cálculo foram mantidas)
    const formatCurrency = (value) => { if (typeof value !== 'number' || isNaN(value)) { return 'R$ 0'; } return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 0, maximumFractionDigits: 0 }); };
    const capitalizeText = (text) => { if (!text) return ''; return String(text).trim().toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' '); };
    const showToast = (message, type = 'default', duration = 3000) => { const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = `toast ${type}`; t.textContent = message; c.appendChild(t); setTimeout(() => t.classList.add('show'), 10); setTimeout(() => { t.classList.remove('show'); setTimeout(() => c.removeChild(t), 300); }, duration); };
    const getQty = (element) => Math.max(0, parseInt(element.value) || 0);
    const phoneMask = (value) => { let d = value.replace(/\D/g, ""); if (d.startsWith("055")) d = d.substring(3); d = d.substring(0, 6); return "(055) " + (d.length > 3 ? d.substring(0, 3) + "-" + d.substring(3) : d); };
    if (els.telefone) { els.telefone.addEventListener('input', (e) => { e.target.value = e.target.value.length < 7 ? "(055) " : phoneMask(e.target.value); }); els.telefone.addEventListener('focus', (e) => { if (!e.target.value) e.target.value = "(055) "; }); }
    const updateDataVenda = () => { els.dataVenda.value = new Date().toLocaleDateString('pt-BR'); };
    updateDataVenda();
    const perUnit = { tickets: { moneyBruto: 525 }, tablets: { cobre: 20, plastico: 40, fita_adesiva: 2, lixo_eletronico: 2 }, nitro: { aluminio: 20, cobre: 20, vidro: 45, fita_adesiva: 1, porca: 1, parafuso: 1 } };
    const valores = { tablets: { limpo: 17000, sujo: 20000, limpo_alianca: 15000, sujo_alianca: 18000 }, tickets: { limpo: 9800, sujo: 11700, limpo_alianca: 8000, sujo_alianca: 10000 }, nitro: { limpo: 42500, sujo: 50000, limpo_alianca: 38000, sujo_alianca: 45000 } };
    const valorDescricao = { 'limpo': 'Dinheiro Limpo', 'sujo': 'Dinheiro Sujo', 'limpo_alianca': 'Limpo (Aliança)', 'sujo_alianca': 'Sujo (Aliança)' };
    const calculate = () => { const qT = getQty(els.qtyTickets), qTb = getQty(els.qtyTablets), qN = getQty(els.qtyNitro), tV = els.tipoValor.value; const totals = { cobre: 0, plastico: 0, fita_adesiva: 0, lixo_eletronico: 0, aluminio: 0, vidro: 0, porca: 0, parafuso: 0, moneyBruto: 0 }; let totalVal = 0; const pVals = []; totals.cobre += qTb * perUnit.tablets.cobre; totals.plastico += qTb * perUnit.tablets.plastico; totals.fita_adesiva += qTb * perUnit.tablets.fita_adesiva; totals.lixo_eletronico += qTb * perUnit.tablets.lixo_eletronico; const tbVal = qTb * valores.tablets[tV]; totalVal += tbVal; if (qTb > 0) pVals.push({ product: `Tablets (${qTb} und.)`, value: tbVal }); totals.moneyBruto += qT * perUnit.tickets.moneyBruto; const tkVal = qT * valores.tickets[tV]; totalVal += tkVal; if (qT > 0) pVals.push({ product: `Tickets (${qT} und.)`, value: tkVal }); totals.aluminio += qN * perUnit.nitro.aluminio; totals.cobre += qN * perUnit.nitro.cobre; totals.vidro += qN * perUnit.nitro.vidro; totals.fita_adesiva += qN * perUnit.nitro.fita_adesiva; totals.porca += qN * perUnit.nitro.porca; totals.parafuso += qN * perUnit.nitro.parafuso; const nVal = qN * valores.nitro[tV]; totalVal += nVal; if (qN > 0) pVals.push({ product: `Nitro (${qN} und.)`, value: nVal }); const hasQ = qT > 0 || qTb > 0 || qN > 0; if (hasQ) { els.results.style.display = 'block'; els.resultsBody.innerHTML = Object.entries(totals).filter(([, v]) => v > 0).map(([m, v]) => `<tr><td>${capitalizeText(m.replace(/_/g, ' '))}</td><td>${v.toLocaleString('pt-BR')}</td></tr>`).join(''); els.valuesBody.innerHTML = pVals.map(i => `<tr><td>${i.product}</td><td>${formatCurrency(i.value)}</td></tr>`).join(''); els.valorTotalGeral.textContent = formatCurrency(totalVal); } else { els.results.style.display = 'none'; } return { qtyTickets: qT, qtyTablets: qTb, qtyNitro: qN, totalValue: totalVal, tipoValor: tV, hasQuantities: hasQ }; };
    const clearAllFields = () => { ['qtyTickets', 'qtyTablets', 'qtyNitro', 'nomeCliente', 'organizacao', 'telefone', 'negociadoras', 'vendaValorObs'].forEach(id => els[id].value = ''); els.tipoValor.value = 'limpo'; els.organizacaoTipo.value = 'CNPJ'; els.results.style.display = 'none'; document.querySelectorAll('.input-invalido').forEach(i => i.classList.remove('input-invalido')); if (vendaEmEdicaoId) { vendaEmEdicaoId = null; els.registerBtn.textContent = 'Registrar Venda'; } };
    const validateFields = () => { let isValid = true; [els.nomeCliente, els.organizacao, els.telefone, els.negociadoras].forEach(f => { if (!f.value.trim()) { f.classList.add('input-invalido'); isValid = false; } else { f.classList.remove('input-invalido'); } }); return isValid; };
    const buildDiscordMessage = () => { /* ... sua função de criar mensagem para o discord ... */ };
    
    // --- LÓGICA DE PERMISSÕES E AUTENTICAÇÃO (ATUALIZADA) ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            const userRef = ref(db, `users/${user.uid}`);
            const snapshot = await get(userRef);
            currentUserTag = (snapshot.exists() && snapshot.val().tag) ? snapshot.val().tag : 'Visitante';
            if (!snapshot.exists()) set(userRef, { username: user.displayName, tag: 'Visitante' });

            els.authScreen.style.display = 'none';
            els.mainCard.style.display = 'block';
            els.adminPanelBtn.style.display = (currentUserTag === 'ADMIN') ? 'inline-block' : 'none';
            loadSales();
        } else {
            currentUser = null;
            currentUserTag = 'Visitante';
            els.authScreen.style.display = 'block';
            [els.mainCard, els.historyCard, els.adminPanel].forEach(el => el.style.display = 'none');
        }
    });

    const loadSales = () => {
        onValue(ref(db, 'vendas'), (snapshot) => {
            vendas = [];
            snapshot.forEach(child => vendas.push({ id: child.key, ...child.val() }));
            if (els.historyCard.style.display === 'block') displaySalesHistory();
        });
    };

    const displaySalesHistory = () => {
        const historyToDisplay = (currentUserTag === 'ADMIN' || currentUserTag === 'HELLS') ? vendas : vendas.filter(v => v.registradoPorUID === currentUser.uid);
        
        els.salesHistory.innerHTML = '';
        if(historyToDisplay.length === 0) {
            const row = els.salesHistory.insertRow();
            const cell = row.insertCell(); cell.colSpan = 9; cell.textContent = "Nenhuma venda registrada."; cell.style.textAlign = 'center';
            return;
        }

        historyToDisplay.sort((a, b) => b.timestamp - a.timestamp).forEach(venda => {
            const row = els.salesHistory.insertRow();
            const [data, hora] = (venda.dataHora || ' , ').split(', ');
            row.insertCell().innerHTML = `<span class="history-datetime-line">${data}</span><span class="history-datetime-line">${hora}</span>`;
            row.insertCell().textContent = capitalizeText(venda.cliente);
            row.insertCell().textContent = `${capitalizeText(venda.organizacao)} (${venda.organizacaoTipo})`;
            row.insertCell().textContent = venda.telefone;
            let produtos = [];
            if (venda.qtyTickets > 0) produtos.push(`${venda.qtyTickets} Tickets`);
            if (venda.qtyTablets > 0) produtos.push(`${venda.qtyTablets} Tablets`);
            if (venda.qtyNitro > 0) produtos.push(`${venda.qtyNitro} Nitro`);
            row.insertCell().textContent = capitalizeText(produtos.join(', '));
            const valorCell = row.insertCell();
            valorCell.innerHTML = `<span class="valor-total-cell"><span>${formatCurrency(venda.valorTotal || 0)}</span><span class="valor-obs-text">(${valorDescricao[venda.tipoValor] || 'N/A'})</span></span>`;
            row.insertCell().textContent = capitalizeText(venda.negociadoras);
            row.insertCell().textContent = venda.registradoPor || 'Desconhecido';
            
            const actionsCell = row.insertCell();
            actionsCell.className = 'history-actions-cell';
            if ((currentUserTag === 'ADMIN') || (currentUser && currentUser.uid === venda.registradoPorUID)) {
                actionsCell.innerHTML = `<button onclick="window.globalEditVenda('${venda.id}')" class="action-btn muted">Editar</button><button onclick="window.globalRemoveVenda('${venda.id}')" class="action-btn danger">Deletar</button>`;
            }
        });
        els.clearHistoryBtn.style.display = (currentUserTag === 'ADMIN') ? 'inline-block' : 'none';
    };

    const registerVenda = () => {
      const { qtyTickets, qtyTablets, qtyNitro, totalValue, tipoValor, hasQuantities } = calculate();
      if (!hasQuantities || !validateFields() || !currentUser) {
          showToast("Verifique os campos ou se está logado.", "error");
          return;
      }
      const newVenda = {
        timestamp: Date.now(), dataHora: new Date().toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' }),
        cliente: els.nomeCliente.value.trim(), organizacao: els.organizacao.value.trim(), organizacaoTipo: els.organizacaoTipo.value,
        telefone: els.telefone.value.trim(), negociadoras: els.negociadoras.value.trim(), vendaValorObs: els.vendaValorObs.value.trim(),
        qtyTickets, qtyTablets, qtyNitro, valorTotal: totalValue, tipoValor,
        registradoPor: currentUser.displayName,
        registradoPorUID: currentUser.uid // **ESSENCIAL**
      };
      const op = vendaEmEdicaoId ? set(ref(db, `vendas/${vendaEmEdicaoId}`), newVenda) : push(ref(db, 'vendas'), newVenda);
      op.then(() => { showToast(`Venda ${vendaEmEdicaoId ? 'atualizada' : 'registrada'}!`, "success"); clearAllFields(); }).catch(err => showToast("Erro: " + err.message, "error"));
    };
    
    window.globalEditVenda = (id) => {
        const venda = vendas.find(v => v.id === id); if (!venda) return;
        ['qtyTickets', 'qtyTablets', 'qtyNitro', 'tipoValor', 'nomeCliente', 'organizacao', 'organizacaoTipo', 'telefone', 'negociadoras', 'vendaValorObs'].forEach(key => { if (els[key]) els[key].value = venda[key] || ''; });
        calculate(); vendaEmEdicaoId = id; els.registerBtn.textContent = 'Atualizar Venda'; toggleView(false); showToast(`Editando venda de ${venda.cliente}`, "default");
    };
    window.globalRemoveVenda = (id) => { if (confirm("Tem certeza que deseja remover esta venda?")) remove(ref(db, `vendas/${id}`)).then(() => showToast("Venda removida.", "success")).catch(err => showToast("Erro: " + err.message, "error")); };
    
    const handleAuth = (isRegistering) => {
        const email = els.username.value.trim() + "@ha.com";
        const password = els.password.value;
        const displayName = els.username.value.trim();
        if (password.length < 6) { els.authMessage.textContent = "A senha deve ter no mínimo 6 caracteres."; return; }
        const action = isRegistering ? createUserWithEmailAndPassword(auth, email, password).then(cred => updateProfile(cred.user, { displayName })) : signInWithEmailAndPassword(auth, email, password);
        action.catch(err => { els.authMessage.textContent = err.code === 'auth/invalid-credential' ? "Usuário ou senha incorretos." : err.code === 'auth/email-already-in-use' ? "Nome de usuário já existe." : "Erro de autenticação."; });
    };

    els.loginBtn.onclick = () => handleAuth(false);
    els.registerUserBtn.onclick = () => handleAuth(true);
    els.logoutBtn.onclick = () => auth.signOut();
    
    const toggleView = (showHistory) => { els.mainCard.style.display = showHistory ? 'none' : 'block'; els.historyCard.style.display = showHistory ? 'block' : 'none'; if (showHistory) displaySalesHistory(); };
    els.adminPanelBtn.onclick = () => { [els.mainCard, els.historyCard].forEach(el => el.style.display = 'none'); els.adminPanel.style.display = 'block'; };
    els.toggleHistoryBtn.onclick = () => toggleView(true);
    els.toggleCalcBtn.onclick = () => toggleView(false);
    els.closeAdminPanelBtn.onclick = els.toggleCalcBtn.onclick;

    els.resetBtn.onclick = clearAllFields;
    els.registerBtn.onclick = registerVenda;
    
    // --- Restante dos seus listeners e código inicial ---
    // (O seu código para o tutorial, tema, CSV, etc. pode ser colado aqui)
    const savedTheme = localStorage.getItem('theme') || 'light'; document.body.classList.add(savedTheme);
    if (localStorage.getItem('hasVisited')) { els.welcomeScreen.style.display = 'none'; } else { els.welcomeScreen.classList.add('show'); els.authScreen.style.display = 'none'; els.mainCard.style.display = 'none'; }
    els.enterBtn.onclick = () => { localStorage.setItem('hasVisited', 'true'); els.welcomeScreen.classList.add('hidden'); setTimeout(() => els.welcomeScreen.style.display = 'none', 500); };

  </script>
</body>
</html>
